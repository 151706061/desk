<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
  "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>
VTK Mesh display
</title>
<script type="text/javascript" src="O3Djs.js"></script>
<script type="text/javascript" id="myscript"> 

window.onload = init;
window.onunload = uninit;

function getParameter( parameterName )
{
  parameterName = parameterName.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
  var regexS = "[\\?&]"+parameterName+"=([^&#]*)";
  var regex = new RegExp( regexS );
  var results = regex.exec( window.location.href );
  if( results == null )
    return null;
  else
    return results[1];
}

// global variables

var g_scene;

function resizeClient(width,height) {

	if ((width!=null)&&(height!=null))
	{
		var parent=document.getElementById("o3d");
		parent.style.width=width+"px";
		parent.style.height=height+"px";
	}


    g_scene.resize();
    g_scene.render();
    
    function workaround_render()
    {
    	g_scene.render();
    }
 //   var t=setTimeout(workaround_render,500);
}

/**
 * Creates the client area.
 */
function init() {
	var parent=document.getElementById("o3d");
	var height=getParameter("height")
	if (height!=null)
		parent.style.height=height+"px";
	var width=getParameter("width")
	if (width!=null)
		parent.style.width=width+"px";

  o3djs.webgl.makeClients(initStep2);
}
/**
 * Initializes O3D, creates the object and sets up the transform and
 * render graphs.
 * @param {Array} clientElements Array of o3d object elements.
 */

function initStep2(clientElements) {

	canvaselement=clientElements[0];
	g_scene=o3djs.renderscene.createRenderScene(clientElements[0]);
   	g_scene.render();
	window.onresize = resizeClient;

	var mesh=getParameter("mesh")
	if (mesh!=null)
		g_scene.loadMesh (mesh);
	else
		g_scene.loadMesh ("ADAM/adam.xml");

//	g_scene.addMeshes("http://www.creatis.insa-lyon.fr/~valette/meshView/stream/output.xml");
//	g_scene.addMeshes("http://www.creatis.insa-lyon.fr/~valette/meshView/bones/output.xml");
//	g_scene.addMeshes("http://www.creatis.insa-lyon.fr/~valette/meshView/coeurThoraxVoxels/output.xml");
//	g_scene.addMeshes("test/output_full.xml");
//	createFromFile(g_scene,"data/heart.vtk",[1,1,1,0.6]);
//	createFromFile(g_scene,"data/skull.vtk",[1,1,1,0.6]);
//	createFromFile(g_scene,"coeurThorax/poumonDroit.vtk",[1,1,1,1]);
}

/**
 * Removes any callbacks so they don't get called after the page has unloaded.
 */
function uninit() {
  if (g_scene.client) {
    g_scene.client.cleanup();
  }
}

var canvaselement=0;

function keyPressedEvent(e)
{
	keyPressed(e.which);
}
function keyPressed(code)
{
	var pressedKey=String.fromCharCode(code);
//	alert (pressedKey);
	if (pressedKey=='c')
	{
//		var myCanvas=document.getElementsByTagName('canvas')[0];
//		alert(document.getElementsByTagName('canvas').length);
//		//alert(myCanvas);
        var context = canvaselement.getContext('2d');
//        context.fillStyle = "rgb(200,0,0)";
//	context.fillRect (10, 10, 55, 50);
//	context.fillStyle = "rgba(0, 0, 200, 0.5)";
//	context.fillRect (30, 30, 55, 50);


		var strData = canvaselement.toDataURL("image/png");
//		var strData = client.toDataURL("image/png");
		var saveData=strData.replace("image/png", "image/octet-stream");
		document.location.href = saveData;
	}
	if ((pressedKey=="r")||(pressedKey=="R"))
	{
		g_scene.resetCamera();
//		alert("Reset Camera");
		g_scene.render();
	}
	if ((pressedKey=="b")||(pressedKey=="B"))
	{
		alert ("Bounding Box :\n"+g_scene.meshesBoundingBox.minExtent+"\n"+g_scene.meshesBoundingBox.maxExtent);
	}
}

</script>
</head>
<body onkeypress="keyPressedEvent(event)">

<!-- Start of O3D plugin -->
<div id="o3d" style="width: 100%; height: 100%;"></div>
<!-- End of O3D plugin -->

</div>
</body>
</html>
