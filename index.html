<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
  "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>
VTK Mesh display
</title>
<script type="text/javascript" src="o3d-webgl/base.js"></script>
<script type="text/javascript" src="o3djs/base.js"></script>
<script type="text/javascript" src="o3dvtk.js"></script>
<script type="text/javascript" id="o3dscript">
o3djs.base.o3d = o3d;
o3djs.require('o3djs.webgl');
o3djs.require('o3djs.math');
o3djs.require('o3djs.quaternions');
o3djs.require('o3djs.rendergraph');
o3djs.require('o3djs.pack');
o3djs.require('o3djs.arcball');
o3djs.require('o3djs.event');
//o3djs.require('o3djs.scene');
o3djs.require('o3djs.primitives');

// Events
// Run the init() function once the page has finished loading.
// Run the uninit() function when the page has is unloaded.
window.onload = init;
window.onunload = uninit;

// global variables
var g_o3d;
var g_math;
var g_pack;
var g_client;

var g_thisRot;
var g_lastRot;

var g_o3dWidth = -1;
var g_o3dHeight = -1;

var g_aball;
var g_viewInfo;
var g_camera = {
// eye: [0, 0, 4],
 eye: [0, 0, 10],
 target: [0, 0, 0]
// eye: [60, 60, 100],
// target: [60, 60, 60]
};


function updateClient() {
  // If we are in RENDERMODE_ON_DEMAND mode then set the render mode again
  // which will cause the client re-render the display.
  if (g_client.renderMode == g_o3d.Client.RENDERMODE_ON_DEMAND) {
    g_client.render();
  }
}

function renderCallback(renderEvent) {
  resize();
    g_client.renderMode = g_o3d.Client.RENDERMODE_ON_DEMAND;
}

/**
 * Creates the client area.
 */
function init() {
  o3djs.webgl.makeClients(initStep2);
}

function setClientSize() {
  var newWidth  = g_client.width;
  var newHeight = g_client.height;

  if (newWidth != g_o3dWidth || newHeight != g_o3dHeight) {
    g_o3dWidth = newWidth;
    g_o3dHeight = newHeight;

    // Set the perspective projection matrix
    g_viewInfo.drawContext.projection = g_math.matrix4.perspective(
      g_math.degToRad(45), g_o3dWidth / g_o3dHeight, 0.1, 100);

    // Sets a new area size for arcball.
    g_aball.setAreaSize(g_o3dWidth, g_o3dHeight);

    //o3djs.dump.dump("areaWidth: " + g_o3dWidth + "\n");
    //o3djs.dump.dump("areaHeight: " + g_o3dHeight + "\n");
  }
}

function resize() {
  setClientSize();
}

var g_dragging = false;

function startDragging(e) {
  g_lastRot = g_thisRot;
  g_aball.click([e.x, e.y]);
  g_dragging = true;
}

function drag(e) {
  if (g_dragging) {
    var rotationQuat = g_aball.drag([e.x, e.y]);
    var rot_mat = g_quaternions.quaternionToRotation(rotationQuat);
    g_thisRot = g_math.matrix4.mul(g_lastRot, rot_mat);
    var m = g_client.root.localMatrix;
    g_math.matrix4.setUpper3x3(m, g_thisRot);
    g_client.root.localMatrix = m;
    updateClient();
  }
}

function stopDragging(e) {
  g_dragging = false;
}

function scrollMe(e) {
  if (e.deltaY) {
    g_camera.eye =
        g_math.mulScalarVector((-e.deltaY < 0 ? 11 : 13) / 12, g_camera.eye);
    g_viewInfo.drawContext.view = g_math.matrix4.lookAt(g_camera.eye,
                                                        g_camera.target,
                                                        [0, 1, 0]);
    updateClient();
  }
}
/**
 * Initializes O3D, creates the object and sets up the transform and
 * render graphs.
 * @param {Array} clientElements Array of o3d object elements.
 */
function initStep2(clientElements) {
	// Initializes global variables and libraries.
	var o3dElement = clientElements[0];
	g_client = o3dElement.client;
	g_o3d = o3dElement.o3d;
	g_math = o3djs.math;

	g_quaternions = o3djs.quaternions;
	g_lastRot = g_math.matrix4.identity();
	g_thisRot = g_math.matrix4.identity();

	// Create a pack to manage the objects created.
	g_pack = g_client.createPack();

	// Create the render graph for a view.
	g_viewInfo = o3djs.rendergraph.createBasicView(
	  g_pack,
	  g_client.root,
	  g_client.renderGraphRoot,
	  [1, 1, 1, 1]);

	// Set up our view transformation to look towards the world origin where the
	// object is located.
	g_viewInfo.drawContext.view = g_math.matrix4.lookAt(
	g_camera.eye,
	g_camera.target,
	[0, 1, 0]);  // up

	g_aball = o3djs.arcball.create(100, 100);
	setClientSize();

	// Create the Shape for the mesh
//	var Shape=createfromXML("foot.xml",g_pack,[1,1,1,1]);
	var Shape=createfromXML("skull.xml",g_pack,[1,1,1,0.6]);
//	var Shape=createfromXML("rockerarm.xml",g_pack,[1,1,1,0.6]);
//	var Shape=createfromXML("bunny.xml",g_pack,[1,1,1,0.6]);
//	var Shape=createfromXML("hand.xml",g_pack,[1,1,1,1]);
//	var Shape=createfromXML("skull.xml",g_pack,[1,1,1,1]);
//	var Shape=createfromXML("heart.xml",g_pack,[1,1,1,1]);

	// Create a new transform and parent the Shape under it.
	var Transform = g_pack.createObject('Transform');
	Transform.addShape(Shape);

	// Parent the object's transform to the client root.
	Transform.parent = g_client.root;

	o3djs.event.addEventListener(o3dElement, 'mousedown', startDragging);
	o3djs.event.addEventListener(o3dElement, 'mousemove', drag);
	o3djs.event.addEventListener(o3dElement, 'mouseup', stopDragging);
	o3djs.event.addEventListener(o3dElement, 'wheel', scrollMe);

	// Set our render callback for animation.
	// This sets a function to be executed every time a frame is rendered.
	g_client.setRenderCallback(renderCallback);
	window.onresize = updateClient;
}

/**
 * Removes any callbacks so they don't get called after the page has unloaded.
 */
function uninit() {
  if (g_client) {
    g_client.cleanup();
  }
}

</script>
</head>
<body>
<h1>Mesh Display</h1>
This example shows a VTK mesh exported to ASCII xml
<br/>

<!-- Start of O3D plugin -->
<div id="o3d" style="width: 100%; height: 80%;"></div>
<!-- End of O3D plugin -->

</div>
</body>
</html>
