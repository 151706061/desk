var o3djs=o3djs||{},goog=goog||{};goog.typedef=true;o3djs.global=this;o3djs.BROWSER_ONLY=true;o3djs.provided_=[];o3djs.provide=function(){};o3djs.implicitNamespaces_={};o3djs.exportPath_=function(a,b,c){a=a.split(".");c=c||o3djs.global;var d;!(a[0]in c)&&c.execScript&&c.execScript("var "+a[0]);for(;a.length&&(d=a.shift());)if(!a.length&&o3djs.isDef(b))c[d]=b;else c=c[d]?c[d]:c[d]={}};
o3djs.getObjectByName=function(a,b){for(var c=a.split("."),d=b||o3djs.global,e=0;e<c.length;++e){var f=c[e];if(d[f])d=d[f];else return null}return d};o3djs.require=function(){document.getElementsByTagName("script")};o3djs.basePath="";o3djs.included_={};o3djs.dependencies_={visited:{},written:{}};
o3djs.findBasePath_=function(){var a=o3djs.global.document;if(typeof a!="undefined")if(o3djs.global.BASE_PATH)o3djs.basePath=o3djs.global.BASE_PATH;else{o3djs.global.BASE_PATH=null;a=a.getElementsByTagName("script");for(var b,c=0;b=a[c];c++){b=b.src;var d=b.length;if(b.substr(d-13)=="o3djs/base.js"){o3djs.basePath=b.substr(0,d-13);break}}}};
o3djs.writeScriptTag_=function(a){var b=o3djs.global.document;if(typeof b!="undefined"&&!o3djs.dependencies_.written[a]){o3djs.dependencies_.written[a]=true;b.write('<script type="text/javascript" src="'+a+'"><\/script>')}};
o3djs.writeScripts_=function(){function a(f){if(!(f in d.written)){f in d.visited||(d.visited[f]=true);if(!(f in c)){c[f]=true;b.push(f)}}}var b=[],c={},d=o3djs.dependencies_,e;for(e in o3djs.included_)d.written[e]||a(e);for(e=0;e<b.length;e++)if(b[e])o3djs.writeScriptTag_(o3djs.basePath+b[e]);else throw Error("Undefined script input");};o3djs.getPathFromRule_=function(a){return a.split(".").join("/")+".js"};o3djs.findBasePath_();o3djs.isDef=function(a){return typeof a!="undefined"};
o3djs.exportSymbol=function(a,b,c){o3djs.exportPath_(a,b,c)};o3djs.v8Initializer_="";o3djs.v8InitializerArgs_=[];
o3djs.valueToString_=function(a){switch(typeof a){case "undefined":return"undefined";case "string":var b=escape(a);return b===a?'"'+a+'"':'unescape("'+b+'")';case "object":if(a===null)return"null";else{if(a instanceof RegExp){b="new RegExp("+o3djs.valueToString_(a.source)+', "';if(a.global)b+="g";if(a.ignoreCase)b+="i";if(a.multiline)b+="m";b+='")'}else if(o3djs.base.isArray(a)){b="[";for(var c="",d=0;d<a.length;++d){b+=c+o3djs.valueToString_(a[d]);c=","}b+="]\n"}else{b="{\n";c="";for(d in a){b+=
c+'"'+d+'": '+o3djs.valueToString_(a[d]);c=","}b+="}\n"}return b}default:return a.toString()}};
o3djs.namespaceInitializer_=function(a,b,c){var d=b+" = {};\n",e;for(e in a){var f=b+"."+e,g=a[e];if(typeof g==="object"&&g!==null&&!o3djs.base.isArray(g)&&!(g instanceof RegExp))d+=o3djs.namespaceInitializer_(g,f);else{var h=o3djs.valueToString_(g);if(typeof g=="function"&&h.indexOf("o3djs.BROWSER_ONLY")!=-1){h="args_["+c.length+"]";c.push(g)}d+=f+" = "+h+";\n";if(typeof g==="function"&&g.prototype)d+=o3djs.namespaceInitializer_(g.prototype,f+".prototype")}}return d};o3djs.provide("o3djs.base");
o3djs.base=o3djs.base||{};o3djs.base.o3d=null;o3djs.base.glsl=false;o3djs.base.snapshotProvidedNamespaces=function(){o3djs.v8Initializer_="function(args_) {\n";o3djs.v8InitializerArgs_=[];for(var a=0;a<o3djs.provided_.length;++a){var b=o3djs.getObjectByName(o3djs.provided_[a]);o3djs.v8Initializer_+=o3djs.namespaceInitializer_(b,o3djs.provided_[a],o3djs.v8InitializerArgs_)}o3djs.v8Initializer_+="}\n"};
o3djs.base.initV8=function(a){a.eval(function(b,c){var d=o3djs;o3djs={};o3djs.browser=d;o3djs.global=function(){return this}();o3djs.require=function(){};o3djs.provide=function(){};eval("("+b+")")(c);o3djs.base.o3d=plugin.o3d;o3djs.base.glsl=plugin.client.clientInfo.glsl}.toString())(o3djs.v8Initializer_,o3djs.v8InitializerArgs_)};
o3djs.base.init=function(a){function b(d){var e={},f=false,g;for(g in d){var h=d[g];if(typeof h=="object"||typeof h=="function")h=b(h);if(typeof h!="undefined"){e[g]=h;f=true}}return f?e:undefined}try{o3djs.base.o3d=b(a.o3d)}catch(c){o3djs.base.o3d=a.o3d}o3djs.base.o3d=o3djs.base.o3d||a.o3d;o3djs.base.glsl=a.client.clientInfo.glsl};o3djs.base.isArray=function(a){return typeof a==="object"&&a!==null&&"length"in a&&"splice"in a};o3djs.base.ready=function(){return o3djs.base.o3d!=null};
o3djs.base.maybeDeobfuscateFunctionName_=function(a){return a};o3djs.base.inherit=function(a,b){var c=function(){};c.prototype=b.prototype;a.prototype=new c};
o3djs.base.parseErrorStack=function(a){var b=[],c;if(!a||!a.stack)return b;for(var d=a.stack.split("\n"),e=0;e<d.length-1;e++){c=d[e];a=(a=c.match(/^([a-zA-Z0-9_$]*)/)[1])?o3djs.base.maybeDeobfuscateFunctionName_(a):"anonymous";(c=(c=c.match(/(.*:[0-9]+)$/))&&c[1])||(c="(unknown)");b[b.length]=a+" : "+c}for(a=/^anonymous :/;b.length&&a.exec(b[b.length-1]);)b.length-=1;return b};
o3djs.base.getFunctionName=function(a){if((a=a.toString().match(/function(\s*)(\w*)/))&&a.length>=2&&a[2])return o3djs.base.maybeDeobfuscateFunctionName_(a[2]);return"anonymous"};o3djs.base.formatErrorStack=function(a){for(var b="",c=0;c<a.length;c++)b+="> "+a[c]+"\n";return b};
o3djs.base.getStackTrace=function(a){var b="";if(typeof arguments.caller!="undefined")for(var c=arguments.caller;c!=null;c=c.caller){b+="> "+o3djs.base.getFunctionName(c.callee)+"\n";if(c.caller==c){b+="*";break}}else try{eval("var var;")}catch(d){c=o3djs.base.parseErrorStack(d);b+=o3djs.base.formatErrorStack(c.slice(3+a,c.length))}return b};o3djs.base.setErrorHandler=function(a){a.setErrorCallback(function(b){a.clearErrorCallback();alert("ERROR: "+b+"\n"+o3djs.base.getStackTrace(1))})};
o3djs.base.IsMSIE=function(){var a=navigator.userAgent.toLowerCase();return/msie/.test(a)&&!/opera/.test(a)};o3djs.provide("o3djs.webgl");o3djs.require("o3djs.effect");o3djs.require("o3djs.util");o3djs.webgl=o3djs.webgl||{};
o3djs.webgl.makeClients=function(a,b,c,d,e,f,g){var h=[];c=o3djs.util.getO3DContainerElements(e,f);for(d=0;d<c.length;++d){e=c[d];f=b;if(!f)f=(f=e.getAttribute("o3d_features"))?f:"";e=o3djs.webgl.createClient(e,f,g);if(!e)return;h.push(e)}var j=window.setInterval(function(){for(var i=0;i<h.length;++i)if(!h[i].sizeInitialized_)return;window.clearInterval(j);a(h)})};
o3djs.webgl.createGLErrorWrapper=function(a,b){return function(){var c=a[b].apply(a,arguments),d=a.getError();if(d!=0)throw"GL error "+d+" in "+b;return c}};o3djs.webgl.addDebuggingWrapper=function(a){var b={},c;for(c in a)b[c]=typeof a[c]=="function"?o3djs.webgl.createGLErrorWrapper(a,c):a[c];b.getError=function(){return a.getError()};return b};
o3djs.webgl.webGlCanvasError=function(a){var b=document.createElement("div");b.style.backgroundColor="#ccffff";b.style.textAlign="center";b.style.margin="10px";b.style.width="100%";b.style.height="100%";b.innerHTML='<br/><br/><a href="http://get.webgl.org">Your browser does not appear to support WebGL.<br/><br/>Check that WebGL is enabled or click here to upgrade your browser:</a><br/>';a.appendChild(b)};
o3djs.webgl.createClient=function(a,b,c){function d(){return false}c=c||false;o3djs.effect.setLanguage("glsl");var e;e=document.createElement("canvas");if(!e||!e.getContext){o3djs.webgl.webGlCanvasError(a,"HTMLCanvas");return null}e.style.width="100%";e.style.height="100%";var f=new o3d.Client;b=function(){var g=Math.max(1,e.clientHeight);e.width=Math.max(1,e.clientWidth);e.height=g;e.sizeInitialized_=true;if(f.gl)f.gl.displayInfo={width:e.width,height:e.height}};window.addEventListener("resize",
b,false);setTimeout(b,0);if(!f.initWithCanvas(e)){o3djs.webgl.webGlCanvasError(a,"WebGL context");return null}document.onselectstart=d;document.onmousedown=d;e.client=f;e.o3d=o3d;if(c)f.gl=o3djs.webgl.addDebuggingWrapper(f.gl);a.appendChild(e);return e};o3djs.provide("o3djs.util");o3djs.require("o3djs.io");o3djs.require("o3djs.effect");o3djs.require("o3djs.event");o3djs.require("o3djs.error");o3djs.util=o3djs.util||{};o3djs.util.PLUGIN_NAME="O3D Plugin";o3djs.util.REQUIRED_VERSION="0.1.42.4";
o3djs.util.MINIMUM_WIDTH_FOR_MESSAGE=200;o3djs.util.MINIMUM_HEIGHT_FOR_MESSAGE=200;o3djs.util.PLUGIN_DOWNLOAD_URL="http://tools.google.com/dlpage/o3d";o3djs.util.rendererInitStatus={NO_PLUGIN:-1,UNINITIALIZED:0,SUCCESS:1,OUT_OF_RESOURCES:2,GPU_NOT_UP_TO_SPEC:3,INITIALIZATION_ERROR:4};o3djs.util.curry=function(a){for(var b=[],c=1;c<arguments.length;++c)b.push(arguments[c]);return function(){for(var d=b.slice(),e=0;e<arguments.length;++e)d.push(arguments[e]);return a.apply(this,d)}};
o3djs.util.getCurrentURI=function(){var a=window.location.href,b=a.lastIndexOf("/");return a.substring(0,b+1)};o3djs.util.getAbsoluteURI=function(a){return o3djs.util.getCurrentURI()+a};o3djs.util.arrayContains=function(a,b){for(var c=0;c<a.length;c++)if(a[c]==b)return true;return false};
o3djs.util.getTransformsInTreeByTags=function(a,b){for(var c=b.split(","),d=a.getTransformsInTree(),e=[],f=0;f<d.length;f++){var g=d[f].getParam("collada.tags");if(g){g=g.value.split(",");for(var h=0;h<g.length;h++)if(o3djs.util.arrayContains(c,g[h])){e[e.length]=d[f];break}}}return e};o3djs.util.getTransformsInTreeByPrefix=function(a,b){for(var c=[],d=a.getTransformsInTree(),e=0;e<d.length;e++){var f=d[e];if(f.name.indexOf(b)==0)c[c.length]=f}return c};
o3djs.util.getBoundingBoxOfTree=function(a){var b=a.boundingBox;if(b.valid)return b;for(var c=a.children,d=0;d<c.length;++d){var e=c[d],f=o3djs.util.getBoundingBoxOfTree(e);if(f.valid){f=f.mul(e.localMatrix);b=b.valid?b.add(f):f}}a=a.shapes;for(d=0;d<a.length;++d){c=a[d].elements;for(e=0;e<c.length;++e){f=c[e].boundingBox;f.valid||(f=c[e].getBoundingBox(0));b=b.valid?b.add(f):f}}return b};o3djs.util.getPowerOfTwoSize=function(a){var b=1;for(a-=1;a;){a>>=1;b<<=1}return b};
o3djs.util.getPluginVersion=function(){var a=null,b=null;if(navigator.plugins!=null&&navigator.plugins.length>0){var c=navigator.plugins[o3djs.util.PLUGIN_NAME];if(c)b=c.description}else if(o3djs.base.IsMSIE())try{b=(new ActiveXObject("o3d_host.O3DHostControl")).description}catch(d){}if(b)if((b=/.*version:\s*(\d+)\.(\d+)\.(\d+)\.(\d+).*/.exec(b))&&b.length==5)a=""+parseInt(b[1],10)+"."+parseInt(b[2],10)+"."+parseInt(b[3],10)+"."+parseInt(b[4],10);return a};
o3djs.util.requiredVersionAvailable=function(a){var b=o3djs.util.getPluginVersion();if(!b)return false;b=b.split(".");a=a.split(".");if(a.length>4)throw Error("requiredVersion has more than 4 parts!");for(var c=0;c<a.length;++c){var d=parseInt(b[c],10),e=parseInt(a[c],10);if(d<e)return false;if(d>e)break}return true};o3djs.util.getElementsByTagAndId=function(a,b){for(var c=[],d=document.getElementsByTagName(a),e=0;e<d.length;++e){var f=d[e];f.id&&f.id.match(b)&&c.push(f)}return c};
o3djs.util.getO3DContainerElements=function(a,b){return o3djs.util.getElementsByTagAndId(b||"div",a||"^o3d")};
o3djs.util.offerPlugin=function(a,b){var c=o3djs.util.requiredVersionAvailable(""),d=o3djs.util.getO3DContainerElements(a,b),e=false;c=c?"This page requires a newer version of the O3D plugin.":"This page requires the O3D plugin to be installed.";for(var f='<div style="background: lightblue; width: 100%; height: 100%; text-align:center;"><br/><br/>'+c+'<br/><a href="'+o3djs.util.PLUGIN_DOWNLOAD_URL+'">Click here to download.</a></div>',g=0;g<d.length;++g){var h=d[g];if(h.clientWidth>=o3djs.util.MINIMUM_WIDTH_FOR_MESSAGE&&
h.clientHeight>=o3djs.util.MINIMUM_HEIGHT_FOR_MESSAGE&&h.style.display.toLowerCase()!="none"&&h.style.visibility.toLowerCase()!="hidden"){e=true;h.innerHTML=f}}if(!e)if(confirm(c+"\n\nClick OK to download."))window.location=o3djs.util.PLUGIN_DOWNLOAD_URL};
o3djs.util.informNoGraphics=function(a,b,c,d){c=o3djs.util.getO3DContainerElements(c,d);d=false;var e="",f=function(){},g=function(j){var i="";if(j.length>0)i="<br/><br/><div>More Info:<br/>"+j+"</div>";return i};if(a==o3djs.util.rendererInitStatus.GPU_NOT_UP_TO_SPEC){a="We are terribly sorry but it appears your graphics card is not able to run o3d. We are working on a solution.";b='<div style="background: lightgray; width: 100%; height: 100%; text-align: center;"><br/><br/>'+a+'<br/><br/><a href="'+
o3djs.util.PLUGIN_DOWNLOAD_URL+'">Click Here to go the O3D website</a>'+g(b)+"</div>";e="\n\nClick OK to go to the o3d website.";f=function(){window.location=o3djs.util.PLUGIN_DOWNLOAD_URL}}else{a=a==o3djs.util.rendererInitStatus.OUT_OF_RESOURCES?"Your graphics system appears to be out of resources. Try closing some applications and then refreshing this page.":"A unknown error has prevented O3D from starting. Try downloading new drivers or checking for OS updates.";b='<div style="background: lightgray; width: 100%; height: 100%; text-align: center;"><br/><br/>'+
a+g(b)+"</div>"}for(g=0;g<c.length;++g){var h=c[g];if(h.clientWidth>=o3djs.util.MINIMUM_WIDTH_FOR_MESSAGE&&h.clientHeight>=o3djs.util.MINIMUM_HEIGHT_FOR_MESSAGE&&h.style.display.toLowerCase()!="none"&&h.style.visibility.toLowerCase()!="hidden"){d=true;h.innerHTML=b}}d||confirm(a+e)&&f()};o3djs.util.informPluginFailure=function(a,b,c,d){a==o3djs.util.rendererInitStatus.NO_PLUGIN?o3djs.util.offerPlugin(c,d):o3djs.util.informNoGraphics(a,b,c,d)};
o3djs.util.getElementContentById=function(a){o3djs.BROWSER_ONLY=true;var b=document.getElementById(a);if(!b)throw"getElementContentById could not find node with id "+a;switch(b.tagName){case "TEXTAREA":return b.value;case "SCRIPT":return b.text;default:throw"getElementContentById does not no how to get content from a "+b.tagName+" element";}};o3djs.util.getElementById=function(a){o3djs.BROWSER_ONLY=true;return document.getElementById(a)};o3djs.util.Engine={BROWSER:0,V8:1};o3djs.util.mainEngine_=o3djs.util.Engine.BROWSER;
function o3djs_navHas(a){return navigator.userAgent.indexOf(a)!=-1}function o3djs_isV8Supported(){if(o3djs_navHas("Chrome"))return true;if(!o3djs_navHas("Safari"))return true;return!o3djs_navHas("Intel Mac OS X 10_6")}o3djs.util.setMainEngine=function(a){if(a==o3djs.util.Engine.V8&&!o3djs_isV8Supported())a=o3djs.util.Engine.BROWSER;o3djs.util.mainEngine_=a};o3djs.util.fixFunctionString_=/^\s*function\s+[^\s]+\s*\(([^)]*)\)/;
o3djs.util.callV8=function(a,b,c,d){b=b.toString();b=b.replace(o3djs.util.fixFunctionString_,"function($1)");return a.eval("function(thisArg, args) {\n  var localArgs = [];\n  var numArgs = args.length;\n  for (var i = 0; i < numArgs; ++i) {\n    localArgs.push(args[i]);\n  }\n  var func = "+b+";\n  return func.apply(thisArg, localArgs);\n}\n")(c,d)};o3djs.util.stripDotDot_=/\/[^\/]+\/\.\./;
o3djs.util.toAbsoluteUri=function(a){if(a.indexOf("://")==-1){var b=document.location.toString(),c=b.lastIndexOf("/");if(c!=-1)b=b.substring(0,c);a=b+"/"+a}do{b=a;a=a.replace(o3djs.util.stripDotDot_,"")}while(b!==a);return a};o3djs.util.scriptUris_=[];o3djs.util.addScriptUri=function(a){o3djs.util.scriptUris_.push(o3djs.util.toAbsoluteUri(a))};
o3djs.util.isScriptUri=function(a){a=o3djs.util.toAbsoluteUri(a);for(var b=0;b<o3djs.util.scriptUris_.length;++b){var c=o3djs.util.scriptUris_[b];if(a.substring(0,c.length)===c)return true}return false};o3djs.util.isWantedScriptTag_=function(a){return a.id&&a.id.match(/^o3dscript/)};
o3djs.util.getScriptTagText_=function(){for(var a="",b=document.getElementsByTagName("script"),c=0;c<b.length;++c){var d=b[c];if(d.type===""||d.type==="text/javascript"){if("text"in d&&d.text&&o3djs.util.isWantedScriptTag_(d))a+=d.text;if("src"in d&&d.src&&o3djs.util.isScriptUri(d.src))a+=o3djs.io.loadTextFileSynchronous(d.src)}}return a};
o3djs.util.createClient=function(a,b,c){b=b||"";c=c||o3djs.util.REQUIRED_VERSION;if(!o3djs.util.requiredVersionAvailable(c))return null;b+=(b?",":"")+"APIVersion="+c;if(o3djs.base.IsMSIE()){a.innerHTML='<OBJECT WIDTH="100%" HEIGHT="100%"CLASSID="CLSID:9666A772-407E-4F90-BC37-982E8160EB2D"><PARAM name="o3d_features" value="'+b+'"/></OBJECT>';c=a.childNodes[0]}else{c=document.createElement("object");c.type="application/vnd.o3d.auto";c.style.width="100%";c.style.height="100%";c.setAttribute("o3d_features",
b);a.appendChild(c)}c.client.clientInfo.glsl&&o3djs.effect.setLanguage("glsl");return c};
o3djs.util.makeClients=function(a,b,c,d,e,f){d=d||o3djs.util.informPluginFailure;c=c||o3djs.util.REQUIRED_VERSION;if(o3djs.util.requiredVersionAvailable(c)){var g=[];c=o3djs.util.getO3DContainerElements(e,f);for(var h=null,j=0;j<c.length;++j){var i=c[j],k=b;if(!k)k=(k=i.getAttribute("o3d_features"))?k:"";k=o3djs.util.createClient(i,k);g.push(k);if(i.id==="o3d")h=k}var l=window.setInterval(function(){for(var m=0,n="",r,o=0;o<g.length;++o){var q=g[o];r=q.o3d;if(!(r&&q.client&&q.client.rendererInitStatus>
o3djs.util.rendererInitStatus.UNINITIALIZED))return;q=g[o].client.rendererInitStatus;if(q>m){m=q;n=g[o].client.lastError}}window.clearInterval(l);if(m>0&&m!=r.Renderer.SUCCESS){for(o=0;o<g.length;++o){r=g[o];r.parentNode.removeChild(r)}d(m,n,e,f)}else{o3djs.base.snapshotProvidedNamespaces();for(o=0;o<g.length;++o){o3djs_isV8Supported()&&o3djs.base.initV8(g[o]);o3djs.event.startKeyboardEventSynthesis(g[o]);o3djs.error.setDefaultErrorHandler(g[o].client)}o3djs.base.init(g[0]);switch(o3djs.util.mainEngine_){case o3djs.util.Engine.BROWSER:a(g);
break;case o3djs.util.Engine.V8:if(!h)throw'V8 engine was requested but there is no element with the id "o3d"';m=o3djs.util.getScriptTagText_();h.eval(m);o3djs.util.callV8(h,a,o3djs.global,[g]);break;default:throw"Unknown engine "+o3djs.util.mainEngine_;}}},10)}else d(o3djs.util.rendererInitStatus.NO_PLUGIN,"",e,f)};o3djs.provide("o3djs.arcball");o3djs.require("o3djs.math");o3djs.require("o3djs.quaternions");o3djs.arcball=o3djs.arcball||{};
o3djs.arcball.create=function(a,b){return new o3djs.arcball.ArcBall(a,b)};o3djs.arcball.ArcBall=function(a,b){this.startVector_=[0,0,0];this.endVector_=[0,0,0];this.areaWidth_=a;this.areaHeight_=b};o3djs.arcball.ArcBall.prototype.setAreaSize=function(a,b){this.areaWidth_=a;this.areaHeight_=b};
o3djs.arcball.ArcBall.prototype.mapToSphere=function(a){a=o3djs.math.copyVector(a);a[0]=a[0]/this.areaWidth_*2-1;a[1]=1-a[1]/this.areaHeight_*2;var b=o3djs.math.lengthSquared(a);return b>1?o3djs.math.normalize(a).concat(0):a.concat(Math.sqrt(1-b))};o3djs.arcball.ArcBall.prototype.click=function(a){this.startVector_=this.mapToSphere(a)};
o3djs.arcball.ArcBall.prototype.drag=function(a){this.endVector_=this.mapToSphere(a);return o3djs.math.cross(this.startVector_,this.endVector_).concat(o3djs.math.dot(this.startVector_,this.endVector_))};o3djs.provide("o3djs.cameracontroller");o3djs.require("o3djs.math");o3djs.cameracontroller=o3djs.cameracontroller||{};o3djs.cameracontroller.DragMode={NONE:0,SPIN_ABOUT_CENTER:1,DOLLY_IN_OUT:2,ZOOM_IN_OUT:3,DOLLY_ZOOM:4,MOVE_CENTER_IN_VIEW_PLANE:5};
o3djs.cameracontroller.createCameraController=function(a,b,c,d,e,f){return new o3djs.cameracontroller.CameraController(a,b,c,d,e,f)};
o3djs.cameracontroller.CameraController=function(a,b,c,d,e,f){this.centerPos=a;this.backpedal=b;this.fieldOfViewAngle=e;this.onChange=f||null;this.dragMode_=o3djs.cameracontroller.DragMode.NONE;this.mouseY_=this.mouseX_=0;this.pixelsPerUnit=300;this.radiansPerUnit=1;this.distancePerUnit=10;this.zoomPerUnit=1;this.areaWidth_=c;this.areaHeight_=d;this.thisRot_=g_math.matrix4.identity();this.lastRot_=g_math.matrix4.identity()};
o3djs.cameracontroller.CameraController.prototype.setAreaSize=function(a,b){this.areaWidth_=a;this.areaHeight_=b;var c=Math.min(a,b);this.distancePerUnit=c/100;this.pixelsPerUnit=c/5};
o3djs.cameracontroller.CameraController.prototype.viewAll=function(a,b){var c=a.minExtent,d=a.maxExtent,e=o3djs.math.divVectorScalar(o3djs.math.addVector(c,d),2),f=this.calculateViewMatrix_(e,0),g=0,h=Math.tan(this.fieldOfViewAngle),j=Math.tan(Math.atan(b*h));c=[c,d];for(d=0;d<2;d++)for(var i=0;i<2;i++)for(var k=0;k<2;k++){var l=[c[k][0],c[i][1],c[d][2],1];l=o3djs.math.mulVectorMatrix(l,f);if(l[2]>=0){g=Math.max(g,l[2]+l[0]/j);g=Math.max(g,l[2]+l[1]/h)}}this.centerPos=e;this.backpedal=g;this.distancePerUnit=
g/5};o3djs.cameracontroller.CameraController.prototype.calculateViewMatrix=function(){return this.calculateViewMatrix_(this.centerPos,this.backpedal)};o3djs.cameracontroller.CameraController.prototype.calculateViewMatrix_=function(a,b){var c=o3djs.math.matrix4,d=c.translation(o3djs.math.negativeVector(a));d=c.mul(d,this.thisRot_);return d=c.mul(d,c.translation([0,0,-b]))};
o3djs.cameracontroller.CameraController.prototype.setDragMode=function(a,b,c){this.dragMode_=a;this.mouseX_=b;this.mouseY_=c;this.lastRot_=this.thisRot_};
o3djs.cameracontroller.CameraController.prototype.mouseMoved=function(a,b){var c=(a-this.mouseX_)/this.pixelsPerUnit,d=(b-this.mouseY_)/this.pixelsPerUnit;this.mouseX_=a;this.mouseY_=b;if(this.dragMode_==o3djs.cameracontroller.DragMode.SPIN_ABOUT_CENTER){var e=c*this.radiansPerUnit,f=o3djs.math.matrix4;this.thisRot_=g_math.matrix4.mul(this.thisRot_,f.rotationX(d*this.radiansPerUnit));this.thisRot_=g_math.matrix4.mul(this.thisRot_,f.rotationY(e))}if(this.dragMode_==o3djs.cameracontroller.DragMode.DOLLY_IN_OUT)this.backpedal+=
d*this.distancePerUnit;if(this.dragMode_==o3djs.cameracontroller.DragMode.ZOOM_IN_OUT){f=Math.tan(this.fieldOfViewAngle);f*=Math.pow(2,d*this.zoomPerUnit);this.fieldOfViewAngle=Math.atan(f)}if(this.dragMode_==o3djs.cameracontroller.DragMode.DOLLY_ZOOM)if(this.backpedal>0){f=Math.tan(this.fieldOfViewAngle);this.fieldOfViewAngle+=d*this.radiansPerUnit;this.fieldOfViewAngle=Math.min(this.fieldOfViewAngle,0.98*Math.PI/2);this.fieldOfViewAngle=Math.max(this.fieldOfViewAngle,0.02*Math.PI/2);this.backpedal*=
f/Math.tan(this.fieldOfViewAngle)}if(this.dragMode_==o3djs.cameracontroller.DragMode.MOVE_CENTER_IN_VIEW_PLANE){f=o3djs.math.matrix4;e=this.distancePerUnit*this.backpedal/50;c=[-c*e,d*e,0];d=f.inverse(this.calculateViewMatrix());c=f.transformDirection(d,c);this.centerPos=o3djs.math.addVector(this.centerPos,c)}if(this.onChange!=null&&this.dragMode_!=o3djs.cameracontroller.DragMode.NONE)this.onChange(this)};o3djs.provide("o3djs.camera");o3djs.require("o3djs.util");o3djs.require("o3djs.math");
o3djs.camera=o3djs.camera||{};o3djs.camera.CameraInfo=function(a,b,c,d,e,f){this.view=a;this.projection=o3djs.math.matrix4.identity();this.orthographic=false;this.zNear=b;this.zFar=c;this.fieldOfViewRadians=o3djs.math.degToRad(30);this.eye=d;this.target=e;this.up=f;this.magY=this.magX=undefined};o3djs.camera.CameraInfo.prototype.setAsOrthographic=function(a,b){this.orthographic=true;this.magX=a;this.magY=b};
o3djs.camera.CameraInfo.prototype.setAsPerspective=function(a){this.orthographic=false;this.fieldOfViewRadians=a};o3djs.camera.CameraInfo.prototype.computeProjection=function(a,b){if(this.orthographic){var c=this.magX,d=this.magY;this.projection=o3djs.math.matrix4.orthographic(-c,c,-d,d,this.zNear,this.zFar)}else this.projection=o3djs.math.matrix4.perspective(this.fieldOfViewRadians,a/b,this.zNear,this.zFar);return this.projection};
o3djs.camera.findCameras=function(a){return o3djs.util.getTransformsInTreeByTags(a,"camera")};
o3djs.camera.getViewAndProjectionFromCamera=function(a,b,c){var d=30,e=1,f=5E3,g=undefined,h=undefined,j=undefined,i,k=o3djs.math,l;i=a.getParam("collada.eyePosition");var m=a.getParam("collada.targetPosition"),n=a.getParam("collada.upVector");if(i!=null&&m!=null&&n!=null){g=i.value;h=m.value;j=n.value;i=k.matrix4.lookAt(g,h,j)}else i=k.inverse(a.getUpdatedWorldMatrix());if(m=a.getParam("collada.projectionType")){e=a.getParam("collada.projectionNearZ").value;f=a.getParam("collada.projectionFarZ").value;
if(m.value=="orthographic"){m=a.getParam("collada.projectionMagX").value;a=a.getParam("collada.projectionMagY").value;l=new o3djs.camera.CameraInfo(i,e,f);l.setAsOrthographic(m,a)}else if(m.value=="perspective")d=a.getParam("collada.perspectiveFovY").value}if(!l){l=new o3djs.camera.CameraInfo(i,e,f,g,h,j);l.setAsPerspective(k.degToRad(d))}l.computeProjection(b,c);return l};
o3djs.camera.getCameraFitToScene=function(a,b,c){var d=o3djs.math,e=o3djs.util.getBoundingBoxOfTree(a);a=d.lerpVector(e.minExtent,e.maxExtent,0.5);var f=d.subVector(e.maxExtent,e.minExtent);e=o3djs.math.distance(e.minExtent,e.maxExtent);f=d.addVector(a,[f[0]*0.3,f[1]*0.7,e*1.5]);a=new o3djs.camera.CameraInfo(d.matrix4.lookAt(f,a,[0,1,0]),e/1E3,e*10);a.setAsPerspective(d.degToRad(45));a.computeProjection(b,c);return a};
o3djs.camera.getViewAndProjectionFromCameras=function(a,b,c){var d=o3djs.camera.findCameras(a);return d.length>0?o3djs.camera.getViewAndProjectionFromCamera(d[0],b,c):o3djs.camera.getCameraFitToScene(a,b,c)};o3djs.camera.getCameraInfos=function(a,b,c){a=o3djs.camera.findCameras(a);for(var d=[],e=0;e<a.length;++e)d.push(o3djs.camera.getViewAndProjectionFromCamera(a[e],b,c));return d};
o3djs.camera.fitContextToScene=function(a,b,c,d){a=o3djs.camera.getCameraFitToScene(a,b,c);d.view=a.view;d.projection=a.projection};o3djs.provide("o3djs.canvas");o3djs.require("o3djs.effect");o3djs.require("o3djs.primitives");o3djs.canvas=o3djs.canvas||{};o3djs.canvas.create=function(a,b,c){return new o3djs.canvas.CanvasInfo(a,b,c)};
o3djs.canvas.buildShaderString=function(){var a=o3djs.effect,b=a.BEGIN_OUT_STRUCT+a.VARYING+a.FLOAT4+" "+a.VARYING_DECLARATION_PREFIX+"position"+a.semanticSuffix("POSITION")+";\n"+a.VARYING+a.FLOAT2+" "+a.VARYING_DECLARATION_PREFIX+"texCoord"+a.semanticSuffix("TEXCOORD0")+";\n"+a.END_STRUCT;return"uniform "+a.MATRIX4+" worldViewProjection"+a.semanticSuffix("WORLDVIEWPROJECTION")+";\n\n"+a.BEGIN_IN_STRUCT+a.ATTRIBUTE+a.FLOAT4+" position"+a.semanticSuffix("POSITION")+";\n"+a.ATTRIBUTE+a.FLOAT2+" texCoord0"+
a.semanticSuffix("TEXCOORD0")+";\n"+a.END_STRUCT+"\n"+b+"\n"+a.beginVertexShaderMain()+"  "+a.VERTEX_VARYING_PREFIX+"position = "+a.mul(a.ATTRIBUTE_PREFIX+"position","worldViewProjection")+";\n  "+a.VERTEX_VARYING_PREFIX+"texCoord = "+a.ATTRIBUTE_PREFIX+"texCoord0;\n"+a.endVertexShaderMain()+"\n"+a.pixelShaderHeader()+"uniform "+a.SAMPLER+" texSampler0;\n"+a.repeatVaryingDecls(b)+a.beginPixelShaderMain()+a.endPixelShaderMain(a.TEXTURE+"2D(texSampler0, "+a.PIXEL_VARYING_PREFIX+"texCoord)")+a.entryPoints()+
a.matrixLoadOrder()};
o3djs.canvas.CanvasInfo=function(a,b,c){this.pack=a;this.viewInfo=c;this.root=b;this.effect_=this.pack.createObject("Effect");this.effect_.loadFromFXString(o3djs.canvas.buildShaderString());this.transparentMaterial_=this.pack.createObject("Material");this.opaqueMaterial_=this.pack.createObject("Material");this.transparentMaterial_.effect=this.effect_;this.opaqueMaterial_.effect=this.effect_;this.transparentMaterial_.drawList=c.zOrderedDrawList;this.opaqueMaterial_.drawList=c.performanceDrawList;this.transparentState_=
this.pack.createObject("State");this.transparentState_.getStateParam("AlphaBlendEnable").value=true;this.transparentState_.getStateParam("SourceBlendFunction").value=o3djs.base.o3d.State.BLENDFUNC_ONE;this.transparentState_.getStateParam("DestinationBlendFunction").value=o3djs.base.o3d.State.BLENDFUNC_INVERSE_SOURCE_ALPHA;this.transparentMaterial_.state=this.transparentState_;this.transparentQuadShape=o3djs.primitives.createPlane(this.pack,this.transparentMaterial_,1,1,1,1,[[1,0,0,0],[0,0,1,0],[0,
-1,0,0],[0,0,0,1]]);this.opaqueQuadShape=o3djs.primitives.createPlane(this.pack,this.opaqueMaterial_,1,1,1,1,[[1,0,0,0],[0,0,1,0],[0,-1,0,0],[0,0,0,1]])};
o3djs.canvas.CanvasQuad=function(a,b,c,d,e){this.canvasInfo=a;e=e||a.root;this.transform=a.pack.createObject("Transform");this.transform.parent=e;this.scaleTransform=a.pack.createObject("Transform");this.scaleTransform.parent=this.transform;this.texture=a.pack.createTexture2D(b,c,o3djs.base.o3d.Texture.ARGB8,1,false);this.canvas=a.pack.createObject("Canvas");this.canvas.setSize(b,c);this.sampler=a.pack.createObject("Sampler");this.sampler.addressModeU=o3djs.base.o3d.Sampler.CLAMP;this.sampler.addressModeV=
o3djs.base.o3d.Sampler.CLAMP;this.paramSampler_=this.scaleTransform.createParam("texSampler0","ParamSampler");this.paramSampler_.value=this.sampler;this.sampler.texture=this.texture;d?this.scaleTransform.addShape(a.transparentQuadShape):this.scaleTransform.addShape(a.opaqueQuadShape);this.scaleTransform.translate(b/2,c/2,0);this.scaleTransform.scale(b,-c,1)};
o3djs.canvas.CanvasQuad.prototype.updateTexture=function(){var a=this.texture.width,b=this.texture.height;this.texture.drawImage(this.canvas,0,b-1,a,-b,0,0,0,a,b)};o3djs.canvas.CanvasInfo.prototype.createXYQuad=function(a,b,c,d,e,f,g){d=new o3djs.canvas.CanvasQuad(this,d,e,f,g);d.transform.translate(a,b,c);return d};o3djs.canvas.CanvasInfo.prototype.createQuad=function(a,b,c,d){return new o3djs.canvas.CanvasQuad(this,a,b,c,d)};o3djs.provide("o3djs.dump");o3djs.dump=o3djs.dump||{};
o3djs.dump.dumpXYZ_=function(a,b,c){o3djs.dump.dump((c||"")+a+" : "+b[0]+", "+b[1]+", "+b[2]+"\n")};o3djs.dump.dumpXYZW_=function(a,b,c){o3djs.dump.dump((c||"")+a+" : "+b[0]+", "+b[1]+", "+b[2]+", "+b[3]+"\n")};o3djs.dump.getFunctionName_=function(a){if(a.name)return a.name;a=a.toString();if(a=a.substring(a.indexOf("function")+8,a.indexOf("(")))return a;return"*anonymous*"};
o3djs.dump.getSignature_=function(a){var b=o3djs.dump.getFunctionName_(a);b+="(";for(var c=0;c<a.arguments.length;c++){var d=a.arguments[c];if(d.length>30)d=d.substring(0,30)+"...";b+="'"+d+"'";if(c<a.arguments.length-1)b+=", "}b+=")";return b};o3djs.dump.dump=function(a){o3djs.BROWSER_ONLY=true;if(window.dump)window.dump(a);else window.console&&window.console.log&&window.console.log(a)};
o3djs.dump.getMatrixAsString=function(a,b){b=b||"";for(var c=b+"[",d=0;;++d){var e=a[d];c+="[";for(var f=0;;++f){c+=e[f];if(f<e.length-1)c+=", ";else{c+="]";break}}if(d<a.length-1){c+="\n";c+=b}else break}c+="]";return c};o3djs.dump.dumpFloat3=function(a,b,c){o3djs.dump.dumpXYZ_(a,b,c||"")};o3djs.dump.dumpFloat4=function(a,b,c){o3djs.dump.dumpXYZW_(a,b,c||"")};o3djs.dump.dumpVector4=function(a,b,c){o3djs.dump.dumpXYZW_(a,b,c||"")};
o3djs.dump.dumpMatrix=function(a,b,c){c=c||"";o3djs.dump.dump(c+a+" :\n"+o3djs.dump.getMatrixAsString(b,c+"    ")+"\n")};o3djs.dump.dumpBoundingBox=function(a,b,c){c=c||"";o3djs.dump.dump(c+a+" :\n");o3djs.dump.dumpFloat3("min : ",b.minExtent,c+"    ");o3djs.dump.dumpFloat3("max : ",b.maxExtent,c+"    ")};
o3djs.dump.getParamValueAsString=function(a,b){b=b||"";var c="*unknown*";if(a.isAClassName("o3d.ParamFloat"))c=a.value.toString();else if(a.isAClassName("o3d.ParamFloat2"))c="["+a.value[0]+", "+a.value[1]+"]";else if(a.isAClassName("o3d.ParamFloat3"))c="["+a.value[0]+", "+a.value[1]+", "+a.value[2]+"]";else if(a.isAClassName("o3d.ParamFloat4"))c="["+a.value[0]+", "+a.value[1]+", "+a.value[2]+", "+a.value[3]+"]";else if(a.isAClassName("o3d.ParamInteger"))c=a.value.toString();else if(a.isAClassName("o3d.ParamBoolean"))c=
a.value.toString();else if(a.isAClassName("o3d.ParamMatrix4"))c="\n"+o3djs.dump.getMatrixAsString(a.value,b+"    ");else if(a.isAClassName("o3d.ParamString"))c=a.value;else if(a.isAClassName("o3d.ParamTexture")){c=a.value;c='texture : "'+(c?c.name:"NULL")+'"'}else if(a.isAClassName("o3d.ParamSampler")){c=a.value;c='sampler : "'+(c?c.name:"NULL")+'"'}else if(a.isAClassName("o3d.ParamMaterial")){c=a.value;c='material : "'+(c?c.name:"NULL")+'"'}else if(a.isAClassName("o3d.ParamEffect")){c=a.value;c=
'effect : "'+(c?c.name:"NULL")+'"'}else if(a.isAClassName("o3d.ParamState")){c=a.value;c='state : "'+(c?c.name:"NULL")+'"'}else if(a.isAClassName("o3d.ParamTransform")){c=a.value;c='transform : "'+(c?c.name:"NULL")+'"'}else if(a.isAClassName("o3d.ParamDrawList")){c=a.value;c='drawlist : "'+(c?c.name:"NULL")+'"'}else if(a.isAClassName("o3d.ParamRenderSurface")){c=a.value;c='renderSurface : "'+(c?c.name:"NULL")+'"'}else if(a.isAClassName("o3d.ParamRenderDepthStencilSurface")){c=a.value;c='renderDepthStencilSurface: "'+
(c?c.name:"NULL")+'"'}else if(a.isAClassName("o3d.ParamDrawContext")){c=a.value;c='drawcontext : "'+(c?c.name:"NULL")+'"'}return c};o3djs.dump.dumpParam=function(a,b){b=b||"";o3djs.dump.dump(b+a.className+' : "'+a.name+'" : '+o3djs.dump.getParamValueAsString(a,b)+"\n")};o3djs.dump.dumpParams=function(a,b){b=b||"";for(var c=a.params,d=0;d<c.length;d++)o3djs.dump.dumpParam(c[d],b)};
o3djs.dump.dumpParamObject=function(a,b){b=b||"";o3djs.dump.dump(b+a.className+' : "'+a.name+'"\n');o3djs.dump.dumpParams(a,b+"    ")};o3djs.dump.dumpStream=function(a,b){o3djs.dump.dump((b||"")+"semantic: "+a.semantic+", index: "+a.semanticIndex+", dataType: "+a.dataType+", field: "+a.field.name+"\n")};
o3djs.dump.dumpElement=function(a,b){b=b||"";o3djs.dump.dump(b+"------------ Element --------------\n");o3djs.dump.dump(b+'Element: "'+a.name+'"\n');o3djs.dump.dump(b+"  --Params--\n");o3djs.dump.dumpParams(a,b+"  ");o3djs.dump.dump(b+"  --DrawElements--\n");for(var c=a.drawElements,d=0;d<c.length;d++)o3djs.dump.dumpParamObject(c[d],b+"    ");if(a.isAClassName("o3d.Primitive")){o3djs.dump.dump(b+"  primitive type: "+a.primitiveType+"\n");o3djs.dump.dump(b+"  number vertices: "+a.numberVertices+"\n");
o3djs.dump.dump(b+"  number primitives: "+a.numberPrimitives+"\n");if(c=a.streamBank){c=c.vertexStreams;for(d=0;d<c.length;d++){var e=c[d];o3djs.dump.dump(b+"  stream "+d+": ");o3djs.dump.dumpStream(e)}}}};
o3djs.dump.dumpShape=function(a,b){b=b||"";o3djs.dump.dump(b+"------------ Shape --------------\n");o3djs.dump.dump(b+'Shape: "'+a.name+'"\n');o3djs.dump.dump(b+"  --Params--\n");o3djs.dump.dumpParams(a,b+"  ");o3djs.dump.dump(b+"  --Elements--\n");for(var c=a.elements,d=0;d<c.length;d++)o3djs.dump.dumpElement(c[d],b+"    ")};
o3djs.dump.dumpTexture=function(a,b){b=b||"";var c="",d=a.getParam("uri");if(d)c=d.value;o3djs.dump.dump(b+a.className+' : "'+a.name+'" uri : "'+c+'" width: '+a.width+" height: "+a.height+" alphaIsOne: "+a.alphaIsOne+"\n")};
o3djs.dump.dumpTransform=function(a,b){b=b||"";o3djs.dump.dump(b+"----------- Transform -------------\n");o3djs.dump.dump(b+"Transform: "+a.name+'"\n');o3djs.dump.dump(b+"  --Local Matrix--\n");o3djs.dump.dump(o3djs.dump.getMatrixAsString(a.localMatrix,b+"    ")+"\n");o3djs.dump.dump(b+"  --Params--\n");o3djs.dump.dumpParams(a,b+"  ");o3djs.dump.dump(b+"  --Shapes--\n");for(var c=a.shapes,d=0;d<c.length;d++)o3djs.dump.dumpNamedObjectName(c[d],b+"  ")};
o3djs.dump.dumpTransformTree=function(a,b){b=b||"";o3djs.dump.dumpTransform(a,b);for(var c=b+"    ",d=a.children,e=0;e<d.length;e++)o3djs.dump.dumpTransformTree(d[e],c)};o3djs.dump.dumpTransformList=function(a){o3djs.dump.dump(a.length+" transforms in list!!!\n");for(var b=0;b<a.length;b++)o3djs.dump.dumpTransform(a[b])};o3djs.dump.dumpNamedObjectName=function(a,b){o3djs.dump.dump((b||"")+a.className+' : "'+a.name+'"\n')};
o3djs.dump.dumpRenderNode=function(a,b){b=b||"";o3djs.dump.dump(b+"----------- Render Node -----------\n");o3djs.dump.dumpNamedObjectName(a,b);o3djs.dump.dump(b+"  --Params--\n");o3djs.dump.dumpParams(a,b+"  ")};o3djs.dump.dumpRenderNodeTree=function(a,b){b=b||"";o3djs.dump.dumpRenderNode(a,b);for(var c=b+"    ",d=a.children.sort(function(f,g){return f.priority-g.priority}),e=0;e<d.length;e++)o3djs.dump.dumpRenderNodeTree(d[e],c)};
o3djs.dump.dumpStackTrace=function(){o3djs.dump.dump("Stack trace:\n");for(var a=arguments.callee.caller;a;){o3djs.dump.dump(o3djs.dump.getSignature_(a)+"\n");a=a.caller}o3djs.dump.dump("\n\n")};o3djs.provide("o3djs.effect");o3djs.require("o3djs.io");o3djs.effect=o3djs.effect||{};o3djs.effect.TWO_COLOR_CHECKER_EFFECT_NAME="o3djs.effect.twoColorCheckerEffect";
o3djs.effect.o3d={LANGUAGE:"o3d",FLOAT2:"float2",FLOAT3:"float3",FLOAT4:"float4",MATRIX4:"float4x4",MATRIX3:"float3x3",MOD:"fmod",ATTRIBUTE:"  ",ATTRIBUTE_PREFIX:"input.",VARYING:"  ",VARYING_DECLARATION_PREFIX:"",VERTEX_VARYING_PREFIX:"output.",PIXEL_VARYING_PREFIX:"input.",TEXTURE:"tex",SAMPLER:"sampler",BEGIN_IN_STRUCT:"struct InVertex {\n",BEGIN_OUT_STRUCT:"struct OutVertex {\n",END_STRUCT:"};\n"};
o3djs.effect.glsl={LANGUAGE:"glsl",FLOAT2:"vec2",FLOAT3:"vec3",FLOAT4:"vec4",MATRIX4:"mat4",MATRIX3:"mat3",MOD:"mod",ATTRIBUTE:"attribute ",ATTRIBUTE_PREFIX:"",VARYING:"varying ",VARYING_DECLARATION_PREFIX:"v_",VERTEX_VARYING_PREFIX:"v_",PIXEL_VARYING_PREFIX:"v_",TEXTURE:"texture",SAMPLER:"sampler2D",BEGIN_IN_STRUCT:"",BEGIN_OUT_STRUCT:"",END_STRUCT:"",semanticNameMap:{POSITION:"position",NORMAL:"normal",TANGENT:"tangent",BINORMAL:"binormal",COLOR:"color",TEXCOORD0:"texCoord0",TEXCOORD1:"texCoord1",
TEXCOORD2:"texCoord2",TEXCOORD3:"texCoord3",TEXCOORD4:"texCoord4",TEXCOORD5:"texCoord5",TEXCOORD6:"texCoord6",TEXCOORD7:"texCoord7"}};o3djs.effect.glsl.semanticSuffix=function(){return""};o3djs.effect.o3d.semanticSuffix=function(a){return" : "+a};o3djs.effect.glsl.getAttributeName_=function(a,b){return o3djs.effect.semanticNameMap[b]};o3djs.effect.o3d.getAttributeName_=function(a){return a};o3djs.effect.glsl.mul=function(a,b){return"("+b+" * "+a+")"};
o3djs.effect.o3d.mul=function(a,b){return"mul("+a+", "+b+")"};o3djs.effect.glsl.utilityFunctions=function(){return"vec4 lit(float l ,float h, float m) {\n  return vec4(1.0,\n              max(l, 0.0),\n              (l > 0.0) ? pow(max(0.0, h), m) : 0.0,\n              1.0);\n}\n"};o3djs.effect.o3d.utilityFunctions=function(){return""};o3djs.effect.glsl.beginVertexShaderMain=function(){return"void main() {\n"};o3djs.effect.o3d.beginVertexShaderMain=function(){return"OutVertex vertexShaderFunction(InVertex input) {\n  OutVertex output;\n"};
o3djs.effect.glsl.endVertexShaderMain=function(){return"  gl_Position = "+o3djs.effect.VERTEX_VARYING_PREFIX+"position;\n}\n"};o3djs.effect.o3d.endVertexShaderMain=function(){return"  return output;\n}\n"};o3djs.effect.glsl.pixelShaderHeader=function(){return"\n// #o3d SplitMarker\n"};o3djs.effect.o3d.pixelShaderHeader=function(){return""};o3djs.effect.glsl.repeatVaryingDecls=function(a){return(a||o3djs.effect.varying_decls_||o3djs.buildVaryingDecls())+"\n"};o3djs.effect.o3d.repeatVaryingDecls=function(){return""};
o3djs.effect.glsl.beginPixelShaderMain=function(){return"void main() {\n"};o3djs.effect.o3d.beginPixelShaderMain=function(){return"float4 pixelShaderFunction(OutVertex input) : COLOR {\n"};o3djs.effect.o3d.endPixelShaderMain=function(a){return"  return "+a+";\n}\n"};o3djs.effect.glsl.endPixelShaderMain=function(a){return"  gl_FragColor = "+a+";\n}\n"};o3djs.effect.o3d.entryPoints=function(){return"// #o3d VertexShaderEntryPoint vertexShaderFunction\n// #o3d PixelShaderEntryPoint pixelShaderFunction\n"};
o3djs.effect.glsl.entryPoints=function(){return""};o3djs.effect.glsl.matrixLoadOrder=o3djs.effect.o3d.matrixLoadOrder=function(){return"// #o3d MatrixLoadOrder RowMajor\n"};o3djs.effect.setLanguage=function(a){var b=o3djs.effect.o3d;if(a=="glsl")b=o3djs.effect.glsl;for(var c in o3djs.effect.glsl)o3djs.effect[c]=b[c];o3djs.effect.TWO_COLOR_CHECKER_FXSTRING=o3djs.effect.buildCheckerShaderString()};o3djs.effect.getLanguage=function(){if(language_namespace==o3djs.effect.glsl)return"glsl";return"o3d"};
o3djs.effect.buildAttributeDecls=function(a,b,c,d){var e=o3djs.effect.BEGIN_IN_STRUCT+o3djs.effect.ATTRIBUTE+o3djs.effect.FLOAT4+" position"+o3djs.effect.semanticSuffix("POSITION")+";\n";if(b||c)e+=o3djs.effect.ATTRIBUTE+o3djs.effect.FLOAT3+" normal"+o3djs.effect.semanticSuffix("NORMAL")+";\n";e+=o3djs.effect.buildTexCoords(a,false)+o3djs.effect.buildBumpInputCoords(d)+o3djs.effect.END_STRUCT;return e};o3djs.effect.varying_decls_="";
o3djs.effect.buildVaryingDecls=function(a,b,c,d){var e=o3djs.effect;a=e.BEGIN_OUT_STRUCT+e.VARYING+e.FLOAT4+" "+e.VARYING_DECLARATION_PREFIX+"position"+e.semanticSuffix("POSITION")+";\n"+e.buildTexCoords(a,true)+e.buildBumpOutputCoords(d);if(b||c)a+=e.VARYING+e.FLOAT3+" "+e.VARYING_DECLARATION_PREFIX+"normal"+e.semanticSuffix("TEXCOORD"+e.interpolant_++ +"")+";\n"+e.VARYING+e.FLOAT3+" "+e.VARYING_DECLARATION_PREFIX+"surfaceToLight"+e.semanticSuffix("TEXCOORD"+e.interpolant_++ +"")+";\n";if(c)a+=e.VARYING+
e.FLOAT3+" "+e.VARYING_DECLARATION_PREFIX+"surfaceToView"+e.semanticSuffix("TEXCOORD"+e.interpolant_++ +"")+";\n";a+=e.END_STRUCT;return e.varying_decls_=a};o3djs.effect.interpolant_=0;
o3djs.effect.buildTexCoord=function(a,b,c){var d=o3djs.effect;if(a.getParam(c+"Sampler"))if(b)return"  "+d.VARYING+d.FLOAT2+" "+d.VARYING_DECLARATION_PREFIX+c+"UV"+d.semanticSuffix("TEXCOORD"+d.interpolant_++ +"")+";\n";else{a=c+"UV";b="TEXCOORD"+d.interpolant_++;c=d.getAttributeName_(a,b);if(d.semanticNameMap)d.nameToSemanticMap_[a]=b;return"  "+d.ATTRIBUTE+d.FLOAT2+" "+c+d.semanticSuffix(b)+";\n"}else return""};
o3djs.effect.buildTexCoords=function(a,b){var c=o3djs.effect;c.interpolant_=0;if(!b)c.nameToSemanticMap_={};return c.buildTexCoord(a,b,"emissive")+c.buildTexCoord(a,b,"ambient")+c.buildTexCoord(a,b,"diffuse")+c.buildTexCoord(a,b,"specular")};o3djs.effect.buildUVPassthrough=function(a,b){var c=o3djs.effect;if(a.getParam(b+"Sampler")){var d=b+"UV",e=d,f=c.nameToSemanticMap_[d];if(f)d=c.getAttributeName_(d,f);return"  "+c.VERTEX_VARYING_PREFIX+e+" = "+c.ATTRIBUTE_PREFIX+d+";\n"}else return""};
o3djs.effect.buildUVPassthroughs=function(a){var b=o3djs.effect;return b.buildUVPassthrough(a,"emissive")+b.buildUVPassthrough(a,"ambient")+b.buildUVPassthrough(a,"diffuse")+b.buildUVPassthrough(a,"specular")+b.buildUVPassthrough(a,"bump")};
o3djs.effect.buildBumpInputCoords=function(a){var b=o3djs.effect;return a?"  "+b.FLOAT3+" tangent"+b.semanticSuffix("TANGENT")+";\n  "+b.FLOAT3+" binormal"+b.semanticSuffix("BINORMAL")+";\n  "+b.FLOAT2+" bumpUV"+b.semanticSuffix("TEXCOORD"+b.interpolant_++)+";\n":""};
o3djs.effect.buildBumpOutputCoords=function(a){var b=o3djs.effect;return a?"  "+b.FLOAT3+" tangent"+b.semanticSuffix("TEXCOORD"+b.interpolant_++)+";\n  "+b.FLOAT3+" binormal"+b.semanticSuffix("TEXCOORD"+b.interpolant_++)+";\n  "+b.FLOAT2+" bumpUV"+b.semanticSuffix("TEXCOORD"+b.interpolant_++)+";\n":""};
o3djs.effect.buildCheckerShaderString=function(){var a=o3djs.effect,b=a.BEGIN_OUT_STRUCT+a.VARYING+a.FLOAT4+" "+a.VARYING_DECLARATION_PREFIX+"position"+a.semanticSuffix("POSITION")+";\n"+a.VARYING+a.FLOAT2+" "+a.VARYING_DECLARATION_PREFIX+"texCoord"+a.semanticSuffix("TEXCOORD0")+";\n"+a.VARYING+a.FLOAT3+" "+a.VARYING_DECLARATION_PREFIX+"normal"+a.semanticSuffix("TEXCOORD1")+";\n"+a.VARYING+a.FLOAT3+" "+a.VARYING_DECLARATION_PREFIX+"worldPosition"+a.semanticSuffix("TEXCOORD2")+";\n"+a.END_STRUCT;return"uniform "+
a.MATRIX4+" worldViewProjection"+a.semanticSuffix("WORLDVIEWPROJECTION")+";\nuniform "+a.MATRIX4+" worldInverseTranspose"+a.semanticSuffix("WORLDINVERSETRANSPOSE")+";\nuniform "+a.MATRIX4+" world"+a.semanticSuffix("WORLD")+";\n\n"+a.BEGIN_IN_STRUCT+a.ATTRIBUTE+a.FLOAT4+" position"+a.semanticSuffix("POSITION")+";\n"+a.ATTRIBUTE+a.FLOAT3+" normal"+a.semanticSuffix("NORMAL")+";\n"+a.ATTRIBUTE+a.FLOAT2+" texCoord0"+a.semanticSuffix("TEXCOORD0")+";\n"+a.END_STRUCT+"\n"+b+"\n"+a.beginVertexShaderMain()+
"  "+a.VERTEX_VARYING_PREFIX+"position = "+a.mul(a.ATTRIBUTE_PREFIX+"position","worldViewProjection")+";\n  "+a.VERTEX_VARYING_PREFIX+"normal = "+a.mul(a.FLOAT4+"("+a.ATTRIBUTE_PREFIX+"normal, 0.0)","worldInverseTranspose")+".xyz;\n  "+a.VERTEX_VARYING_PREFIX+"worldPosition = "+a.mul(a.ATTRIBUTE_PREFIX+"position","world")+".xyz;\n  "+a.VERTEX_VARYING_PREFIX+"texCoord = "+a.ATTRIBUTE_PREFIX+"texCoord0;\n"+a.endVertexShaderMain()+"\n"+a.pixelShaderHeader()+"uniform "+a.FLOAT4+" color1;\nuniform "+a.FLOAT4+
" color2;\nuniform float checkSize;\nuniform "+a.FLOAT3+" lightWorldPos;\nuniform "+a.FLOAT3+" lightColor;\n\n"+a.repeatVaryingDecls(b)+a.FLOAT4+" checker("+a.FLOAT2+" uv) {\n  float fmodResult = "+a.MOD+"(    floor(checkSize * uv.x) + \n    floor(checkSize * uv.y), 2.0);\n  return (fmodResult < 1.0) ? color1 : color2;\n}\n\n"+a.beginPixelShaderMain()+"  "+a.FLOAT3+" surfaceToLight = \n      normalize(lightWorldPos - "+a.PIXEL_VARYING_PREFIX+"worldPosition);\n  "+a.FLOAT3+" worldNormal = normalize("+
a.PIXEL_VARYING_PREFIX+"normal);\n  "+a.FLOAT4+" check = checker("+a.PIXEL_VARYING_PREFIX+"texCoord);\n  float directionalIntensity = \n      clamp(dot(worldNormal, surfaceToLight), 0.0, 1.0);\n  "+a.FLOAT4+" outColor = directionalIntensity * check;\n"+a.endPixelShaderMain(a.FLOAT4+"(outColor.rgb, check.a)")+"\n"+a.entryPoints()+a.matrixLoadOrder()};o3djs.effect.COLLADA_LIGHTING_TYPE_PARAM_NAME="collada.lightingType";o3djs.effect.COLLADA_LIGHTING_TYPES={phong:1,lambert:1,blinn:1,constant:1};
o3djs.effect.COLLADA_SAMPLER_PARAMETER_PREFIXES=["emissive","ambient","diffuse","specular","bump"];o3djs.effect.isColladaLightingType=function(a){return o3djs.effect.COLLADA_LIGHTING_TYPES[a.toLowerCase()]==1};o3djs.effect.getColladaLightingType=function(a){if(a=a.getParam(o3djs.effect.COLLADA_LIGHTING_TYPE_PARAM_NAME)){a=a.value.toLowerCase();if(o3djs.effect.isColladaLightingType(a))return a}return""};
o3djs.effect.getNumTexCoordStreamsNeeded=function(a){var b=o3djs.effect,c=b.getColladaLightingType(a);if(!b.isColladaLightingType(c))throw"not a collada standard material";b=b.COLLADA_SAMPLER_PARAMETER_PREFIXES;for(var d=c=0;d<b.length;++d)a.getParam(b[d]+"Sampler")&&++c;return c};o3djs.effect.loadEffect=function(a,b){var c=o3djs.io.loadTextFileSynchronous(b);a.loadFromFXString(c)};
o3djs.effect.createEffectFromFile=function(a,b){var c=o3djs.effect,d=a.getObjects(b,"o3d.Effect")[0];if(!d){d=a.createObject("Effect");c.loadEffect(d,b);d.name=b}return d};
o3djs.effect.buildStandardShaderString=function(a,b){var c=o3djs.effect,d=a.getParam("bumpSampler"),e=function(s){s=s.value;if(!s)return"2D";switch(s.className){case "o3d.Texture1D":return"1D";case "o3d.Texture2D":return"2D";case "o3d.Texture3D":return"3D";case "o3d.TextureCUBE":return"CUBE";default:return"2D"}},f=function(s){s=s.value;if(!s)return"2D";return(s=s.getParam("Texture"))?e(s):"2D"},g=function(){return"uniform "+c.MATRIX4+" worldViewProjection"+c.semanticSuffix("WORLDVIEWPROJECTION")+
";\nuniform "+c.FLOAT3+" lightWorldPos;\n"},h=function(){return"uniform "+c.FLOAT4+" lightColor;\n"},j=function(){return"uniform "+c.MATRIX4+" world"+c.semanticSuffix("WORLD")+";\nuniform "+c.MATRIX4+" viewInverse"+c.semanticSuffix("VIEWINVERSE")+";\nuniform "+c.MATRIX4+" worldInverseTranspose"+c.semanticSuffix("WORLDINVERSETRANSPOSE")+";\n"},i=function(s,v,A,B){if(B===undefined)B=true;if(s=s.getParam(A+"Sampler")){B=f(s);v.push(A+B+"Texture");return"uniform sampler"+B+" "+A+"Sampler;\n"}else if(B){v.push(A+
"Color");return"uniform "+c.FLOAT4+" "+A+";\n"}else return""},k=function(s,v){var A=s.getParam(v+"Sampler");if(A){A=f(A);return"  "+c.FLOAT4+" "+v+" = "+c.TEXTURE+A+"("+v+"Sampler, "+c.PIXEL_VARYING_PREFIX+v+"UV);\n"}else return""},l=function(s,v){v.push("constant");return g()+w(s,false,false)+c.beginVertexShaderMain()+o()+c.buildUVPassthroughs(s)+c.endVertexShaderMain()+c.pixelShaderHeader(s,false,false,d)+h()+c.repeatVaryingDecls()+i(s,v,"emissive")+c.beginPixelShaderMain()+k(s,"emissive")+c.endPixelShaderMain("emissive")+
c.entryPoints()+c.matrixLoadOrder()},m=function(s,v){v.push("lambert");return g()+j()+w(s,true,false)+c.beginVertexShaderMain()+c.buildUVPassthroughs(s)+o()+q()+p()+u()+c.endVertexShaderMain()+c.pixelShaderHeader(s,true,false)+h()+c.repeatVaryingDecls()+i(s,v,"emissive")+i(s,v,"ambient")+i(s,v,"diffuse")+i(s,v,"bump",false)+c.utilityFunctions()+c.beginPixelShaderMain()+k(s,"emissive")+k(s,"ambient")+k(s,"diffuse")+x()+"  "+c.FLOAT3+" surfaceToLight = normalize("+c.PIXEL_VARYING_PREFIX+"surfaceToLight);\n  "+
c.FLOAT4+" litR = lit(dot(normal, surfaceToLight), 0.0, 0.0);\n"+c.endPixelShaderMain(c.FLOAT4+"((emissive +\n      lightColor * (ambient * diffuse + diffuse * litR.y)).rgb,\n          diffuse.a)")+c.entryPoints()+c.matrixLoadOrder()},n=function(s,v){v.push("phong");return g()+j()+w(s,true,true)+c.beginVertexShaderMain()+c.buildUVPassthroughs(s)+o()+q()+p()+t()+u()+c.endVertexShaderMain()+c.pixelShaderHeader(s,true,true)+h()+c.repeatVaryingDecls()+i(s,v,"emissive")+i(s,v,"ambient")+i(s,v,"diffuse")+
i(s,v,"specular")+i(s,v,"bump",false)+"uniform float shininess;\nuniform float specularFactor;\n"+c.utilityFunctions()+c.beginPixelShaderMain()+k(s,"emissive")+k(s,"ambient")+k(s,"diffuse")+k(s,"specular")+x()+"  "+c.FLOAT3+" surfaceToLight = normalize("+c.PIXEL_VARYING_PREFIX+"surfaceToLight);\n  "+c.FLOAT3+" surfaceToView = normalize("+c.PIXEL_VARYING_PREFIX+"surfaceToView);\n  "+c.FLOAT3+" halfVector = normalize(surfaceToLight + "+c.PIXEL_VARYING_PREFIX+"surfaceToView);\n  "+c.FLOAT4+" litR = lit(dot(normal, surfaceToLight), \n                    dot(normal, halfVector), shininess);\n"+
c.endPixelShaderMain(c.FLOAT4+"((emissive +\n  lightColor * (ambient * diffuse + diffuse * litR.y +\n                        + specular * litR.z * specularFactor)).rgb,\n      diffuse.a)")+c.entryPoints()+c.matrixLoadOrder()},r=function(s,v){v.push("phong");return g()+j()+w(s,true,true)+c.beginVertexShaderMain()+c.buildUVPassthroughs(s)+o()+q()+p()+t()+u()+c.endVertexShaderMain()+c.pixelShaderHeader(s,true,true)+h()+c.repeatVaryingDecls()+i(s,v,"emissive")+i(s,v,"ambient")+i(s,v,"diffuse")+i(s,v,
"specular")+i(s,v,"bump",false)+"uniform float shininess;\nuniform float specularFactor;\n"+c.utilityFunctions()+c.beginPixelShaderMain()+k(s,"emissive")+k(s,"ambient")+k(s,"diffuse")+k(s,"specular")+x()+"  "+c.FLOAT3+" surfaceToLight = normalize("+c.PIXEL_VARYING_PREFIX+"surfaceToLight);\n  "+c.FLOAT3+" surfaceToView = normalize("+c.PIXEL_VARYING_PREFIX+"surfaceToView);\n  "+c.FLOAT3+" halfVector = normalize(surfaceToLight + surfaceToView);\n  "+c.FLOAT4+" litR = lit(dot(normal, surfaceToLight), \n                    dot(normal, halfVector), shininess);\n"+
c.endPixelShaderMain(c.FLOAT4+"((emissive +\n  lightColor * (ambient * diffuse + diffuse * litR.y +\n                        + specular * litR.z * specularFactor)).rgb,\n      diffuse.a)")+c.entryPoints()+c.matrixLoadOrder()},o=function(){return"  "+c.VERTEX_VARYING_PREFIX+"position = "+c.mul(c.ATTRIBUTE_PREFIX+"position","worldViewProjection")+";\n"},q=function(){return"  "+c.VERTEX_VARYING_PREFIX+"normal = "+c.mul(c.FLOAT4+"("+c.ATTRIBUTE_PREFIX+"normal, 0)","worldInverseTranspose")+".xyz;\n"},
p=function(){return"  "+c.VERTEX_VARYING_PREFIX+"surfaceToLight = lightWorldPos - \n                          "+c.mul(c.ATTRIBUTE_PREFIX+"position","world")+".xyz;\n"},t=function(){return"  "+c.VERTEX_VARYING_PREFIX+"surfaceToView = (viewInverse[3] - "+c.mul(c.ATTRIBUTE_PREFIX+"position","world")+").xyz;\n"},u=function(){return d?"  "+c.VERTEX_VARYING_PREFIX+"binormal = "+c.mul(c.FLOAT4+"("+c.ATTRIBUTE_PREFIX+"binormal, 0)","worldInverseTranspose")+".xyz;\n  "+c.VERTEX_VARYING_PREFIX+"tangent = "+
c.mul(c.FLOAT4+"("+c.ATTRIBUTE_PREFIX+"tangent, 0)","worldInverseTranspose")+".xyz;\n":""},x=function(){return d?c.MATRIX3+" tangentToWorld = "+c.MATRIX3+"("+c.ATTRIBUTE_PREFIX+"tangent,\n                                   "+c.ATTRIBUTE_PREFIX+"binormal,\n                                   "+c.ATTRIBUTE_PREFIX+"normal);\n"+c.FLOAT3+" tangentNormal = "+c.TEXTURE+"2D(bumpSampler, "+c.ATTRIBUTE_PREFIX+"bumpUV.xy).xyz -\n                       "+c.FLOAT3+"(0.5, 0.5, 0.5);\n"+c.FLOAT3+" normal = "+c.mul("tangentNormal",
"tangentToWorld")+";\nnormal = normalize("+c.PIXEL_VARYING_PREFIX+"normal);\n":"  "+c.FLOAT3+" normal = normalize("+c.PIXEL_VARYING_PREFIX+"normal);\n"},w=function(s,v,A){return c.buildAttributeDecls(s,v,A,d)+c.buildVaryingDecls(s,v,A,d)},y=[];if(b=="phong")l=r(a,y);else if(b=="lambert")l=m(a,y);else if(b=="blinn")l=n(a,y);else if(b=="constant")l=l(a,y);else throw'unknown effect type "'+b+'"';return{description:y.join("_"),shader:l}};
o3djs.effect.getStandardShader=function(a,b,c){b=o3djs.effect.buildStandardShaderString(b,c);c=a.getObjectsByClassName("o3d.Effect");for(var d=0;d<c.length;++d)if(c[d].name==b.description&&c[d].source==b.shader)return c[d];if(c=a.createObject("Effect")){c.name=b.description;if(c.loadFromFXString(b.shader))return c;a.removeObject(c)}return null};
o3djs.effect.attachStandardShader=function(a,b,c,d){if(a=o3djs.effect.getStandardShader(a,b,d)){b.effect=a;a.createUniformParameters(b);if((a=b.getParam("lightWorldPos"))&&!a.inputConnection)a.value=c;if((a=b.getParam("lightColor"))&&!a.inputConnection)a.value=[1,1,1,1];return true}else return false};
o3djs.effect.createUniformParameters=function(a,b,c){b.createUniformParameters(c);b=b.getParameterInfo();for(var d=0;d<b.length;++d){var e=b[d];if(e.sasClassName.length==0)if(e.numElements>0){var f=a.createObject("ParamArray"),g=c.getParam(e.name);g.value=f;f.resize(e.numElements,e.className);if(e.className=="o3d.ParamSampler")for(g=0;g<e.numElements;++g){var h=a.createObject("Sampler");f.getParam(g).value=h}}else if(e.className=="o3d.ParamSampler"){h=a.createObject("Sampler");g=c.getParam(e.name);
g.value=h}}};o3djs.effect.createCheckerEffect=function(a){var b=a.getObjects(o3djs.effect.TWO_COLOR_CHECKER_EFFECT_NAME,"o3d.Effect");if(b.length>0)return b[0];a=a.createObject("Effect");a.loadFromFXString(o3djs.effect.TWO_COLOR_CHECKER_FXSTRING);a.name=o3djs.effect.TWO_COLOR_CHECKER_EFFECT_NAME;return a};o3djs.effect.setLanguage("o3d");o3djs.provide("o3djs.element");o3djs.require("o3djs.math");o3djs.element=o3djs.element||{};
o3djs.element.setBoundingBoxAndZSortPoint=function(a){var b=a.getBoundingBox(0),c=b.minExtent,d=b.maxExtent;a.boundingBox=b;a.cull=true;a.zSortPoint=o3djs.math.divVectorScalar(o3djs.math.addVector(c,d),2)};
o3djs.element.addMissingTexCoordStreams=function(a){if(a.isAClassName("o3d.Primitive")){var b=a.material;a=a.streamBank;if(o3djs.effect.getColladaLightingType(b)){b=o3djs.effect.getNumTexCoordStreamsNeeded(b);for(var c=a.vertexStreams,d=null,e=0,f=0;f<c.length;++f){var g=c[f];if(g.semantic==o3djs.base.o3d.Stream.TEXCOORD){d=g;++e}}for(f=e;f<b;++f)a.setVertexStream(d.semantic,d.semanticIndex+f-e+1,d.field,d.startIndex)}}};
o3djs.element.duplicateElement=function(a,b){var c=a.createObject(b.className);c.copyParams(b);if(b.isAClassName("o3d.Primitive")){c.indexBuffer=b.indexBuffer;c.startIndex=b.startIndex;c.primitiveType=b.primitiveType;c.numberVertices=b.numberVertices;c.numberPrimitives=b.numberPrimitives}return c};
o3djs.element.getNormalForTriangle=function(a,b,c){var d=a.primitiveType;if(d!=o3djs.base.o3d.Primitive.TRIANGLELIST&&d!=o3djs.base.o3d.Primitive.TRIANGLESTRIP)throw"primitive is not a TRIANGLELIST or TRIANGLESTRIP";var e=a.indexBuffer;b=d==o3djs.base.o3d.Primitive.TRIANGLELIST?b*3:b+2;e=e?e.fields[0].getAt(b,3):[b,b+1,b+2];if(b=a.streamBank.getVertexStream(o3djs.base.o3d.Stream.NORMAL,0)){c=b.field;b=[0,0,0];for(a=0;a<3;++a){d=c.getAt(e[a],1);b=o3djs.math.addVector(b,d)}return o3djs.math.normalize(b)}else{a=
a.streamBank.getVertexStream(o3djs.base.o3d.Stream.POSITION,0);if(!a)throw"no POSITION,0 stream in primitive";d=a.field;b=[];for(a=0;a<3;++a)b[a]=d.getAt(e[a],1);e=o3djs.math.normalize(o3djs.math.subVector(b[1],b[0]));a=o3djs.math.normalize(o3djs.math.subVector(b[2],b[1]));return c?o3djs.math.cross(a,e):o3djs.math.cross(e,a)}};o3djs.provide("o3djs.error");o3djs.error=o3djs.error||{};o3djs.error.callbacks_=[];
o3djs.error.setErrorHandler=function(a,b){var c=a.clientId,d=o3djs.error.callbacks_[c];(o3djs.error.callbacks_[c]=b)?a.setErrorCallback(b):a.clearErrorCallback();return d};o3djs.error.setDefaultErrorHandler=function(a){o3djs.error.setErrorHandler(a,function(b){o3djs.error.setErrorHandler(a,null);alert("ERROR: "+b)})};o3djs.error.createErrorCollector=function(a){return new o3djs.error.ErrorCollector(a)};
o3djs.error.ErrorCollector=function(a){var b=this;this.client_=a;this.errors=[];this.oldCallback_=o3djs.error.setErrorHandler(a,function(c){b.errors.push(c)})};o3djs.error.ErrorCollector.prototype.finish=function(){o3djs.error.setErrorHandler(this.client_,this.oldCallback_)};o3djs.provide("o3djs.event");o3djs.event=o3djs.event||{};o3djs.event.appendWithSpace=function(a,b){return a.length==0?b:a+" "+b};o3djs.event.appendWithSpaceIf=function(a,b,c){return a?o3djs.event.appendWithSpace(b,c):b};
o3djs.event.getModifierString=function(a,b,c,d){a=o3djs.event.appendWithSpaceIf(a,"","Control");a=o3djs.event.appendWithSpaceIf(b,a,"Alt");a=o3djs.event.appendWithSpaceIf(c,a,"Shift");return o3djs.event.appendWithSpaceIf(d,a,"Meta")};o3djs.event.padWithLeadingZeroes=function(a,b){for(;a.length<b;)a="0"+a;return a};
o3djs.event.getKeyIdentifier=function(a,b){a||(a=b);switch(a){case 3:case 13:return"Enter";case 37:return"Left";case 39:return"Right";case 38:return"Up";case 40:return"Down"}var c=(a>=97&&a<=122?a-32:a).toString(16).toUpperCase();return"U+"+o3djs.event.padWithLeadingZeroes(c,4)};
o3djs.event.keyIdentifierToChar=function(a){if(a&&typeof a=="string"){switch(a){case "Enter":return 13;case "Left":return 37;case "Right":return 39;case "Up":return 38;case "Down":return 40}if(a.indexOf("U+")==0)return parseInt(a.substr(2).toUpperCase(),16)}return 0};o3djs.event.getEventKeyChar=function(a){if(!a)a=window.event;var b=0;if(a.keyIdentifier)b=o3djs.event.keyIdentifierToChar(a.keyIdentifier);b||(b=window.event?window.event.keyCode:a.charCode);if(!b)b=a.keyCode;return b};
o3djs.event.cancel=function(a){if(!a)a=window.event;a.cancelBubble=true;a.stopPropagation&&a.stopPropagation();a.preventDefault&&a.preventDefault()};o3djs.event.startKeyboardEventSynthesis=function(a){var b=function(c){o3djs.event.onKey(c,a)};o3djs.event.addEventListener(a,"keypress",b);o3djs.event.addEventListener(a,"keydown",b);o3djs.event.addEventListener(a,"keyup",b)};
o3djs.event.onKey=function(a,b){var c=o3djs.event.createKeyEvent(a.type,a.charCode,a.keyCode,a.ctrlKey,a.altKey,a.shiftKey,a.metaKey);if(c)if(b.parentNode.dispatchEvent)b.parentNode.dispatchEvent(c);else b.fireEvent&&b.fireEvent("on"+a.type,c)};
o3djs.event.createKeyEvent=function(a,b,c,d,e,f,g){var h,j=o3djs.event.getKeyIdentifier(b,c);if(document.createEvent){h=document.createEvent("KeyboardEvent");if(h.initKeyboardEvent){h.initKeyboardEvent(a,true,true,window,j,0,d,e,f,g);h.charCode=b;h.keyCode=a=="keypress"?b:c}else if(h.initKeyEvent){h.initKeyEvent(a,true,true,window,d,e,f,g,c,b);h.keyIdentifier=j}}else if(document.createEventObject){h=document.createEventObject();h.ctrlKey=d;h.altKey=e;h.shiftKey=f;h.metaKey=g;h.keyCode=b;h.keyIdentifier=
j}h.synthetic=true;return h};o3djs.event.createEventHandler=function(a){return function(b){for(var c=a.length,d=0;d<c;++d){var e=a[d];typeof e.handleEvent=="function"?e.handleEvent(b):e(b)}}};
o3djs.event.addEventListener=function(a,b,c){if(!c||typeof b!="string"||typeof c!="function"&&typeof c.handleEvent!="function")throw Error("Invalid argument.");a.o3d_eventRegistry=a.o3d_eventRegistry||[];var d=a.o3d_eventRegistry,e=d[b];if(!e||e.length==0){e=d[b]=[];a.client.setEventCallback(b,o3djs.event.createEventHandler(e))}else for(var f in e)if(e[f]==c)return;e.push(c)};
o3djs.event.removeEventListener=function(a,b,c){var d=a.o3d_eventRegistry;if(d)if(d=d[b])for(var e in d)if(d[e]==c){d.length==1&&a.client.clearEventCallback(b);d.splice(e,1);break}};o3djs.provide("o3djs.fps");o3djs.require("o3djs.rendergraph");o3djs.require("o3djs.canvas");o3djs.require("o3djs.effect");o3djs.require("o3djs.math");o3djs.require("o3djs.primitives");o3djs.fps=o3djs.fps||{};o3djs.fps.NUM_FRAMES_TO_AVERAGE=16;
o3djs.fps.PERF_BAR_COLORS=[[0,0,1,1],[0,1,0,1],[1,1,0,1],[1,0.5,0,1],[1,0,0,1]];
o3djs.fps.buildShaderString=function(){var a=o3djs.effect,b=a.BEGIN_OUT_STRUCT+a.VARYING+a.FLOAT4+" "+a.VARYING_DECLARATION_PREFIX+"position"+a.semanticSuffix("POSITION")+";\n"+a.END_STRUCT;return"uniform "+a.MATRIX4+" worldViewProjection"+a.semanticSuffix("WORLDVIEWPROJECTION")+";\n\n"+a.BEGIN_IN_STRUCT+a.ATTRIBUTE+a.FLOAT4+" position"+a.semanticSuffix("POSITION")+";\n"+a.END_STRUCT+"\n"+b+"\n"+a.beginVertexShaderMain()+"  "+a.VERTEX_VARYING_PREFIX+"position = "+a.mul(a.ATTRIBUTE_PREFIX+"position",
"worldViewProjection")+";\n"+a.endVertexShaderMain()+"\n"+a.pixelShaderHeader()+"uniform "+a.FLOAT4+" color;\n"+a.repeatVaryingDecls(b)+a.beginPixelShaderMain()+a.endPixelShaderMain("color")+a.entryPoints()+a.matrixLoadOrder()};o3djs.fps.createFPSManager=function(a,b,c,d){return new o3djs.fps.FPSManager(a,b,c,d)};
o3djs.fps.FPSManager=function(a,b,c,d){this.totalActiveTime_=this.totalTime_=0;this.timeTable_=[];this.activeTimeTable_=[];for(var e=this.timeTableCursor_=0;e<o3djs.fps.NUM_FRAMES_TO_AVERAGE;++e){this.timeTable_[e]=0;this.activeTimeTable_[e]=0}this.root_=a.createObject("Transform");this.viewInfo=o3djs.rendergraph.createBasicView(a,this.root_,d);this.viewInfo.root.priority=1E5;this.viewInfo.clearBuffer.clearColorFlag=false;this.viewInfo.zOrderedState.getStateParam("CullMode").value=o3djs.base.o3d.State.CULL_NONE;
this.viewInfo.drawContext.view=o3djs.math.matrix4.lookAt([0,0,1],[0,0,0],[0,1,0]);this.canvasLib_=o3djs.canvas.create(a,this.root_,this.viewInfo);this.paint_=a.createObject("CanvasPaint");this.fpsQuad=this.canvasLib_.createXYQuad(0,0,-1,64,32,true);this.colorEffect_=a.createObject("Effect");this.colorEffect_.loadFromFXString(o3djs.fps.buildShaderString());this.colorMaterial_=a.createObject("Material");this.colorMaterial_.effect=this.colorEffect_;this.colorMaterial_.drawList=this.viewInfo.zOrderedDrawList;
this.colorEffect_.createUniformParameters(this.colorMaterial_);this.colorMaterial_.getParam("color").value=[1,1,1,1];this.colorQuadShape_=o3djs.primitives.createPlane(a,this.colorMaterial_,1,1,1,1,[[1,0,0,0],[0,0,1,0],[0,-1,0,0],[0.5,0.5,0,1]]);d=b-20;this.numPerfBars_=o3djs.fps.PERF_BAR_COLORS.length-1;this.perfBarRoot_=a.createObject("Transform");this.perfBarRoot_.parent=this.root_;this.perfBarBack_=new o3djs.fps.ColorRect(a,this.colorQuadShape_,this.perfBarRoot_,10,2,-3,d,7,[0,0,0,1]);this.perfMarker_=
[];for(e=0;e<this.numPerfBars_;++e)this.perfMarker_[e]=new o3djs.fps.ColorRect(a,this.colorQuadShape_,this.perfBarRoot_,10+d/(this.numPerfBars_+1)*(e+1),1,-1,1,9,[1,1,1,1]);this.perfBar_=new o3djs.fps.ColorRect(a,this.colorQuadShape_,this.perfBarRoot_,11,3,-2,1,5,[1,1,0,1]);this.perfBarWidth_=d-2;this.perfBarHeight_=5;this.perfBarXOffset_=10;this.perfBarYOffset_=2;this.resize(b,c);this.setPosition(10,10)};
o3djs.fps.FPSManager.prototype.setPosition=function(a,b){this.fpsQuad.transform.identity();this.fpsQuad.transform.translate(a,b,-1)};o3djs.fps.FPSManager.prototype.setVisible=function(a){this.viewInfo.root.active=a};o3djs.fps.FPSManager.prototype.setPerfVisible=function(a){this.perfBarRoot_.visible=a};
o3djs.fps.FPSManager.prototype.resize=function(a,b){this.viewInfo.drawContext.projection=o3djs.math.matrix4.orthographic(0.5,a+0.5,b+0.5,0.5,0.001,1E3);var c=a-this.perfBarXOffset_*2;this.perfBarBack_.setSize(c,this.perfBarHeight_);for(var d=0;d<this.numPerfBars_;++d)this.perfMarker_[d].setPosition(this.perfBarXOffset_+c/(this.numPerfBars_+1)*(d+1),this.perfBarYOffset_-1);this.perfBarWidth_=c-2};
o3djs.fps.FPSManager.prototype.update=function(a){var b=a.elapsedTime;a=a.activeTime;this.totalTime_+=b-this.timeTable_[this.timeTableCursor_];this.totalActiveTime_+=a-this.activeTimeTable_[this.timeTableCursor_];this.timeTable_[this.timeTableCursor_]=b;this.activeTimeTable_[this.timeTableCursor_]=a;++this.timeTableCursor_;if(this.timeTableCursor_==o3djs.fps.NUM_FRAMES_TO_AVERAGE)this.timeTableCursor_=0;b=""+Math.floor(1/(this.totalTime_/o3djs.fps.NUM_FRAMES_TO_AVERAGE)+0.5)+" : "+Math.floor(1/b+
0.5);a=this.fpsQuad.canvas;a.clear([0,0,0,0]);var c=this.paint_;a.saveMatrix();c.setOutline(3,[0,0,0,1]);c.textAlign=o3djs.base.o3d.CanvasPaint.LEFT;c.textSize=12;c.textTypeface="Arial";c.color=[1,1,0,1];a.drawText(b,2,16,c);a.restoreMatrix();this.fpsQuad.updateTexture();b=this.totalActiveTime_/o3djs.fps.NUM_FRAMES_TO_AVERAGE/(1/60);a=Math.min(b,o3djs.fps.PERF_BAR_COLORS.length-1);a=Math.floor(Math.max(a,0));if(!isNaN(a)){this.perfBar_.setColor(o3djs.fps.PERF_BAR_COLORS[a]);this.perfBar_.setSize(b*
this.perfBarWidth_/this.numPerfBars_,this.perfBarHeight_)}};o3djs.fps.ColorRect=function(a,b,c,d,e,f,g,h,j){this.transform_=a.createObject("Transform");this.colorParam_=this.transform_.createParam("color","ParamFloat4");this.transform_.addShape(b);this.transform_.parent=c;this.y_=this.x_=this.height_=this.width_=0;this.z_=f;this.setPosition(d,e);this.setSize(g,h);this.setColor(j)};
o3djs.fps.ColorRect.prototype.updateTransform_=function(){this.transform_.identity();this.transform_.translate(this.x_,this.y_,this.z_);this.transform_.scale(this.width_,this.height_,1)};o3djs.fps.ColorRect.prototype.setPosition=function(a,b){this.x_=a;this.y_=b;this.updateTransform_()};o3djs.fps.ColorRect.prototype.setSize=function(a,b){this.width_=a;this.height_=b;this.updateTransform_()};o3djs.fps.ColorRect.prototype.setColor=function(a){this.colorParam_.value=a};o3djs.provide("o3djs.gpu2d");o3djs.require("o3djs.base");
o3djs.gpu2d=o3djs.gpu2d||{};o3djs.gpu2d.createPath=function(a,b){return new o3djs.gpu2d.Path(a,b)};
o3djs.gpu2d.Path=function(a,b){this.pack_=a;this.drawList_=b;this.path_=a.createObject("ProcessedPath");var c=a.createObject("State");c.getStateParam("o3d.AlphaBlendEnable").value=true;c.getStateParam("o3d.SourceBlendFunction").value=o3djs.base.o3d.State.BLENDFUNC_SOURCE_ALPHA;c.getStateParam("o3d.DestinationBlendFunction").value=o3djs.base.o3d.State.BLENDFUNC_INVERSE_SOURCE_ALPHA;c.getStateParam("o3d.CullMode").value=o3djs.base.o3d.State.CULL_NONE;var d=a.createObject("State");d.getStateParam("o3d.CullMode").value=
o3djs.base.o3d.State.CULL_NONE;this.exteriorMaterial_=a.createObject("Material");this.exteriorMaterial_.name="ExteriorMaterial";this.exteriorMaterial_.state=c;this.exteriorMaterial_.drawList=b;this.interiorMaterial_=a.createObject("Material");this.interiorMaterial_.name="InteriorMaterial";this.interiorMaterial_.state=d;this.interiorMaterial_.drawList=b;this.shape=a.createObject("Shape");c=a.createObject("Primitive");d=a.createObject("StreamBank");var e=a.createObject("VertexBuffer"),f=e.createField("FloatField",
2);this.exteriorVertices_=f;this.exteriorTexCoords_=e=e.createField("FloatField",3);d.setVertexStream(o3djs.base.o3d.Stream.POSITION,0,f,0);d.setVertexStream(o3djs.base.o3d.Stream.TEXCOORD,0,e,0);c.streamBank=d;c.primitiveType=o3djs.base.o3d.Primitive.TRIANGLELIST;c.material=this.exteriorMaterial_;c.owner=this.shape;this.exteriorTriangles_=c;c=a.createObject("Primitive");d=a.createObject("StreamBank");e=a.createObject("VertexBuffer");this.interiorVertices_=f=e.createField("FloatField",2);d.setVertexStream(o3djs.base.o3d.Stream.POSITION,
0,f,0);c.streamBank=d;c.primitiveType=o3djs.base.o3d.Primitive.TRIANGLELIST;c.material=this.interiorMaterial_;c.owner=this.shape;this.interiorTriangles_=c;this.setFill(o3djs.gpu2d.createColor(a,0,0,0,1));this.shape.createDrawElements(a,null)};o3djs.gpu2d.Path.prototype.clear=function(){this.path_.clear()};o3djs.gpu2d.Path.prototype.moveTo=function(a,b){this.path_.moveTo(a,b)};o3djs.gpu2d.Path.prototype.lineTo=function(a,b){this.path_.lineTo(a,b)};
o3djs.gpu2d.Path.prototype.quadraticTo=function(a,b,c,d){this.path_.quadraticTo(a,b,c,d)};o3djs.gpu2d.Path.prototype.cubicTo=function(a,b,c,d,e,f){this.path_.cubicTo(a,b,c,d,e,f)};o3djs.gpu2d.Path.prototype.close=function(){this.path_.close()};
o3djs.gpu2d.Path.prototype.update=function(){this.path_.createMesh(this.exteriorVertices_,this.exteriorTexCoords_,this.interiorVertices_);var a=this.exteriorVertices_.buffer.numElements;if(a==1){this.exteriorTriangles_.numberVertices=0;this.exteriorTriangles_.numberPrimitives=0}else{this.exteriorTriangles_.numberVertices=a;this.exteriorTriangles_.numberPrimitives=a/3}a=this.interiorVertices_.buffer.numElements;if(a==1){this.interiorTriangles_.numberVertices=0;this.interiorTriangles_.numberPrimitives=
0}else{this.interiorTriangles_.numberVertices=a;this.interiorTriangles_.numberPrimitives=a/3}};o3djs.gpu2d.Path.prototype.setPolygonOffset=function(a,b){this.exteriorMaterial_.state.getStateParam("o3d.PolygonOffset1").value=a;this.exteriorMaterial_.state.getStateParam("o3d.PolygonOffset2").value=b;this.interiorMaterial_.state.getStateParam("o3d.PolygonOffset1").value=a;this.interiorMaterial_.state.getStateParam("o3d.PolygonOffset2").value=b};
o3djs.gpu2d.Path.prototype.setFill=function(a){this.fill_&&this.fill_.detach_(this);this.interiorMaterial_.effect=a.interiorEffect;this.exteriorMaterial_.effect=a.exteriorEffect;this.fill_=a;a.attach_(this)};o3djs.gpu2d.Fill=function(a){this.pack_=a;this.attachedPaths_=[]};o3djs.gpu2d.Fill.prototype.attach_=function(a){this.attachedPaths_.indexOf(a)<0&&this.attachedPaths_.push(a);this.apply_(a)};
o3djs.gpu2d.Fill.prototype.detach_=function(a){a=this.attachedPaths_.indexOf(a);a>=0&&this.attachedPaths_.splice(a,a)};o3djs.gpu2d.Fill.prototype.applyToPaths_=function(){for(var a=0;a<this.attachedPaths_.length;a++)this.apply_(this.attachedPaths_[a])};o3djs.gpu2d.Fill.prototype.apply_=function(){};
o3djs.gpu2d.Color=function(a){o3djs.gpu2d.Fill.call(this,a);this.interiorEffect=o3djs.gpu2d.loadEffect_(a,o3djs.gpu2d.FillTypes_.COLOR,true);this.exteriorEffect=o3djs.gpu2d.loadEffect_(a,o3djs.gpu2d.FillTypes_.COLOR,false);this.b_=this.g_=this.r_=0;this.a_=1};o3djs.base.inherit(o3djs.gpu2d.Color,o3djs.gpu2d.Fill);o3djs.gpu2d.Color.prototype.set=function(a,b,c,d){this.r_=a;this.g_=b;this.b_=c;this.a_=d;this.applyToPaths_()};
o3djs.gpu2d.Color.prototype.get=function(){return[this.r_,this.g_,this.b_,this.a_]};o3djs.gpu2d.Color.prototype.apply_=function(a){this.applyToMaterial_(a.interiorMaterial_);this.applyToMaterial_(a.exteriorMaterial_)};o3djs.gpu2d.Color.prototype.applyToMaterial_=function(a){var b=a.getParam("color");b||(b=a.createParam("color","ParamFloat4"));b.set(this.r_,this.g_,this.b_,this.a_)};o3djs.gpu2d.createColor=function(a,b,c,d,e){a=new o3djs.gpu2d.Color(a);a.set(b,c,d,e);return a};
o3djs.gpu2d.generateLoopBlinnShaderSource_=function(a,b,c){return o3djs.base.glsl?"// Vertex shader\nuniform mat4 worldViewProjection;\n\nattribute vec2 position;\nattribute vec3 texCoord0;\n\nvarying vec3 klm;\n\nvoid main() {\n  // TODO(kbr): figure out why this multiplication needs to be\n  // transposed compared to the Cg version.\n  gl_Position = worldViewProjection * vec4(position, 0.0, 1.0);\n  klm = texCoord0;\n}\n// #o3d SplitMarker\n// Fragment shader\nvarying vec3 klm;\n"+b+"void main() {\n"+
(a?"  // Gradients\n  vec3 px = dFdx(klm);\n  vec3 py = dFdy(klm);\n\n  // Chain rule\n  float k2 = klm.x * klm.x;\n  float c = k2 * klm.x - klm.y * klm.z;\n  float k23 = 3.0 * k2;\n  float cx = k23 * px.x - klm.z * px.y - klm.y * px.z;\n  float cy = k23 * py.x - klm.z * py.y - klm.y * py.z;\n\n  // Signed distance\n  float sd = c / sqrt(cx * cx + cy * cy);\n\n  // Linear alpha\n  // TODO(kbr): figure out why this needs to be\n  // negated compared to Cg version, and also why\n  // we need an adjustment by +1.0 for it to look good.\n  // float alpha = clamp(0.5 - sd, 0.0, 1.0);\n  float alpha = clamp(sd + 0.5, 0.0, 1.0);\n":
"  float t = klm.x * klm.x * klm.x - klm.y * klm.z;\n  float alpha = clamp(sign(t), 0.0, 1.0);\n")+"\n"+c+"}\n\n// #o3d MatrixLoadOrder RowMajor\n":"uniform float4x4 worldViewProjection : WORLDVIEWPROJECTION;\n"+b+"\nstruct VertexShaderInput {\n  float2 position : POSITION;\n  float3 klm : TEXCOORD0;\n};\n\nstruct PixelShaderInput {\n  float4 position : POSITION;\n  float3 klm : TEXCOORD0;\n};\n\nPixelShaderInput vertexShaderFunction(VertexShaderInput input) {\n  PixelShaderInput output;\n\n  output.position = mul(float4(input.position, 0, 1),\n                        worldViewProjection);\n  output.klm = input.klm;\n  return output;\n}\n\nfloat4 pixelShaderFunction(PixelShaderInput input) : COLOR {\n  float3 klm = input.klm;\n  float t = klm.x * klm.x * klm.x - klm.y * klm.z;\n  float alpha = clamp(sign(t), 0.0, 1.0);\n\n"+
c+"}\n\n// #o3d VertexShaderEntryPoint vertexShaderFunction\n// #o3d PixelShaderEntryPoint pixelShaderFunction\n// #o3d MatrixLoadOrder RowMajor\n"};
o3djs.gpu2d.generateSolidShaderSource_=function(a,b){return o3djs.base.glsl?"// Vertex shader\nuniform mat4 worldViewProjection;\n\nattribute vec2 position;\n\nvoid main() {\n  // TODO(kbr): figure out why this multiplication needs to be\n  // transposed compared to the Cg version.\n  gl_Position = worldViewProjection * vec4(position, 0.0, 1.0);\n}\n// #o3d SplitMarker\n// Fragment shader\n"+a+"void main() {\n  float alpha = 1.0;\n"+b+"}\n\n// #o3d MatrixLoadOrder RowMajor\n":"uniform float4x4 worldViewProjection : WORLDVIEWPROJECTION;\n"+
a+"\nstruct VertexShaderInput {\n  float2 position : POSITION;\n};\n\nstruct PixelShaderInput {\n  float4 position : POSITION;\n};\n\nPixelShaderInput vertexShaderFunction(VertexShaderInput input) {\n  PixelShaderInput output;\n\n  output.position = mul(float4(input.position, 0, 1),\n                        worldViewProjection);\n  return output;\n}\n\nfloat4 pixelShaderFunction(PixelShaderInput input) : COLOR {\n  float alpha = 1.0;\n"+b+"}\n\n// #o3d VertexShaderEntryPoint vertexShaderFunction\n// #o3d PixelShaderEntryPoint pixelShaderFunction\n// #o3d MatrixLoadOrder RowMajor\n"};
o3djs.gpu2d.FillTypes_={COLOR:0};o3djs.gpu2d.FILL_CODE_CG_=[{uniforms:"uniform float4 color;\n",source:"return float4(color.r, color.g, color.b, color.a * alpha);\n"}];o3djs.gpu2d.FILL_CODE_GLSL_=[{uniforms:"uniform vec4 color;\n",source:"gl_FragColor = vec4(color.r, color.g, color.b, color.a * alpha);\n"}];o3djs.gpu2d.interiorEffectCache_=[];o3djs.gpu2d.exteriorEffectCache_=[];
o3djs.gpu2d.loadEffect_=function(a,b,c){var d=o3djs.gpu2d.getEffectList_(a,c?o3djs.gpu2d.interiorEffectCache_:o3djs.gpu2d.exteriorEffectCache_),e=d[b];if(!e){e=a.createObject("Effect");a=false;a=o3djs.base.glsl?o3djs.gpu2d.FILL_CODE_GLSL_[b]:o3djs.gpu2d.FILL_CODE_CG_[b];(a=c?e.loadFromFXString(o3djs.gpu2d.generateSolidShaderSource_(a.uniforms,a.source)):e.loadFromFXString(o3djs.gpu2d.generateLoopBlinnShaderSource_(true,a.uniforms,a.source)))||alert("Error loading shader: interior = "+c);d[b]=e}return e};
o3djs.gpu2d.getEffectList_=function(a,b){var c=b[a.clientId];if(!c){c=[];b[a.clientId]=c}return c};o3djs.provide("o3djs.io");o3djs.require("o3djs.texture");o3djs.io=o3djs.io||{};o3djs.io.createLoadInfo=function(a,b){return new o3djs.io.LoadInfo(a,b)};o3djs.io.LoadInfo=function(a,b){this.request_=a;this.hasStatus_=b;this.streamLength_=0;this.children_=[]};o3djs.io.LoadInfo.prototype.addChild=function(a){this.children_.push(a)};
o3djs.io.LoadInfo.prototype.finish=function(){if(this.request_){if(this.hasStatus_)this.streamLength_=this.request_.streamLength;this.request_=null}};o3djs.io.LoadInfo.prototype.getTotalKnownBytesToStreamSoFar=function(){if(!this.streamLength_&&this.request_&&this.hasStatus_)this.streamLength_=this.request_.streamLength;for(var a=this.streamLength_,b=0;b<this.children_.length;++b)a+=this.children_[b].getTotalKnownBytesToStreamSoFar();return a};
o3djs.io.LoadInfo.prototype.getTotalBytesDownloaded=function(){for(var a=this.request_&&this.hasStatus_?this.request_.bytesReceived:this.streamLength_,b=0;b<this.children_.length;++b)a+=this.children_[b].getTotalBytesDownloaded();return a};o3djs.io.LoadInfo.prototype.getTotalKnownRequestsToStreamSoFar=function(){for(var a=1,b=0;b<this.children_.length;++b)a+=this.children_[b].getTotalKnownRequestToStreamSoFar();return a};
o3djs.io.LoadInfo.prototype.getTotalRequestsDownloaded=function(){for(var a=this.request_?0:1,b=0;b<this.children_.length;++b)a+=this.children_[b].getTotalRequestsDownloaded();return a};o3djs.io.LoadInfo.prototype.getKnownProgressInfoSoFar=function(){var a=0,b=this.getTotalKnownBytesToStreamSoFar(),c=this.getTotalBytesDownloaded();if(b>0)a=Math.floor(c/b*100);var d=b<1048576?1024:1048576;return{percent:a,downloaded:(c/d).toFixed(2),totalBytes:(b/d).toFixed(2),base:d,suffix:d==1024?"kb":"mb"}};
o3djs.io.loadTextFileSynchronous=function(a){o3djs.BROWSER_ONLY=true;var b='loadTextFileSynchronous failed to load url "'+a+'"',c;if(!o3djs.base.IsMSIE()&&window.XMLHttpRequest){c=new XMLHttpRequest;c.overrideMimeType&&c.overrideMimeType("text/plain")}else if(window.ActiveXObject)c=new ActiveXObject("MSXML2.XMLHTTP.3.0");else throw"XMLHttpRequest is disabled";c.open("GET",a,false);c.send(null);if(c.readyState!=4)throw b;return c.responseText};
o3djs.io.loadTextFile=function(a,b){o3djs.BROWSER_ONLY=true;var c;if(!o3djs.base.IsMSIE()&&window.XMLHttpRequest){c=new XMLHttpRequest;c.overrideMimeType&&c.overrideMimeType("text/plain")}else if(window.ActiveXObject)c=new ActiveXObject("MSXML2.XMLHTTP.3.0");else throw"XMLHttpRequest is disabled";var d=o3djs.io.createLoadInfo(c,false);c.open("GET",a,true);c.onreadystatechange=function(){if(c.readyState==4){var e="",f=c.status==200||c.status==0;if(f)e=c.responseText;d.finish();b(e,f?null:"could not load: "+
a)}};c.send(null);return d};o3djs.io.ArchiveInfo=function(a,b,c){var d=this;this.files={};this.pack=a;this.destroyed=false;this.request_=null;this.loadInfo=o3djs.io.loadArchiveAdvanced(a,b,function(e){d.files[e.uri]=e},function(e,f){d.request_=e;c(d,f)})};o3djs.io.ArchiveInfo.prototype.destroy=function(){if(!this.destroyed){this.pack.removeObject(this.request_);this.destroyed=true;this.files={}}};
o3djs.io.ArchiveInfo.prototype.getFiles=function(a,b){if(!(a instanceof RegExp)){a=a.replace(/(\W)/g,"\\$&");a=a.replace(/\\\*/g,".*");a=a.replace(/\\\?/g,".");a=RegExp(a,b?"i":"")}var c=[],d;for(d in this.files)a.test(d)&&c.push(this.files[d]);return c};o3djs.io.ArchiveInfo.prototype.getFileByURI=function(a,b){if(b){a=a.toLowerCase();for(var c in this.files)if(c.toLowerCase()==a)return this.files[c]}else return this.files[a]};
o3djs.io.loadArchive=function(a,b,c){return(new o3djs.io.ArchiveInfo(a,b,c)).loadInfo};o3djs.io.loadArchiveAdvanced=function(a,b,c,d){var e=a.createArchiveRequest(),f=o3djs.io.createLoadInfo(e,true);e.open("GET",b);e.onfileavailable=c;e.onreadystatechange=function(){if(e.done){f.finish();var g=null;if(!e.success)(g=e.error)||(g="unknown error loading archive");d(e,g)}};e.send();return f};
o3djs.io.loadRawData=function(a,b,c){var d=a.createFileRequest("RAWDATA"),e=o3djs.io.createLoadInfo(d,false);d.open("GET",b,true);d.onreadystatechange=function(){if(d.done){var f=d.data,g=d.success,h=d.error;e.finish();if(!g&&!h)h="unknown error loading RawData: "+b;c(d,f,g?null:h)}};d.send();return e};o3djs.io.loadBitmaps=function(a,b,c,d){if(typeof d==="undefined")d=true;return o3djs.io.loadRawData(a,b,function(e,f,g){var h=[];if(!g){h=a.createBitmapsFromRawData(f);a.removeObject(e)}c(h,g)})};
o3djs.io.loadTexture=function(a,b,c,d,e){return o3djs.io.loadRawData(a,b,function(f,g,h){var j=null;if(!h){j=o3djs.texture.createTextureFromRawData(a,g,d,e);a.removeObject(f)}c(j,h)})};o3djs.provide("o3djs.primitives");o3djs.require("o3djs.math");o3djs.primitives=o3djs.primitives||{};o3djs.primitives.setCullingInfo=function(a){var b=a.getBoundingBox(0);a.boundingBox=b;a.zSortPoint=o3djs.math.divVectorScalar(o3djs.math.addVector(b.minExtent,b.maxExtent),2)};
o3djs.primitives.VertexStreamInfo=function(a,b,c){this.numComponents=a;this.semantic=b;this.semanticIndex=c||0;this.elements=[];this.addElement=function(){};this.setElement=function(){};this.addElementVector=function(){};this.setElementVector=function(){};this.getElementVector=function(){return[]};switch(a){case 1:this.addElement=function(d){this.elements.push(d)};this.getElement=function(d){return this.elements[d]};this.setElement=function(d,e){this.elements[d]=e};break;case 2:this.addElement=function(d,
e){this.elements.push(d,e)};this.addElementVector=function(d){this.elements.push(d[0],d[1])};this.getElementVector=function(d){return this.elements.slice(d*a,(d+1)*a)};this.setElement=function(d,e,f){this.elements[d*a+0]=e;this.elements[d*a+1]=f};this.setElementVector=function(d,e){this.elements[d*a+0]=e[0];this.elements[d*a+1]=e[1]};break;case 3:this.addElement=function(d,e,f){this.elements.push(d,e,f)};this.addElementVector=function(d){this.elements.push(d[0],d[1],d[2])};this.getElementVector=function(d){return this.elements.slice(d*
a,(d+1)*a)};this.setElement=function(d,e,f,g){this.elements[d*a+0]=e;this.elements[d*a+1]=f;this.elements[d*a+2]=g};this.setElementVector=function(d,e){this.elements[d*a+0]=e[0];this.elements[d*a+1]=e[1];this.elements[d*a+2]=e[2]};break;case 4:this.addElement=function(d,e,f,g){this.elements.push(d,e,f,g)};this.addElementVector=function(d){this.elements.push(d[0],d[1],d[2],d[3])};this.getElementVector=function(d){return this.elements.slice(d*a,(d+1)*a)};this.setElement=function(d,e,f,g,h){this.elements[d*
a+0]=e;this.elements[d*a+1]=f;this.elements[d*a+2]=g;this.elements[d*a+3]=h};this.setElementVector=function(d,e){this.elements[d*a+0]=e[0];this.elements[d*a+1]=e[1];this.elements[d*a+2]=e[2];this.elements[d*a+3]=e[3]};break;default:throw"A stream must contain between 1 and 4 components";}};o3djs.primitives.VertexStreamInfo.prototype.numElements=function(){return this.elements.length/this.numComponents};
o3djs.primitives.createVertexStreamInfo=function(a,b,c){return new o3djs.primitives.VertexStreamInfo(a,b,c)};o3djs.primitives.VertexInfoBase=function(){this.streams=[];this.indices=[]};o3djs.primitives.VertexInfoBase.prototype.addStream=function(a,b,c){this.removeStream(b,c);a=o3djs.primitives.createVertexStreamInfo(a,b,c);this.streams.push(a);return a};
o3djs.primitives.VertexInfoBase.prototype.findStream=function(a,b){b=b||0;for(var c=0;c<this.streams.length;++c)if(this.streams[c].semantic===a&&this.streams[c].semanticIndex==b)return this.streams[c];return null};o3djs.primitives.VertexInfoBase.prototype.removeStream=function(a,b){b=b||0;for(var c=0;c<this.streams.length;++c)if(this.streams[c].semantic===a&&this.streams[c].semanticIndex==b){this.streams.splice(c,1);break}};
o3djs.primitives.VertexInfoBase.prototype.append=function(a){if(this.streams.length==0&&a.streams.length!=0){for(var b=0;b<a.streams.length;b++){var c=a.streams[b],d=this.addStream(c.numComponents,c.semantic,c.semanticIndex);d.elements=d.elements.concat(c.elements)}this.indices=this.indices.concat(a.indices)}else{if(this.streams.length!=a.streams.length)throw"Number of VertexInfoStreams did not match";for(b=0;b<this.streams.length;b++){c=false;d=this.streams[b].semantic;for(var e=this.streams[b].numComponents,
f=this.streams[b].semanticIndex,g=0;g<a.streams.length;g++){var h=a.streams[g];if(h.semantic===d&&h.numComponents==e&&h.semanticIndex==f){c=true;break}}if(!c)throw"Did not find stream with semantic="+d+", numComponents="+e+", and semantic index="+f+" in given VertexInfo";}b=this.findStream(o3djs.base.o3d.Stream.POSITION);if(!b)throw"POSITION stream is missing";e=b.numElements();for(b=0;b<this.streams.length;b++){d=this.streams[b];c=a.findStream(d.semantic,d.semanticIndex);d.elements=d.elements.concat(c.elements)}for(b=
0;b<a.indices.length;b++)this.indices.push(a.indices[b]+e)}};
o3djs.primitives.VertexInfoBase.prototype.validate=function(){var a=this.findStream(o3djs.base.o3d.Stream.POSITION);if(!a)throw"POSITION stream is missing";a=a.numElements();for(var b=0;b<this.streams.length;++b)if(this.streams[b].numElements()!==a)throw"Stream "+b+" contains "+this.streams[b].numElements()+" elements whereas the POSITION stream contains "+a;for(b=0;b<this.indices.length;++b)if(this.indices[b]<0||this.indices[b]>=a)throw"The index "+this.indices[b]+" is out of range [0, "+a+"]";};
o3djs.primitives.VertexInfoBase.prototype.reorient=function(a){var b=o3djs.math;b.inverse(b.matrix4.getUpper3x3(a));for(var c=0;c<this.streams.length;++c){var d=this.streams[c];if(d.numComponents==3){var e=d.numElements();switch(d.semantic){case o3djs.base.o3d.Stream.POSITION:for(var f=0;f<e;++f)d.setElementVector(f,b.matrix4.transformPoint(a,d.getElementVector(f)));break;case o3djs.base.o3d.Stream.NORMAL:for(f=0;f<e;++f)d.setElementVector(f,b.matrix4.transformNormal(a,d.getElementVector(f)));break;
case o3djs.base.o3d.Stream.TANGENT:case o3djs.base.o3d.Stream.BINORMAL:for(f=0;f<e;++f)d.setElementVector(f,b.matrix4.transformDirection(a,d.getElementVector(f)))}}}};
o3djs.primitives.VertexInfoBase.prototype.createShapeByType=function(a,b,c){this.validate();var d=this.indices.length,e;switch(c){case o3djs.base.o3d.Primitive.POINTLIST:e=d/1;break;case o3djs.base.o3d.Primitive.LINELIST:e=d/2;break;case o3djs.base.o3d.Primitive.LINESTRIP:e=d-1;break;case o3djs.base.o3d.Primitive.TRIANGLELIST:e=d/3;break;case o3djs.base.o3d.Primitive.TRIANGLESTRIP:case o3djs.base.o3d.Primitive.TRIANGLEFAN:e=d-2;break;default:throw"unknown primitive type";}var f=this.findStream(o3djs.base.o3d.Stream.POSITION).numElements();
d=a.createObject("Shape");var g=a.createObject("Primitive"),h=a.createObject("StreamBank");g.owner=d;g.streamBank=h;g.material=b;g.numberPrimitives=e;g.primitiveType=c;g.numberVertices=f;g.createDrawElement(a,null);e=b.effect.getStreamInfo();for(b=0;b<e.length;++b){var j=e[b].semantic,i=e[b].semanticIndex,k=this.findStream(j,i);if(!k)switch(j){case o3djs.base.o3d.Stream.TANGENT:case o3djs.base.o3d.Stream.BINORMAL:if(c==o3djs.base.o3d.Primitive.TRIANGLELIST)this.addTangentStreams(i);else throw"Can not create tangents and binormals for primitive type"+
c;break;case o3djs.base.o3d.Stream.COLOR:k=this.addStream(4,j,i);for(j=0;j<f;++j)k.addElement(1,1,1,1);break;case o3djs.base.o3d.Stream.INFLUENCE_WEIGHTS:case o3djs.base.o3d.Stream.INFLUENCE_INDICES:break;default:throw"Missing stream for semantic "+j+" with semantic index "+i;}}c=a.createObject("VertexBuffer");e=[];for(b=0;b<this.streams.length;++b){k=this.streams[b];e[b]=c.createField(k.semantic==o3djs.base.o3d.Stream.COLOR&&k.numComponents==4?"UByteNField":"FloatField",k.numComponents);h.setVertexStream(k.semantic,
k.semanticIndex,e[b],0)}c.allocateElements(f);for(b=0;b<this.streams.length;++b)e[b].setAt(0,this.streams[b].elements);a=a.createObject("IndexBuffer");a.set(this.indices);g.indexBuffer=a;o3djs.primitives.setCullingInfo(g);return d};o3djs.primitives.VertexInfo=function(){o3djs.primitives.VertexInfoBase.call(this)};o3djs.base.inherit(o3djs.primitives.VertexInfo,o3djs.primitives.VertexInfoBase);o3djs.primitives.VertexInfo.prototype.numTriangles=function(){return this.indices.length/3};
o3djs.primitives.VertexInfo.prototype.addTriangle=function(a,b,c){this.indices.push(a,b,c)};o3djs.primitives.VertexInfo.prototype.getTriangle=function(a){a*=3;return[this.indices[a+0],this.indices[a+1],this.indices[a+2]]};o3djs.primitives.VertexInfo.prototype.setTriangle=function(a,b,c,d){a*=3;this.indices[a+0]=b;this.indices[a+1]=c;this.indices[a+2]=d};o3djs.primitives.VertexInfo.prototype.createShape=function(a,b){return this.createShapeByType(a,b,o3djs.base.o3d.Primitive.TRIANGLELIST)};
o3djs.primitives.VertexInfo.prototype.addTangentStreams=function(a){function b(t){return[Math.round(t[0]),Math.round(t[1]),Math.round(t[2])]}function c(t,u,x,w){t=b(e.mulVectorScalar(t,100))+","+b(e.mulVectorScalar(u,100));(u=j[t])||(u=[[0,0,0],[0,0,0]]);u=e.addMatrix(u,[x,w]);j[t]=u}function d(t,u){var x=b(e.mulVectorScalar(t,100))+","+b(e.mulVectorScalar(u,100));return j[x]}a=a||0;var e=o3djs.math;this.validate();var f=this.findStream(o3djs.base.o3d.Stream.POSITION);if(!f)throw"Cannot calculate tangent frame because POSITION stream is missing";
if(f.numComponents!=3)throw"Cannot calculate tangent frame because POSITION stream is not 3D";var g=this.findStream(o3djs.base.o3d.Stream.NORMAL);if(!g)throw"Cannot calculate tangent frame because NORMAL stream is missing";if(g.numComponents!=3)throw"Cannot calculate tangent frame because NORMAL stream is not 3D";var h=this.findStream(o3djs.base.o3d.Stream.TEXCOORD,a);if(!h)throw"Cannot calculate tangent frame because TEXCOORD stream "+a+" is missing";for(var j={},i=this.numTriangles(),k=0;k<i;++k){for(var l=
this.getTriangle(k),m=[],n=[],r=[],o=0;o<3;++o){var q=l[o];m[o]=h.getElementVector(q);n[o]=f.getElementVector(q);r[o]=g.getElementVector(q)}l=[0,0,0];var p=[0,0,0];for(q=0;q<3;++q){o=e.normalize(e.cross([n[1][q]-n[0][q],m[1][0]-m[0][0],m[1][1]-m[0][1]],[n[2][q]-n[0][q],m[2][0]-m[0][0],m[2][1]-m[0][1]]));if(o[0]==0)o[0]=1;l[q]=-o[1]/o[0];p[q]=-o[2]/o[0]}m=e.length(l);if(m>0.001)l=e.mulVectorScalar(l,1/m);m=e.length(p);if(m>0.001)p=e.mulVectorScalar(p,1/m);for(o=0;o<3;++o)c(n[o],r[o],l,p)}h=this.addStream(3,
o3djs.base.o3d.Stream.TANGENT,a);a=this.addStream(3,o3djs.base.o3d.Stream.BINORMAL,a);i=f.numElements();for(q=0;q<i;++q){l=f.getElementVector(q);k=g.getElementVector(q);p=d(l,k);l=p[0];l=e.subVector(l,e.mulVectorScalar(k,e.dot(k,l)));m=e.length(l);if(m>0.001)l=e.mulVectorScalar(l,1/m);p=p[1];p=e.subVector(p,e.mulVectorScalar(l,e.dot(l,p)));p=e.subVector(p,e.mulVectorScalar(k,e.dot(k,p)));m=e.length(p);if(m>0.001)p=e.mulVectorScalar(p,1/m);h.setElementVector(q,l);a.setElementVector(q,p)}};
o3djs.primitives.createVertexInfo=function(){return new o3djs.primitives.VertexInfo};
o3djs.primitives.createSphereVertices=function(a,b,c,d){if(b<=0||c<=0)throw Error("subdivisionAxis and subdivisionHeight must be > 0");for(var e=o3djs.primitives.createVertexInfo(),f=e.addStream(3,o3djs.base.o3d.Stream.POSITION),g=e.addStream(3,o3djs.base.o3d.Stream.NORMAL),h=e.addStream(2,o3djs.base.o3d.Stream.TEXCOORD,0),j=0;j<=c;j++)for(var i=0;i<=b;i++){var k=i/b,l=j/c,m=2*Math.PI*k,n=Math.PI*l,r=Math.sin(n),o=Math.cos(m)*r;n=Math.cos(n);m=Math.sin(m)*r;f.addElement(a*o,a*n,a*m);g.addElement(o,
n,m);h.addElement(1-k,1-l)}a=b+1;for(i=0;i<b;i++)for(j=0;j<c;j++){e.addTriangle((j+0)*a+i,(j+0)*a+i+1,(j+1)*a+i);e.addTriangle((j+1)*a+i,(j+0)*a+i+1,(j+1)*a+i+1)}d&&e.reorient(d);return e};o3djs.primitives.createSphere=function(a,b,c,d,e,f){return o3djs.primitives.createSphereVertices(c,d,e,f).createShape(a,b)};o3djs.primitives.CUBE_FACE_INDICES_=[[3,7,5,1],[0,4,6,2],[6,7,3,2],[0,1,5,4],[5,7,6,4],[2,3,1,0]];
o3djs.primitives.createCubeVertices=function(a,b){var c=a/2;c=[[-c,-c,-c],[+c,-c,-c],[-c,+c,-c],[+c,+c,-c],[-c,-c,+c],[+c,-c,+c],[-c,+c,+c],[+c,+c,+c]];for(var d=[[+1,+0,+0],[-1,+0,+0],[+0,+1,+0],[+0,-1,+0],[+0,+0,+1],[+0,+0,-1]],e=[[0,0],[1,0],[1,1],[0,1]],f=o3djs.primitives.createVertexInfo(),g=f.addStream(3,o3djs.base.o3d.Stream.POSITION),h=f.addStream(3,o3djs.base.o3d.Stream.NORMAL),j=f.addStream(2,o3djs.base.o3d.Stream.TEXCOORD,0),i=0;i<6;++i)for(var k=o3djs.primitives.CUBE_FACE_INDICES_[i],
l=0;l<4;++l){var m=d[i],n=e[l];g.addElementVector(c[k[l]]);h.addElementVector(m);j.addElementVector(n);m=4*i;f.addTriangle(m+0,m+1,m+2);f.addTriangle(m+0,m+2,m+3)}b&&f.reorient(b);return f};o3djs.primitives.createCube=function(a,b,c,d){return o3djs.primitives.createCubeVertices(c,d).createShape(a,b)};o3djs.primitives.createBox=function(a,b,c,d,e,f){var g=o3djs.primitives.createCubeVertices(1);g.reorient([[c,0,0,0],[0,d,0,0],[0,0,e,0],[0,0,0,1]]);f&&g.reorient(f);return g.createShape(a,b)};
o3djs.primitives.createRainbowCube=function(a,b,c,d){c=o3djs.primitives.createCubeVertices(c,d);d=c.addStream(4,o3djs.base.o3d.Stream.COLOR);for(var e=[[1,0,0,1],[0,1,0,1],[0,0,1,1],[1,1,0,1],[0,1,1,1],[1,0,1,1],[0,0.5,0.3,1],[0.3,0,0.5,1]],f=0;f<6;++f)for(var g=o3djs.primitives.CUBE_FACE_INDICES_[f],h=0;h<4;++h)d.addElementVector(e[g[h]]);return c.createShape(a,b)};
o3djs.primitives.createDiscVertices=function(a,b,c,d,e,f){if(b<3)throw Error("divisions must be at least 3");c=c?c:1;d=d?d:0;e=e?e:1;var g=o3djs.primitives.createVertexInfo(),h=g.addStream(3,o3djs.base.o3d.Stream.POSITION),j=g.addStream(3,o3djs.base.o3d.Stream.NORMAL),i=g.addStream(2,o3djs.base.o3d.Stream.TEXCOORD,0),k=0;if(d==0){h.addElement(0,0,0);j.addElement(0,1,0);i.addElement(0,0);k++}for(var l=Math.max(d,1);l<=c;++l){for(var m=a*Math.pow(l/c,e),n=0;n<b;++n){var r=2*Math.PI*n/b,o=m*Math.cos(r);
r=m*Math.sin(r);h.addElement(o,0,r);j.addElement(0,1,0);i.addElement(o,r);if(l>d){o=k+(n+1)%b;r=k+n;if(l>1){var q=k+n-b,p=k+(n+1)%b-b;g.addTriangle(o,r,q);g.addTriangle(o,q,p)}else g.addTriangle(0,o,r)}}k+=b}f&&g.reorient(f);return g};o3djs.primitives.createDisc=function(a,b,c,d,e,f,g,h){return o3djs.primitives.createDiscVertices(c,d,e,f,g,h).createShape(a,b)};o3djs.primitives.createCylinderVertices=function(a,b,c,d,e){return o3djs.primitives.createTruncatedConeVertices(a,a,b,c,d,e)};
o3djs.primitives.createCylinder=function(a,b,c,d,e,f,g){return o3djs.primitives.createCylinderVertices(c,d,e,f,g).createShape(a,b)};
o3djs.primitives.createTruncatedConeVertices=function(a,b,c,d,e,f){if(d<3)throw Error("radialSubdivisions must be 3 or greater");if(e<1)throw Error("verticalSubdivisions must be 1 or greater");var g=o3djs.primitives.createVertexInfo(),h=g.addStream(3,o3djs.base.o3d.Stream.POSITION),j=g.addStream(3,o3djs.base.o3d.Stream.NORMAL),i=g.addStream(2,o3djs.base.o3d.Stream.TEXCOORD,0),k=d+1,l=Math.atan2(a-b,c),m=Math.cos(l);l=Math.sin(l);for(var n=-2;n<=e+2;++n){var r=n/e,o=c*r,q;if(n<0){o=0;r=1;q=a}else if(n>
e){o=c;r=1;q=b}else q=a+(b-a)*(n/e);if(n==-2||n==e+2)r=q=0;o-=c/2;for(var p=0;p<k;++p){var t=Math.sin(p*Math.PI*2/d),u=Math.cos(p*Math.PI*2/d);h.addElement(t*q,o,u*q);j.addElement(n<0||n>e?0:t*m,n<0?-1:n>e?1:l,n<0||n>e?0:u*m);i.addElement(p/d,r)}}for(n=0;n<e+4;++n)for(p=0;p<d;++p){g.addTriangle(k*(n+0)+0+p,k*(n+0)+1+p,k*(n+1)+1+p);g.addTriangle(k*(n+0)+0+p,k*(n+1)+1+p,k*(n+1)+0+p)}f&&g.reorient(f);return g};
o3djs.primitives.createTruncatedCone=function(a,b,c,d,e,f,g,h){return o3djs.primitives.createTruncatedConeVertices(c,d,e,f,g,h).createShape(a,b)};
o3djs.primitives.createTorusVertices=function(a,b,c,d,e){if(c<3)throw Error("tubeLengthSubdivisions must be 3 or greater");if(d<3)throw Error("circleSubdivisions must be 3 or greater");for(var f=o3djs.primitives.createVertexInfo(),g=f.addStream(3,o3djs.base.o3d.Stream.POSITION),h=f.addStream(3,o3djs.base.o3d.Stream.NORMAL),j=f.addStream(2,o3djs.base.o3d.Stream.TEXCOORD,0),i=0;i<c;++i)for(var k=i/c*2*Math.PI,l=0;l<d;++l){var m=l/d*2*Math.PI,n=Math.sin(k),r=Math.cos(k),o=Math.sin(m);m=Math.cos(m);g.addElement((a+
b*m)*r,b*o,(a+b*m)*n);h.addElement(m*r,o,m*n);j.addElement(i/c,l/d)}for(i=0;i<c;++i)for(l=0;l<d;++l){a=(i+1)%c;h=(l+1)%d;b=d*i+l;g=d*i+h;h=d*a+h;f.addTriangle(b,h,d*a+l);f.addTriangle(b,g,h)}e&&f.reorient(e);return f};o3djs.primitives.createTorus=function(a,b,c,d,e,f,g){return o3djs.primitives.createTorusVertices(c,d,e,f,g).createShape(a,b)};
o3djs.primitives.createWedgeVertices=function(a,b,c){var d=o3djs.math,e=o3djs.primitives.createVertexInfo(),f=e.addStream(3,o3djs.base.o3d.Stream.POSITION),g=e.addStream(3,o3djs.base.o3d.Stream.NORMAL),h=e.addStream(2,o3djs.base.o3d.Stream.TEXCOORD,0),j=-b*0.5;b*=0.5;var i=[];a=[[a[0][0],a[0][1]],[a[1][0],a[1][1]],[a[2][0],a[2][1]]];i[0]=d.cross(d.normalize([a[1][0]-a[0][0],a[1][1]-a[0][1],j-j]),d.normalize([a[1][0]-a[1][0],a[1][1]-a[1][1],b-j]));i[1]=d.cross(d.normalize([a[2][0]-a[1][0],a[2][1]-
a[1][1],j-j]),d.normalize([a[2][0]-a[2][0],a[2][1]-a[2][1],b-j]));i[2]=d.cross([a[0][0]-a[2][0],a[0][1]-a[2][1],j-j],[a[0][0]-a[0][0],a[0][1]-a[0][1],b-j]);f.addElement(a[0][0],a[0][1],j);g.addElement(0,0,-1);h.addElement(0,1);f.addElement(a[1][0],a[1][1],j);g.addElement(0,0,-1);h.addElement(1,0);f.addElement(a[2][0],a[2][1],j);g.addElement(0,0,-1);h.addElement(0,0);f.addElement(a[0][0],a[0][1],b);g.addElement(0,0,1);h.addElement(0,1);f.addElement(a[1][0],a[1][1],b);g.addElement(0,0,1);h.addElement(1,
0);f.addElement(a[2][0],a[2][1],b);g.addElement(0,0,1);h.addElement(0,0);f.addElement(a[0][0],a[0][1],j);g.addElement(i[0][0],i[0][1],i[0][2]);h.addElement(0,1);f.addElement(a[1][0],a[1][1],j);g.addElement(i[0][0],i[0][1],i[0][2]);h.addElement(0,0);f.addElement(a[1][0],a[1][1],b);g.addElement(i[0][0],i[0][1],i[0][2]);h.addElement(1,0);f.addElement(a[0][0],a[0][1],b);g.addElement(i[0][0],i[0][1],i[0][2]);h.addElement(1,1);f.addElement(a[1][0],a[1][1],j);g.addElement(i[1][0],i[1][1],i[1][2]);h.addElement(0,
1);f.addElement(a[2][0],a[2][1],j);g.addElement(i[1][0],i[1][1],i[1][2]);h.addElement(0,0);f.addElement(a[2][0],a[2][1],b);g.addElement(i[1][0],i[1][1],i[1][2]);h.addElement(1,0);f.addElement(a[1][0],a[1][1],b);g.addElement(i[1][0],i[1][1],i[1][2]);h.addElement(1,1);f.addElement(a[2][0],a[2][1],j);g.addElement(i[2][0],i[2][1],i[2][2]);h.addElement(0,1);f.addElement(a[0][0],a[0][1],j);g.addElement(i[2][0],i[2][1],i[2][2]);h.addElement(0,0);f.addElement(a[0][0],a[0][1],b);g.addElement(i[2][0],i[2][1],
i[2][2]);h.addElement(1,0);f.addElement(a[2][0],a[2][1],b);g.addElement(i[2][0],i[2][1],i[2][2]);h.addElement(1,1);e.addTriangle(0,2,1);e.addTriangle(3,4,5);e.addTriangle(6,7,8);e.addTriangle(6,8,9);e.addTriangle(10,11,12);e.addTriangle(10,12,13);e.addTriangle(14,15,16);e.addTriangle(14,16,17);c&&e.reorient(c);return e};o3djs.primitives.createWedge=function(a,b,c,d,e){return o3djs.primitives.createWedgeVertices(c,d,e).createShape(a,b)};
o3djs.primitives.createPrismVertices=function(a,b,c){if(a.length<3)throw Error("there must be 3 or more points");var d=-0.5*b;b*=0.5;for(var e=[],f=o3djs.primitives.createVertexInfo(),g=f.addStream(3,o3djs.base.o3d.Stream.POSITION),h=f.addStream(3,o3djs.base.o3d.Stream.NORMAL),j=f.addStream(2,o3djs.base.o3d.Stream.TEXCOORD,0),i=a.length,k=0;k<i;++k){var l=(k+1)%i,m=a[l][0]-a[k][0],n=a[l][1]-a[k][1];l=Math.sqrt(m*m+n*n);e[k]=[n/l,-m/l,0]}l=a[0][0];var r=a[0][1],o=a[0][0],q=a[0][1];for(k=1;k<i;++k){m=
a[k][0];n=a[k][1];l=Math.min(l,m);r=Math.min(r,n);o=Math.max(o,m);q=Math.max(q,n)}m=[];n=[];var p=o-l;q-=r;for(k=0;k<i;++k){m[k]=[(a[k][0]-l)/p,(a[k][1]-r)/q];n[k]=[(o-a[k][0])/p,(a[k][1]-r)/q]}for(k=0;k<i;++k){l=(k+1)%i;g.addElement(a[k][0],a[k][1],d);h.addElement(0,0,-1);j.addElement(n[k][0],n[k][1]);g.addElement(a[k][0],a[k][1],b);h.addElement(0,0,1);j.addElement(m[k][0],m[k][1]);g.addElement(a[k][0],a[k][1],d);h.addElement(e[k][0],e[k][1],e[k][2]);j.addElement(0,1);g.addElement(a[l][0],a[l][1],
d);h.addElement(e[k][0],e[k][1],e[k][2]);j.addElement(0,0);g.addElement(a[l][0],a[l][1],b);h.addElement(e[k][0],e[k][1],e[k][2]);j.addElement(1,0);g.addElement(a[k][0],a[k][1],b);h.addElement(e[k][0],e[k][1],e[k][2]);j.addElement(1,1);if(k>0&&k<i-1){f.addTriangle(0,6*(k+1),6*k);f.addTriangle(1,6*k+1,6*(k+1)+1)}f.addTriangle(6*k+2,6*k+3,6*k+4);f.addTriangle(6*k+2,6*k+4,6*k+5)}c&&f.reorient(c);return f};
o3djs.primitives.createPrism=function(a,b,c,d,e){return o3djs.primitives.createPrismVertices(c,d,e).createShape(a,b)};
o3djs.primitives.createPlaneVertices=function(a,b,c,d,e){if(c<=0||d<=0)throw Error("subdivisionWidth and subdivisionDepth must be > 0");for(var f=o3djs.primitives.createVertexInfo(),g=f.addStream(3,o3djs.base.o3d.Stream.POSITION),h=f.addStream(3,o3djs.base.o3d.Stream.NORMAL),j=f.addStream(2,o3djs.base.o3d.Stream.TEXCOORD,0),i=0;i<=d;i++)for(var k=0;k<=c;k++){var l=k/c,m=i/d;g.addElement(a*l-a*0.5,0,b*m-b*0.5);h.addElement(0,1,0);j.addElement(l,1-m)}a=c+1;for(i=0;i<d;i++)for(k=0;k<c;k++){f.addTriangle((i+
0)*a+k,(i+1)*a+k,(i+0)*a+k+1);f.addTriangle((i+1)*a+k,(i+1)*a+k+1,(i+0)*a+k+1)}e&&f.reorient(e);return f};o3djs.primitives.createPlane=function(a,b,c,d,e,f,g){return o3djs.primitives.createPlaneVertices(c,d,e,f,g).createShape(a,b)};o3djs.primitives.createFadePlane=function(a,b,c,d,e,f,g){c=o3djs.primitives.createPlaneVertices(c,d,e,f,g);d=c.addStream(4,o3djs.base.o3d.Stream.COLOR);for(g=0;g<=f;g++)for(var h=g/f,j=0;j<=e;j++)d.addElement(1,1,1,h);return c.createShape(a,b)};o3djs.provide("o3djs.lineprimitives");
o3djs.require("o3djs.math");o3djs.require("o3djs.primitives");o3djs.lineprimitives=o3djs.lineprimitives||{};o3djs.lineprimitives.LineVertexInfo=function(){o3djs.primitives.VertexInfoBase.call(this)};o3djs.base.inherit(o3djs.lineprimitives.LineVertexInfo,o3djs.primitives.VertexInfoBase);o3djs.lineprimitives.LineVertexInfo.prototype.numLines=function(){return this.indices.length/2};o3djs.lineprimitives.LineVertexInfo.prototype.addLine=function(a,b){this.indices.push(a,b)};
o3djs.lineprimitives.LineVertexInfo.prototype.getLine=function(a){a*=3;return[this.indices[a+0],this.indices[a+1],this.indices[a+2]]};o3djs.lineprimitives.LineVertexInfo.prototype.setLine=function(a,b,c){a*=2;this.indices[a+0]=b;this.indices[a+1]=c};o3djs.lineprimitives.LineVertexInfo.prototype.createShape=function(a,b){return this.createShapeByType(a,b,o3djs.base.o3d.Primitive.LINELIST)};o3djs.lineprimitives.createLineVertexInfo=function(){return new o3djs.lineprimitives.LineVertexInfo};
o3djs.lineprimitives.createLineCubeVertices=function(a,b){var c=a/2,d=[[-c,-c,-c],[+c,-c,-c],[-c,+c,-c],[+c,+c,-c],[-c,-c,+c],[+c,-c,+c],[-c,+c,+c],[+c,+c,+c]];c=[[0,1],[1,3],[3,2],[2,0],[4,5],[5,7],[7,6],[6,4],[0,4],[1,5],[2,6],[3,7]];for(var e=o3djs.lineprimitives.createLineVertexInfo(),f=e.addStream(3,o3djs.base.o3d.Stream.POSITION),g=0;g<d.length;++g)f.addElementVector(d[g]);for(d=0;d<c.length;++d)e.addLine(c[d][0],c[d][1]);b&&e.reorient(b);return e};
o3djs.lineprimitives.createLineCube=function(a,b,c,d){return o3djs.lineprimitives.createLineCubeVertices(c,d).createShape(a,b)};
o3djs.lineprimitives.createLineSphereVertices=function(a,b,c,d){if(b<=0||c<=0)throw Error("subdivisionAxis and subdivisionHeight must be > 0");for(var e=o3djs.lineprimitives.createLineVertexInfo(),f=e.addStream(3,o3djs.base.o3d.Stream.POSITION),g=0;g<=c;g++)for(var h=0;h<=b;h++){var j=2*Math.PI*(h/b),i=Math.PI*(g/c),k=Math.sin(i);f.addElement(a*Math.cos(j)*k,a*Math.cos(i),a*Math.sin(j)*k)}a=b+1;for(h=0;h<b;h++)for(g=0;g<c;g++){e.addLine((g+0)*a+h,(g+0)*a+h+1);e.addLine((g+0)*a+h,(g+1)*a+h)}d&&e.reorient(d);
return e};o3djs.lineprimitives.createLineSphere=function(a,b,c,d,e,f){return o3djs.lineprimitives.createLineSphereVertices(c,d,e,f).createShape(a,b)};
o3djs.lineprimitives.createLineRingVertices=function(a,b,c,d){if(b<3)throw Error("subdivisions must be >= 3");for(var e=o3djs.lineprimitives.createLineVertexInfo(),f=e.addStream(3,o3djs.base.o3d.Stream.POSITION),g=e.addStream(3,o3djs.base.o3d.Stream.NORMAL),h=e.addStream(1,o3djs.base.o3d.Stream.TEXCOORD,0),j=0;j<=b;j++){var i=2*Math.PI*j/b;f.addElement(a*Math.cos(i),0,a*Math.sin(i));g.addElement(Math.cos(i),0,Math.sin(i));h.addElement(c*j/b)}for(j=0;j<b;j++)e.addLine(j,j+1);d&&e.reorient(d);return e};
o3djs.lineprimitives.createLineRing=function(a,b,c,d,e,f){return o3djs.lineprimitives.createLineRingVertices(c,d,e,f).createShape(a,b)};o3djs.provide("o3djs.loader");o3djs.require("o3djs.io");o3djs.require("o3djs.scene");o3djs.loader=o3djs.loader||{};o3djs.loader.Loader=function(a){this.count_=1;this.onFinished_=a;this.loadInfo=o3djs.io.createLoadInfo()};o3djs.loader.createLoader=function(a){return new o3djs.loader.Loader(a)};
o3djs.loader.Loader.prototype.loadTexture=function(a,b,c){var d=this;++this.count_;this.loadInfo.addChild(o3djs.io.loadTexture(a,b,function(e,f){c&&c(e,f);d.countDown_()}))};o3djs.loader.Loader.prototype.loadRawData=function(a,b,c){var d=this;++this.count_;this.loadInfo.addChild(o3djs.io.loadRawData(a,b,function(e,f,g){c(e,f,g);d.countDown_()}))};
o3djs.loader.Loader.prototype.loadBitmaps=function(a,b,c){var d=this;++this.count_;this.loadInfo.addChild(o3djs.io.loadBitmaps(a,b,function(e,f){c(e,f);d.countDown_()}))};o3djs.loader.Loader.prototype.loadScene=function(a,b,c,d,e,f){var g=this;++this.count_;this.loadInfo.addChild(o3djs.scene.loadScene(a,b,c,d,function(h,j,i){e&&e(h,j,i);g.countDown_()},f))};
o3djs.loader.Loader.prototype.loadTextFile=function(a,b){var c=this;++this.count_;this.loadInfo.addChild(o3djs.io.loadTextFile(a,function(d,e){b(d,e);c.countDown_()}))};o3djs.loader.Loader.prototype.createLoader=function(a){var b=this;++this.count_;var c=o3djs.loader.createLoader(function(){a();b.countDown_()});this.loadInfo.addChild(c.loadInfo);return c};o3djs.loader.Loader.prototype.countDown_=function(){--this.count_;if(this.count_===0)this.onFinished_()};o3djs.loader.Loader.prototype.finish=function(){this.countDown_()};
o3djs.provide("o3djs.manipulators");o3djs.require("o3djs.lineprimitives");o3djs.require("o3djs.material");o3djs.require("o3djs.math");o3djs.require("o3djs.picking");o3djs.require("o3djs.primitives");o3djs.require("o3djs.quaternions");o3djs.manipulators=o3djs.manipulators||{};o3djs.manipulators.createManager=function(a,b,c,d,e){return new o3djs.manipulators.Manager(a,b,c,d,e)};
o3djs.manipulators.Line_=function(a,b){this.direction_=o3djs.math.copyVector(a||[1,0,0]);this.point_=o3djs.math.copyVector(b||[0,0,0]);this.recalc_()};o3djs.manipulators.Line_.prototype.setDirection=function(a){this.direction_=o3djs.math.copyVector(a);this.recalc_()};o3djs.manipulators.Line_.prototype.getDirection=function(){return this.direction_};o3djs.manipulators.Line_.prototype.setPoint=function(a){this.point_=o3djs.math.copyVector(a);this.recalc_()};
o3djs.manipulators.Line_.prototype.getPoint=function(){return this.point_};o3djs.manipulators.Line_.prototype.projectPoint=function(a){a=o3djs.math.dot(this.direction_,a);return o3djs.math.addVector(this.alongVec_,o3djs.math.mulScalarVector(a,this.direction_))};o3djs.manipulators.EPSILON=1.0E-5;o3djs.manipulators.X_AXIS=[1,0,0];o3djs.manipulators.Z_AXIS=[0,0,1];
o3djs.manipulators.Line_.prototype.closestPointToRay=function(a,b){var c=o3djs.math.subVector(b,a),d=o3djs.math.dot(this.direction_,c);d=[[-o3djs.math.lengthSquared(this.direction_),d],[d,-o3djs.math.lengthSquared(c)]];var e=o3djs.math.det2(d);if(Math.abs(e)<o3djs.manipulators.EPSILON)return null;d=o3djs.math.inverse2(d);c=[o3djs.math.dot(this.point_,this.direction_)-o3djs.math.dot(a,this.direction_),o3djs.math.dot(a,c)-o3djs.math.dot(this.point_,c)];c=o3djs.math.mulMatrixVector(d,c);return c[1]<
0?a:o3djs.math.addVector(this.point_,o3djs.math.mulScalarVector(c[0],this.direction_))};o3djs.manipulators.Line_.prototype.recalc_=function(){if(o3djs.math.lengthSquared(this.direction_)==0)throw"Line_.recalc_: ERROR: direction was the zero vector (not allowed)";this.alongVec_=o3djs.math.subVector(this.point_,o3djs.math.mulScalarVector(o3djs.math.dot(this.point_,this.direction_),this.direction_))};o3djs.manipulators.DEFAULT_COLOR=[0.8,0.8,0.8,1];o3djs.manipulators.HIGHLIGHTED_COLOR=[0.9,0.9,0,1];
o3djs.manipulators.Plane_=function(a,b){this.point_=o3djs.math.copyVector(b||[0,0,0]);this.setNormal(a||[0,1,0])};o3djs.manipulators.Plane_.prototype.setNormal=function(a){if(o3djs.math.lengthSquared(a)==0)throw"Plane_.setNormal: ERROR: normal was the zero vector (not allowed)";this.normal_=o3djs.math.normalize(a);this.recalc_()};o3djs.manipulators.Plane_.prototype.getNormal=function(){return this.normal_};
o3djs.manipulators.Plane_.prototype.setPoint=function(a){this.point_=o3djs.math.copyVector(a);this.recalc_()};o3djs.manipulators.Plane_.prototype.getPoint=function(){return this.point_};o3djs.manipulators.Plane_.prototype.projectPoint=function(a){var b=o3djs.math.dot(this.normal_,a)-this.normalDotPoint_;return o3djs.math.subVector(a,o3djs.math.mulScalarVector(b,this.normal_))};
o3djs.manipulators.Plane_.prototype.intersectRay=function(a,b){var c=this.normalDotPoint_-o3djs.math.dot(this.normal_,a),d=o3djs.math.dot(this.normal_,b);if(d==0)return null;return o3djs.math.addVector(a,o3djs.math.mulScalarVector(c/d,b))};o3djs.manipulators.Plane_.prototype.recalc_=function(){this.normalDotPoint_=o3djs.math.dot(this.normal_,this.point_)};
o3djs.manipulators.Manager=function(a,b,c,d,e){this.pack=a;this.viewInfo=o3djs.rendergraph.createView(a,b,c,undefined,d,undefined,undefined,undefined,e);this.viewInfo.clearBuffer.active=false;a=this.viewInfo.zOrderedState;a.getStateParam("ZComparisonFunction").value=o3djs.base.o3d.State.CMP_GREATER;a.getStateParam("ZWriteEnable").value=false;a=this.viewInfo.performanceDrawPassInfo.root.priority;this.viewInfo.performanceDrawPassInfo.root.priority=this.viewInfo.zOrderedDrawPassInfo.root.priority;this.viewInfo.zOrderedDrawPassInfo.root.priority=
a;this.unobscuredDrawList_=this.viewInfo.performanceDrawList;this.obscuredDrawList_=this.viewInfo.zOrderedDrawList;this.parentTransform=b;this.manipsByClientId=[];this.pickManager=o3djs.picking.createPickManager(this.parentTransform);this.draggedManip_=this.highlightedManip=null};
o3djs.manipulators.Manager.prototype.getUnobscuredConstantMaterial=function(){if(!this.unobscuredConstantMaterial_)this.unobscuredConstantMaterial_=o3djs.manipulators.createConstantMaterial(this.pack,this.unobscuredDrawList_,[1,1,1,0.8]);return this.unobscuredConstantMaterial_};
o3djs.manipulators.Manager.prototype.getObscuredConstantMaterial=function(){if(!this.obscuredConstantMaterial_)this.obscuredConstantMaterial_=o3djs.manipulators.createConstantMaterial(this.pack,this.obscuredDrawList_,[1,1,1,0.3]);return this.obscuredConstantMaterial_};
o3djs.manipulators.Manager.prototype.getUnobscuredLineRingMaterial=function(){if(!this.unobscuredLineRingMaterial_)this.unobscuredLineRingMaterial_=o3djs.manipulators.createLineRingMaterial(this.pack,this.unobscuredDrawList_,[1,1,1,1],[1,1,1,0.6],false);return this.unobscuredLineRingMaterial_};
o3djs.manipulators.Manager.prototype.getObscuredLineRingMaterial=function(){if(!this.obscuredLineRingMaterial_)this.obscuredLineRingMaterial_=o3djs.manipulators.createLineRingMaterial(this.pack,this.obscuredDrawList_,[1,1,1,0.5],[1,1,1,0.3],true);return this.obscuredLineRingMaterial_};o3djs.manipulators.Manager.prototype.createTranslate1=function(){var a=new o3djs.manipulators.Translate1(this);this.add_(a);return a};
o3djs.manipulators.Manager.prototype.createTranslate2=function(){var a=new o3djs.manipulators.Translate2(this);this.add_(a);return a};o3djs.manipulators.Manager.prototype.createRotate1=function(){var a=new o3djs.manipulators.Rotate1(this);this.add_(a);return a};o3djs.manipulators.Manager.prototype.add_=function(a){a.getTransform().createDrawElements(this.pack,null);this.manipsByClientId[a.getTransform().clientId]=a};
o3djs.manipulators.Manager.prototype.handleMouse_=function(a,b,c,d,e,f,g){this.pickManager.update();a=this.pickManager.pick(o3djs.picking.clientPositionToWorldRayEx(a,b,c,d,e,f));a!=null?g(this,a,this.manipsByClientId[a.shapeInfo.parent.transform.clientId]||this.manipsByClientId[a.shapeInfo.parent.parent.transform.clientId]):g(this,null,null)};o3djs.manipulators.mouseDownCallback_=function(a,b,c){if(c!=null){a.draggedManip_=c;c.makeActive(b)}};
o3djs.manipulators.hoverCallback_=function(a,b,c){if(a.highlightedManip!=null&&a.highlightedManip!=c){a.highlightedManip.clearHighlight();a.highlightedManip=null}if(c!=null){c.highlight(b);a.highlightedManip=c}};o3djs.manipulators.Manager.prototype.mousedown=function(a,b,c,d,e,f){this.handleMouse_(a,b,c,d,e,f,o3djs.manipulators.mouseDownCallback_)};
o3djs.manipulators.Manager.prototype.mousemove=function(a,b,c,d,e,f){if(this.draggedManip_!=null){var g=o3djs.picking.clientPositionToWorldRayEx(a,b,c,d,e,f);this.draggedManip_.drag(g.near,g.far,a,b,c,d,e,f)}else this.handleMouse_(a,b,c,d,e,f,o3djs.manipulators.hoverCallback_)};o3djs.manipulators.Manager.prototype.mouseup=function(){if(this.draggedManip_!=null){this.draggedManip_.makeInactive();this.draggedManip_=null}};
o3djs.manipulators.Manager.prototype.updateInactiveManipulators=function(){for(var a in this.manipsByClientId){var b=this.manipsByClientId[a];b.isActive()||b.updateBaseTransformFromAttachedTransform_()}};
o3djs.manipulators.Manip=function(a){this.manager_=a;var b=a.pack;this.localTransform_=b.createObject("Transform");this.offsetTransform_=b.createObject("Transform");this.baseTransform_=b.createObject("Transform");this.invisibleTransform_=b.createObject("Transform");this.invisibleTransform_.visible=false;this.invisibleTransform_.parent=this.localTransform_;this.localTransform_.parent=this.offsetTransform_;this.offsetTransform_.parent=this.baseTransform_;this.baseTransform_.parent=a.parentTransform;
a.pickManager.update();a.pickManager.getTransformInfo(this.invisibleTransform_).pickableEvenIfInvisible=true;this.attachedTransform_=null;this.active_=false};o3djs.manipulators.Manip.prototype.addShapes_=function(a,b){if(b==undefined)b=true;for(var c=0;c<a.length;c++)b?this.localTransform_.addShape(a[c]):this.invisibleTransform_.addShape(a[c])};o3djs.manipulators.Manip.prototype.getBaseTransform_=function(){return this.baseTransform_};o3djs.manipulators.Manip.prototype.getOffsetTransform=function(){return this.offsetTransform_};
o3djs.manipulators.Manip.prototype.getTransform=function(){return this.localTransform_};o3djs.manipulators.Manip.prototype.setOffsetTranslation=function(a){this.getOffsetTransform().localMatrix=o3djs.math.matrix4.setTranslation(this.getOffsetTransform().localMatrix,a)};o3djs.manipulators.Manip.prototype.setOffsetRotation=function(a){a=o3djs.quaternions.quaternionToRotation(a);this.getOffsetTransform().localMatrix=o3djs.math.matrix4.setUpper3x3(this.getOffsetTransform().localMatrix,a)};
o3djs.manipulators.Manip.prototype.setTranslation=function(a){this.getTransform().localMatrix=o3djs.math.matrix4.setTranslation(this.getTransform().localMatrix,a)};o3djs.manipulators.Manip.prototype.setRotation=function(a){a=o3djs.quaternions.quaternionToRotation(a);this.getTransform().localMatrix=o3djs.math.matrix4.setUpper3x3(this.getTransform().localMatrix,a)};o3djs.manipulators.Manip.prototype.attachTo=function(a){this.attachedTransform_=a;this.updateBaseTransformFromAttachedTransform_()};
o3djs.manipulators.Manip.prototype.highlight=function(){};o3djs.manipulators.Manip.prototype.clearHighlight=function(){};o3djs.manipulators.Manip.prototype.makeActive=function(){this.active_=true};o3djs.manipulators.Manip.prototype.makeInactive=function(){this.active_=false};o3djs.manipulators.Manip.prototype.drag=function(){};o3djs.manipulators.Manip.prototype.isActive=function(){return this.active_};
o3djs.manipulators.Manip.prototype.updateBaseTransformFromAttachedTransform_=function(){if(this.attachedTransform_!=null){var a=this.attachedTransform_.worldMatrix,b=o3djs.math.matrix4.inverse(this.manager_.parentTransform.worldMatrix);this.baseTransform_.localMatrix=o3djs.math.matrix4.mul(a,b);this.localTransform_.localMatrix=o3djs.math.matrix4.identity()}};
o3djs.manipulators.Manip.prototype.updateAttachedTransformFromLocalTransform_=function(){if(this.attachedTransform_!=null){var a=this.baseTransform_.worldMatrix,b=this.offsetTransform_.localMatrix,c=this.localTransform_.localMatrix,d=o3djs.math.matrix4.inverse(b);c=o3djs.math.matrix4.mul(d,c);c=o3djs.math.matrix4.mul(c,b);c=o3djs.math.matrix4.mul(c,a);a=this.attachedTransform_.worldMatrix;a=o3djs.math.matrix4.mul(o3djs.math.matrix4.inverse(this.attachedTransform_.localMatrix),a);a=o3djs.math.matrix4.inverse(a);
c=o3djs.math.matrix4.mul(c,a);this.attachedTransform_.localMatrix=c}};o3djs.manipulators.Manip.prototype.setMaterial_=function(a,b){for(var c=a.elements,d=0;d<c.length;d++)for(var e=c[d].drawElements,f=0;f<e.length;f++)e[f].material=b};o3djs.manipulators.Manip.prototype.setMaterials_=function(a,b){for(var c=0;c<a.length;c++)this.setMaterial_(a[c],b)};
o3djs.manipulators.createArrowVertices_=function(a){var b=o3djs.math.matrix4,c=o3djs.primitives.createTruncatedConeVertices(0.15,0,0.3,4,1,b.mul(b.translation([0,0.85,0]),a));c.append(o3djs.primitives.createCylinderVertices(0.06,1.4,4,1,a));c.append(o3djs.primitives.createTruncatedConeVertices(0,0.15,0.3,4,1,b.mul(b.translation([0,-0.85,0]),a)));return c};
o3djs.manipulators.Translate1=function(a){o3djs.manipulators.Manip.call(this,a);var b=a.pack,c=a.translate1Shape_;if(!c){c=o3djs.manipulators.createArrowVertices_(o3djs.math.matrix4.rotationZ(Math.PI/2)).createShape(b,a.getUnobscuredConstantMaterial());c.createDrawElements(b,a.getObscuredConstantMaterial());a.translate1Shape_=c}this.addShapes_([c]);this.colorParam_=this.getTransform().createParam("highlightColor","ParamFloat4");this.clearHighlight();this.dragLine_=new o3djs.manipulators.Line_};
o3djs.base.inherit(o3djs.manipulators.Translate1,o3djs.manipulators.Manip);o3djs.manipulators.Translate1.prototype.highlight=function(){this.colorParam_.value=o3djs.manipulators.HIGHLIGHTED_COLOR};o3djs.manipulators.Translate1.prototype.clearHighlight=function(){this.colorParam_.value=o3djs.manipulators.DEFAULT_COLOR};
o3djs.manipulators.Translate1.prototype.makeActive=function(a){o3djs.manipulators.Manip.prototype.makeActive.call(this,a);this.highlight(a);var b=this.getTransform().worldMatrix;this.dragLine_.setDirection(o3djs.math.matrix4.transformDirection(b,o3djs.manipulators.X_AXIS));this.dragLine_.setPoint(a.worldIntersectionPosition)};
o3djs.manipulators.Translate1.prototype.makeInactive=function(){o3djs.manipulators.Manip.prototype.makeInactive.call(this);this.clearHighlight();this.updateAttachedTransformFromLocalTransform_();this.updateBaseTransformFromAttachedTransform_()};
o3djs.manipulators.Translate1.prototype.drag=function(a,b){var c=this.dragLine_.closestPointToRay(a,b);if(c!=null){c=o3djs.math.subVector(c,this.dragLine_.getPoint());var d=o3djs.math.matrix4.inverse(this.getTransform().worldMatrix);this.getTransform().localMatrix=o3djs.math.matrix4.setTranslation(this.getTransform().localMatrix,o3djs.math.matrix4.transformDirection(d,c));this.updateAttachedTransformFromLocalTransform_()}};
o3djs.manipulators.Translate2=function(a){o3djs.manipulators.Manip.call(this,a);var b=a.pack,c=a.Translate2Shape_;if(!c){c=o3djs.manipulators.createArrowVertices_(o3djs.math.matrix4.rotationZ(Math.PI/2));c.append(o3djs.manipulators.createArrowVertices_(o3djs.math.matrix4.rotationZ(0)));c=c.createShape(b,a.getUnobscuredConstantMaterial());c.createDrawElements(b,a.getObscuredConstantMaterial());a.Translate2Shape_=c}this.addShapes_([c]);this.colorParam_=this.getTransform().createParam("highlightColor",
"ParamFloat4");this.clearHighlight();this.dragPlane_=new o3djs.manipulators.Plane_};o3djs.base.inherit(o3djs.manipulators.Translate2,o3djs.manipulators.Manip);o3djs.manipulators.Translate2.prototype.highlight=function(){this.colorParam_.value=o3djs.manipulators.HIGHLIGHTED_COLOR};o3djs.manipulators.Translate2.prototype.clearHighlight=function(){this.colorParam_.value=o3djs.manipulators.DEFAULT_COLOR};
o3djs.manipulators.Translate2.prototype.makeActive=function(a){o3djs.manipulators.Manip.prototype.makeActive.call(this,a);this.highlight(a);var b=this.getTransform().worldMatrix;this.dragPlane_.setNormal(o3djs.math.matrix4.transformDirection(b,o3djs.manipulators.Z_AXIS));this.dragPlane_.setPoint(a.worldIntersectionPosition)};
o3djs.manipulators.Translate2.prototype.makeInactive=function(){o3djs.manipulators.Manip.prototype.makeInactive.call(this);this.clearHighlight();this.updateAttachedTransformFromLocalTransform_();this.updateBaseTransformFromAttachedTransform_()};
o3djs.manipulators.Translate2.prototype.drag=function(a,b){var c=this.dragPlane_.intersectRay(a,o3djs.math.subVector(b,a));if(c!=null){c=o3djs.math.subVector(c,this.dragPlane_.getPoint());var d=o3djs.math.matrix4.inverse(this.getTransform().worldMatrix);this.getTransform().localMatrix=o3djs.math.matrix4.setTranslation(this.getTransform().localMatrix,o3djs.math.matrix4.transformDirection(d,c));this.updateAttachedTransformFromLocalTransform_()}};
o3djs.manipulators.Rotate1=function(a){o3djs.manipulators.Manip.call(this,a);var b=a.pack,c=a.Rotate1PickShape_;if(!c){var d=o3djs.primitives.createTorusVertices(1,0.1,16,6,o3djs.math.matrix4.rotationZ(Math.PI/2));c=d.createShape(b,a.getUnobscuredConstantMaterial());a.Rotate1PickShape_=c}d=a.Rotate1VisibleShape_;if(!d){d=o3djs.lineprimitives.createLineRingVertices(1,32,120,o3djs.math.matrix4.rotationZ(Math.PI/2));d=d.createShape(b,a.getUnobscuredLineRingMaterial());d.createDrawElements(b,a.getObscuredLineRingMaterial());
a.Rotate1VisibleShape_=d}this.addShapes_([c],false);this.addShapes_([d]);this.colorParam_=this.getTransform().createParam("highlightColor","ParamFloat4");this.clearHighlight();this.dragLine_=new o3djs.manipulators.Line_};o3djs.base.inherit(o3djs.manipulators.Rotate1,o3djs.manipulators.Manip);o3djs.manipulators.Rotate1.prototype.highlight=function(){this.colorParam_.value=o3djs.manipulators.HIGHLIGHTED_COLOR};o3djs.manipulators.Rotate1.prototype.clearHighlight=function(){this.colorParam_.value=o3djs.manipulators.DEFAULT_COLOR};
o3djs.manipulators.Rotate1.prototype.makeActive=function(a){o3djs.manipulators.Manip.prototype.makeActive.call(this,a);this.highlight(a);var b=this.getTransform().worldMatrix,c=o3djs.math.matrix4.inverse(b);c=o3djs.math.matrix4.transformPoint(c,a.worldIntersectionPosition);c=o3djs.math.cross(c,o3djs.manipulators.X_AXIS);this.dragLine_.setDirection(o3djs.math.matrix4.transformDirection(b,c));this.dragLine_.setPoint(a.worldIntersectionPosition)};
o3djs.manipulators.Rotate1.prototype.makeInactive=function(){o3djs.manipulators.Manip.prototype.makeInactive.call(this);this.clearHighlight();this.updateAttachedTransformFromLocalTransform_();this.updateBaseTransformFromAttachedTransform_()};o3djs.manipulators.frustumPositionToClientPosition_=function(a,b,c){return[(a[0]+1)*b/2,(-a[1]+1)*c/2]};
o3djs.manipulators.Rotate1.prototype.drag=function(a,b,c,d,e,f,g,h){b=o3djs.math.matrix4.mul(e,f);a=o3djs.manipulators.frustumPositionToClientPosition_(o3djs.math.matrix4.transformPoint(b,this.dragLine_.getPoint()),g,h);b=o3djs.manipulators.frustumPositionToClientPosition_(o3djs.math.matrix4.transformPoint(b,o3djs.math.addVector(this.dragLine_.getPoint(),this.dragLine_.getDirection())),g,h);b=o3djs.math.normalize(o3djs.math.subVector(b,a));c=(o3djs.math.dot(b,[c,d])-o3djs.math.dot(b,a))/Math.max(g,
h)*2*Math.PI;this.getTransform().localMatrix=o3djs.math.matrix4.rotationX(-c);this.updateAttachedTransformFromLocalTransform_()};o3djs.manipulators.phongFXString_="uniform float4x4 worldViewProjection : WORLDVIEWPROJECTION;\nuniform float3 lightWorldPos;\nuniform float4 lightColor;\nuniform float4x4 world : WORLD;\nuniform float4x4 viewInverse : VIEWINVERSE;\nuniform float4x4 worldInverseTranspose : WORLDINVERSETRANSPOSE;\nuniform float4 emissive;\nuniform float4 ambient;\nuniform float4 diffuse;\nuniform float4 highlightColor;\nuniform float4 specular;\nuniform float shininess;\nuniform float specularFactor;\nstruct InVertex {\n  float4 position : POSITION;\n  float3 normal : NORMAL;\n};\nstruct OutVertex {\n  float4 position : POSITION;\n  float3 normal : TEXCOORD0;\n  float3 surfaceToLight: TEXCOORD1;\n  float3 surfaceToView : TEXCOORD2;\n};\nOutVertex vertexShaderFunction(InVertex input) {\n  OutVertex output;\n  output.position = mul(input.position, worldViewProjection);\n  output.normal = mul(float4(input.normal, 0),\n                      worldInverseTranspose).xyz;\n  output.surfaceToLight = lightWorldPos - \n      mul(input.position, world).xyz;\n  output.surfaceToView = (viewInverse[3] - mul(input.position,\n      world)).xyz;\n  return output;\n}\nfloat4 pixelShaderFunction(OutVertex input) : COLOR {\n  float4 newDiffuse = diffuse * highlightColor;\n  float3 normal = normalize(input.normal);\n  float3 surfaceToLight = normalize(input.surfaceToLight);\n  float3 surfaceToView = normalize(input.surfaceToView);\n  float3 halfVector = normalize(surfaceToLight + surfaceToView);\n  float4 litR = lit(dot(normal, surfaceToLight), \n                    dot(normal, halfVector), shininess);\n  return float4((emissive +\n      lightColor * (ambient * newDiffuse + newDiffuse * litR.y +\n      + specular * litR.z * specularFactor)).rgb, newDiffuse.a);\n}\n\n// #o3d VertexShaderEntryPoint vertexShaderFunction\n// #o3d PixelShaderEntryPoint pixelShaderFunction\n// #o3d MatrixLoadOrder RowMajor\n";
o3djs.manipulators.constantFXString_="uniform float4x4 worldViewProjection : WORLDVIEWPROJECTION;\nuniform float4 color;\nuniform float4 highlightColor;\n\nstruct VertexShaderInput {\n  float4 position : POSITION;\n};\n\nstruct PixelShaderInput {\n  float4 position : POSITION;\n};\n\nPixelShaderInput vertexShaderFunction(VertexShaderInput input) {\n  PixelShaderInput output;\n\n  output.position = mul(input.position, worldViewProjection);\n  return output;\n}\n\nfloat4 pixelShaderFunction(PixelShaderInput input): COLOR {\n  return color * highlightColor;\n}\n\n// #o3d VertexShaderEntryPoint vertexShaderFunction\n// #o3d PixelShaderEntryPoint pixelShaderFunction\n// #o3d MatrixLoadOrder RowMajor\n";
o3djs.manipulators.getLineRingFXString_=function(a){var b="";if(a)b="  // Use the texCoord to do stippling.\n  if (input.texCoord.x % 2 > 1) return float4(0, 0, 0, 0);\n";return'uniform float4x4 worldViewProjection : WORLDVIEWPROJECTION;\n// NOTE: We transform the normals through the\n// worldViewProjectionInverseTranspose instead of the\n// worldViewInverseTranspose. The projection matrix warps the\n// normals in strange ways. One result of this is that the "front\n// face" color of the ring can extend around more than 50% of the\n// ring. This may be good or bad. If we dont include the projection\n// matrix, we always get a 50% split, but we do not account for\n// perspective. An alternative would be to get a little more\n// complicated, using the positions of the camera and the center\n// of the ring.\nuniform float4x4 worldViewProjectionInverseTranspose :\n    WORLDVIEWPROJECTIONINVERSETRANSPOSE;\nuniform float4 color1;\nuniform float4 color2;\nuniform float4 highlightColor;\n\nstruct VertexShaderInput {\n  float4 position : POSITION;\n  float4 normal : NORMAL;\n  float1 texCoord : TEXCOORD0;\n};\n\nstruct PixelShaderInput {\n  float4 position : POSITION;\n  float3 normal : TEXCOORD0;\n  float1 texCoord : TEXCOORD1;\n};\n\nPixelShaderInput vertexShaderFunction(VertexShaderInput input) {\n  PixelShaderInput output;\n\n  output.position = mul(input.position, worldViewProjection);\n  output.normal = mul(input.normal,\n                      worldViewProjectionInverseTranspose).xyz;\n  output.texCoord = input.texCoord;\n  return output;\n}\n\nfloat4 pixelShaderFunction(PixelShaderInput input): COLOR {\n'+
b+"  if (input.normal.z < 0) {\n    return color1 * highlightColor; // Front face of the ring.\n  } else {\n    return color2 * highlightColor; // Back face of the ring.\n  }\n}\n\n// #o3d VertexShaderEntryPoint vertexShaderFunction\n// #o3d PixelShaderEntryPoint pixelShaderFunction\n// #o3d MatrixLoadOrder RowMajor\n"};
o3djs.manipulators.enableAlphaBlendingOnMaterial=function(a,b,c){if(!b.state)b.state=a.createObject("State");a=b.state;a.getStateParam("AlphaBlendEnable").value=true;a.getStateParam("SourceBlendFunction").value=o3djs.base.o3d.State.BLENDFUNC_SOURCE_ALPHA;a.getStateParam("DestinationBlendFunction").value=o3djs.base.o3d.State.BLENDFUNC_INVERSE_SOURCE_ALPHA;a.getStateParam("AlphaTestEnable").value=c;a.getStateParam("AlphaComparisonFunction").value=o3djs.base.o3d.State.CMP_GREATER;a.getStateParam("AlphaReference").value=
0};o3djs.manipulators.createLineRingMaterial=function(a,b,c,d,e){var f=a.createObject("Material");f.effect=a.createObject("Effect");f.effect.loadFromFXString(o3djs.manipulators.getLineRingFXString_(e));f.drawList=b;f.createParam("color1","ParamFloat4").value=c;f.createParam("color2","ParamFloat4").value=d;o3djs.manipulators.enableAlphaBlendingOnMaterial(a,f,true);return f};
o3djs.manipulators.createConstantMaterial=function(a,b,c){var d=a.createObject("Material");d.effect=a.createObject("Effect");d.effect.loadFromFXString(o3djs.manipulators.constantFXString_);d.drawList=b;d.createParam("color","ParamFloat4").value=c;o3djs.manipulators.enableAlphaBlendingOnMaterial(a,d,false);return d};
o3djs.manipulators.createPhongMaterial=function(a,b,c){var d=a.createObject("Material");d.effect=a.createObject("Effect");d.effect.loadFromFXString(o3djs.manipulators.phongFXString_);d.drawList=b;d.createParam("diffuse","ParamFloat4").value=c;d.createParam("emissive","ParamFloat4").value=[0,0,0,1];d.createParam("ambient","ParamFloat4").value=[0.5,0.5,0.5,1];d.createParam("specular","ParamFloat4").value=[1,1,1,1];d.createParam("shininess","ParamFloat").value=50;d.createParam("specularFactor","ParamFloat").value=
1;d.createParam("lightColor","ParamFloat4").value=[1,1,1,1];d.createParam("lightWorldPos","ParamFloat3").value=[1E3,2E3,3E3];o3djs.manipulators.enableAlphaBlendingOnMaterial(a,d,false);return d};o3djs.provide("o3djs.material");o3djs.require("o3djs.math");o3djs.require("o3djs.effect");o3djs.material=o3djs.material||{};
o3djs.material.hasNonOneAlpha_=function(a,b){var c=false,d=false,e=null,f=a.getParam(b+"Sampler");if(f&&f.isAClassName("o3d.ParamSampler")){c=true;if(f=f.value)e=f.texture}else if((f=a.getParam(b+"Texture"))&&f.isAClassName("o3d.ParamTexture")){c=true;e=f.value}if(e&&!e.alphaIsOne)d=true;if(!c)if((e=a.getParam(b))&&e.isAClassName("o3d.ParamFloat4"))c=true;return{found:c,nonOneAlpha:d}};
o3djs.material.prepareMaterial=function(a,b,c,d){var e=b.performanceDrawList;if(!c.drawList){var f=c.getParam("collada.transparent");if(f&&f.className=="o3d.ParamBoolean")c.drawList=f.value?b.zOrderedDrawList:b.performanceDrawList}if(!c.effect){if(!d)if(f=o3djs.effect.getColladaLightingType(c))d=f;if(d){o3djs.material.attachStandardEffect(a,c,b,d);if(c.drawList==null){a=o3djs.material.hasNonOneAlpha_(c,"diffuse");a.found||(a=o3djs.material.hasNonOneAlpha_(c,"emissive"));if(a.nonOneAlpha)e=b.zOrderedDrawList}}}if(!c.drawList)c.drawList=
e};o3djs.material.prepareMaterials=function(a,b,c){for(var d=a.getObjectsByClassName("o3d.Material"),e=0;e<d.length;e++)o3djs.material.prepareMaterial(c||a,b,d[e])};o3djs.material.attachStandardEffectEx=function(a,b,c){if(!b.effect)if(!o3djs.effect.attachStandardShader(a,b,[0,0,0],c))throw"Could not attach a standard effect";};
o3djs.material.attachStandardEffect=function(a,b,c,d){if(!b.effect){c=o3djs.math.matrix4.getTranslation(o3djs.math.inverse(c.drawContext.view));if(!o3djs.effect.attachStandardShader(a,b,c,d))throw"Could not attach a standard effect";}};o3djs.material.setDrawListOnMaterials=function(a,b){for(var c=a.getObjectsByClassName("o3d.Material"),d=0;d<c.length;d++)c[d].drawList=b};
o3djs.material.createBasicMaterial=function(a,b,c,d){var e=a.createObject("Material");e.drawList=d?b.zOrderedDrawList:b.performanceDrawList;if(c.length)e.createParam("diffuse","ParamFloat4").value=c;else{d=e.createParam("diffuseSampler","ParamSampler");var f=a.createObject("Sampler");d.value=f;f.texture=c}e.createParam("emissive","ParamFloat4").value=[0,0,0,1];e.createParam("ambient","ParamFloat4").value=[0,0,0,1];e.createParam("specular","ParamFloat4").value=[1,1,1,1];e.createParam("shininess","ParamFloat").value=
50;e.createParam("specularFactor","ParamFloat").value=1;e.createParam("lightColor","ParamFloat4").value=[1,1,1,1];c=e.createParam("lightWorldPos","ParamFloat3");o3djs.material.attachStandardEffect(a,e,b,"phong");c.value=[1E3,2E3,3E3];return e};
o3djs.material.createConstantMaterialEx=function(a,b,c){var d=a.createObject("Material");d.drawList=b;if(c.length)d.createParam("emissive","ParamFloat4").value=c;else{b=d.createParam("emissiveSampler","ParamSampler");var e=a.createObject("Sampler");b.value=e;e.texture=c}o3djs.material.attachStandardEffectEx(a,d,"constant");return d};o3djs.material.createConstantMaterial=function(a,b,c,d){return o3djs.material.createConstantMaterialEx(a,d?b.zOrderedDrawList:b.performanceDrawList,c)};
o3djs.material.createCheckerMaterial=function(a,b,c,d,e,f){c=c||[0.4,0.5,0.5,1];d=d||[0.6,0.8,0.8,1];f=f||10;var g=o3djs.effect.createCheckerEffect(a),h=a.createObject("Material");h.effect=g;h.drawList=e?b.zOrderedDrawList:b.performanceDrawList;o3djs.effect.createUniformParameters(a,g,h);h.getParam("color1").value=c;h.getParam("color2").value=d;h.getParam("checkSize").value=f;return h};
o3djs.material.createMaterialFromFile=function(a,b,c){b=o3djs.effect.createEffectFromFile(a,b);var d=a.createObject("Material");d.effect=b;d.drawList=c;o3djs.effect.createUniformParameters(a,b,d);return d};o3djs.material.bindParamsOnMaterial=function(a,b){for(var c in b){var d=b[c],e=a.getParam(c);e&&d.isAClassName(e.className)&&e.bind(d)}};o3djs.material.bindParams=function(a,b){for(var c=a.getObjectsByClassName("o3d.Material"),d=0;d<c.length;++d)o3djs.material.bindParamsOnMaterial(c[d],b)};
o3djs.material.createParams=function(a,b){var c=a.createObject("ParamObject"),d={},e;for(e in b)d[e]=c.createParam(e,b[e]);return d};o3djs.material.createStandardParams=function(a){return o3djs.material.createParams(a,{lightColor:"ParamFloat4",lightWorldPos:"ParamFloat3"})};o3djs.material.createAndBindStandardParams=function(a){var b=o3djs.material.createStandardParams(a);o3djs.material.bindParams(a,b);return b};o3djs.provide("o3djs.math");o3djs.math=o3djs.math||{};o3djs.math.randomSeed_=0;
o3djs.math.RANDOM_RANGE_=Math.pow(2,32);o3djs.math.matrix4=o3djs.math.matrix4||{};o3djs.math.rowMajor=o3djs.math.rowMajor||{};o3djs.math.columnMajor=o3djs.math.columnMajor||{};o3djs.math.errorCheck=o3djs.math.errorCheck||{};o3djs.math.errorCheckFree=o3djs.math.errorCheckFree||{};o3djs.math.Vector2=goog.typedef;o3djs.math.Vector3=goog.typedef;o3djs.math.Vector4=goog.typedef;o3djs.math.Vector=goog.typedef;o3djs.math.Matrix1=goog.typedef;o3djs.math.Matrix2=goog.typedef;o3djs.math.Matrix3=goog.typedef;
o3djs.math.Matrix4=goog.typedef;o3djs.math.Matrix=goog.typedef;o3djs.math.pseudoRandom=function(){var a=o3djs.math;return(a.randomSeed_=(134775813*a.randomSeed_+1)%a.RANDOM_RANGE_)/a.RANDOM_RANGE_};o3djs.math.resetPseudoRandom=function(){o3djs.math.randomSeed_=0};o3djs.math.degToRad=function(a){return a*Math.PI/180};o3djs.math.radToDeg=function(a){return a*180/Math.PI};o3djs.math.lerpScalar=function(a,b,c){return(1-c)*a+c*b};
o3djs.math.addVector=function(a,b){for(var c=[],d=a.length,e=0;e<d;++e)c[e]=a[e]+b[e];return c};o3djs.math.subVector=function(a,b){for(var c=[],d=a.length,e=0;e<d;++e)c[e]=a[e]-b[e];return c};o3djs.math.lerpVector=function(a,b,c){for(var d=[],e=a.length,f=0;f<e;++f)d[f]=(1-c)*a[f]+c*b[f];return d};o3djs.math.modClamp=function(a,b,c){c=c||0;if(b<1.0E-5)return c;a-=c;if(a<0)a-=Math.floor(a/b)*b;else a%=b;return a+c};
o3djs.math.lerpCircular=function(a,b,c,d){a=o3djs.math.modClamp(a,d);b=o3djs.math.modClamp(b,d);var e=b-a;if(Math.abs(e)>d*0.5)if(e>0)b-=d;else b+=d;return o3djs.math.modClamp(o3djs.math.lerpScalar(a,b,c),d)};o3djs.math.lerpRadian=function(a,b,c){return o3djs.math.lerpCircular(a,b,c,Math.PI*2)};o3djs.math.divVectorScalar=function(a,b){for(var c=[],d=a.length,e=0;e<d;++e)c[e]=a[e]/b;return c};o3djs.math.dot=function(a,b){for(var c=0,d=a.length,e=0;e<d;++e)c+=a[e]*b[e];return c};
o3djs.math.cross=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]};o3djs.math.length=function(a){for(var b=0,c=a.length,d=0;d<c;++d)b+=a[d]*a[d];return Math.sqrt(b)};o3djs.math.lengthSquared=function(a){for(var b=0,c=a.length,d=0;d<c;++d)b+=a[d]*a[d];return b};o3djs.math.distance=function(a,b){for(var c=0,d=a.length,e=0;e<d;++e){var f=a[e]-b[e];c+=f*f}return Math.sqrt(c)};
o3djs.math.distanceSquared=function(a,b){for(var c=0,d=a.length,e=0;e<d;++e){var f=a[e]-b[e];c+=f*f}return c};o3djs.math.normalize=function(a){for(var b=[],c=0,d=a.length,e=0;e<d;++e)c+=a[e]*a[e];c=Math.sqrt(c);for(e=0;e<d;++e)b[e]=a[e]/c;return b};o3djs.math.addMatrix=function(a,b){for(var c=[],d=a.length,e=a[0].length,f=0;f<d;++f){for(var g=[],h=a[f],j=b[f],i=0;i<e;++i)g[i]=h[i]+j[i];c[f]=g}return c};
o3djs.math.subMatrix=function(a,b){for(var c=[],d=a.length,e=a[0].length,f=0;f<d;++f){for(var g=[],h=a[f],j=b[f],i=0;i<e;++i)g[i]=h[i]-j[i];c[f]=g}return c};o3djs.math.lerpMatrix=function(a,b,c){for(var d=[],e=a.length,f=a[0].length,g=0;g<e;++g){for(var h=[],j=a[g],i=b[g],k=0;k<f;++k)h[k]=(1-c)*j[k]+c*i[k];d[g]=h}return d};o3djs.math.divMatrixScalar=function(a,b){for(var c=[],d=a.length,e=a[0].length,f=0;f<d;++f){c[f]=[];for(var g=0;g<e;++g)c[f][g]=a[f][g]/b}return c};o3djs.math.negativeScalar=function(a){return-a};
o3djs.math.negativeVector=function(a){for(var b=[],c=a.length,d=0;d<c;++d)b[d]=-a[d];return b};o3djs.math.negativeMatrix=function(a){for(var b=[],c=a.length,d=a[0].length,e=0;e<c;++e){b[e]=[];for(var f=0;f<d;++f)b[e][f]=-a[e][f]}return b};o3djs.math.copyScalar=function(a){return a};o3djs.math.copyVector=function(a){for(var b=[],c=0;c<a.length;c++)b[c]=a[c];return b};o3djs.math.copyMatrix=function(a){for(var b=[],c=a.length,d=0;d<c;++d){b[d]=[];for(var e=0;e<a[d].length;e++)b[d][e]=a[d][e]}return b};
o3djs.math.getMatrixElements=function(a){for(var b=[],c=a.length,d=0,e=0;e<c;e++)for(var f=0;f<a[e].length;f++)b[d++]=a[e][f];return b};o3djs.math.mulScalarScalar=function(a,b){return a*b};o3djs.math.mulScalarVector=function(a,b){for(var c=[],d=b.length,e=0;e<d;++e)c[e]=a*b[e];return c};o3djs.math.mulVectorScalar=function(a,b){return o3djs.math.mulScalarVector(b,a)};o3djs.math.mulScalarMatrix=function(a,b){for(var c=[],d=b.length,e=b[0].length,f=0;f<d;++f){c[f]=[];for(var g=0;g<e;++g)c[f][g]=a*b[f][g]}return c};
o3djs.math.mulMatrixScalar=function(a,b){return o3djs.math.mulScalarMatrix(b,a)};o3djs.math.mulVectorVector=function(a,b){for(var c=[],d=a.length,e=0;e<d;++e)c[e]=a[e]*b[e];return c};o3djs.math.divVectorVector=function(a,b){for(var c=[],d=a.length,e=0;e<d;++e)c[e]=a[e]/b[e];return c};o3djs.math.rowMajor.mulVectorMatrix=function(a,b){for(var c=[],d=b[0].length,e=a.length,f=0;f<d;++f)for(var g=c[f]=0;g<e;++g)c[f]+=a[g]*b[g][f];return c};
o3djs.math.columnMajor.mulVectorMatrix=function(a,b){for(var c=[],d=b.length,e=a.length,f=0;f<d;++f){c[f]=0;for(var g=b[f],h=0;h<e;++h)c[f]+=a[h]*g[h]}return c};o3djs.math.mulVectorMatrix=null;o3djs.math.rowMajor.mulMatrixVector=function(a,b){for(var c=[],d=a.length,e=a[0].length,f=0;f<d;++f){c[f]=0;for(var g=a[f],h=0;h<e;++h)c[f]+=g[h]*b[h]}return c};
o3djs.math.columnMajor.mulMatrixVector=function(a,b){for(var c=[],d=a[0].length,e=b.length,f=0;f<d;++f)for(var g=c[f]=0;g<e;++g)c[f]+=b[g]*a[g][f];return c};o3djs.math.mulMatrixVector=null;o3djs.math.rowMajor.mulMatrixMatrix2=function(a,b){var c=a[0],d=a[1],e=b[0],f=b[1],g=c[0];c=c[1];var h=d[0];d=d[1];var j=e[0];e=e[1];var i=f[0];f=f[1];return[[g*j+c*i,g*e+c*f],[h*j+d*i,h*e+d*f]]};
o3djs.math.columnMajor.mulMatrixMatrix2=function(a,b){var c=a[0],d=a[1],e=b[0],f=b[1],g=c[0];c=c[1];var h=d[0];d=d[1];var j=e[0];e=e[1];var i=f[0];f=f[1];return[[g*j+h*e,c*j+d*e],[g*i+h*f,c*i+d*f]]};o3djs.math.mulMatrixMatrix2=null;
o3djs.math.rowMajor.mulMatrixMatrix3=function(a,b){var c=a[0],d=a[1],e=a[2],f=b[0],g=b[1],h=b[2],j=c[0],i=c[1];c=c[2];var k=d[0],l=d[1];d=d[2];var m=e[0],n=e[1];e=e[2];var r=f[0],o=f[1];f=f[2];var q=g[0],p=g[1];g=g[2];var t=h[0],u=h[1];h=h[2];return[[j*r+i*q+c*t,j*o+i*p+c*u,j*f+i*g+c*h],[k*r+l*q+d*t,k*o+l*p+d*u,k*f+l*g+d*h],[m*r+n*q+e*t,m*o+n*p+e*u,m*f+n*g+e*h]]};
o3djs.math.columnMajor.mulMatrixMatrix3=function(a,b){var c=a[0],d=a[1],e=a[2],f=b[0],g=b[1],h=b[2],j=c[0],i=c[1];c=c[2];var k=d[0],l=d[1];d=d[2];var m=e[0],n=e[1];e=e[2];var r=f[0],o=f[1];f=f[2];var q=g[0],p=g[1];g=g[2];var t=h[0],u=h[1];h=h[2];return[[j*r+k*o+m*f,i*r+l*o+n*f,c*r+d*o+e*f],[j*q+k*p+m*g,i*q+l*p+n*g,c*q+d*p+e*g],[j*t+k*u+m*h,i*t+l*u+n*h,c*t+d*u+e*h]]};o3djs.math.mulMatrixMatrix3=null;
o3djs.math.rowMajor.mulMatrixMatrix4=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=b[0],h=b[1],j=b[2],i=b[3],k=c[0],l=c[1],m=c[2];c=c[3];var n=d[0],r=d[1],o=d[2];d=d[3];var q=e[0],p=e[1],t=e[2];e=e[3];var u=f[0],x=f[1],w=f[2];f=f[3];var y=g[0],s=g[1],v=g[2];g=g[3];var A=h[0],B=h[1],D=h[2];h=h[3];var C=j[0],z=j[1],E=j[2];j=j[3];var F=i[0],G=i[1],H=i[2];i=i[3];return[[k*y+l*A+m*C+c*F,k*s+l*B+m*z+c*G,k*v+l*D+m*E+c*H,k*g+l*h+m*j+c*i],[n*y+r*A+o*C+d*F,n*s+r*B+o*z+d*G,n*v+r*D+o*E+d*H,n*g+r*h+o*j+d*i],
[q*y+p*A+t*C+e*F,q*s+p*B+t*z+e*G,q*v+p*D+t*E+e*H,q*g+p*h+t*j+e*i],[u*y+x*A+w*C+f*F,u*s+x*B+w*z+f*G,u*v+x*D+w*E+f*H,u*g+x*h+w*j+f*i]]};
o3djs.math.columnMajor.mulMatrixMatrix4=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=b[0],h=b[1],j=b[2],i=b[3],k=c[0],l=c[1],m=c[2];c=c[3];var n=d[0],r=d[1],o=d[2];d=d[3];var q=e[0],p=e[1],t=e[2];e=e[3];var u=f[0],x=f[1],w=f[2];f=f[3];var y=g[0],s=g[1],v=g[2];g=g[3];var A=h[0],B=h[1],D=h[2];h=h[3];var C=j[0],z=j[1],E=j[2];j=j[3];var F=i[0],G=i[1],H=i[2];i=i[3];return[[k*y+n*s+q*v+u*g,l*y+r*s+p*v+x*g,m*y+o*s+t*v+w*g,c*y+d*s+e*v+f*g],[k*A+n*B+q*D+u*h,l*A+r*B+p*D+x*h,m*A+o*B+t*D+w*h,c*A+d*B+e*D+f*
h],[k*C+n*z+q*E+u*j,l*C+r*z+p*E+x*j,m*C+o*z+t*E+w*j,c*C+d*z+e*E+f*j],[k*F+n*G+q*H+u*i,l*F+r*G+p*H+x*i,m*F+o*G+t*H+w*i,c*F+d*G+e*H+f*i]]};o3djs.math.mulMatrixMatrix4=null;o3djs.math.rowMajor.mulMatrixMatrix=function(a,b){for(var c=[],d=a.length,e=b[0].length,f=b.length,g=0;g<d;++g){for(var h=[],j=a[g],i=0;i<e;++i)for(var k=h[i]=0;k<f;++k)h[i]+=j[k]*b[k][i];c[g]=h}return c};
o3djs.math.columnMajor.mulMatrixMatrix=function(a,b){for(var c=[],d=b.length,e=a[0].length,f=a.length,g=0;g<d;++g){for(var h=[],j=b[g],i=0;i<e;++i)for(var k=h[i]=0;k<f;++k)h[i]+=j[k]*a[k][i];c[g]=h}return c};o3djs.math.mulMatrixMatrix=null;o3djs.math.rowMajor.column=function(a,b){for(var c=[],d=a.length,e=0;e<d;++e)c[e]=a[e][b];return c};o3djs.math.columnMajor.column=function(a,b){return a[b].slice()};o3djs.math.column=null;o3djs.math.rowMajor.row=function(a,b){return a[b].slice()};
o3djs.math.columnMajor.row=function(a,b){for(var c=[],d=a.length,e=0;e<d;++e)c[e]=a[e][b];return c};o3djs.math.row=null;o3djs.math.identity=function(a){for(var b=[],c=0;c<a;++c){b[c]=[];for(var d=0;d<a;++d)b[c][d]=d==c?1:0}return b};o3djs.math.transpose=function(a){for(var b=[],c=a[0].length,d=a.length,e=0;e<c;++e){b[e]=[];for(var f=0;f<d;++f)b[e][f]=a[f][e]}return b};o3djs.math.trace=function(a){for(var b=0,c=a.length,d=0;d<c;++d)b+=a[d][d];return b};o3djs.math.det1=function(a){return a[0][0]};
o3djs.math.det2=function(a){return a[0][0]*a[1][1]-a[0][1]*a[1][0]};o3djs.math.det3=function(a){return a[2][2]*(a[0][0]*a[1][1]-a[0][1]*a[1][0])-a[2][1]*(a[0][0]*a[1][2]-a[0][2]*a[1][0])+a[2][0]*(a[0][1]*a[1][2]-a[0][2]*a[1][1])};
o3djs.math.det4=function(a){var b=a[0][0]*a[1][1]-a[0][1]*a[1][0],c=a[0][0]*a[1][2]-a[0][2]*a[1][0],d=a[0][0]*a[1][3]-a[0][3]*a[1][0],e=a[0][1]*a[1][2]-a[0][2]*a[1][1],f=a[0][1]*a[1][3]-a[0][3]*a[1][1],g=a[0][2]*a[1][3]-a[0][3]*a[1][2];return a[3][3]*(a[2][2]*b-a[2][1]*c+a[2][0]*e)-a[3][2]*(a[2][3]*b-a[2][1]*d+a[2][0]*f)+a[3][1]*(a[2][3]*c-a[2][2]*d+a[2][0]*g)-a[3][0]*(a[2][3]*e-a[2][2]*f+a[2][1]*g)};o3djs.math.inverse1=function(a){return[[1/a[0][0]]]};
o3djs.math.inverse2=function(a){var b=1/(a[0][0]*a[1][1]-a[0][1]*a[1][0]);return[[b*a[1][1],-b*a[0][1]],[-b*a[1][0],b*a[0][0]]]};
o3djs.math.inverse3=function(a){var b=a[1][1]*a[2][2]-a[1][2]*a[2][1],c=a[0][1]*a[2][2]-a[0][2]*a[2][1],d=a[0][1]*a[1][2]-a[0][2]*a[1][1],e=1/(a[0][0]*b-a[1][0]*c+a[2][0]*d);return[[e*b,-e*c,e*d],[-e*(a[1][0]*a[2][2]-a[1][2]*a[2][0]),e*(a[0][0]*a[2][2]-a[0][2]*a[2][0]),-e*(a[0][0]*a[1][2]-a[0][2]*a[1][0])],[e*(a[1][0]*a[2][1]-a[1][1]*a[2][0]),-e*(a[0][0]*a[2][1]-a[0][1]*a[2][0]),e*(a[0][0]*a[1][1]-a[0][1]*a[1][0])]]};
o3djs.math.inverse4=function(a){var b=a[2][2]*a[3][3],c=a[3][2]*a[2][3],d=a[1][2]*a[3][3],e=a[3][2]*a[1][3],f=a[1][2]*a[2][3],g=a[2][2]*a[1][3],h=a[0][2]*a[3][3],j=a[3][2]*a[0][3],i=a[0][2]*a[2][3],k=a[2][2]*a[0][3],l=a[0][2]*a[1][3],m=a[1][2]*a[0][3],n=a[2][0]*a[3][1],r=a[3][0]*a[2][1],o=a[1][0]*a[3][1],q=a[3][0]*a[1][1],p=a[1][0]*a[2][1],t=a[2][0]*a[1][1],u=a[0][0]*a[3][1],x=a[3][0]*a[0][1],w=a[0][0]*a[2][1],y=a[2][0]*a[0][1],s=a[0][0]*a[1][1],v=a[1][0]*a[0][1],A=b*a[1][1]+e*a[2][1]+f*a[3][1]-(c*
a[1][1]+d*a[2][1]+g*a[3][1]),B=c*a[0][1]+h*a[2][1]+k*a[3][1]-(b*a[0][1]+j*a[2][1]+i*a[3][1]),D=d*a[0][1]+j*a[1][1]+l*a[3][1]-(e*a[0][1]+h*a[1][1]+m*a[3][1]),C=g*a[0][1]+i*a[1][1]+m*a[2][1]-(f*a[0][1]+k*a[1][1]+l*a[2][1]),z=1/(a[0][0]*A+a[1][0]*B+a[2][0]*D+a[3][0]*C);return[[z*A,z*B,z*D,z*C],[z*(c*a[1][0]+d*a[2][0]+g*a[3][0]-(b*a[1][0]+e*a[2][0]+f*a[3][0])),z*(b*a[0][0]+j*a[2][0]+i*a[3][0]-(c*a[0][0]+h*a[2][0]+k*a[3][0])),z*(e*a[0][0]+h*a[1][0]+m*a[3][0]-(d*a[0][0]+j*a[1][0]+l*a[3][0])),z*(f*a[0][0]+
k*a[1][0]+l*a[2][0]-(g*a[0][0]+i*a[1][0]+m*a[2][0]))],[z*(n*a[1][3]+q*a[2][3]+p*a[3][3]-(r*a[1][3]+o*a[2][3]+t*a[3][3])),z*(r*a[0][3]+u*a[2][3]+y*a[3][3]-(n*a[0][3]+x*a[2][3]+w*a[3][3])),z*(o*a[0][3]+x*a[1][3]+s*a[3][3]-(q*a[0][3]+u*a[1][3]+v*a[3][3])),z*(t*a[0][3]+w*a[1][3]+v*a[2][3]-(p*a[0][3]+y*a[1][3]+s*a[2][3]))],[z*(o*a[2][2]+t*a[3][2]+r*a[1][2]-(p*a[3][2]+n*a[1][2]+q*a[2][2])),z*(w*a[3][2]+n*a[0][2]+x*a[2][2]-(u*a[2][2]+y*a[3][2]+r*a[0][2])),z*(u*a[1][2]+v*a[3][2]+q*a[0][2]-(s*a[3][2]+o*a[0][2]+
x*a[1][2])),z*(s*a[2][2]+p*a[0][2]+y*a[1][2]-(w*a[1][2]+v*a[2][2]+t*a[0][2]))]]};o3djs.math.codet=function(a,b,c){for(var d=a.length,e=[],f=0,g=0;g<d-1;++g){f==b&&f++;e[g]=[];for(var h=0,j=0;j<d-1;++j){h==c&&h++;e[g][j]=a[f][h];h++}f++}return o3djs.math.det(e)};o3djs.math.det=function(a){var b=a.length;if(b<=4)return o3djs.math["det"+b](a);b=0;for(var c=1,d=a[0],e=a.length,f=0;f<e;f++){b+=c*d[f]*o3djs.math.codet(a,0,f);c*=-1}return b};
o3djs.math.inverse=function(a){var b=a.length;if(b<=4)return o3djs.math["inverse"+b](a);b=[];for(var c=a.length,d=0;d<c;++d){b[d]=[];for(var e=0;e<c;++e)b[d][e]=((e+d)%2?-1:1)*o3djs.math.codet(a,e,d)}return o3djs.math.divMatrixScalar(b,o3djs.math.det(a))};o3djs.math.orthonormalize=function(a){for(var b=[],c=a.length,d=0;d<c;++d){for(var e=a[d],f=0;f<d;++f)e=o3djs.math.subVector(e,o3djs.math.mulScalarVector(o3djs.math.dot(b[f],a[d]),b[f]));b[d]=o3djs.math.normalize(e)}return b};
o3djs.math.matrix4.inverse=function(a){return o3djs.math.inverse4(a)};o3djs.math.matrix4.mul=function(a,b){return o3djs.math.mulMatrixMatrix4(a,b)};o3djs.math.matrix4.det=function(a){return o3djs.math.det4(a)};o3djs.math.matrix4.copy=function(a){return o3djs.math.copyMatrix(a)};o3djs.math.matrix4.setUpper3x3=function(a,b){var c=b[0],d=b[1],e=b[2];a[0].splice(0,3,c[0],c[1],c[2]);a[1].splice(0,3,d[0],d[1],d[2]);a[2].splice(0,3,e[0],e[1],e[2]);return a};
o3djs.math.matrix4.getUpper3x3=function(a){return[a[0].slice(0,3),a[1].slice(0,3),a[2].slice(0,3)]};o3djs.math.matrix4.setTranslation=function(a,b){a[3].splice(0,4,b[0],b[1],b[2],1);return a};o3djs.math.matrix4.getTranslation=function(a){return a[3].slice(0,3)};o3djs.math.matrix4.transformPoint=function(a,b){var c=b[0],d=b[1],e=b[2],f=a[0],g=a[1],h=a[2],j=a[3],i=c*f[3]+d*g[3]+e*h[3]+j[3];return[(c*f[0]+d*g[0]+e*h[0]+j[0])/i,(c*f[1]+d*g[1]+e*h[1]+j[1])/i,(c*f[2]+d*g[2]+e*h[2]+j[2])/i]};
o3djs.math.matrix4.transformVector4=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=a[0],h=a[1],j=a[2],i=a[3];return[c*g[0]+d*h[0]+e*j[0]+f*i[0],c*g[1]+d*h[1]+e*j[1]+f*i[1],c*g[2]+d*h[2]+e*j[2]+f*i[2],c*g[3]+d*h[3]+e*j[3]+f*i[3]]};o3djs.math.matrix4.transformDirection=function(a,b){var c=b[0],d=b[1],e=b[2],f=a[0],g=a[1],h=a[2];return[c*f[0]+d*g[0]+e*h[0],c*f[1]+d*g[1]+e*h[1],c*f[2]+d*g[2]+e*h[2]]};
o3djs.math.matrix4.transformNormal=function(a,b){var c=o3djs.math.inverse4(a),d=b[0],e=b[1],f=b[2],g=c[0],h=c[1];c=c[2];return[d*g[0]+e*g[1]+f*g[2],d*h[0]+e*h[1]+f*h[2],d*c[0]+e*c[1]+f*c[2]]};o3djs.math.matrix4.identity=function(){return[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]]};o3djs.math.matrix4.setIdentity=function(a){for(var b=0;b<4;b++)for(var c=0;c<4;c++)a[b][c]=b==c?1:0;return a};
o3djs.math.matrix4.perspective=function(a,b,c,d){a=Math.tan(0.5*(Math.PI-a));var e=c-d;return[[a/b,0,0,0],[0,a,0,0],[0,0,d/e,-1],[0,0,c*d/e,0]]};o3djs.math.matrix4.orthographic=function(a,b,c,d,e,f){return[[2/(b-a),0,0,0],[0,2/(d-c),0,0],[0,0,1/(e-f),0],[(a+b)/(a-b),(c+d)/(c-d),e/(e-f),1]]};o3djs.math.matrix4.frustum=function(a,b,c,d,e,f){var g=b-a,h=d-c,j=e-f;return[[2*e/g,0,0,0],[0,2*e/h,0,0],[(a+b)/g,(d+c)/h,f/j,-1],[0,0,e*f/j,0]]};
o3djs.math.matrix4.lookAt=function(a,b,c){b=o3djs.math.normalize(o3djs.math.subVector(a,b).slice(0,3)).concat(0);c=o3djs.math.normalize(o3djs.math.cross(c,b)).concat(0);var d=o3djs.math.cross(b,c).concat(0);return o3djs.math.inverse([c,d,b,a.concat(1)])};
o3djs.math.matrix4.composition=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=b[0],h=b[1],j=b[2],i=b[3],k=c[0],l=c[1],m=c[2];c=c[3];var n=d[0],r=d[1],o=d[2];d=d[3];var q=e[0],p=e[1],t=e[2];e=e[3];var u=f[0],x=f[1],w=f[2];f=f[3];var y=g[0],s=g[1],v=g[2];g=g[3];var A=h[0],B=h[1],D=h[2];h=h[3];var C=j[0],z=j[1],E=j[2];j=j[3];var F=i[0],G=i[1],H=i[2];i=i[3];return[[k*y+n*s+q*v+u*g,l*y+r*s+p*v+x*g,m*y+o*s+t*v+w*g,c*y+d*s+e*v+f*g],[k*A+n*B+q*D+u*h,l*A+r*B+p*D+x*h,m*A+o*B+t*D+w*h,c*A+d*B+e*D+f*h],[k*C+
n*z+q*E+u*j,l*C+r*z+p*E+x*j,m*C+o*z+t*E+w*j,c*C+d*z+e*E+f*j],[k*F+n*G+q*H+u*i,l*F+r*G+p*H+x*i,m*F+o*G+t*H+w*i,c*F+d*G+e*H+f*i]]};
o3djs.math.matrix4.compose=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=b[0],h=b[1],j=b[2],i=b[3],k=c[0],l=c[1],m=c[2];c=c[3];var n=d[0],r=d[1],o=d[2];d=d[3];var q=e[0],p=e[1],t=e[2];e=e[3];var u=f[0],x=f[1],w=f[2];f=f[3];var y=g[0],s=g[1],v=g[2];g=g[3];var A=h[0],B=h[1],D=h[2];h=h[3];var C=j[0],z=j[1],E=j[2];j=j[3];var F=i[0],G=i[1],H=i[2];i=i[3];a[0].splice(0,4,k*y+n*s+q*v+u*g,l*y+r*s+p*v+x*g,m*y+o*s+t*v+w*g,c*y+d*s+e*v+f*g);a[1].splice(0,4,k*A+n*B+q*D+u*h,l*A+r*B+p*D+x*h,m*A+o*B+t*D+w*h,c*A+
d*B+e*D+f*h);a[2].splice(0,4,k*C+n*z+q*E+u*j,l*C+r*z+p*E+x*j,m*C+o*z+t*E+w*j,c*C+d*z+e*E+f*j);a[3].splice(0,4,k*F+n*G+q*H+u*i,l*F+r*G+p*H+x*i,m*F+o*G+t*H+w*i,c*F+d*G+e*H+f*i);return a};o3djs.math.matrix4.translation=function(a){return[[1,0,0,0],[0,1,0,0],[0,0,1,0],[a[0],a[1],a[2],1]]};o3djs.math.matrix4.translate=function(a,b){var c=b[0],d=b[1],e=b[2],f=a[0],g=a[1],h=a[2],j=a[3];j.splice(0,4,f[0]*c+g[0]*d+h[0]*e+j[0],f[1]*c+g[1]*d+h[1]*e+j[1],f[2]*c+g[2]*d+h[2]*e+j[2],f[3]*c+g[3]*d+h[3]*e+j[3]);return a};
o3djs.math.matrix4.scaling=function(a){return[[a[0],0,0,0],[0,a[1],0,0],[0,0,a[2],0],[0,0,0,1]]};o3djs.math.matrix4.scale=function(a,b){var c=b[0],d=b[1],e=b[2],f=a[0],g=a[1],h=a[2];f.splice(0,4,c*f[0],c*f[1],c*f[2],c*f[3]);g.splice(0,4,d*g[0],d*g[1],d*g[2],d*g[3]);h.splice(0,4,e*h[0],e*h[1],e*h[2],e*h[3]);return a};o3djs.math.matrix4.rotationX=function(a){var b=Math.cos(a);a=Math.sin(a);return[[1,0,0,0],[0,b,a,0],[0,-a,b,0],[0,0,0,1]]};
o3djs.math.matrix4.rotateX=function(a,b){var c=a[1],d=a[2],e=c[0],f=c[1],g=c[2],h=c[3],j=d[0],i=d[1],k=d[2],l=d[3],m=Math.cos(b),n=Math.sin(b);c.splice(0,4,m*e+n*j,m*f+n*i,m*g+n*k,m*h+n*l);d.splice(0,4,m*j-n*e,m*i-n*f,m*k-n*g,m*l-n*h);return a};o3djs.math.matrix4.rotationY=function(a){var b=Math.cos(a);a=Math.sin(a);return[[b,0,-a,0],[0,1,0,0],[a,0,b,0],[0,0,0,1]]};
o3djs.math.matrix4.rotateY=function(a,b){var c=a[0],d=a[2],e=c[0],f=c[1],g=c[2],h=c[3],j=d[0],i=d[1],k=d[2],l=d[3],m=Math.cos(b),n=Math.sin(b);c.splice(0,4,m*e-n*j,m*f-n*i,m*g-n*k,m*h-n*l);d.splice(0,4,m*j+n*e,m*i+n*f,m*k+n*g,m*l+n*h);return a};o3djs.math.matrix4.rotationZ=function(a){var b=Math.cos(a);a=Math.sin(a);return[[b,a,0,0],[-a,b,0,0],[0,0,1,0],[0,0,0,1]]};
o3djs.math.matrix4.rotateZ=function(a,b){var c=a[0],d=a[1],e=c[0],f=c[1],g=c[2],h=c[3],j=d[0],i=d[1],k=d[2],l=d[3],m=Math.cos(b),n=Math.sin(b);c.splice(0,4,m*e+n*j,m*f+n*i,m*g+n*k,m*h+n*l);d.splice(0,4,m*j-n*e,m*i-n*f,m*k-n*g,m*l-n*h);return a};o3djs.math.matrix4.rotationZYX=function(a){var b=Math.sin(a[0]),c=Math.cos(a[0]),d=Math.sin(a[1]),e=Math.cos(a[1]),f=Math.sin(a[2]);a=Math.cos(a[2]);var g=a*d,h=f*d;return[[a*e,f*e,-d,0],[g*b-f*c,h*b+a*c,e*b,0],[g*c+f*b,h*c-a*b,e*c,0],[0,0,0,1]]};
o3djs.math.matrix4.rotateZYX=function(a,b){var c=Math.sin(b[0]),d=Math.cos(b[0]),e=Math.sin(b[1]),f=Math.cos(b[1]),g=Math.sin(b[2]),h=Math.cos(b[2]),j=h*e,i=g*e,k=h*f,l=g*f;e=-e;var m=j*c-g*d,n=i*c+h*d,r=f*c;g=j*d+g*c;c=i*d-h*c;d*=f;f=a[0];h=a[1];i=a[2];j=f[0];var o=f[1],q=f[2],p=f[3],t=h[0],u=h[1],x=h[2],w=h[3],y=i[0],s=i[1],v=i[2],A=i[3];f.splice(0,4,k*j+l*t+e*y,k*o+l*u+e*s,k*q+l*x+e*v,k*p+l*w+e*A);h.splice(0,4,m*j+n*t+r*y,m*o+n*u+r*s,m*q+n*x+r*v,m*p+n*w+r*A);i.splice(0,4,g*j+c*t+d*y,g*o+c*u+d*
s,g*q+c*x+d*v,g*p+c*w+d*A);return a};o3djs.math.matrix4.axisRotation=function(a,b){var c=a[0],d=a[1],e=a[2],f=Math.sqrt(c*c+d*d+e*e);c/=f;d/=f;e/=f;f=c*c;var g=d*d,h=e*e,j=Math.cos(b),i=Math.sin(b),k=1-j;return[[f+(1-f)*j,c*d*k+e*i,c*e*k-d*i,0],[c*d*k-e*i,g+(1-g)*j,d*e*k+c*i,0],[c*e*k+d*i,d*e*k-c*i,h+(1-h)*j,0],[0,0,0,1]]};
o3djs.math.matrix4.axisRotate=function(a,b,c){var d=b[0],e=b[1],f=b[2];b=Math.sqrt(d*d+e*e+f*f);d/=b;e/=b;f/=b;b=d*d;var g=e*e,h=f*f,j=Math.cos(c),i=Math.sin(c),k=1-j;c=b+(1-b)*j;b=d*e*k+f*i;var l=d*f*k-e*i,m=d*e*k-f*i;g+=(1-g)*j;var n=e*f*k+d*i,r=d*f*k+e*i;d=e*f*k-d*i;e=h+(1-h)*j;f=a[0];h=a[1];j=a[2];i=f[0];k=f[1];var o=f[2],q=f[3],p=h[0],t=h[1],u=h[2],x=h[3],w=j[0],y=j[1],s=j[2],v=j[3];f.splice(0,4,c*i+b*p+l*w,c*k+b*t+l*y,c*o+b*u+l*s,c*q+b*x+l*v);h.splice(0,4,m*i+g*p+n*w,m*k+g*t+n*y,m*o+g*u+n*s,
m*q+g*x+n*v);j.splice(0,4,r*i+d*p+e*w,r*k+d*t+e*y,r*o+d*u+e*s,r*q+d*x+e*v);return a};o3djs.math.installRowMajorFunctions=function(){for(var a in o3djs.math.rowMajor)o3djs.math[a]=o3djs.math.rowMajor[a]};o3djs.math.installColumnMajorFunctions=function(){for(var a in o3djs.math.columnMajor)o3djs.math[a]=o3djs.math.columnMajor[a]};o3djs.math.installErrorCheckFunctions=function(){for(var a in o3djs.math.errorCheck)o3djs.math[a]=o3djs.math.errorCheck[a]};
o3djs.math.installErrorCheckFreeFunctions=function(){for(var a in o3djs.math.errorCheckFree)o3djs.math[a]=o3djs.math.errorCheckFree[a]};o3djs.math.installRowMajorFunctions();o3djs.math.installErrorCheckFunctions();o3djs.provide("o3djs.pack");o3djs.require("o3djs.material");o3djs.require("o3djs.shape");o3djs.pack=o3djs.pack||{};o3djs.pack.preparePack=function(a,b,c){o3djs.material.prepareMaterials(a,b,c);o3djs.shape.prepareShapes(a)};o3djs.provide("o3djs.particles");o3djs.require("o3djs.effect");o3djs.require("o3djs.math");
o3djs.particles=o3djs.particles||{};o3djs.particles.ParticleStateIds={BLEND:0,ADD:1,BLEND_PREMULTIPLY:2,BLEND_NO_ALPHA:3,SUBTRACT:4,INVERSE:5};
o3djs.particles.FX_STRINGS_CG=[{name:"particle3d",fxString:"float4x4 worldViewProjection : WORLDVIEWPROJECTION;\nfloat4x4 world : WORLD;\nfloat3 worldVelocity;\nfloat3 worldAcceleration;\nfloat timeRange;\nfloat time;\nfloat timeOffset;\nfloat frameDuration;\nfloat numFrames;\n\n// We need to implement 1D!\nsampler rampSampler;\nsampler colorSampler;\n\nstruct VertexShaderInput {\n  float4 uvLifeTimeFrameStart : POSITION; // uv, lifeTime, frameStart\n  float4 positionStartTime : TEXCOORD0;    // position.xyz, startTime\n  float4 velocityStartSize : TEXCOORD1;   // velocity.xyz, startSize\n  float4 accelerationEndSize : TEXCOORD2; // acceleration.xyz, endSize\n  float4 spinStartSpinSpeed : TEXCOORD3;  // spinStart.x, spinSpeed.y\n  float4 orientation : TEXCOORD4;  // orientation\n  float4 colorMult : COLOR; //\n};\n\nstruct PixelShaderInput {\n  float4 position : POSITION;\n  float2 texcoord : TEXCOORD0;\n  float1 percentLife : TEXCOORD1;\n  float4 colorMult: TEXCOORD2;\n};\n\nPixelShaderInput vertexShaderFunction(VertexShaderInput input) {\n  PixelShaderInput output;\n\n  float2 uv = input.uvLifeTimeFrameStart.xy;\n  float lifeTime = input.uvLifeTimeFrameStart.z;\n  float frameStart = input.uvLifeTimeFrameStart.w;\n  float3 position = input.positionStartTime.xyz;\n  float startTime = input.positionStartTime.w;\n  float3 velocity = mul(float4(input.velocityStartSize.xyz, 0),\n                        world).xyz + worldVelocity;\n  float startSize = input.velocityStartSize.w;\n  float3 acceleration = mul(float4(input.accelerationEndSize.xyz, 0),\n                            world).xyz + worldAcceleration;\n  float endSize = input.accelerationEndSize.w;\n  float spinStart = input.spinStartSpinSpeed.x;\n  float spinSpeed = input.spinStartSpinSpeed.y;\n\n  float localTime = fmod((time - timeOffset - startTime), timeRange);\n  float percentLife = localTime / lifeTime;\n\n  float frame = fmod(floor(localTime / frameDuration + frameStart),\n                     numFrames);\n  float uOffset = frame / numFrames;\n  float u = uOffset + (uv.x + 0.5) * (1 / numFrames);\n\n  output.texcoord = float2(u, uv.y + 0.5);\n  output.colorMult = input.colorMult;\n\n  float size = lerp(startSize, endSize, percentLife);\n  size = (percentLife < 0 || percentLife > 1) ? 0 : size;\n  float s = sin(spinStart + spinSpeed * localTime);\n  float c = cos(spinStart + spinSpeed * localTime);\n\n  float4 rotatedPoint = float4((uv.x * c + uv.y * s) * size, 0,\n                               (uv.x * s - uv.y * c) * size, 1);\n  float3 center = velocity * localTime +\n                  acceleration * localTime * localTime + \n                  position;\n  \n      float4 q2 = input.orientation + input.orientation;\n      float4 qx = input.orientation.xxxw * q2.xyzx;\n      float4 qy = input.orientation.xyyw * q2.xyzy;\n      float4 qz = input.orientation.xxzw * q2.xxzz;\n  \n      float4x4 localMatrix = float4x4(\n        (1.0f - qy.y) - qz.z, \n        qx.y + qz.w, \n        qx.z - qy.w,\n        0,\n  \n        qx.y - qz.w, \n        (1.0f - qx.x) - qz.z, \n        qy.z + qx.w,\n        0,\n  \n        qx.z + qy.w, \n        qy.z - qx.w, \n        (1.0f - qx.x) - qy.y,\n        0,\n  \n        center.x, center.y, center.z, 1);\n  rotatedPoint = mul(rotatedPoint, localMatrix);\n  output.position = mul(rotatedPoint, worldViewProjection);\n  output.percentLife = percentLife;\n  return output;\n}\n\nfloat4 pixelShaderFunction(PixelShaderInput input): COLOR {\n  float4 colorMult = tex2D(rampSampler, \n                           float2(input.percentLife, 0.5)) *\n                     input.colorMult;\n  float4 color = tex2D(colorSampler, input.texcoord) * colorMult;\n  return color;\n}\n\n// #o3d VertexShaderEntryPoint vertexShaderFunction\n// #o3d PixelShaderEntryPoint pixelShaderFunction\n// #o3d MatrixLoadOrder RowMajor\n"},{name:"particle2d",
fxString:"float4x4 viewProjection : VIEWPROJECTION;\nfloat4x4 world : WORLD;\nfloat4x4 viewInverse : VIEWINVERSE;\nfloat3 worldVelocity;\nfloat3 worldAcceleration;\nfloat timeRange;\nfloat time;\nfloat timeOffset;\nfloat frameDuration;\nfloat numFrames;\n\n// We need to implement 1D!\nsampler rampSampler;\nsampler colorSampler;\n\nstruct VertexShaderInput {\n  float4 uvLifeTimeFrameStart : POSITION; // uv, lifeTime, frameStart\n  float4 positionStartTime : TEXCOORD0;    // position.xyz, startTime\n  float4 velocityStartSize : TEXCOORD1;   // velocity.xyz, startSize\n  float4 accelerationEndSize : TEXCOORD2; // acceleration.xyz, endSize\n  float4 spinStartSpinSpeed : TEXCOORD3;  // spinStart.x, spinSpeed.y\n  float4 colorMult : COLOR; //\n};\n\nstruct PixelShaderInput {\n  float4 position : POSITION;\n  float2 texcoord : TEXCOORD0;\n  float1 percentLife : TEXCOORD1;\n  float4 colorMult: TEXCOORD2;\n};\n\nPixelShaderInput vertexShaderFunction(VertexShaderInput input) {\n  PixelShaderInput output;\n\n  float2 uv = input.uvLifeTimeFrameStart.xy;\n  float lifeTime = input.uvLifeTimeFrameStart.z;\n  float frameStart = input.uvLifeTimeFrameStart.w;\n  float3 position = mul(float4(input.positionStartTime.xyz, 1),\n                        world).xyz;\n  float startTime = input.positionStartTime.w;\n  float3 velocity = mul(float4(input.velocityStartSize.xyz, 0),\n                        world).xyz + worldVelocity;\n  float startSize = input.velocityStartSize.w;\n  float3 acceleration = mul(float4(input.accelerationEndSize.xyz, 0),\n                            world).xyz + worldAcceleration;\n  float endSize = input.accelerationEndSize.w;\n  float spinStart = input.spinStartSpinSpeed.x;\n  float spinSpeed = input.spinStartSpinSpeed.y;\n\n  float localTime = fmod((time - timeOffset - startTime), timeRange);\n  float percentLife = localTime / lifeTime;\n\n  float frame = fmod(floor(localTime / frameDuration + frameStart),\n                     numFrames);\n  float uOffset = frame / numFrames;\n  float u = uOffset + (uv.x + 0.5) * (1 / numFrames);\n\n  output.texcoord = float2(u, uv.y + 0.5);\n  output.colorMult = input.colorMult;\n\n  float3 basisX = viewInverse[0].xyz;\n  float3 basisZ = viewInverse[1].xyz;\n\n  float size = lerp(startSize, endSize, percentLife);\n  size = (percentLife < 0 || percentLife > 1) ? 0 : size;\n  float s = sin(spinStart + spinSpeed * localTime);\n  float c = cos(spinStart + spinSpeed * localTime);\n\n  float2 rotatedPoint = float2(uv.x * c + uv.y * s, \n                               -uv.x * s + uv.y * c);\n  float3 localPosition = float3(basisX * rotatedPoint.x +\n                                basisZ * rotatedPoint.y) * size +\n                         velocity * localTime +\n                         acceleration * localTime * localTime + \n                         position;\n\n  output.position = mul(float4(localPosition, 1), \n                        viewProjection);\n  output.percentLife = percentLife;\n  return output;\n}\n\nfloat4 pixelShaderFunction(PixelShaderInput input): COLOR {\n  float4 colorMult = tex2D(rampSampler, \n                           float2(input.percentLife, 0.5)) *\n                     input.colorMult;\n  float4 color = tex2D(colorSampler, input.texcoord) * colorMult;\n  return color;\n}\n\n// #o3d VertexShaderEntryPoint vertexShaderFunction\n// #o3d PixelShaderEntryPoint pixelShaderFunction\n// #o3d MatrixLoadOrder RowMajor\n"}];
o3djs.particles.FX_STRINGS_GLSL=[{name:"particle3d",fxString:"uniform mat4 world;\nuniform mat4 worldViewProjection;\nuniform vec3 worldVelocity;\nuniform vec3 worldAcceleration;\nuniform float timeRange;\nuniform float time;\nuniform float timeOffset;\nuniform float frameDuration;\nuniform float numFrames;\n\nattribute vec4 position; // uv, lifeTime, frameStart\nattribute vec4 texCoord0; // position.xyz, startTime\nattribute vec4 texCoord1; // velocity.xyz, startSize\nattribute vec4 texCoord2; // acceleration.xyz, endSize\nattribute vec4 texCoord3; // spinStart.x, spinSpeed.y\nattribute vec4 texCoord4; // orientation\nattribute vec4 color; //\n\nvarying vec4 v_position;\nvarying vec2 v_texcoord;\nvarying float v_percentLife;\nvarying vec4 v_colorMult;\n\nvoid main() {\n  vec4 uvLifeTimeFrameStart = position;\n  vec4 positionStartTime = texCoord0;\n  vec4 velocityStartSize = texCoord1;\n  vec4 accelerationEndSize = texCoord2;\n  vec4 spinStartSpinSpeed = texCoord3;\n  vec4 orientation = texCoord4;\n  vec4 colorMult = color;\n  vec2 uv = uvLifeTimeFrameStart.xy;\n  float lifeTime = uvLifeTimeFrameStart.z;\n  float frameStart = uvLifeTimeFrameStart.w;\n  vec3 position = positionStartTime.xyz;\n  float startTime = positionStartTime.w;\n  vec3 velocity = (world * vec4(velocityStartSize.xyz, 0)).xyz\n      + worldVelocity;\n  float startSize = velocityStartSize.w;\n  vec3 acceleration = (world *\n      vec4(accelerationEndSize.xyz, 0)).xyz + worldAcceleration;\n  float endSize = accelerationEndSize.w;\n  float spinStart = spinStartSpinSpeed.x;\n  float spinSpeed = spinStartSpinSpeed.y;\n\n  float localTime = mod((time - timeOffset - startTime),\n      timeRange);\n  float percentLife = localTime / lifeTime;\n\n  float frame = mod(floor(localTime / frameDuration + frameStart),\n                     numFrames);\n  float uOffset = frame / numFrames;\n  float u = uOffset + (uv.x + 0.5) * (1.0 / numFrames);\n\n  v_texcoord = vec2(u, uv.y + 0.5);\n  v_colorMult = colorMult;\n\n  float size = mix(startSize, endSize, percentLife);\n  size = (percentLife < 0.0 || percentLife > 1.0) ? 0.0 : size;\n  float s = sin(spinStart + spinSpeed * localTime);\n  float c = cos(spinStart + spinSpeed * localTime);\n\n  vec4 rotatedPoint = vec4((uv.x * c + uv.y * s) * size, 0.0,\n                               (uv.x * s - uv.y * c) * size, 1.0);\n  vec3 center = velocity * localTime +\n                  acceleration * localTime * localTime + \n                  position;\n  \n      vec4 q2 = orientation + orientation;\n      vec4 qx = orientation.xxxw * q2.xyzx;\n      vec4 qy = orientation.xyyw * q2.xyzy;\n      vec4 qz = orientation.xxzw * q2.xxzz;\n  \n      mat4 localMatrix = mat4(\n        (1.0 - qy.y) - qz.z, \n        qx.y + qz.w, \n        qx.z - qy.w,\n        0,\n  \n        qx.y - qz.w, \n        (1.0 - qx.x) - qz.z, \n        qy.z + qx.w,\n        0,\n  \n        qx.z + qy.w, \n        qy.z - qx.w, \n        (1.0 - qx.x) - qy.y,\n        0,\n  \n        center.x, center.y, center.z, 1.0);\n  rotatedPoint = localMatrix * rotatedPoint;\n  gl_Position = worldViewProjection * rotatedPoint;\n  v_percentLife = percentLife;\n}\n\n// #o3d SplitMarker\n\nvarying vec4 v_position;\nvarying vec2 v_texcoord;\nvarying float v_percentLife;\nvarying vec4 v_colorMult;\n\n// We need to implement 1D!\nuniform sampler2D rampSampler;\nuniform sampler2D colorSampler;\n\nvoid main() {\n  vec4 colorMult = texture2D(rampSampler, \n      vec2(v_percentLife, 0.5)) * v_colorMult;\n  vec4 color = texture2D(colorSampler, v_texcoord) * colorMult;\n  gl_FragColor = color;\n}\n\n// #o3d MatrixLoadOrder RowMajor\n"},
{name:"particle2d",fxString:"uniform mat4 viewProjection;\nuniform mat4 world;\nuniform mat4 viewInverse;\nuniform vec3 worldVelocity;\nuniform vec3 worldAcceleration;\nuniform float timeRange;\nuniform float time;\nuniform float timeOffset;\nuniform float frameDuration;\nuniform float numFrames;\n\nattribute vec4 position; // uv, lifeTime, frameStart\nattribute vec4 texCoord0; // position.xyz, startTime\nattribute vec4 texCoord1; // velocity.xyz, startSize\nattribute vec4 texCoord2; // acceleration.xyz, endSize\nattribute vec4 texCoord3; // spinStart.x, spinSpeed.y\nattribute vec4 color; //\n\nvarying vec4 v_position;\nvarying vec2 v_texcoord;\nvarying float v_percentLife;\nvarying vec4 v_colorMult;\n\nvoid main() {\n  vec4 uvLifeTimeFrameStart = position;\n  vec4 positionStartTime = texCoord0;\n  vec4 velocityStartSize = texCoord1;\n  vec4 accelerationEndSize = texCoord2;\n  vec4 spinStartSpinSpeed = texCoord3;\n  vec4 colorMult = color;\n  vec2 uv = uvLifeTimeFrameStart.xy;\n  float lifeTime = uvLifeTimeFrameStart.z;\n  float frameStart = uvLifeTimeFrameStart.w;\n  vec3 position = (world * vec4(positionStartTime.xyz, 1.0)).xyz;\n  float startTime = positionStartTime.w;\n  vec3 velocity = (world * vec4(velocityStartSize.xyz, 0)).xyz \n      + worldVelocity;\n  float startSize = velocityStartSize.w;\n  vec3 acceleration = (world *\n      vec4(accelerationEndSize.xyz, 0)).xyz + worldAcceleration;\n  float endSize = accelerationEndSize.w;\n  float spinStart = spinStartSpinSpeed.x;\n  float spinSpeed = spinStartSpinSpeed.y;\n\n  float localTime = mod((time - timeOffset - startTime),\n      timeRange);\n  float percentLife = localTime / lifeTime;\n\n  float frame = mod(floor(localTime / frameDuration + frameStart),\n                     numFrames);\n  float uOffset = frame / numFrames;\n  float u = uOffset + (uv.x + 0.5) * (1.0 / numFrames);\n\n  v_texcoord = vec2(u, uv.y + 0.5);\n  v_colorMult = colorMult;\n\n  vec3 basisX = viewInverse[0].xyz;\n  vec3 basisZ = viewInverse[1].xyz;\n\n  float size = mix(startSize, endSize, percentLife);\n  size = (percentLife < 0.0 || percentLife > 1.0) ? 0.0 : size;\n  float s = sin(spinStart + spinSpeed * localTime);\n  float c = cos(spinStart + spinSpeed * localTime);\n\n  vec2 rotatedPoint = vec2(uv.x * c + uv.y * s, \n                               -uv.x * s + uv.y * c);\n  vec3 localPosition = vec3(basisX * rotatedPoint.x +\n                                basisZ * rotatedPoint.y) * size +\n                         velocity * localTime +\n                         acceleration * localTime * localTime + \n                         position;\n\n  gl_Position = (viewProjection * vec4(localPosition, 1.0));\n  v_percentLife = percentLife;\n}\n\n// #o3d SplitMarker\n\nvarying vec4 v_position;\nvarying vec2 v_texcoord;\nvarying float v_percentLife;\nvarying vec4 v_colorMult;\n\n// We need to implement 1D!\nuniform sampler2D rampSampler;\nuniform sampler2D colorSampler;\n\nvoid main() {\n  vec4 colorMult = texture2D(rampSampler, \n      vec2(v_percentLife, 0.5)) * v_colorMult;\n  vec4 color = texture2D(colorSampler, v_texcoord) * colorMult;\n  gl_FragColor = color;\n}\n\n// #o3d MatrixLoadOrder RowMajor\n"}];
o3djs.particles.useCorrectShaders_=function(){o3djs.particles.FX_STRINGS=o3djs.particles.FX_STRINGS_CG;if(o3djs.effect.LANGUAGE=="glsl")o3djs.particles.FX_STRINGS=o3djs.particles.FX_STRINGS_GLSL};o3djs.particles.CORNERS_=[[-0.5,-0.5],[+0.5,-0.5],[+0.5,+0.5],[-0.5,+0.5]];o3djs.particles.createParticleSystem=function(a,b,c,d){return new o3djs.particles.ParticleSystem(a,b,c,d)};
o3djs.particles.ParticleSystem=function(a,b,c,d){var e=o3djs.base.o3d,f=[],g=[];o3djs.particles.useCorrectShaders_();for(var h=0;h<o3djs.particles.FX_STRINGS.length;++h){var j=o3djs.particles.FX_STRINGS[h],i=a.createObject("Effect");i.name=j.name;i.loadFromFXString(j.fxString);g.push(i)}h={};h[o3djs.particles.ParticleStateIds.BLEND]={SourceBlendFunction:o3djs.base.o3d.State.BLENDFUNC_SOURCE_ALPHA,DestinationBlendFunction:o3djs.base.o3d.State.BLENDFUNC_INVERSE_SOURCE_ALPHA};h[o3djs.particles.ParticleStateIds.ADD]=
{SourceBlendFunction:o3djs.base.o3d.State.BLENDFUNC_SOURCE_ALPHA,DestinationBlendFunction:o3djs.base.o3d.State.BLENDFUNC_ONE};h[o3djs.particles.ParticleStateIds.BLEND_PREMULTIPLY]={SourceBlendFunction:o3djs.base.o3d.State.BLENDFUNC_ONE,DestinationBlendFunction:o3djs.base.o3d.State.BLENDFUNC_INVERSE_SOURCE_ALPHA};h[o3djs.particles.ParticleStateIds.BLEND_NO_ALPHA]={SourceBlendFunction:o3djs.base.o3d.State.BLENDFUNC_SOURCE_COLOR,DestinationBlendFunction:o3djs.base.o3d.State.BLENDFUNC_INVERSE_SOURCE_COLOR};
h[o3djs.particles.ParticleStateIds.SUBTRACT]={SourceBlendFunction:o3djs.base.o3d.State.BLENDFUNC_SOURCE_ALPHA,DestinationBlendFunction:o3djs.base.o3d.State.BLENDFUNC_INVERSE_SOURCE_ALPHA,BlendEquation:o3djs.base.o3d.State.BLEND_REVERSE_SUBTRACT};h[o3djs.particles.ParticleStateIds.INVERSE]={SourceBlendFunction:o3djs.base.o3d.State.BLENDFUNC_INVERSE_DESTINATION_COLOR,DestinationBlendFunction:o3djs.base.o3d.State.BLENDFUNC_INVERSE_SOURCE_COLOR};for(var k in o3djs.particles.ParticleStateIds){i=a.createObject("State");
j=o3djs.particles.ParticleStateIds[k];f[j]=i;i.getStateParam("ZWriteEnable").value=false;i.getStateParam("CullMode").value=e.State.CULL_NONE;j=h[j];for(var l in j)i.getStateParam(l).value=j[l]}k=a.createTexture2D(8,8,e.Texture.ARGB8,1,false);l=[0,0.2,0.7,1,0.7,0.2,0,0];j=[];for(h=0;h<8;++h)for(i=0;i<8;++i){var m=l[i]*l[h];j.push(m,m,m,m)}k.set(0,j);e=a.createTexture2D(3,1,e.Texture.ARGB8,1,false);e.set(0,[1,1,1,1,1,1,1,0.5,1,1,1,0]);if(!c){this.counter_=a.createObject("SecondCounter");c=this.counter_.getParam("count")}this.randomFunction_=
d||function(){return Math.random()};this.particleStates=f;this.clockParam=c;this.pack=a;this.viewInfo=b;this.effects=g;this.defaultColorTexture=k;this.defaultRampTexture=e};
o3djs.particles.ParticleSpec=function(){this.frameDuration=this.numFrames=this.numParticles=1;this.frameStartRange=this.frameStart=0;this.timeRange=99999999;this.startTime=null;this.lifeTime=1;this.lifeTimeRange=0;this.startSize=1;this.startSizeRange=0;this.endSize=1;this.endSizeRange=0;this.position=[0,0,0];this.positionRange=[0,0,0];this.velocity=[0,0,0];this.velocityRange=[0,0,0];this.acceleration=[0,0,0];this.accelerationRange=[0,0,0];this.spinSpeedRange=this.spinSpeed=this.spinStartRange=this.spinStart=
0;this.colorMult=[1,1,1,1];this.colorMultRange=[0,0,0,0];this.worldVelocity=[0,0,0];this.worldAcceleration=[0,0,0];this.billboard=true;this.orientation=[0,0,0,1]};o3djs.particles.ParticleSystem.prototype.createParticleEmitter=function(a,b){return new o3djs.particles.ParticleEmitter(this,a,b)};o3djs.particles.ParticleSystem.prototype.createTrail=function(a,b,c,d,e,f){return new o3djs.particles.Trail(this,a,b,c,d,e,f)};
o3djs.particles.ParticleEmitter=function(a,b,c){c=c||a.clockParam;var d=o3djs.base.o3d,e=a.pack,f=a.viewInfo,g=e.createObject("Material");g.name="particles";g.drawList=f.zOrderedDrawList;g.effect=a.effects[1];a.effects[1].createUniformParameters(g);g.getParam("time").bind(c);f=e.createObject("Sampler");f.texture=a.defaultRampTexture;f.addressModeU=d.Sampler.CLAMP;var h=e.createObject("Sampler");h.texture=b||a.defaultColorTexture;h.addressModeU=d.Sampler.CLAMP;h.addressModeV=d.Sampler.CLAMP;g.getParam("rampSampler").value=
f;g.getParam("colorSampler").value=h;b=e.createObject("VertexBuffer");var j=b.createField("FloatField",4),i=b.createField("FloatField",4),k=b.createField("FloatField",4),l=b.createField("FloatField",4),m=b.createField("FloatField",4),n=b.createField("FloatField",4),r=b.createField("FloatField",4),o=e.createObject("IndexBuffer"),q=e.createObject("StreamBank");q.setVertexStream(d.Stream.POSITION,0,j,0);q.setVertexStream(d.Stream.TEXCOORD,0,i,0);q.setVertexStream(d.Stream.TEXCOORD,1,k,0);q.setVertexStream(d.Stream.TEXCOORD,
2,l,0);q.setVertexStream(d.Stream.TEXCOORD,3,m,0);q.setVertexStream(d.Stream.TEXCOORD,4,n,0);q.setVertexStream(d.Stream.COLOR,0,r,0);var p=e.createObject("Shape"),t=e.createObject("Primitive");t.material=g;t.owner=p;t.streamBank=q;t.indexBuffer=o;t.primitiveType=d.Primitive.TRIANGLELIST;t.createDrawElement(e,null);this.vertexBuffer_=b;this.uvLifeTimeFrameStartField_=j;this.positionStartTimeField_=i;this.velocityStartSizeField_=k;this.accelerationEndSizeField_=l;this.spinStartSpinSpeedField_=m;this.orientationField_=
n;this.colorMultField_=r;this.indexBuffer_=o;this.streamBank_=q;this.primitive_=t;this.rampSampler_=f;this.rampTexture_=a.defaultRampTexture;this.colorSampler_=h;this.particleSystem=a;this.shape=p;this.material=g;this.clockParam=c};o3djs.particles.ParticleEmitter.prototype.setState=function(a){this.material.state=this.particleSystem.particleStates[a]};
o3djs.particles.ParticleEmitter.prototype.setColorRamp=function(a){var b=a.length/4;if(b%1!=0)throw"colorRamp must have multiple of 4 entries";if(this.rampTexture_==this.particleSystem.defaultRampTexture)this.rampTexture_=null;if(this.rampTexture_&&this.rampTexture_.width!=b){this.particleSystem.pack.removeObject(this.rampTexture_);this.rampTexture_=null}if(!this.rampTexture_)this.rampTexture_=this.particleSystem.pack.createTexture2D(b,1,o3djs.base.o3d.Texture.ARGB8,1,false);this.rampTexture_.set(0,
a);this.rampSampler_.texture=this.rampTexture_};o3djs.particles.ParticleEmitter.prototype.validateParameters=function(a){var b=new o3djs.particles.ParticleSpec,c;for(c in a)if(typeof b[c]==="undefined")throw'unknown particle parameter "'+c+'"';for(c in b)if(typeof a[c]==="undefined")a[c]=b[c]};
o3djs.particles.ParticleEmitter.prototype.createParticles_=function(a,b,c,d){var e=this.uvLifeTimeFrameStart_,f=this.positionStartTime_,g=this.velocityStartSize_,h=this.accelerationEndSize_,j=this.spinStartSpinSpeed_,i=this.orientation_,k=this.colorMults_;this.material.effect=this.particleSystem.effects[c.billboard?1:0];this.material.getParam("timeRange").value=c.timeRange;this.material.getParam("numFrames").value=c.numFrames;this.material.getParam("frameDuration").value=c.frameDuration;this.material.getParam("worldVelocity").value=
c.worldVelocity;this.material.getParam("worldAcceleration").value=c.worldAcceleration;for(var l=this.particleSystem.randomFunction_,m=function(G){return(l()-0.5)*G*2},n=function(G){for(var H=[],I=0;I<G.length;++I)H.push(m(G[I]));return H},r=0;r<b;++r){d&&d(r,c);for(var o=c.lifeTime,q=c.startTime===null?r*c.lifeTime/b:c.startTime,p=c.frameStart+m(c.frameStartRange),t=o3djs.math.addVector(c.position,n(c.positionRange)),u=o3djs.math.addVector(c.velocity,n(c.velocityRange)),x=o3djs.math.addVector(c.acceleration,
n(c.accelerationRange)),w=o3djs.math.addVector(c.colorMult,n(c.colorMultRange)),y=c.spinStart+m(c.spinStartRange),s=c.spinSpeed+m(c.spinSpeedRange),v=c.startSize+m(c.startSizeRange),A=c.endSize+m(c.endSizeRange),B=c.orientation,D=0;D<4;++D){var C=(r*4+D)*4,z=C+1,E=C+2,F=C+3;e[C]=o3djs.particles.CORNERS_[D][0];e[z]=o3djs.particles.CORNERS_[D][1];e[E]=o;e[F]=p;f[C]=t[0];f[z]=t[1];f[E]=t[2];f[F]=q;g[C]=u[0];g[z]=u[1];g[E]=u[2];g[F]=v;h[C]=x[0];h[z]=x[1];h[E]=x[2];h[F]=A;j[C]=y;j[z]=s;j[E]=0;j[F]=0;i[C]=
B[0];i[z]=B[1];i[E]=B[2];i[F]=B[3];k[C]=w[0];k[z]=w[1];k[E]=w[2];k[F]=w[3]}}a*=4;this.uvLifeTimeFrameStartField_.setAt(a,e);this.positionStartTimeField_.setAt(a,f);this.velocityStartSizeField_.setAt(a,g);this.accelerationEndSizeField_.setAt(a,h);this.spinStartSpinSpeedField_.setAt(a,j);this.orientationField_.setAt(a,i);this.colorMultField_.setAt(a,k)};
o3djs.particles.ParticleEmitter.prototype.allocateParticles_=function(a){if(this.vertexBuffer_.numElements!=a*4){this.vertexBuffer_.allocateElements(a*4);for(var b=[],c=0;c<a;++c){var d=c*4;b.push(d+0,d+1,d+2);b.push(d+0,d+2,d+3)}this.indexBuffer_.set(b);this.uvLifeTimeFrameStart_=[];this.positionStartTime_=[];this.velocityStartSize_=[];this.accelerationEndSize_=[];this.spinStartSpinSpeed_=[];this.orientation_=[];this.colorMults_=[]}this.primitive_.numberPrimitives=a*2;this.primitive_.numberVertices=
a*4};o3djs.particles.ParticleEmitter.prototype.setParameters=function(a,b){this.validateParameters(a);var c=a.numParticles;this.allocateParticles_(c);this.createParticles_(0,c,a,b)};o3djs.particles.ParticleEmitter.prototype.createOneShot=function(a){return new o3djs.particles.OneShot(this,a)};
o3djs.particles.OneShot=function(a,b){var c=a.particleSystem.pack;this.emitter_=a;this.transform=c.createObject("Transform");this.transform.visible=false;this.transform.addShape(a.shape);this.timeOffsetParam_=this.transform.createParam("timeOffset","ParamFloat");b&&this.setParent(b)};o3djs.particles.OneShot.prototype.setParent=function(a){this.transform.parent=a};
o3djs.particles.OneShot.prototype.trigger=function(a,b){b&&this.setParent(b);if(a){this.transform.identity();this.transform.translate(a)}this.transform.visible=true;this.timeOffsetParam_.value=this.emitter_.clockParam.value};
o3djs.particles.Trail=function(a,b,c,d,e,f,g){o3djs.particles.ParticleEmitter.call(this,a,e,g);a=a.pack;this.allocateParticles_(c);this.validateParameters(d);this.parameters=d;this.perParticleParamSetter=f;this.birthIndex_=0;this.maxParticles_=c;this.transform=a.createObject("Transform");this.transform.addShape(this.shape);this.transform.parent=b};o3djs.base.inherit(o3djs.particles.Trail,o3djs.particles.ParticleEmitter);
o3djs.particles.Trail.prototype.birthParticles=function(a){var b=this.parameters.numParticles;this.parameters.startTime=this.clockParam.value;for(this.parameters.position=a;this.birthIndex_+b>=this.maxParticles_;){a=this.maxParticles_-this.birthIndex_;this.createParticles_(this.birthIndex_,a,this.parameters,this.perParticleParamSetter);b-=a;this.birthIndex_=0}this.createParticles_(this.birthIndex_,b,this.parameters,this.perParticleParamSetter);this.birthIndex_+=b};o3djs.provide("o3djs.performance");
o3djs.performance=o3djs.performance||{};o3djs.performance.createPerformanceMonitor=function(a,b,c,d,e){return new o3djs.performance.PerformanceMonitor(a,b,c,d,e)};
o3djs.performance.PerformanceMonitor=function(a,b,c,d,e){e=e||{};this.increaseQuality=c;this.decreaseQuality=d;this.sampleCount=this.meanFrameTime=0;this.minSamples=e.opt_minSamples||60;this.damping=e.opt_damping||120;this.delayCycles=e.opt_delayCycles||2*this.minSamples;this.targetFrameTimeMax_=1/a;this.targetFrameTimeMin_=1/b;this.scaleInput_=1/this.minSamples;this.scaleMean_=1;this.delayCyclesLeft_=0;if(this.damping<this.minSamples)throw Error("Damping must be at least minSamples.");};
o3djs.performance.PerformanceMonitor.Options=goog.typedef;
o3djs.performance.PerformanceMonitor.prototype.onRender=function(a){var b=true;if(this.sampleCount<this.damping){if(this.sampleCount>=this.minSamples){this.scaleInput_=1/(this.sampleCount+1);this.scaleMean_=this.sampleCount*this.scaleInput_}else b=false;this.sampleCount+=1}this.meanFrameTime=this.meanFrameTime*this.scaleMean_+a*this.scaleInput_;if(this.delayCyclesLeft_>0)this.delayCyclesLeft_-=1;else if(b)if(this.meanFrameTime<this.targetFrameTimeMin_){this.increaseQuality();this.delayCyclesLeft_=
this.delayCycles}else if(this.meanFrameTime>this.targetFrameTimeMax_){this.decreaseQuality();this.delayCyclesLeft_=this.delayCycles}};o3djs.provide("o3djs.picking");o3djs.require("o3djs.math");o3djs.require("o3djs.dump");o3djs.picking=o3djs.picking||{};o3djs.picking.Ray=goog.typedef;o3djs.picking.createPickInfo=function(a,b,c,d){return new o3djs.picking.PickInfo(a,b,c,d)};
o3djs.picking.clientPositionToWorldRayEx=function(a,b,c,d,e,f){c=o3djs.math.inverse(o3djs.math.matrix4.composition(d,c));a=a/(e*0.5)-1;b=-(b/(f*0.5)-1);return{near:o3djs.math.matrix4.transformPoint(c,[a,b,0]),far:o3djs.math.matrix4.transformPoint(c,[a,b,1])}};o3djs.picking.clientPositionToWorldRay=function(a,b,c,d,e){return o3djs.picking.clientPositionToWorldRayEx(a,b,c.view,c.projection,d,e)};o3djs.picking.dprint=function(){};o3djs.picking.dprintPoint3=function(){};
o3djs.picking.dprintBoundingBox=function(){};o3djs.picking.dumpRayIntersectionInfo=function(a,b){o3djs.picking.dprint(a+" : valid = "+b.valid+" : intersected = "+b.intersected);b.intersected&&o3djs.picking.dprint(" : pos: "+b.position[0]+", "+b.position[1]+", "+b.position[2]+", ");o3djs.picking.dprint("\n")};o3djs.picking.PickInfo=function(a,b,c,d){this.element=a;this.shapeInfo=b;this.rayIntersectionInfo=c;this.worldIntersectionPosition=d};
o3djs.picking.ShapeInfo=function(a,b,c){this.shape=a;this.parent=b;this.boundingBox=null;this.pickManager=c;this.update()};o3djs.picking.ShapeInfo.prototype.isPickable=function(){return true};o3djs.picking.ShapeInfo.prototype.getBoundingBox=function(){return this.boundingBox};o3djs.picking.ShapeInfo.prototype.update=function(){var a=this.shape.elements;if(a.length>0){this.boundingBox=a[0].getBoundingBox(0);for(var b=1;b<a.length;b++)this.boundingBox=this.boundingBox.add(a[b].getBoundingBox(0))}};
o3djs.picking.ShapeInfo.prototype.pick=function(a){if(this.isPickable()){var b=this.parent.transform.getUpdatedWorldMatrix(),c=o3djs.math.inverse(b),d=o3djs.math.matrix4.transformPoint(c,a.near),e=o3djs.math.matrix4.transformPoint(c,a.far);a=this.boundingBox.intersectRay(d,e);o3djs.picking.dumpRayIntersectionInfo("SHAPE(box): "+this.shape.name,a);if(a.intersected)for(var f=this.shape.elements,g=0;g<f.length;g++){c=f[g];a=c.intersectRay(0,o3djs.base.o3d.State.CULL_CCW,d,e);o3djs.picking.dumpRayIntersectionInfo("SHAPE(tris): "+
this.shape.name+" : element "+c.name,a);if(a.intersected){b=o3djs.math.matrix4.transformPoint(b,a.position);return o3djs.picking.createPickInfo(c,this,a,b)}}}return null};o3djs.picking.ShapeInfo.prototype.dump=function(a){a=a||"";o3djs.picking.dprint(a+"SHAPE: "+this.shape.name+"\n");o3djs.picking.dprintPoint3("bb min",this.boundingBox.minExtent,a+"    ");o3djs.picking.dprintPoint3("bb max",this.boundingBox.maxExtent,a+"    ")};
o3djs.picking.TransformInfo=function(a,b,c){this.childTransformInfos={};this.shapeInfos={};this.transform=a;this.parent=b;this.boundingBox=null;this.pickManager=c;this.pickableEvenIfInvisible=false};o3djs.picking.TransformInfo.prototype.getBoundingBox=function(){return this.boundingBox};o3djs.picking.TransformInfo.prototype.isPickable=function(){return this.transform.visible||this.pickableEvenIfInvisible};
o3djs.picking.TransformInfo.prototype.update=function(){for(var a={},b={},c=this.transform.children,d=0;d<c.length;d++){var e=c[d],f=this.childTransformInfos[e.clientId];if(f)f.boundingBox=null;else f=this.pickManager.createTransformInfo(e,this);f.update();a[e.clientId]=f}c=this.transform.shapes;for(d=0;d<c.length;d++){e=c[d];(f=this.shapeInfos[e.clientId])||(f=this.pickManager.createShapeInfo(e,this));b[e.clientId]=f}for(var g in this.childTransformInfos){var h=g;a[h]||this.pickManager.removeTransformInfo(this.childTransformInfos[h])}this.childTransformInfos=
a;this.shapeInfos=b;g=null;for(h in b){f=b[h];if(f.isPickable()){f=f.getBoundingBox().mul(this.transform.localMatrix);if(g){if(f)g=g.add(f)}else g=f}}for(h in a){f=a[h];if(f.isPickable())if(f=f.getBoundingBox())g=g?g.add(f.mul(this.transform.localMatrix)):f.mul(this.transform.localMatrix)}this.boundingBox=g};
o3djs.picking.TransformInfo.prototype.pick=function(a){if(this.isPickable()&&this.boundingBox){var b=o3djs.math.matrix4.identity();if(this.parent)b=o3djs.math.inverse(this.parent.transform.getUpdatedWorldMatrix());var c=o3djs.math.matrix4.transformPoint(b,a.near);b=o3djs.math.matrix4.transformPoint(b,a.far);c=this.boundingBox.intersectRay(c,b);o3djs.picking.dumpRayIntersectionInfo("TRANSFORM(box): "+this.transform.name,c);if(c.intersected){c=null;b=-1;for(var d in this.childTransformInfos){var e=
d;if(e=this.childTransformInfos[e].pick(a)){var f=o3djs.math.lengthSquared(o3djs.math.subVector(a.near,e.worldIntersectionPosition));if(!c||f<b){b=f;c=e}}}for(d in this.shapeInfos){e=d;if(e=this.shapeInfos[e].pick(a)){f=o3djs.math.lengthSquared(o3djs.math.subVector(a.near,e.worldIntersectionPosition));if(!c||f<b){b=f;c=e}}}return c}}return null};
o3djs.picking.TransformInfo.prototype.dump=function(a){a=a||"";o3djs.picking.dprint(a+"TRANSFORM: "+this.transform.name+"\n");if(this.boundingBox){o3djs.picking.dprintPoint3("bb min",this.boundingBox.minExtent,a+"    ");o3djs.picking.dprintPoint3("bb max",this.boundingBox.maxExtent,a+"    ")}else o3djs.picking.dprint(a+"    bb *NA*\n");o3djs.picking.dprint(a+"--Shapes--\n");for(var b in this.shapeInfos){var c=b;this.shapeInfos[c].dump(a+"    ")}o3djs.picking.dprint(a+"--Children--\n");for(b in this.childTransformInfos){c=
b;this.childTransformInfos[c].dump(a+"    ")}};o3djs.picking.PickManager=function(a){this.transformInfosByClientId={};this.rootTransformInfo=this.createTransformInfo(a,null)};o3djs.picking.PickManager.prototype.createShapeInfo=function(a,b){return new o3djs.picking.ShapeInfo(a,b,this)};o3djs.picking.PickManager.prototype.createTransformInfo=function(a,b){var c=new o3djs.picking.TransformInfo(a,b,this);this.addTransformInfo(c);return c};
o3djs.picking.PickManager.prototype.addTransformInfo=function(a){this.transformInfosByClientId[a.transform.clientId]=a};o3djs.picking.PickManager.prototype.removeTransformInfo=function(a){delete this.transformInfosByClientId[a.transform.clientId]};o3djs.picking.PickManager.prototype.getTransformInfo=function(a){return this.transformInfosByClientId[a.clientId]};o3djs.picking.PickManager.prototype.update=function(){this.rootTransformInfo.update()};o3djs.picking.PickManager.prototype.dump=function(){this.rootTransformInfo.dump()};
o3djs.picking.PickManager.prototype.pick=function(a){return this.rootTransformInfo.pick(a)};o3djs.picking.createPickManager=function(a){return new o3djs.picking.PickManager(a)};o3djs.provide("o3djs.quaternions");o3djs.quaternions=o3djs.quaternions||{};o3djs.quaternions.Quaternion=goog.typedef;o3djs.quaternions.mathType=function(a){if(typeof a==="number")return"Scalar";return"Quaternion"};o3djs.quaternions.copy=function(a){return a.slice()};
o3djs.quaternions.negative=function(a){return[-a[0],-a[1],-a[2],-a[3]]};o3djs.quaternions.addQuaternionQuaternion=function(a,b){return[a[0]+b[0],a[1]+b[1],a[2]+b[2],a[3]+b[3]]};o3djs.quaternions.addQuaternionScalar=function(a,b){return a.slice(0,3).concat(a[3]+b)};o3djs.quaternions.addScalarQuaternion=function(a,b){return b.slice(0,3).concat(a+b[3])};o3djs.quaternions.subQuaternionQuaternion=function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2],a[3]-b[3]]};
o3djs.quaternions.subQuaternionScalar=function(a,b){return a.slice(0,3).concat(a[3]-b)};o3djs.quaternions.subScalarQuaternion=function(a,b){return[-b[0],-b[1],-b[2],a-b[3]]};o3djs.quaternions.mulScalarQuaternion=function(a,b){return[a*b[0],a*b[1],a*b[2],a*b[3]]};o3djs.quaternions.mulQuaternionScalar=function(a,b){return[b*a[0],b*a[1],b*a[2],b*a[3]]};
o3djs.quaternions.mulQuaternionQuaternion=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=b[0],h=b[1],j=b[2],i=b[3];return[f*g+c*i+d*j-e*h,f*h+d*i+e*g-c*j,f*j+e*i+c*h-d*g,f*i-c*g-d*h-e*j]};o3djs.quaternions.divQuaternionQuaternion=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=b[0],h=b[1],j=b[2],i=b[3],k=1/(i*i+g*g+h*h+j*j);return[(c*i-f*g-d*j+e*h)*k,(c*j-f*h+d*i-e*g)*k,(d*g+e*i-f*j-c*h)*k,(f*i+c*g+d*h+e*j)*k]};
o3djs.quaternions.divQuaternionScalar=function(a,b){return[a[0]/b,a[1]/b,a[2]/b,a[3]/b]};o3djs.quaternions.divScalarQuaternion=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=1/(c*c+d*d+e*e+f*f);return[-a*c*g,-a*d*g,-a*e*g,a*f*g]};o3djs.quaternions.inverse=function(a){var b=a[0],c=a[1],d=a[2];a=a[3];var e=1/(b*b+c*c+d*d+a*a);return[-b*e,-c*e,-d*e,a*e]};o3djs.quaternions.mul=function(a,b){return o3djs.quaternions["mul"+o3djs.quaternions.mathType(a)+o3djs.quaternions.mathType(b)](a,b)};
o3djs.quaternions.div=function(a,b){return o3djs.quaternions["div"+o3djs.quaternions.mathType(a)+o3djs.quaternions.mathType(b)](a,b)};o3djs.quaternions.add=function(a,b){return o3djs.quaternions["add"+o3djs.quaternions.mathType(a)+o3djs.quaternions.mathType(b)](a,b)};o3djs.quaternions.sub=function(a,b){return o3djs.quaternions["sub"+o3djs.quaternions.mathType(a)+o3djs.quaternions.mathType(b)](a,b)};o3djs.quaternions.length=function(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3])};
o3djs.quaternions.lengthSquared=function(a){return a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3]};o3djs.quaternions.normalize=function(a){var b=1/Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3]);return[a[0]*b,a[1]*b,a[2]*b,a[3]*b]};o3djs.quaternions.conjugate=function(a){return[-a[0],-a[1],-a[2],a[3]]};o3djs.quaternions.rotationX=function(a){return[Math.sin(a/2),0,0,Math.cos(a/2)]};o3djs.quaternions.rotationY=function(a){return[0,Math.sin(a/2),0,Math.cos(a/2)]};
o3djs.quaternions.rotationZ=function(a){return[0,0,Math.sin(a/2),Math.cos(a/2)]};o3djs.quaternions.axisRotation=function(a,b){var c=1/Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]),d=Math.sin(b/2);return[d*a[0]*c,d*a[1]*c,d*a[2]*c,Math.cos(b/2)]};
o3djs.quaternions.quaternionToRotation=function(a){var b=a[0],c=a[1],d=a[2],e=a[3];a=e*e;var f=e*b,g=e*c;e*=d;var h=b*b,j=b*c;b*=d;var i=c*c;c*=d;d*=d;var k=a+h+i+d;return[[(a+h-i-d)/k,2*(e+j)/k,2*(b-g)/k,0],[2*(j-e)/k,(a-h+i-d)/k,2*(f+c)/k,0],[2*(g+b)/k,2*(c-f)/k,(a-h-i+d)/k,0],[0,0,0,1]]};
o3djs.quaternions.rotationToQuaternion=function(a){var b,c,d,e=[],f=a[0],g=a[1];a=a[2];b=f[0];c=g[1];d=a[2];var h=b+c+d;if(h>0){h=Math.sqrt(1+h);var j=0.5/h;return[(g[2]-a[1])*j,(a[0]-f[2])*j,(f[1]-g[0])*j,0.5*h]}var i,k;if(b>c&&b>d){b=0;i=f;c=1;k=g;d=2;f=a}else if(c>b&&c>d){b=1;i=g;c=2;k=a;d=0}else{b=2;i=a;c=0;k=f;d=1;f=g}h=Math.sqrt(1+i[b]-k[c]-f[d]);j=0.5/h;e[b]=0.5*h;e[c]=(k[b]+i[c])*j;e[d]=(i[d]+f[b])*j;e[3]=(k[d]-f[c])*j;return e};o3djs.provide("o3djs.rendergraph");
o3djs.rendergraph=o3djs.rendergraph||{};o3djs.rendergraph.createView=function(a,b,c,d,e,f,g,h,j){return new o3djs.rendergraph.ViewInfo(a,b,c,d,e,f,g,h,j)};o3djs.rendergraph.createBasicView=function(a,b,c,d,e,f){return o3djs.rendergraph.createView(a,b,c,d,e,f)};o3djs.rendergraph.createExtraView=function(a,b,c,d){return o3djs.rendergraph.createView(a.pack,a.treeRoot,a.renderGraphRoot,c,d,b,a.performanceDrawList,a.zOrderedDrawList)};
o3djs.rendergraph.ViewInfo=function(a,b,c,d,e,f,g,h,j){d=d||[0.5,0.5,0.5,1];var i=e||0;e=0;var k=a.createObject("Viewport");if(f)k.viewport=f;k.priority=i;f=a.createObject("ClearBuffer");f.clearColor=d;f.priority=e++;f.parent=k;d=a.createObject("TreeTraversal");d.priority=e++;d.parent=k;d.transform=b;this.drawPassInfos_=[];this.pack=a;this.renderGraphRoot=c;this.treeRoot=b;this.viewport=this.root=k;this.clearBuffer=f;this.drawContext=j||a.createObject("DrawContext");this.treeTraversal=d;this.priority=
e;a=this.createDrawPass(o3djs.base.o3d.DrawList.BY_PERFORMANCE,undefined,undefined,undefined,g);b=a.state;h=this.createDrawPass(o3djs.base.o3d.DrawList.BY_Z_ORDER,undefined,undefined,undefined,h);g=h.state;g.getStateParam("AlphaBlendEnable").value=true;g.getStateParam("SourceBlendFunction").value=o3djs.base.o3d.State.BLENDFUNC_SOURCE_ALPHA;g.getStateParam("DestinationBlendFunction").value=o3djs.base.o3d.State.BLENDFUNC_INVERSE_SOURCE_ALPHA;g.getStateParam("AlphaTestEnable").value=true;g.getStateParam("AlphaComparisonFunction").value=
o3djs.base.o3d.State.CMP_GREATER;if(c)this.root.parent=c;this.performanceDrawPassInfo=a;this.zOrderedDrawPassInfo=h;this.performanceStateSet=a.stateSet;this.performanceState=b;this.performanceDrawList=a.drawList;this.zOrderedStateSet=h.stateSet;this.zOrderedState=g;this.zOrderedDrawList=h.drawList;this.performanceDrawPass=a.drawPass;this.zOrderedDrawPass=h.drawPass;this.ownDrawContext_=j?false:true};
o3djs.rendergraph.ViewInfo.prototype.destroy=function(a){if(a===undefined)a=true;for(var b=0;b<this.drawPassInfos_.length;++b)this.drawPassInfos_[b].destroy();this.pack.removeObject(this.viewport);this.pack.removeObject(this.clearBuffer);a&&this.ownDrawContext_&&this.pack.removeObject(this.drawContext);this.pack.removeObject(this.treeTraversal);this.viewport.parent=null};
o3djs.rendergraph.ViewInfo.prototype.createDrawPass=function(a,b,c,d,e){b=b||this.drawContext;d=d||this.viewport;c=typeof c!=="undefined"?c:this.priority++;a=o3djs.rendergraph.createDrawPassInfo(this.pack,b,a,d,e);a.root.priority=c;this.treeTraversal.registerDrawList(a.drawList,b,true);this.drawPassInfos_.push(a);return a};o3djs.rendergraph.createDrawPassInfo=function(a,b,c,d,e){return new o3djs.rendergraph.DrawPassInfo(a,b,c,d,e)};
o3djs.rendergraph.DrawPassInfo=function(a,b,c,d,e){b=e?false:true;d=d||null;e=e||a.createObject("DrawList");var f=a.createObject("StateSet"),g=a.createObject("State");f.state=g;f.parent=d;d=a.createObject("DrawPass");d.drawList=e;d.sortMethod=c;d.parent=f;this.pack=a;this.state=g;this.stateSet=f;this.drawPass=d;this.drawList=e;this.root=f;this.ownDrawList_=b};
o3djs.rendergraph.DrawPassInfo.prototype.destroy=function(){if(this.ownDrawList_){this.drawPass.drawList=null;this.pack.removeObject(this.drawList)}this.drawPass.parent=null;this.stateSet.parent=null;this.pack.removeObject(this.drawPass);this.pack.removeObject(this.stateSet);this.pack.removeObject(this.state)};o3djs.provide("o3djs.scene");o3djs.require("o3djs.io");o3djs.require("o3djs.serialization");o3djs.scene=o3djs.scene||{};
o3djs.scene.loadScene=function(a,b,c,d,e,f){return o3djs.io.loadArchive(b,d,function(g,h){if(h){g.destroy();e(b,c,h)}else o3djs.serialization.deserializeArchive(g,"scene.json",a,b,c,function(j,i,k){g.destroy();e(j,i,k)},f)})};o3djs.provide("o3djs.serialization");o3djs.require("o3djs.error");o3djs.require("o3djs.texture");o3djs.serialization=o3djs.serialization||{};o3djs.serialization.supportedVersion=5;o3djs.serialization.CURVE_KEY_TYPES={step:1,linear:2,bezier:3};o3djs.serialization.Options=goog.typedef;
o3djs.serialization.Deserializer=function(a,b){function c(e,f,g,h){g=e.pack.createObject(g);if("custom"in f)if("fieldData"in f.custom){f=f.custom.fieldData;if(f.length>0){h=[];for(var j=0;j<f.length;++j){var i=f[j],k=g.createField(i.type,i.numComponents);h.push(k);e.addObject(i.id,k)}e=f[0];g.allocateElements(e.data.length/e.numComponents);for(j=0;j<f.length;++j){i=f[j];h[j].setAt(0,i.data)}}}else{h=e.archiveInfo.getFileByURI(h);g.set(h,f.custom.binaryRange[0],f.custom.binaryRange[1]-f.custom.binaryRange[0]);
for(h=0;h<f.custom.fields.length;++h)e.addObject(f.custom.fields[h],g.fields[h])}return g}this.pack=a;this.json=b;this.archiveInfo=null;this.createCallbacks={"o3djs.DestinationBuffer":function(e,f){var g=e.pack.createObject("o3d.VertexBuffer");if("custom"in f){for(var h=0;h<f.custom.fields.length;++h){var j=f.custom.fields[h],i=g.createField(j.type,j.numComponents);e.addObject(j.id,i)}g.allocateElements(f.custom.numElements)}return g},"o3d.VertexBuffer":function(e,f){return c(e,f,"o3d.VertexBuffer",
"vertex-buffers.bin")},"o3d.SourceBuffer":function(e,f){return c(e,f,"o3d.SourceBuffer","vertex-buffers.bin")},"o3d.IndexBuffer":function(e,f){return c(e,f,"o3d.IndexBuffer","index-buffers.bin")},"o3d.Texture2D":function(e,f){if("o3d.uri"in f.params){var g=f.params["o3d.uri"].value,h=e.archiveInfo.getFileByURI(g);if(!h)throw"Could not find texture "+g+" in the archive";return o3djs.texture.createTextureFromRawData(a,h,true)}else return e.pack.createTexture2D(f.custom.width,f.custom.height,f.custom.format,
f.custom.levels,f.custom.renderSurfacesEnabled)},"o3d.TextureCUBE":function(e,f){if("o3d.negx_uri"in f.params){for(var g=["o3d.posx_uri","o3d.negx_uri","o3d.posy_uri","o3d.negy_uri","o3d.posz_uri","o3d.negz_uri"],h=[],j=0;j<g.length;j++){var i=f.params[g[j]].value,k=e.archiveInfo.getFileByURI(i);if(!k)throw"Could not find texture "+i+" in the archive";h.push(k)}return o3djs.texture.createTextureFromRawDataArray(a,h,true,false)}else if("o3d.uri"in f.params){i=f.params["o3d.uri"].value;k=e.archiveInfo.getFileByURI(i);
if(!k)throw"Could not find texture "+i+" in the archive";return o3djs.texture.createTextureFromRawData(a,k,true)}else return e.pack.createTextureCUBE(f.custom.edgeLength,f.custom.format,f.custom.levels,f.custom.renderSurfacesEnabled)}};this.initCallbacks={"o3d.Curve":function(e,f,g){if("custom"in g)if("keys"in g.custom){g=g.custom.keys;e=o3djs.serialization.CURVE_KEY_TYPES.step;for(var h=o3djs.serialization.CURVE_KEY_TYPES.linear,j=o3djs.serialization.CURVE_KEY_TYPES.bezier,i=0;i<g.length;++i){var k=
g[i];switch(k[0]){case e:f.addStepKeys(k.slice(1));break;case h:f.addLinearKeys(k.slice(1));break;case j:f.addBezierKeys(k.slice(1))}}}else{e=e.archiveInfo.getFileByURI("curve-keys.bin");f.set(e,g.custom.binaryRange[0],g.custom.binaryRange[1]-g.custom.binaryRange[0])}},"o3d.Effect":function(e,f){var g=f.getParam("o3d.uri");if(g){var h=e.archiveInfo.getFileByURI(g.value);if(!h)throw"Cannot find shader "+g.value+" in archive.";if(!f.loadFromFXString(h.stringValue))throw"Cannot load shader "+g.value+
" in archive.";}},"o3d.Skin":function(e,f,g){if("custom"in g)if("binaryRange"in g.custom){e=e.archiveInfo.getFileByURI("skins.bin");f.set(e,g.custom.binaryRange[0],g.custom.binaryRange[1]-g.custom.binaryRange[0])}},"o3d.SkinEval":function(e,f,g){if("custom"in g)for(var h=0;h<g.custom.vertexStreams.length;++h){var j=g.custom.vertexStreams[h],i=e.getObjectById(j.stream.field);f.setVertexStream(j.stream.semantic,j.stream.semanticIndex,i,j.stream.startIndex);if("bind"in j){i=e.getObjectById(j.bind);f.bindStream(i,
j.stream.semantic,j.stream.semanticIndex)}}},"o3d.StreamBank":function(e,f,g){if("custom"in g)for(var h=0;h<g.custom.vertexStreams.length;++h){var j=g.custom.vertexStreams[h],i=e.getObjectById(j.stream.field);f.setVertexStream(j.stream.semantic,j.stream.semanticIndex,i,j.stream.startIndex);if("bind"in j){i=e.getObjectById(j.bind);f.bindStream(i,j.stream.semantic,j.stream.semanticIndex)}}}};if(!("version"in b))throw"Version in JSON file was missing.";if(b.version<o3djs.serialization.supportedVersion)throw"Version in JSON file was "+
b.version+" but expected at least version "+o3djs.serialization.supportedVersion+".";if(!("objects"in b))throw"Objects array in JSON file was missing.";this.objectsById_=[null];this.objectsByIndex_=[];this.classNames_=[];for(var d in b.objects)this.classNames_.push(d);this.globalObjectIndex_=this.nextObjectIndex_=this.nextClassIndex_=this.phase_=0};o3djs.serialization.Deserializer.prototype.getObjectById=function(a){return this.objectsById_[a]};
o3djs.serialization.Deserializer.prototype.addObject=function(a,b){this.objectsById_[a]=b};o3djs.serialization.Deserializer.prototype.deserializeValue=function(a){if(typeof a==="object"){if(a===null)return null;if("length"in a){for(var b=0;b!=a.length;++b)a[b]=this.deserializeValue(a[b]);return a}b=a.ref;if(b!==undefined){a=this.objectsById_[b];if(a===undefined)throw"Could not find object with id "+b+".";}}return a};
o3djs.serialization.Deserializer.prototype.setParamValue_=function(a,b,c){a=a.getParam(b);if(a!==null){b=c.value;if(b!==undefined)a.value=this.deserializeValue(b);c=c.bind;if(c!==undefined){b=this.objectsById_[c];if(b===undefined)throw"Could not find output param with id "+c+".";a.bind(b)}}};o3djs.serialization.Deserializer.prototype.createAndIdentifyParam_=function(a,b,c){var d=c["class"];a=d!==undefined?a.createParam(b,d):a.getParam(b);c=c.id;if(c!==undefined&&a!==null)this.objectsById_[c]=a};
o3djs.serialization.Deserializer.prototype.createObjectsPhase_=function(a){for(;this.nextClassIndex_<this.classNames_.length;++this.nextClassIndex_){for(var b=this.classNames_[this.nextClassIndex_],c=this.json.objects[b],d=c.length;this.nextObjectIndex_<d;++this.nextObjectIndex_){if(a--<=0)return;var e=c[this.nextObjectIndex_],f=undefined;if("id"in e)f=this.objectsById_[e.id];if(f===undefined)f=b in this.createCallbacks?this.createCallbacks[b](this,e):this.pack.createObject(b);this.objectsByIndex_[this.globalObjectIndex_++]=
f;if("id"in e)this.objectsById_[e.id]=f;if("params"in e)if("length"in e.params)for(var g=0;g!=e.params.length;++g){var h=e.params[g];this.createAndIdentifyParam_(f,g,h)}else for(var j in e.params){h=e.params[j];this.createAndIdentifyParam_(f,j,h)}}this.nextObjectIndex_=0}if(this.nextClassIndex_===this.classNames_.length){this.globalObjectIndex_=this.nextObjectIndex_=this.nextClassIndex_=0;++this.phase_}};
o3djs.serialization.Deserializer.prototype.setPropertiesPhase_=function(a){for(;this.nextClassIndex_<this.classNames_.length;++this.nextClassIndex_){for(var b=this.classNames_[this.nextClassIndex_],c=this.json.objects[b],d=c.length;this.nextObjectIndex_<d;++this.nextObjectIndex_){if(a--<=0)return;var e=c[this.nextObjectIndex_],f=this.objectsByIndex_[this.globalObjectIndex_++];if("properties"in e)for(var g in e.properties)if(g in f){var h=this.deserializeValue(e.properties[g]);f[g]=h}if("params"in
e)if("length"in e.params)for(h=0;h!=e.params.length;++h){var j=e.params[h];this.setParamValue_(f,h,j)}else for(var i in e.params){j=e.params[i];this.setParamValue_(f,i,j)}if(b in this.initCallbacks)this.initCallbacks[b](this,f,e)}this.nextObjectIndex_=0}if(this.nextClassIndex_===this.classNames_.length){this.globalObjectIndex_=this.nextObjectIndex_=this.nextClassIndex_=0;++this.phase_}};
o3djs.serialization.Deserializer.prototype.run=function(a){if(a){switch(this.phase_){case 0:this.createObjectsPhase_(a);break;case 1:this.setPropertiesPhase_(a)}return this.phase_<2}else{for(;this.run(1E4););return false}};
o3djs.serialization.Deserializer.prototype.runBackground=function(a,b,c,d){var e=this.json.objects.length*2/(c*60),f,g=this;f=window.setInterval(function(){var h=null,j=false,i=o3djs.error.createErrorCollector(a);try{j=!g.run(e)}catch(k){j=true;h=k}if(i.errors.length>0){j=true;h=i.errors.join("\n")+(h?"\n"+h.toString():"")}i.finish();if(j){window.clearInterval(f);d(b,h)}},1E3/60)};o3djs.serialization.createDeserializer=function(a,b){return new o3djs.serialization.Deserializer(a,b)};
o3djs.serialization.deserialize=function(a,b){o3djs.serialization.createDeserializer(a,b).run()};
o3djs.serialization.deserializeArchive=function(a,b,c,d,e,f,g){g=g||{};var h=a.getFileByURI(b);if(!h)throw"Could not find "+b+" in archive";h=eval("("+h.stringValue+")");b=o3djs.serialization.createDeserializer(d,h);b.addObject(h.o3d_rootObject_root,e);b.archiveInfo=a;a=function(i,k){if(!k){var l=i.getObjects("o3d.animSourceOwner","o3d.ParamObject");if(l.length>0){if(g.opt_animSource)for(var m=l[0].getParam("animSource").outputConnections,n=0;n<m.length;++n)m[n].bind(g.opt_animSource);for(n=0;n<l.length;++n)i.removeObject(l[n])}}f(i,
e,k)};if(g.opt_async)b.runBackground(c,d,5,a);else{h=null;c=o3djs.error.createErrorCollector(c);try{b.run()}catch(j){h=j}if(c.errors.length>0)h=c.errors.join("\n")+(h?"\n"+h.toString():"");c.finish();a(d,h)}};o3djs.provide("o3djs.shape");o3djs.require("o3djs.math");o3djs.require("o3djs.element");o3djs.shape=o3djs.shape||{};o3djs.shape.addMissingTexCoordStreams=function(a){a=a.elements;for(var b=0;b<a.length;++b)o3djs.element.addMissingTexCoordStreams(a[b])};
o3djs.shape.setBoundingBoxesAndZSortPoints=function(a){a=a.elements;for(var b=0;b<a.length;++b)o3djs.element.setBoundingBoxAndZSortPoint(a[b])};o3djs.shape.prepareShape=function(a,b){b.createDrawElements(a,null);o3djs.shape.setBoundingBoxesAndZSortPoints(b);o3djs.shape.addMissingTexCoordStreams(b)};o3djs.shape.prepareShapes=function(a){for(var b=a.getObjectsByClassName("o3d.Shape"),c=0;c<b.length;++c)o3djs.shape.prepareShape(a,b[c])};
o3djs.shape.deleteDuplicateShape=function(a,b){for(var c=a.elements,d=0;d<c.length;d++){for(var e=c[d],f=e.drawElements,g=0;g<f.length;g++)b.removeObject(f[g]);b.removeObject(e)}b.removeObject(a)};o3djs.shape.duplicateShape=function(a,b){for(var c=a.createObject("Shape"),d=b.elements,e=0;e<d.length;e++)o3djs.element.duplicateElement(a,d[e]).owner=c;c.createDrawElements(a,null);return c};o3djs.provide("o3djs.serialization");o3djs.require("o3djs.error");o3djs.require("o3djs.texture");
o3djs.serialization=o3djs.serialization||{};o3djs.serialization.supportedVersion=5;o3djs.serialization.CURVE_KEY_TYPES={step:1,linear:2,bezier:3};o3djs.serialization.Options=goog.typedef;
o3djs.serialization.Deserializer=function(a,b){function c(e,f,g,h){g=e.pack.createObject(g);if("custom"in f)if("fieldData"in f.custom){f=f.custom.fieldData;if(f.length>0){h=[];for(var j=0;j<f.length;++j){var i=f[j],k=g.createField(i.type,i.numComponents);h.push(k);e.addObject(i.id,k)}e=f[0];g.allocateElements(e.data.length/e.numComponents);for(j=0;j<f.length;++j){i=f[j];h[j].setAt(0,i.data)}}}else{h=e.archiveInfo.getFileByURI(h);g.set(h,f.custom.binaryRange[0],f.custom.binaryRange[1]-f.custom.binaryRange[0]);
for(h=0;h<f.custom.fields.length;++h)e.addObject(f.custom.fields[h],g.fields[h])}return g}this.pack=a;this.json=b;this.archiveInfo=null;this.createCallbacks={"o3djs.DestinationBuffer":function(e,f){var g=e.pack.createObject("o3d.VertexBuffer");if("custom"in f){for(var h=0;h<f.custom.fields.length;++h){var j=f.custom.fields[h],i=g.createField(j.type,j.numComponents);e.addObject(j.id,i)}g.allocateElements(f.custom.numElements)}return g},"o3d.VertexBuffer":function(e,f){return c(e,f,"o3d.VertexBuffer",
"vertex-buffers.bin")},"o3d.SourceBuffer":function(e,f){return c(e,f,"o3d.SourceBuffer","vertex-buffers.bin")},"o3d.IndexBuffer":function(e,f){return c(e,f,"o3d.IndexBuffer","index-buffers.bin")},"o3d.Texture2D":function(e,f){if("o3d.uri"in f.params){var g=f.params["o3d.uri"].value,h=e.archiveInfo.getFileByURI(g);if(!h)throw"Could not find texture "+g+" in the archive";return o3djs.texture.createTextureFromRawData(a,h,true)}else return e.pack.createTexture2D(f.custom.width,f.custom.height,f.custom.format,
f.custom.levels,f.custom.renderSurfacesEnabled)},"o3d.TextureCUBE":function(e,f){if("o3d.negx_uri"in f.params){for(var g=["o3d.posx_uri","o3d.negx_uri","o3d.posy_uri","o3d.negy_uri","o3d.posz_uri","o3d.negz_uri"],h=[],j=0;j<g.length;j++){var i=f.params[g[j]].value,k=e.archiveInfo.getFileByURI(i);if(!k)throw"Could not find texture "+i+" in the archive";h.push(k)}return o3djs.texture.createTextureFromRawDataArray(a,h,true,false)}else if("o3d.uri"in f.params){i=f.params["o3d.uri"].value;k=e.archiveInfo.getFileByURI(i);
if(!k)throw"Could not find texture "+i+" in the archive";return o3djs.texture.createTextureFromRawData(a,k,true)}else return e.pack.createTextureCUBE(f.custom.edgeLength,f.custom.format,f.custom.levels,f.custom.renderSurfacesEnabled)}};this.initCallbacks={"o3d.Curve":function(e,f,g){if("custom"in g)if("keys"in g.custom){g=g.custom.keys;e=o3djs.serialization.CURVE_KEY_TYPES.step;for(var h=o3djs.serialization.CURVE_KEY_TYPES.linear,j=o3djs.serialization.CURVE_KEY_TYPES.bezier,i=0;i<g.length;++i){var k=
g[i];switch(k[0]){case e:f.addStepKeys(k.slice(1));break;case h:f.addLinearKeys(k.slice(1));break;case j:f.addBezierKeys(k.slice(1))}}}else{e=e.archiveInfo.getFileByURI("curve-keys.bin");f.set(e,g.custom.binaryRange[0],g.custom.binaryRange[1]-g.custom.binaryRange[0])}},"o3d.Effect":function(e,f){var g=f.getParam("o3d.uri");if(g){var h=e.archiveInfo.getFileByURI(g.value);if(!h)throw"Cannot find shader "+g.value+" in archive.";if(!f.loadFromFXString(h.stringValue))throw"Cannot load shader "+g.value+
" in archive.";}},"o3d.Skin":function(e,f,g){if("custom"in g)if("binaryRange"in g.custom){e=e.archiveInfo.getFileByURI("skins.bin");f.set(e,g.custom.binaryRange[0],g.custom.binaryRange[1]-g.custom.binaryRange[0])}},"o3d.SkinEval":function(e,f,g){if("custom"in g)for(var h=0;h<g.custom.vertexStreams.length;++h){var j=g.custom.vertexStreams[h],i=e.getObjectById(j.stream.field);f.setVertexStream(j.stream.semantic,j.stream.semanticIndex,i,j.stream.startIndex);if("bind"in j){i=e.getObjectById(j.bind);f.bindStream(i,
j.stream.semantic,j.stream.semanticIndex)}}},"o3d.StreamBank":function(e,f,g){if("custom"in g)for(var h=0;h<g.custom.vertexStreams.length;++h){var j=g.custom.vertexStreams[h],i=e.getObjectById(j.stream.field);f.setVertexStream(j.stream.semantic,j.stream.semanticIndex,i,j.stream.startIndex);if("bind"in j){i=e.getObjectById(j.bind);f.bindStream(i,j.stream.semantic,j.stream.semanticIndex)}}}};if(!("version"in b))throw"Version in JSON file was missing.";if(b.version<o3djs.serialization.supportedVersion)throw"Version in JSON file was "+
b.version+" but expected at least version "+o3djs.serialization.supportedVersion+".";if(!("objects"in b))throw"Objects array in JSON file was missing.";this.objectsById_=[null];this.objectsByIndex_=[];this.classNames_=[];for(var d in b.objects)this.classNames_.push(d);this.globalObjectIndex_=this.nextObjectIndex_=this.nextClassIndex_=this.phase_=0};o3djs.serialization.Deserializer.prototype.getObjectById=function(a){return this.objectsById_[a]};
o3djs.serialization.Deserializer.prototype.addObject=function(a,b){this.objectsById_[a]=b};o3djs.serialization.Deserializer.prototype.deserializeValue=function(a){if(typeof a==="object"){if(a===null)return null;if("length"in a){for(var b=0;b!=a.length;++b)a[b]=this.deserializeValue(a[b]);return a}b=a.ref;if(b!==undefined){a=this.objectsById_[b];if(a===undefined)throw"Could not find object with id "+b+".";}}return a};
o3djs.serialization.Deserializer.prototype.setParamValue_=function(a,b,c){a=a.getParam(b);if(a!==null){b=c.value;if(b!==undefined)a.value=this.deserializeValue(b);c=c.bind;if(c!==undefined){b=this.objectsById_[c];if(b===undefined)throw"Could not find output param with id "+c+".";a.bind(b)}}};o3djs.serialization.Deserializer.prototype.createAndIdentifyParam_=function(a,b,c){var d=c["class"];a=d!==undefined?a.createParam(b,d):a.getParam(b);c=c.id;if(c!==undefined&&a!==null)this.objectsById_[c]=a};
o3djs.serialization.Deserializer.prototype.createObjectsPhase_=function(a){for(;this.nextClassIndex_<this.classNames_.length;++this.nextClassIndex_){for(var b=this.classNames_[this.nextClassIndex_],c=this.json.objects[b],d=c.length;this.nextObjectIndex_<d;++this.nextObjectIndex_){if(a--<=0)return;var e=c[this.nextObjectIndex_],f=undefined;if("id"in e)f=this.objectsById_[e.id];if(f===undefined)f=b in this.createCallbacks?this.createCallbacks[b](this,e):this.pack.createObject(b);this.objectsByIndex_[this.globalObjectIndex_++]=
f;if("id"in e)this.objectsById_[e.id]=f;if("params"in e)if("length"in e.params)for(var g=0;g!=e.params.length;++g){var h=e.params[g];this.createAndIdentifyParam_(f,g,h)}else for(var j in e.params){h=e.params[j];this.createAndIdentifyParam_(f,j,h)}}this.nextObjectIndex_=0}if(this.nextClassIndex_===this.classNames_.length){this.globalObjectIndex_=this.nextObjectIndex_=this.nextClassIndex_=0;++this.phase_}};
o3djs.serialization.Deserializer.prototype.setPropertiesPhase_=function(a){for(;this.nextClassIndex_<this.classNames_.length;++this.nextClassIndex_){for(var b=this.classNames_[this.nextClassIndex_],c=this.json.objects[b],d=c.length;this.nextObjectIndex_<d;++this.nextObjectIndex_){if(a--<=0)return;var e=c[this.nextObjectIndex_],f=this.objectsByIndex_[this.globalObjectIndex_++];if("properties"in e)for(var g in e.properties)if(g in f){var h=this.deserializeValue(e.properties[g]);f[g]=h}if("params"in
e)if("length"in e.params)for(h=0;h!=e.params.length;++h){var j=e.params[h];this.setParamValue_(f,h,j)}else for(var i in e.params){j=e.params[i];this.setParamValue_(f,i,j)}if(b in this.initCallbacks)this.initCallbacks[b](this,f,e)}this.nextObjectIndex_=0}if(this.nextClassIndex_===this.classNames_.length){this.globalObjectIndex_=this.nextObjectIndex_=this.nextClassIndex_=0;++this.phase_}};
o3djs.serialization.Deserializer.prototype.run=function(a){if(a){switch(this.phase_){case 0:this.createObjectsPhase_(a);break;case 1:this.setPropertiesPhase_(a)}return this.phase_<2}else{for(;this.run(1E4););return false}};
o3djs.serialization.Deserializer.prototype.runBackground=function(a,b,c,d){var e=this.json.objects.length*2/(c*60),f,g=this;f=window.setInterval(function(){var h=null,j=false,i=o3djs.error.createErrorCollector(a);try{j=!g.run(e)}catch(k){j=true;h=k}if(i.errors.length>0){j=true;h=i.errors.join("\n")+(h?"\n"+h.toString():"")}i.finish();if(j){window.clearInterval(f);d(b,h)}},1E3/60)};o3djs.serialization.createDeserializer=function(a,b){return new o3djs.serialization.Deserializer(a,b)};
o3djs.serialization.deserialize=function(a,b){o3djs.serialization.createDeserializer(a,b).run()};
o3djs.serialization.deserializeArchive=function(a,b,c,d,e,f,g){g=g||{};var h=a.getFileByURI(b);if(!h)throw"Could not find "+b+" in archive";h=eval("("+h.stringValue+")");b=o3djs.serialization.createDeserializer(d,h);b.addObject(h.o3d_rootObject_root,e);b.archiveInfo=a;a=function(i,k){if(!k){var l=i.getObjects("o3d.animSourceOwner","o3d.ParamObject");if(l.length>0){if(g.opt_animSource)for(var m=l[0].getParam("animSource").outputConnections,n=0;n<m.length;++n)m[n].bind(g.opt_animSource);for(n=0;n<l.length;++n)i.removeObject(l[n])}}f(i,
e,k)};if(g.opt_async)b.runBackground(c,d,5,a);else{h=null;c=o3djs.error.createErrorCollector(c);try{b.run()}catch(j){h=j}if(c.errors.length>0)h=c.errors.join("\n")+(h?"\n"+h.toString():"");c.finish();a(d,h)}};o3djs.provide("o3djs.simple");o3djs.require("o3djs.math");o3djs.require("o3djs.material");o3djs.require("o3djs.effect");o3djs.require("o3djs.shape");o3djs.require("o3djs.util");o3djs.require("o3djs.rendergraph");o3djs.require("o3djs.pack");o3djs.require("o3djs.primitives");o3djs.require("o3djs.io");
o3djs.require("o3djs.scene");o3djs.require("o3djs.camera");o3djs.simple=o3djs.simple||{};o3djs.simple.create=function(a){return new o3djs.simple.SimpleInfo(a)};
o3djs.simple.SimpleInfo=function(a){this.clientObject=a;this.o3d=a.o3d;this.client=a.client;this.pack=this.client.createPack();this.root=this.pack.createObject("Transform");this.viewInfo=o3djs.rendergraph.createBasicView(this.pack,this.root,this.client.renderGraphRoot);this.updateObjects_={};this.nextId_=1;a=this.pack.createObject("Material");o3djs.effect.attachStandardShader(this.pack,a,[0,0,0],"phong");this.nonTexturedEffect_=a.effect;this.pack.removeObject(a);a=this.pack.createObject("Material");
a.createParam("diffuseSampler","ParamSampler");o3djs.effect.attachStandardShader(this.pack,a,[0,0,0],"phong");this.texturedEffect_=a.effect;this.pack.removeObject(a);this.globalParamObject=this.pack.createObject("ParamObject");this.lightWorldPosParam=this.globalParamObject.createParam("lightWorldPos","ParamFloat3");this.lightColorParam=this.globalParamObject.createParam("lightColor","ParamFloat4");this.setLightColor(1,1,1,1);this.setLightPosition(255,150,150);this.zNear=0.1;this.zFar=1E3;this.fieldOfView=
o3djs.math.degToRad(45);this.setPerspectiveMatrix_();this.cameraPosition=[250,150,150];this.cameraTarget=[0,0,0];this.cameraUp=[0,1,0];this.setViewMatrix_();var b=this;this.client.setRenderCallback(function(c){b.onRender_(Math.min(c.elapsedTime,0.1))})};o3djs.simple.SimpleInfo.prototype.getNextId=function(){return this.nextId_++};
o3djs.simple.SimpleInfo.prototype.createSimpleShape=function(a){a.createDrawElements(this.pack,null);var b=this.pack.createObject("Transform");b.parent=this.root;b.addShape(a);return new o3djs.simple.SimpleShape(this,b)};o3djs.simple.SimpleInfo.prototype.onRender_=function(a){for(var b in this.updateObjects_)this.updateObjects_[b].onUpdate(a)};o3djs.simple.SimpleInfo.prototype.registerObjectForUpdate=function(a){this.updateObjects_[a.id]=a};
o3djs.simple.SimpleInfo.prototype.unregisterObjectForUpdate=function(a){delete this.updateObjects_[a.id]};o3djs.simple.SimpleInfo.prototype.setPerspectiveMatrix_=function(){this.viewInfo.drawContext.projection=o3djs.math.matrix4.perspective(this.fieldOfView,this.client.width/this.client.height,this.zNear,this.zFar)};o3djs.simple.SimpleInfo.prototype.setViewMatrix_=function(){this.viewInfo.drawContext.view=o3djs.math.matrix4.lookAt(this.cameraPosition,this.cameraTarget,this.cameraUp)};
o3djs.simple.SimpleInfo.prototype.setFieldOfView=function(a){this.fieldOfView=a;this.setPerspectiveMatrix_()};o3djs.simple.SimpleInfo.prototype.setZClip=function(a,b){this.zNear=a;this.zFar=b;this.setPerspectiveMatrix_()};o3djs.simple.SimpleInfo.prototype.setLightPosition=function(a,b,c){this.lightWorldPosParam.set(a,b,c)};o3djs.simple.SimpleInfo.prototype.setLightColor=function(a,b,c,d){this.lightColorParam.set(a,b,c,d)};
o3djs.simple.SimpleInfo.prototype.setCameraPosition=function(a,b,c){this.cameraPosition=[a,b,c];this.setViewMatrix_()};o3djs.simple.SimpleInfo.prototype.setCameraTarget=function(a,b,c){this.cameraTarget=[a,b,c];this.setViewMatrix_()};o3djs.simple.SimpleInfo.prototype.setCameraUp=function(a,b,c){this.cameraUp=[a,b,c];this.setViewMatrix_()};
o3djs.simple.SimpleInfo.prototype.createMaterialFromEffect=function(a){var b=this.pack.createObject("Material");b.drawList=this.viewInfo.performanceDrawList;b.effect=a;a.createUniformParameters(b);b.getParam("lightWorldPos").bind(this.lightWorldPosParam);b.getParam("lightColor").bind(this.lightColorParam);return b};
o3djs.simple.SimpleInfo.prototype.createNonTexturedMaterial=function(){var a=this.createMaterialFromEffect(this.nonTexturedEffect_);a.getParam("diffuse").set(1,1,1,1);a.getParam("emissive").set(0,0,0,1);a.getParam("ambient").set(0,0,0,1);a.getParam("specular").set(1,1,1,1);a.getParam("shininess").value=20;return a};
o3djs.simple.SimpleInfo.prototype.createTexturedMaterial=function(){var a=this.createMaterialFromEffect(this.texturedEffect_),b=a.getParam("diffuseSampler"),c=this.pack.createObject("Sampler");b.value=c;return a};o3djs.simple.SimpleInfo.prototype.createCube=function(a){var b=this.createNonTexturedMaterial("phong");return this.createSimpleShape(o3djs.primitives.createCube(this.pack,b,a))};
o3djs.simple.SimpleInfo.prototype.createBox=function(a,b,c){var d=this.createNonTexturedMaterial("phong");return this.createSimpleShape(o3djs.primitives.createBox(this.pack,d,a,b,c))};o3djs.simple.SimpleInfo.prototype.createSphere=function(a,b){var c=this.createNonTexturedMaterial("phong");return this.createSimpleShape(o3djs.primitives.createSphere(this.pack,c,a,b*2,b))};
o3djs.simple.SimpleInfo.prototype.loadScene=function(a,b){var c=this.client.createPack(),d=c.createObject("Transform"),e=c.createObject("ParamObject"),f=e.createParam("animTime","ParamFloat"),g=this;return o3djs.scene.loadScene(this.client,c,d,a,function(h,j,i){var k=null;if(i)h.destroy();else k=new o3djs.simple.SimpleScene(g,a,h,j,e);b(k,i)},{opt_animSource:f})};
o3djs.simple.SimpleInfo.prototype.viewAll=function(){var a=o3djs.util.getBoundingBoxOfTree(this.root),b=o3djs.math.lerpVector(a.minExtent,a.maxExtent,0.5);this.setCameraTarget(b[0],b[1],b[2]);var c=o3djs.math.distance(a.minExtent,a.maxExtent);a=o3djs.math.addVector(b,[a.maxExtent[0],a.minExtent[1]+0.5*c,a.maxExtent[2]]);this.setCameraPosition(a[0],a[1],a[2]);this.setZClip(c/1E3,c*10)};o3djs.simple.SimpleObject=function(){};
o3djs.simple.SimpleObject.prototype.init=function(a,b){this.simpleInfo=a;this.id=a.getNextId();this.transform=b;this.pickCallback_=this.updateCallback_=null};o3djs.simple.SimpleObject.prototype.onPicked=function(){throw"not implemented";};o3djs.simple.SimpleObject.prototype.onUpdate=function(a){this.updateCallback_&&this.updateCallback_(a)};
o3djs.simple.SimpleObject.prototype.setOnUpdate=function(a){a?this.simpleInfo.registerObjectForUpdate(this):this.simpleInfo.unregisterObjectForUpdate(this);var b=this.updateCallback_;this.updateCallback_=a;return b};o3djs.simple.SimpleShape=function(a,b){this.init(a,b)};o3djs.simple.SimpleShape.prototype=new o3djs.simple.SimpleObject;o3djs.simple.SimpleShape.prototype.getMaterial=function(){return this.transform.shapes[0].elements[0].material};
o3djs.simple.SimpleShape.prototype.setMaterial=function(a){var b=this.getMaterial();b!=null&&this.simpleInfo.pack.removeObject(b);this.transform.shapes[0].elements[0].material=a};o3djs.simple.SimpleShape.prototype.setDiffuseColor=function(a,b,c,d){var e=this.getMaterial();e.getParam("diffuse").set(a,b,c,d);e.drawList=d<1?this.simpleInfo.viewInfo.zOrderedDrawList:this.simpleInfo.viewInfo.performanceDrawList};
o3djs.simple.SimpleShape.prototype.getTexture=function(){var a=this.getMaterial().getParam("diffuseSampler");if(a.className=="o3d.ParamSampler")return a.texture;return null};
o3djs.simple.SimpleShape.prototype.loadTexture=function(a){var b=this;o3djs.io.loadTexture(this.simpleInfo.pack,a,function(c,d){if(d)alert("Load texture file returned failure. \n"+d);else{var e=b.getMaterial();if(e.effect!=b.simpleInfo.texturedEffect_){var f=b.simpleInfo.createTexturedMaterial("phong");f.copyParams(e);f.effect=b.simpleInfo.texturedEffect_;b.setMaterial(f);e=f}e.getParam("diffuseSampler").value.texture=c}})};
o3djs.simple.SimpleScene=function(a,b,c,d,e){this.init(a,d);this.url=b;this.pack=c;this.paramObject=e;this.animTimeParam=e.getParam("animTime");o3djs.pack.preparePack(c,a.viewInfo);this.cameraInfos_=o3djs.camera.getCameraInfos(d,a.client.width,a.client.height);b=function(f,g,h){(f=f.getParam(g))&&f.bind(h)};c=c.getObjectsByClassName("o3d.Material");for(d=0;d<c.length;++d){e=c[d];b(e,"lightWorldPos",a.lightWorldPosParam);b(e,"lightColor",a.lightColorParam)}this.transform.parent=this.simpleInfo.root};
o3djs.simple.SimpleScene.prototype=new o3djs.simple.SimpleObject;o3djs.simple.SimpleScene.prototype.setAnimTime=function(a){this.animTimeParam.value=a};o3djs.provide("o3djs.test");o3djs.test=o3djs.test||{};o3djs.test.AssertionError=function(a){this.message=a;this.toString=function(){return a}};
o3djs.test.runTests=function(a,b){try{b=b||o3djs.test.documentReporter;var c=0,d=0,e;for(e in a)if(e.substring(0,4)==="test")if(typeof a[e]==="function"){try{a[e]()}catch(f){++d;b.reportFail(e,String(f));continue}++c;b.reportPass(e)}b.reportSummary(c,d);return d==0}catch(g){return false}};
o3djs.test.valueToString_=function(a,b){if(b===undefined)b=3;var c;if(typeof a==="object")if(a!==null)if(b===0)c="?";else if(o3djs.base.isArray(a)){c="[";for(var d="",e=0;e<a.length;++e){c+=d+o3djs.test.valueToString_(a[e],b-1);d=", "}c+="]"}else{c="{";d="";for(e in a)if(typeof a[e]!=="function"){c+=d+e+": "+o3djs.test.valueToString_(a[e],b-1);d=", "}c+="}"}else c="null";else c=typeof a==="string"?'"'+a+'"':String(a);return c};
o3djs.test.assertTrue=function(a){if(!a)throw new o3djs.test.AssertionError("assertTrue failed for "+o3djs.test.valueToString_(a));};o3djs.test.assertFalse=function(a){if(a)throw new o3djs.test.AssertionError("assertFalse failed for "+o3djs.test.valueToString_(a));};o3djs.test.assertNull=function(a){if(a!==null)throw new o3djs.test.AssertionError("assertNull failed for "+o3djs.test.valueToString_(a));};
o3djs.test.assertEquals=function(a,b){if(a!==b)throw new o3djs.test.AssertionError("assertEquals failed: expected "+o3djs.test.valueToString_(a)+" but got "+o3djs.test.valueToString_(b));};o3djs.test.assertClose=function(a,b){if(b<a-0.001||b>a+0.001)throw new o3djs.test.AssertionError("assertClose failed: expected "+o3djs.test.valueToString_(a)+" but got "+o3djs.test.valueToString_(b));};
o3djs.test.compareArrays_=function(a,b){if(a.length!==b.length)return false;for(var c=0;c!=a.length;++c)if(o3djs.base.isArray(a[c])&&o3djs.base.isArray(b[c])){if(!o3djs.test.compareArrays_(a[c],b[c]))return false}else if(a[c]!==b[c])return false;return true};
o3djs.test.assertArrayEquals=function(a,b){if(!o3djs.base.isArray(a))throw new o3djs.test.AssertionError("assertArrayEquals failed: expected value "+o3djs.test.valueToString_(a)+" is not an array");if(!o3djs.base.isArray(b))throw new o3djs.test.AssertionError("assertArrayEquals failed: actual value "+o3djs.test.valueToString_(b)+" is not an array");if(!o3djs.test.compareArrays_(a,b))throw new o3djs.test.AssertionError("assertArrayEquals failed: expected "+o3djs.test.valueToString_(a)+" but got "+
o3djs.test.valueToString_(b));};o3djs.test.createReportParagraph_=function(a,b){var c=document.createTextNode(a),d=document.createElement("p");d.appendChild(c);if(b!==undefined)d.style.color=b;return d};
o3djs.test.documentReporter={getReportDiv_:function(){if(!this.reportDiv_){this.reportDiv_=document.createElement("div");document.body.appendChild(this.reportDiv_)}return this.reportDiv_},reportPass:function(a){a=o3djs.test.createReportParagraph_(a+" : PASS","green");this.getReportDiv_().appendChild(a)},reportFail:function(a,b){var c=o3djs.test.createReportParagraph_(a+" : FAIL : "+b,"red"),d=this.getReportDiv_();d.insertBefore(c,d.firstChild)},reportSummary:function(a,b){var c=o3djs.test.createReportParagraph_(a+
" passed, "+b+" failed","blue"),d=this.getReportDiv_();d.insertBefore(c,d.firstChild)}};o3djs.provide("o3djs.texture");o3djs.texture=o3djs.texture||{};o3djs.texture.MAX_TEXTURE_DIMENSION=2048;o3djs.texture.computeNumLevels=function(a,b){if(a==0||b==0)return 0;for(var c=Math.max(a,b),d=0;c>0;){++d;c>>=1}return d};
o3djs.texture.createTextureFromRawData=function(a,b,c,d){b=a.createBitmapsFromRawData(b);if(d||typeof d==="undefined")for(d=0;d<b.length;++d)b[d].semantic==o3djs.base.o3d.Bitmap.IMAGE&&b[d].flipVertically();c=o3djs.texture.createTextureFromBitmaps(a,b,c);for(d=0;d<b.length;++d)a.removeObject(b[d]);return c};
o3djs.texture.createTextureFromRawDataArray=function(a,b,c,d){for(var e=[],f=0;f<b.length;++f)e=e.concat(a.createBitmapsFromRawData(b[f]));if(d||typeof d==="undefined")for(f=0;f<e.length;++f)e[f].semantic==o3djs.base.o3d.Bitmap.IMAGE&&e[f].flipVertically();b=o3djs.texture.createTextureFromBitmaps(a,e,c);for(f=0;f<e.length;++f)a.removeObject(e[f]);return b};o3djs.texture.canMakeMipsAndScale=function(a){switch(a){case o3djs.base.o3d.Texture.XRGB8:case o3djs.base.o3d.Texture.ARGB8:case o3djs.base.o3d.Texture.ABGR16F:case o3djs.base.o3d.Texture.R32F:case o3djs.base.o3d.Texture.ABGR32F:return true}return false};
o3djs.texture.createTextureFromBitmaps=function(a,b,c){if(b.length==0)throw"no bitmaps";var d=b[0].width,e=b[0].height,f=b[0].format,g=b[0].numMipmaps,h=o3djs.texture.computeNumLevels(d,e),j=g;if((typeof c==="undefined"||c)&&o3djs.texture.canMakeMipsAndScale(f)&&g==1&&h>1)j=h;for(c=0;c<b.length;++c){var i=b[c];if(i.width!=d||i.height!=e||i.format!=f||i.numMipmaps!=g)throw"bitmaps must all be the same width, height, mips and format";j!=g&&i.generateMips(0,j-1)}i.numMipmaps>1||o3djs.texture.computeNumLevels(d,
e);var k;if(b.length==6&&b[0].semantic!=o3djs.base.o3d.Bitmap.SLICE){if(d!=e||d!=d||e!=e)throw"Cubemaps must be square";k=a.createTextureCUBE(d,f,j,false);for(c=0;c<6;++c)k.setFromBitmap(c,b[c])}else if(b.length==1){k=a.createTexture2D(d,e,f,j,false);k.setFromBitmap(b[0])}return k};o3djs.texture.createCubeTextureFrom6Bitmaps=function(a,b,c){var d=o3djs.texture.computeNumLevels(b,b);a=a.createTextureCUBE(b,c[0].format,d,false);for(b=0;b<6;++b)a.setFromBitmap(b,c[b]);a.generateMips(0,d-1);return a};
o3djs.provide("o3djs.util");o3djs.require("o3djs.io");o3djs.require("o3djs.effect");o3djs.require("o3djs.event");o3djs.require("o3djs.error");o3djs.util=o3djs.util||{};o3djs.util.PLUGIN_NAME="O3D Plugin";o3djs.util.REQUIRED_VERSION="0.1.42.4";o3djs.util.MINIMUM_WIDTH_FOR_MESSAGE=200;o3djs.util.MINIMUM_HEIGHT_FOR_MESSAGE=200;o3djs.util.PLUGIN_DOWNLOAD_URL="http://tools.google.com/dlpage/o3d";
o3djs.util.rendererInitStatus={NO_PLUGIN:-1,UNINITIALIZED:0,SUCCESS:1,OUT_OF_RESOURCES:2,GPU_NOT_UP_TO_SPEC:3,INITIALIZATION_ERROR:4};o3djs.util.curry=function(a){for(var b=[],c=1;c<arguments.length;++c)b.push(arguments[c]);return function(){for(var d=b.slice(),e=0;e<arguments.length;++e)d.push(arguments[e]);return a.apply(this,d)}};o3djs.util.getCurrentURI=function(){var a=window.location.href,b=a.lastIndexOf("/");return a.substring(0,b+1)};
o3djs.util.getAbsoluteURI=function(a){return o3djs.util.getCurrentURI()+a};o3djs.util.arrayContains=function(a,b){for(var c=0;c<a.length;c++)if(a[c]==b)return true;return false};o3djs.util.getTransformsInTreeByTags=function(a,b){for(var c=b.split(","),d=a.getTransformsInTree(),e=[],f=0;f<d.length;f++){var g=d[f].getParam("collada.tags");if(g){g=g.value.split(",");for(var h=0;h<g.length;h++)if(o3djs.util.arrayContains(c,g[h])){e[e.length]=d[f];break}}}return e};
o3djs.util.getTransformsInTreeByPrefix=function(a,b){for(var c=[],d=a.getTransformsInTree(),e=0;e<d.length;e++){var f=d[e];if(f.name.indexOf(b)==0)c[c.length]=f}return c};
o3djs.util.getBoundingBoxOfTree=function(a){var b=a.boundingBox;if(b.valid)return b;for(var c=a.children,d=0;d<c.length;++d){var e=c[d],f=o3djs.util.getBoundingBoxOfTree(e);if(f.valid){f=f.mul(e.localMatrix);b=b.valid?b.add(f):f}}a=a.shapes;for(d=0;d<a.length;++d){c=a[d].elements;for(e=0;e<c.length;++e){f=c[e].boundingBox;f.valid||(f=c[e].getBoundingBox(0));b=b.valid?b.add(f):f}}return b};o3djs.util.getPowerOfTwoSize=function(a){var b=1;for(a-=1;a;){a>>=1;b<<=1}return b};
o3djs.util.getPluginVersion=function(){var a=null,b=null;if(navigator.plugins!=null&&navigator.plugins.length>0){var c=navigator.plugins[o3djs.util.PLUGIN_NAME];if(c)b=c.description}else if(o3djs.base.IsMSIE())try{b=(new ActiveXObject("o3d_host.O3DHostControl")).description}catch(d){}if(b)if((b=/.*version:\s*(\d+)\.(\d+)\.(\d+)\.(\d+).*/.exec(b))&&b.length==5)a=""+parseInt(b[1],10)+"."+parseInt(b[2],10)+"."+parseInt(b[3],10)+"."+parseInt(b[4],10);return a};
o3djs.util.requiredVersionAvailable=function(a){var b=o3djs.util.getPluginVersion();if(!b)return false;b=b.split(".");a=a.split(".");if(a.length>4)throw Error("requiredVersion has more than 4 parts!");for(var c=0;c<a.length;++c){var d=parseInt(b[c],10),e=parseInt(a[c],10);if(d<e)return false;if(d>e)break}return true};o3djs.util.getElementsByTagAndId=function(a,b){for(var c=[],d=document.getElementsByTagName(a),e=0;e<d.length;++e){var f=d[e];f.id&&f.id.match(b)&&c.push(f)}return c};
o3djs.util.getO3DContainerElements=function(a,b){return o3djs.util.getElementsByTagAndId(b||"div",a||"^o3d")};
o3djs.util.offerPlugin=function(a,b){var c=o3djs.util.requiredVersionAvailable(""),d=o3djs.util.getO3DContainerElements(a,b),e=false;c=c?"This page requires a newer version of the O3D plugin.":"This page requires the O3D plugin to be installed.";for(var f='<div style="background: lightblue; width: 100%; height: 100%; text-align:center;"><br/><br/>'+c+'<br/><a href="'+o3djs.util.PLUGIN_DOWNLOAD_URL+'">Click here to download.</a></div>',g=0;g<d.length;++g){var h=d[g];if(h.clientWidth>=o3djs.util.MINIMUM_WIDTH_FOR_MESSAGE&&
h.clientHeight>=o3djs.util.MINIMUM_HEIGHT_FOR_MESSAGE&&h.style.display.toLowerCase()!="none"&&h.style.visibility.toLowerCase()!="hidden"){e=true;h.innerHTML=f}}if(!e)if(confirm(c+"\n\nClick OK to download."))window.location=o3djs.util.PLUGIN_DOWNLOAD_URL};
o3djs.util.informNoGraphics=function(a,b,c,d){c=o3djs.util.getO3DContainerElements(c,d);d=false;var e="",f=function(){},g=function(j){var i="";if(j.length>0)i="<br/><br/><div>More Info:<br/>"+j+"</div>";return i};if(a==o3djs.util.rendererInitStatus.GPU_NOT_UP_TO_SPEC){a="We are terribly sorry but it appears your graphics card is not able to run o3d. We are working on a solution.";b='<div style="background: lightgray; width: 100%; height: 100%; text-align: center;"><br/><br/>'+a+'<br/><br/><a href="'+
o3djs.util.PLUGIN_DOWNLOAD_URL+'">Click Here to go the O3D website</a>'+g(b)+"</div>";e="\n\nClick OK to go to the o3d website.";f=function(){window.location=o3djs.util.PLUGIN_DOWNLOAD_URL}}else{a=a==o3djs.util.rendererInitStatus.OUT_OF_RESOURCES?"Your graphics system appears to be out of resources. Try closing some applications and then refreshing this page.":"A unknown error has prevented O3D from starting. Try downloading new drivers or checking for OS updates.";b='<div style="background: lightgray; width: 100%; height: 100%; text-align: center;"><br/><br/>'+
a+g(b)+"</div>"}for(g=0;g<c.length;++g){var h=c[g];if(h.clientWidth>=o3djs.util.MINIMUM_WIDTH_FOR_MESSAGE&&h.clientHeight>=o3djs.util.MINIMUM_HEIGHT_FOR_MESSAGE&&h.style.display.toLowerCase()!="none"&&h.style.visibility.toLowerCase()!="hidden"){d=true;h.innerHTML=b}}d||confirm(a+e)&&f()};o3djs.util.informPluginFailure=function(a,b,c,d){a==o3djs.util.rendererInitStatus.NO_PLUGIN?o3djs.util.offerPlugin(c,d):o3djs.util.informNoGraphics(a,b,c,d)};
o3djs.util.getElementContentById=function(a){o3djs.BROWSER_ONLY=true;var b=document.getElementById(a);if(!b)throw"getElementContentById could not find node with id "+a;switch(b.tagName){case "TEXTAREA":return b.value;case "SCRIPT":return b.text;default:throw"getElementContentById does not no how to get content from a "+b.tagName+" element";}};o3djs.util.getElementById=function(a){o3djs.BROWSER_ONLY=true;return document.getElementById(a)};o3djs.util.Engine={BROWSER:0,V8:1};o3djs.util.mainEngine_=o3djs.util.Engine.BROWSER;
function o3djs_navHas(a){return navigator.userAgent.indexOf(a)!=-1}function o3djs_isV8Supported(){if(o3djs_navHas("Chrome"))return true;if(!o3djs_navHas("Safari"))return true;return!o3djs_navHas("Intel Mac OS X 10_6")}o3djs.util.setMainEngine=function(a){if(a==o3djs.util.Engine.V8&&!o3djs_isV8Supported())a=o3djs.util.Engine.BROWSER;o3djs.util.mainEngine_=a};o3djs.util.fixFunctionString_=/^\s*function\s+[^\s]+\s*\(([^)]*)\)/;
o3djs.util.callV8=function(a,b,c,d){b=b.toString();b=b.replace(o3djs.util.fixFunctionString_,"function($1)");return a.eval("function(thisArg, args) {\n  var localArgs = [];\n  var numArgs = args.length;\n  for (var i = 0; i < numArgs; ++i) {\n    localArgs.push(args[i]);\n  }\n  var func = "+b+";\n  return func.apply(thisArg, localArgs);\n}\n")(c,d)};o3djs.util.stripDotDot_=/\/[^\/]+\/\.\./;
o3djs.util.toAbsoluteUri=function(a){if(a.indexOf("://")==-1){var b=document.location.toString(),c=b.lastIndexOf("/");if(c!=-1)b=b.substring(0,c);a=b+"/"+a}do{b=a;a=a.replace(o3djs.util.stripDotDot_,"")}while(b!==a);return a};o3djs.util.scriptUris_=[];o3djs.util.addScriptUri=function(a){o3djs.util.scriptUris_.push(o3djs.util.toAbsoluteUri(a))};
o3djs.util.isScriptUri=function(a){a=o3djs.util.toAbsoluteUri(a);for(var b=0;b<o3djs.util.scriptUris_.length;++b){var c=o3djs.util.scriptUris_[b];if(a.substring(0,c.length)===c)return true}return false};o3djs.util.isWantedScriptTag_=function(a){return a.id&&a.id.match(/^o3dscript/)};
o3djs.util.getScriptTagText_=function(){for(var a="",b=document.getElementsByTagName("script"),c=0;c<b.length;++c){var d=b[c];if(d.type===""||d.type==="text/javascript"){if("text"in d&&d.text&&o3djs.util.isWantedScriptTag_(d))a+=d.text;if("src"in d&&d.src&&o3djs.util.isScriptUri(d.src))a+=o3djs.io.loadTextFileSynchronous(d.src)}}return a};
o3djs.util.createClient=function(a,b,c){b=b||"";c=c||o3djs.util.REQUIRED_VERSION;if(!o3djs.util.requiredVersionAvailable(c))return null;b+=(b?",":"")+"APIVersion="+c;if(o3djs.base.IsMSIE()){a.innerHTML='<OBJECT WIDTH="100%" HEIGHT="100%"CLASSID="CLSID:9666A772-407E-4F90-BC37-982E8160EB2D"><PARAM name="o3d_features" value="'+b+'"/></OBJECT>';c=a.childNodes[0]}else{c=document.createElement("object");c.type="application/vnd.o3d.auto";c.style.width="100%";c.style.height="100%";c.setAttribute("o3d_features",
b);a.appendChild(c)}c.client.clientInfo.glsl&&o3djs.effect.setLanguage("glsl");return c};
o3djs.util.makeClients=function(a,b,c,d,e,f){d=d||o3djs.util.informPluginFailure;c=c||o3djs.util.REQUIRED_VERSION;if(o3djs.util.requiredVersionAvailable(c)){var g=[];c=o3djs.util.getO3DContainerElements(e,f);for(var h=null,j=0;j<c.length;++j){var i=c[j],k=b;if(!k)k=(k=i.getAttribute("o3d_features"))?k:"";k=o3djs.util.createClient(i,k);g.push(k);if(i.id==="o3d")h=k}var l=window.setInterval(function(){for(var m=0,n="",r,o=0;o<g.length;++o){var q=g[o];r=q.o3d;if(!(r&&q.client&&q.client.rendererInitStatus>
o3djs.util.rendererInitStatus.UNINITIALIZED))return;q=g[o].client.rendererInitStatus;if(q>m){m=q;n=g[o].client.lastError}}window.clearInterval(l);if(m>0&&m!=r.Renderer.SUCCESS){for(o=0;o<g.length;++o){r=g[o];r.parentNode.removeChild(r)}d(m,n,e,f)}else{o3djs.base.snapshotProvidedNamespaces();for(o=0;o<g.length;++o){o3djs_isV8Supported()&&o3djs.base.initV8(g[o]);o3djs.event.startKeyboardEventSynthesis(g[o]);o3djs.error.setDefaultErrorHandler(g[o].client)}o3djs.base.init(g[0]);switch(o3djs.util.mainEngine_){case o3djs.util.Engine.BROWSER:a(g);
break;case o3djs.util.Engine.V8:if(!h)throw'V8 engine was requested but there is no element with the id "o3d"';m=o3djs.util.getScriptTagText_();h.eval(m);o3djs.util.callV8(h,a,o3djs.global,[g]);break;default:throw"Unknown engine "+o3djs.util.mainEngine_;}}},10)}else d(o3djs.util.rendererInitStatus.NO_PLUGIN,"",e,f)};o3djs.provide("o3djs.webgl");o3djs.require("o3djs.effect");o3djs.require("o3djs.util");o3djs.webgl=o3djs.webgl||{};
o3djs.webgl.makeClients=function(a,b,c,d,e,f,g){var h=[];c=o3djs.util.getO3DContainerElements(e,f);for(d=0;d<c.length;++d){e=c[d];f=b;if(!f)f=(f=e.getAttribute("o3d_features"))?f:"";e=o3djs.webgl.createClient(e,f,g);if(!e)return;h.push(e)}var j=window.setInterval(function(){for(var i=0;i<h.length;++i)if(!h[i].sizeInitialized_)return;window.clearInterval(j);a(h)})};
o3djs.webgl.createGLErrorWrapper=function(a,b){return function(){var c=a[b].apply(a,arguments),d=a.getError();if(d!=0)throw"GL error "+d+" in "+b;return c}};o3djs.webgl.addDebuggingWrapper=function(a){var b={},c;for(c in a)b[c]=typeof a[c]=="function"?o3djs.webgl.createGLErrorWrapper(a,c):a[c];b.getError=function(){return a.getError()};return b};
o3djs.webgl.webGlCanvasError=function(a){var b=document.createElement("div");b.style.backgroundColor="#ccffff";b.style.textAlign="center";b.style.margin="10px";b.style.width="100%";b.style.height="100%";b.innerHTML='<br/><br/><a href="http://get.webgl.org">Your browser does not appear to support WebGL.<br/><br/>Check that WebGL is enabled or click here to upgrade your browser:</a><br/>';a.appendChild(b)};
o3djs.webgl.createClient=function(a,b,c){function d(){return false}c=c||false;o3djs.effect.setLanguage("glsl");var e;e=document.createElement("canvas");if(!e||!e.getContext){o3djs.webgl.webGlCanvasError(a,"HTMLCanvas");return null}e.style.width="100%";e.style.height="100%";var f=new o3d.Client;b=function(){var g=Math.max(1,e.clientHeight);e.width=Math.max(1,e.clientWidth);e.height=g;e.sizeInitialized_=true;if(f.gl)f.gl.displayInfo={width:e.width,height:e.height}};window.addEventListener("resize",
b,false);setTimeout(b,0);if(!f.initWithCanvas(e)){o3djs.webgl.webGlCanvasError(a,"WebGL context");return null}document.onselectstart=d;document.onmousedown=d;e.client=f;e.o3d=o3d;if(c)f.gl=o3djs.webgl.addDebuggingWrapper(f.gl);a.appendChild(e);return e};var o3d=o3d||{};goog=goog||{};goog.typedef=true;o3d.global=this;o3d.basePath="";if(!Object.prototype.__defineSetter__){Object.prototype.__defineSetter__=function(){};Object.prototype.__defineGetter__=function(){}}
o3d.findBasePath_=function(){var a=o3d.global.document;if(typeof a!="undefined")if(o3d.global.BASE_PATH)o3d.basePath=o3d.global.BASE_PATH;else{o3d.global.BASE_PATH=null;a=a.getElementsByTagName("script");for(var b,c=0;b=a[c];c++){b=b.src;var d=b.length;if(b.substr(d-17)=="o3d-webgl/base.js"){o3d.basePath=b.substr(0,d-17)+"o3d-webgl/";break}}}};o3d.writeScriptTag_=function(a){var b=o3d.global.document;typeof b!="undefined"&&b.write('<script type="text/javascript" src="'+a+'"><\/script>')};
o3d.filterTypeName_=function(a){if(a.length>=4&&a.substr(0,4)=="o3d.")a=a.substr(4);return a};o3d.include=function(a){a=a.split(".");o3d.writeScriptTag_(o3d.basePath+(a[a.length-1]+".js"))};o3d.inherit=function(a,b){var c=o3d.global.o3d[b],d=o3d.global.o3d[a];if(!c)throw"Invalid superclass: "+b;if(!d)throw"Invalid subclass: "+a;d.prototype=new c;d.prototype.superClassName=b;d.prototype.superClass=c;d.prototype.className=a};o3d.removeFromArray=function(a,b){var c=a.indexOf(b);c>=0&&a.splice(c,1)};
o3d.isArray_=function(a){return typeof a==="object"&&a!==null&&"length"in a&&"splice"in a};o3d.clone=function(a){var b=o3d.isArray_(a)?[]:{},c;for(c in a){var d=a[c];b[c]=typeof d=="Object"?o3d.clone(d):d}return b};o3d.notImplemented=function(){debugger;throw"Not implemented.";};o3d.findBasePath_();o3d.ObjectBase=function(){};o3d.ObjectBase.prototype.className="o3d.ObjectBase";o3d.ObjectBase.prototype.superClass=null;
o3d.ObjectBase.prototype.isAClassName=function(a){a=o3d.filterTypeName_(a);for(var b=this;b!=undefined;){if(b.className==a)return true;b=b.superClass&&b.superClass.prototype}return false};o3d.NamedObjectBase=function(){o3d.ObjectBase.call(this)};o3d.inherit("NamedObjectBase","ObjectBase");o3d.NamedObjectBase.prototype.name="";o3d.NamedObject=function(){o3d.NamedObjectBase.call(this)};o3d.inherit("NamedObject","NamedObjectBase");o3d.NamedObject.prototype.name="";
o3d.ParamObject=function(){o3d.NamedObject.call(this);this.params_={}};o3d.inherit("ParamObject","NamedObject");o3d.ParamObject.prototype.__defineGetter__("params",function(){var a=[];for(name in this.params_)a.push(this.params_[name]);return a});o3d.ParamObject.prototype.__defineSetter__("params",function(){});o3d.ParamObject.O3D_PREFIX_="o3d.";
o3d.ParamObject.prototype.createParam=function(a,b){if(this.params_[a])return null;b=o3d.filterTypeName_(b);if(!o3d.global.o3d[b])throw"Invalid param type name: "+b;var c=new o3d.global.o3d[b];c.gl=this.gl;c.owner_=this;c.name=a;this.params_[a]=c;return this.filterResult_(this.params_[a])};
o3d.ParamObject.prototype.getParam=function(a){var b=this.params_[a],c;if(!b){c=o3d.ParamObject.O3D_PREFIX_+a;b=this.params_[c]}if(!b)if(this.lazyParamMap_){var d=this.lazyParamMap_[a];if(!d){a=c;d=this.lazyParamMap_[a]}if(d)b=this.createParam(a,d)}return this.filterResult_(b)};o3d.ParamObject.prototype.removeParam=function(a){for(var b in this.params_)this.params_[b]==a&&delete this.params_[b]};o3d.ParamObject.prototype.params_={};
o3d.ParamObject.prototype.copyParams=function(a){for(name in a.params_){var b=a.params_[name];this.createParam(name,b.className);this.getParam(name).value=b.value}};o3d.ParamObject.prototype.filterResult_=function(a){return a?a:null};
o3d.ParamObject.setUpO3DParam_=function(a,b,c){var d=o3d.ParamObject.O3D_PREFIX_+b,e=a.prototype.lazyParamMap_;if(!e){e={};a.prototype.lazyParamMap_=e}e[d]=c;a.prototype.__defineGetter__(b,function(){return this.getParam(d).value});a.prototype.__defineSetter__(b,function(f){this.getParam(d).value=f})};o3d.ParamArray=function(){o3d.NamedObject.call(this);this.params_=[]};o3d.inherit("ParamArray","NamedObject");
o3d.ParamArray.prototype.createParam=function(a,b){b=o3d.filterTypeName_(b);if(!o3d.global.o3d[b])throw"Invalid param type name: "+b;if(a>=this.params_.length)this.resize(a+1,b);else{var c=new o3d.global.o3d[b];c.gl=this.gl;c.owner_=this;this.params_[a]=c}return this.filterResult_(this.params_[a])};o3d.ParamArray.prototype.getParam=function(a){return this.filterResult_(this.params_[a])};
o3d.ParamArray.prototype.removeParams=function(a,b){for(var c=[],d=0,e=0;e<this.params_.length;e++)if(!(e>=a&&e<a+b)){c[d]=this.params_[e];d++}this.params_=c};o3d.ParamArray.prototype.resize=function(a,b){b=o3d.filterTypeName_(b);if(!o3d.global.o3d[b])throw"Invalid param type name: "+b;for(var c=this.params_.length;c<a;c++){var d=new o3d.global.o3d[b];d.gl=this.gl;d.owner_=this;this.params_[c]=d}};o3d.ParamArray.prototype.params_=[];
o3d.ParamArray.prototype.__defineGetter__("params",function(){for(var a=[],b=0;b<this.length;b++)a[b]=this.params_[b];return a});o3d.ParamArray.prototype.__defineGetter__("length",function(){return this.params_.length});o3d.ParamArray.prototype.filterResult_=function(a){return a?a:null};o3d.Param=function(){o3d.Param.prototype.output_connections=[];this.outputConnections=[]};o3d.inherit("Param","NamedObject");o3d.Param.prototype.update_input=true;o3d.Param.prototype.inputConnection=null;
o3d.Param.prototype.outputConnections=[];o3d.Param.prototype.owner_=null;o3d.Param.prototype.value_=null;o3d.Param.prototype.__defineSetter__("value",function(a){if(this.inputConnection)throw"Tried to set bound parameter.";else{if(this.value_!=undefined&&(typeof this.value_!=typeof a||this.value_.length_!==undefined&&this.value_.length_!=a.length))this.gl.client.error_callback("Param type error.");this.value_=a}});
o3d.Param.prototype.__defineGetter__("value",function(){return this.inputConnection?this.inputConnection.value:this.value_});o3d.Param.prototype.bind=function(a){a.outputConnections.push(this);this.inputConnection=a};o3d.Param.prototype.unbindInput=function(){o3d.notImplemented()};o3d.Param.prototype.unbindOutput=function(){o3d.notImplemented()};o3d.Param.prototype.unbindOutputs=function(){o3d.notImplemented()};o3d.Param.prototype.read_only_=false;
o3d.ParamBoolean=function(){o3d.Param.call(this);this.value=false};o3d.inherit("ParamBoolean","Param");o3d.ParamBoundingBox=function(){o3d.Param.call(this);this.value=null};o3d.inherit("ParamBoundingBox","Param");
o3d.ParamBoundingBox.prototype.__defineSetter__("value",function(a){if(this.inputConnection)throw"Tried to set bound parameter.";else{if(a){if(a.length!==undefined)if(a.length==0)a=new o3d.BoundingBox;else if(a.length==2){for(var b=0;b<2;++b)if(a[b].length!=3)throw"Expected sub-array of length 3 at index "+b+", got "+a[b].length;a=new o3d.BoundingBox(a[0],a[1])}else throw"Expected array of length 2";}else a=new o3d.BoundingBox;this.value_=a}});
o3d.ParamBoundingBox.prototype.__defineGetter__("value",function(){return this.inputConnection?this.inputConnection.value:this.value_});o3d.ParamDrawContext=function(){o3d.Param.call(this);this.value=null};o3d.inherit("ParamDrawContext","Param");o3d.ParamDrawList=function(){o3d.Param.call(this);this.value=null};o3d.inherit("ParamDrawList","Param");o3d.ParamEffect=function(){o3d.Param.call(this);this.value=null};o3d.inherit("ParamEffect","Param");
o3d.ParamFloat=function(){o3d.Param.call(this);this.value=0};o3d.inherit("ParamFloat","Param");o3d.ParamFloat2=function(){o3d.Param.call(this);this.value=[0,0]};o3d.inherit("ParamFloat2","Param");o3d.ParamFloat3=function(){o3d.Param.call(this);this.value=[0,0,0]};o3d.inherit("ParamFloat3","Param");o3d.ParamFloat4=function(){o3d.Param.call(this);this.value=[0,0,0,0]};o3d.inherit("ParamFloat4","Param");o3d.ParamFunction=function(){o3d.Param.call(this);this.value=null};o3d.inherit("ParamFunction","Param");
o3d.ParamInteger=function(){o3d.Param.call(this);this.value=0};o3d.inherit("ParamInteger","Param");o3d.ParamMaterial=function(){o3d.Param.call(this);this.value=null};o3d.inherit("ParamMaterial","Param");o3d.ParamMatrix4=function(){o3d.Param.call(this);this.value=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]]};o3d.inherit("ParamMatrix4","Param");o3d.ParamParamArray=function(){o3d.Param.call(this);this.value=null};o3d.inherit("ParamParamArray","Param");o3d.ParamParamArrayOutput=function(){o3d.ParamParamArray.call(this)};
o3d.inherit("ParamParamArrayOutput","ParamParamArray");o3d.ParamParamArrayOutput.prototype.__defineGetter__("value",function(){this.owner_.updateOutputs(this);return this.value_});o3d.ParamParamArrayOutput.prototype.__defineSetter__("value",function(a){this.value_=a});o3d.ParamRenderSurface=function(){o3d.Param.call(this);this.value=null};o3d.inherit("ParamRenderSurface","Param");o3d.ParamRenderDepthStencilSurface=function(){o3d.Param.call(this);this.value=null};
o3d.inherit("ParamRenderDepthStencilSurface","Param");o3d.ParamSampler=function(){o3d.Param.call(this);this.value=null};o3d.inherit("ParamSampler","Param");o3d.ParamSkin=function(){o3d.Param.call(this);this.value=null};o3d.inherit("ParamSkin","Param");o3d.ParamSteamBank=function(){o3d.Param.call(this);this.value=null};o3d.inherit("ParamSteamBank","Param");o3d.ParamState=function(){o3d.Param.call(this);this.value=null};o3d.inherit("ParamState","Param");
o3d.ParamStreamBank=function(){o3d.Param.call(this);this.value=null};o3d.inherit("ParamStreamBank","Param");o3d.ParamString=function(){o3d.Param.call(this);this.value=null};o3d.inherit("ParamString","Param");o3d.ParamTexture=function(){o3d.Param.call(this);this.value=null};o3d.inherit("ParamTexture","Param");o3d.ParamTransform=function(){o3d.Param.call(this);this.value=null};o3d.inherit("ParamTransform","Param");o3d.ParamVertexBufferStream=function(){o3d.Param.call(this);this.stream=null};
o3d.inherit("ParamVertexBufferStream","Param");o3d.CompositionParamMatrix4=function(){o3d.ParamMatrix4.call(this);this.matrix_names_=[]};o3d.inherit("CompositionParamMatrix4","ParamMatrix4");o3d.CompositionParamMatrix4.prototype.matrix_names_=[];o3d.CompositionParamMatrix4.prototype.inverse_=false;o3d.CompositionParamMatrix4.prototype.transpose_=false;
o3d.CompositionParamMatrix4.prototype.__defineGetter__("value",function(){for(var a=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]],b=0;b<this.matrix_names_.length;++b)o3d.Transform.compose(a,o3d.Param.SAS[this.matrix_names_[b]]);this.inverse_&&o3d.Transform.inverse(a);this.transpose_&&o3d.Transform.transpose(a);return a});o3d.CompositionParamMatrix4.prototype.__defineSetter__("value",function(){});o3d.ProjectionParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this);this.matrix_names_=["projection"]};
o3d.inherit("ProjectionParamMatrix4","CompositionParamMatrix4");o3d.ProjectionInverseParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this);this.matrix_names_=["projection"];this.inverse_=true};o3d.inherit("ProjectionInverseParamMatrix4","CompositionParamMatrix4");o3d.ProjectionTransposeParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this);this.matrix_names_=["projection"];this.transpose_=true};o3d.inherit("ProjectionTransposeParamMatrix4","CompositionParamMatrix4");
o3d.ProjectionInverseTransposeParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this);this.matrix_names_=["projection"];this.transpose_=this.inverse_=true};o3d.inherit("ProjectionInverseTransposeParamMatrix4","CompositionParamMatrix4");o3d.ViewParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this);this.matrix_names_=["view"]};o3d.inherit("ViewParamMatrix4","CompositionParamMatrix4");
o3d.ViewInverseParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this);this.matrix_names_=["view"];this.inverse_=true};o3d.inherit("ViewInverseParamMatrix4","CompositionParamMatrix4");o3d.ViewTransposeParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this);this.matrix_names_=["view"];this.transpose_=true};o3d.inherit("ViewTransposeParamMatrix4","CompositionParamMatrix4");
o3d.ViewInverseTransposeParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this);this.matrix_names_=["view"];this.transpose_=this.inverse_=true};o3d.inherit("ViewInverseTransposeParamMatrix4","CompositionParamMatrix4");o3d.ViewProjectionParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this);this.matrix_names_=["viewProjection"]};o3d.inherit("ViewProjectionParamMatrix4","CompositionParamMatrix4");
o3d.ViewProjectionInverseParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this);this.matrix_names_=["viewProjection"];this.inverse_=true};o3d.inherit("ViewProjectionInverseParamMatrix4","CompositionParamMatrix4");o3d.ViewProjectionTransposeParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this);this.matrix_names_=["viewProjection"];this.transpose_=true};o3d.inherit("ViewProjectionTransposeParamMatrix4","CompositionParamMatrix4");
o3d.ViewProjectionInverseTransposeParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this);this.matrix_names_=["viewProjection"];this.transpose_=this.inverse_=true};o3d.inherit("ViewProjectionInverseTransposeParamMatrix4","CompositionParamMatrix4");o3d.WorldParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this);this.matrix_names_=["world"]};o3d.inherit("WorldParamMatrix4","CompositionParamMatrix4");
o3d.WorldInverseParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this);this.matrix_names_=["world"];this.inverse_=true};o3d.inherit("WorldInverseParamMatrix4","CompositionParamMatrix4");o3d.WorldTransposeParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this);this.matrix_names_=["world"];this.transpose_=true};o3d.inherit("WorldTransposeParamMatrix4","CompositionParamMatrix4");
o3d.WorldInverseTransposeParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this);this.matrix_names_=["world"];this.transpose_=this.inverse_=true};o3d.inherit("WorldInverseTransposeParamMatrix4","CompositionParamMatrix4");o3d.WorldViewParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this);this.matrix_names_=["view","world"]};o3d.inherit("WorldViewParamMatrix4","CompositionParamMatrix4");
o3d.WorldViewInverseParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this);this.matrix_names_=["view","world"];this.inverse_=true};o3d.inherit("WorldViewInverseParamMatrix4","CompositionParamMatrix4");o3d.WorldViewTransposeParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this);this.matrix_names_=["view","world"];this.transpose_=true};o3d.inherit("WorldViewTransposeParamMatrix4","CompositionParamMatrix4");
o3d.WorldViewInverseTransposeParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this);this.matrix_names_=["view","world"];this.transpose_=this.inverse_=true};o3d.inherit("WorldViewInverseTransposeParamMatrix4","CompositionParamMatrix4");o3d.WorldViewProjectionParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this);this.matrix_names_=["worldViewProjection"]};o3d.inherit("WorldViewProjectionParamMatrix4","CompositionParamMatrix4");
o3d.WorldViewProjectionInverseParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this);this.matrix_names_=["worldViewProjection"];this.inverse_=true};o3d.inherit("WorldViewProjectionInverseParamMatrix4","CompositionParamMatrix4");o3d.WorldViewProjectionTransposeParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this);this.matrix_names_=["worldViewProjection"];this.transpose_=true};o3d.inherit("WorldViewProjectionTransposeParamMatrix4","CompositionParamMatrix4");
o3d.WorldViewProjectionInverseTransposeParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this);this.matrix_names_=["worldViewProjection"];this.transpose_=this.inverse_=true};o3d.inherit("WorldViewProjectionInverseTransposeParamMatrix4","CompositionParamMatrix4");o3d.ParamInteger.prototype.applyToLocation=function(a,b){a.uniform1i(b,this.value)};o3d.ParamBoolean.prototype.applyToLocation=function(a,b){a.uniform1i(b,this.value)};
o3d.ParamFloat.prototype.applyToLocation=function(a,b){a.uniform1f(b,this.value)};o3d.ParamFloat2.prototype.applyToLocation=function(a,b){a.uniform2fv(b,this.value)};o3d.ParamFloat3.prototype.applyToLocation=function(a,b){a.uniform3fv(b,this.value)};o3d.ParamFloat4.prototype.applyToLocation=function(a,b){a.uniform4fv(b,this.value)};o3d.ParamMatrix4.prototype.applyToLocation=function(a,b){a.uniformMatrix4fv(b,false,o3d.Transform.flattenMatrix4(this.value))};
o3d.ParamParamArray.prototype.applyToLocations=function(a,b){var c=this.value;b.length!=c.length&&a.client.error_callback("Invalid uniform param array: incorrect number of elements.");for(var d=0;d<c.length;d++)c.getParam(d).applyToLocation(a,b[d])};o3d.Param.texture_index_=0;
o3d.ParamSampler.prototype.applyToLocation=function(a,b,c){var d=o3d.Param.texture_index_;a.activeTexture(a.TEXTURE0+d);var e=null;if(this.value)e=this.value;else{o3d.Sampler.defaultSampler_.gl=a;e=o3d.Sampler.defaultSampler_;a.client.reportErrors_()&&a.client.error_callback("Missing Sampler for ParamSampler "+this.name)}e.bindAndSetParameters_(c);a.uniform1i(b,d);o3d.Param.texture_index_++};o3d.ParamSampler.defaultParamSampler_=new o3d.ParamSampler;o3d.Param.SAS=new o3d.ParamObject;
o3d.Param.sasTypes_={world:"WorldParamMatrix4",view:"ViewParamMatrix4",projection:"ProjectionParamMatrix4",worldView:"WorldViewParamMatrix4",viewProjection:"ViewProjectionParamMatrix4",worldViewProjection:"WorldViewProjectionParamMatrix4",worldInverse:"WorldInverseParamMatrix4",viewInverse:"ViewInverseParamMatrix4",projectionInverse:"ProjectionInverseParamMatrix4",worldViewInverse:"WorldViewInverseParamMatrix4",viewProjectionInverse:"ViewProjectionInverseParamMatrix4",worldViewProjectionInverse:"WorldViewProjectionInverseParamMatrix4",
worldTranspose:"WorldTransposeParamMatrix4",viewTranspose:"ViewTransposeParamMatrix4",projectionTranspose:"ProjectionTransposeParamMatrix4",worldViewTranspose:"WorldViewTransposeParamMatrix4",viewProjectionTranspose:"ViewProjectionTransposeParamMatrix4",worldViewProjectionTranspose:"WorldViewProjectionTransposeParamMatrix4",worldInverseTranspose:"WorldInverseTransposeParamMatrix4",viewInverseTranspose:"ViewInverseTransposeParamMatrix4",projectionInverseTranspose:"ProjectionInverseTransposeParamMatrix4",
worldViewInverseTranspose:"WorldViewInverseTransposeParamMatrix4",viewProjectionInverseTranspose:"ViewProjectionInverseTransposeParamMatrix4",worldViewProjectionInverseTranspose:"WorldViewProjectionInverseTransposeParamMatrix4"};for(name in o3d.Param.sasTypes_)o3d.Param.SAS.createParam(name,o3d.Param.sasTypes_[name]);o3d.Param.SAS.setWorld=function(a){this.world=a};o3d.Param.SAS.setView=function(a){this.view=a};o3d.Param.SAS.setProjection=function(a){this.projection=a};
o3d.Param.SAS.setViewProjection=function(a){this.viewProjection=a};o3d.Param.SAS.setWorldViewProjection=function(a){this.worldViewProjection=a};o3d.Event=function(){o3d.ObjectBase.call(this)};o3d.inherit("Event","ObjectBase");o3d.Event.Type=goog.typedef;o3d.Event.TYPE_INVALID=0;o3d.Event.TYPE_CLICK=1;o3d.Event.TYPE_DBLCLICK=2;o3d.Event.TYPE_MOUSEDOWN=3;o3d.Event.TYPE_MOUSEMOVE=4;o3d.Event.TYPE_MOUSEUP=5;o3d.Event.TYPE_WHEEL=6;o3d.Event.TYPE_KEYDOWN=7;o3d.Event.TYPE_KEYPRESS=8;
o3d.Event.TYPE_KEYUP=9;o3d.Event.TYPE_RESIZE=10;o3d.Event.prototype.type=o3d.Event.TYPE_INVALID;o3d.Event.Button=goog.typedef;o3d.Event.BUTTON_LEFT=0;o3d.Event.BUTTON_MIDDLE=1;o3d.Event.BUTTON_RIGHT=2;o3d.Event.BUTTON_4=3;o3d.Event.BUTTON_5=4;o3d.Event.prototype.button=o3d.Event.BUTTON_LEFT;o3d.Event.prototype.ctrl_key=false;o3d.Event.prototype.alt_key=false;o3d.Event.prototype.shift_key=false;o3d.Event.prototype.meta_key=false;o3d.Event.prototype.key_code=0;o3d.Event.prototype.char_code=0;
o3d.Event.prototype.x=0;o3d.Event.prototype.y=0;o3d.Event.prototype.screenX=0;o3d.Event.prototype.screenY=0;o3d.Event.prototype.deltaX=0;o3d.Event.prototype.deltaY=0;o3d.Event.prototype.width=0;o3d.Event.prototype.height=0;o3d.Event.prototype.fullscreen=false;o3d.RenderEvent=function(){o3d.Event.call(this)};o3d.inherit("RenderEvent","Event");o3d.RenderEvent.prototype.elapsedTime=0;o3d.TickEvent=function(){o3d.Event.call(this)};o3d.inherit("RenderEvent","Event");
o3d.TickEvent.prototype.elapsedTime=0;o3d.RawData=function(){o3d.NamedObject.call(this)};o3d.inherit("RawData","NamedObject");o3d.RawData.prototype.stringValue="";o3d.RawData.prototype.image_=null;o3d.RawData.prototype.uri="";o3d.RawData.prototype.length=0;o3d.RawData.prototype.discard=function(){o3d.notImplemented()};o3d.RawData.prototype.flush=function(){o3d.notImplemented()};
o3d.Texture=function(){o3d.ParamObject.call(this);this.format=o3d.Texture.UNKNOWN_FORMAT;this.levels=1;this.alphaIsOne=true;this.texture_=null;this.texture_height_=this.texture_width_=this.texture_target_=0;this.parameter_cache_={}};o3d.inherit("Texture","ParamObject");o3d.Texture.Format=goog.typedef;o3d.Texture.UNKNOWN_FORMAT=0;o3d.Texture.XRGB8=1;o3d.Texture.ARGB8=2;o3d.Texture.ABGR16F=3;o3d.Texture.R32F=4;o3d.Texture.ABGR32F=5;o3d.Texture.DXT1=6;o3d.Texture.DXT3=7;o3d.Texture.DXT5=8;
o3d.Texture.prototype.generateMips=function(a,b){this.gl.bindTexture(this.texture_target_,this.texture_);this.gl.generateMipmap(this.texture_target_);this.levels=b};o3d.Texture.isPowerOfTwo_=function(a){return(a&a-1)==0};o3d.Texture.nextHighestPowerOfTwo_=function(a){for(var b=1;b<a;)b*=2;return b};
o3d.Texture.prototype.getGLTextureFormat_=function(){switch(this.format){case o3d.Texture.XRGB8:return this.gl.RGB;case o3d.Texture.ARGB8:case o3d.Texture.ABGR16F:case o3d.Texture.ABGR32F:return this.gl.RGBA;default:o3d.notImplemented();return 0}};o3d.Texture.prototype.getTexImage2DTarget_=function(a){return this.texture_target_==this.gl.TEXTURE_CUBE_MAP?this.gl.TEXTURE_CUBE_MAP_POSITIVE_X+a:this.gl.TEXTURE_2D};
o3d.Texture.maxLevels_=function(a,b){if(a==0||b==0)return 0;for(var c=Math.max(a,b),d=0;c>0;){++d;c>>=1}return d};var g_counter=0;
o3d.Texture.prototype.setFromCanvas_=function(a,b,c,d,e){var f=this.gl;if(b&&(!o3d.Texture.isPowerOfTwo_(a.width)||!o3d.Texture.isPowerOfTwo_(a.height))){b=o3d.Bitmap.getScratchCanvas_();b.width=o3d.Texture.nextHighestPowerOfTwo_(a.width);b.height=o3d.Texture.nextHighestPowerOfTwo_(a.height);b.getContext("2d").drawImage(a,0,0,a.width,a.height,0,0,b.width,b.height);a=b}f.pixelStorei(f.UNPACK_FLIP_Y_WEBGL,c);f.bindTexture(this.texture_target_,this.texture_);f.texImage2D(this.getTexImage2DTarget_(e),
0,f.RGBA,f.RGBA,f.UNSIGNED_BYTE,a);f.pixelStorei(f.UNPACK_FLIP_Y_WEBGL,0);this.texture_width_=a.width;this.texture_height_=a.height;if(d){this.gl.generateMipmap(this.texture_target_);this.levels=o3d.Texture.maxLevels_(this.texture_width_,this.texture_height_)}g_counter++};
o3d.Texture.prototype.drawImageFromCanvas_=function(a,b,c,d,e,f,g,h,j,i,k){g=o3d.Bitmap.getScratchCanvas_();g.width=j;g.height=i;h=g.getContext("2d");h.save();h.translate(-b,-c);h.scale(j/d,i/e);h.drawImage(a,0,0,a.width,a.height);a=this.gl;a.bindTexture(this.texture_target_,this.texture_);this.getGLTextureFormat_();a.texImage2D(this.getTexImage2DTarget_(k),f,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,g);this.texture_width_=g.width;this.texture_height_=g.height;h.restore()};
o3d.Texture.prototype.setValues_=function(a,b,c){for(var d=new Uint8Array(b.length),e=0;e<b.length;++e)d[e]=Math.min(255,Math.max(0,b[e]*256));b=this.getGLTextureFormat_();this.gl.bindTexture(this.texture_target_,this.texture_);this.gl.texSubImage2D(this.getTexImage2DTarget_(c),a,0,0,this.texture_width_,this.texture_height_,b,this.gl.UNSIGNED_BYTE,d)};
o3d.Texture.prototype.initWithTarget_=function(a,b,c,d,e){this.width=b;this.height=c;this.format=d;this.levels=e;this.texture_=this.gl.createTexture();this.texture_target_=a;if(b!=undefined&&c!=undefined){this.gl.bindTexture(this.texture_target_,this.texture_);d=this.getGLTextureFormat_();a=new Uint8Array(b*c*4);e=o3d.Bitmap.getScratchCanvas_();e.width=b;e.height=c;e=1;if(this.texture_target_==this.gl.TEXTURE_CUBE_MAP)e=6;for(var f=0;f<e;++f)this.gl.texImage2D(this.getTexImage2DTarget_(f),0,d,b,c,
0,d,this.gl.UNSIGNED_BYTE,a);this.texture_width_=b;this.texture_height_=c}};o3d.Texture2D=function(a,b){o3d.Texture.call(this);this.width=a||0;this.height=b||0;this.renderSurfaces_=[]};o3d.inherit("Texture2D","Texture");o3d.ParamObject.setUpO3DParam_(o3d.Texture2D,"width","ParamInteger");o3d.ParamObject.setUpO3DParam_(o3d.Texture2D,"height","ParamInteger");o3d.Texture2D.prototype.init_=function(a,b,c,d,e){this.initWithTarget_(this.gl.TEXTURE_2D,a,b,c,d,e)};
o3d.Texture2D.prototype.getRenderSurface=function(a){if(!this.renderSurfaces_[a]){var b=new o3d.RenderSurface;b.gl=this.gl;b.initWithTexture(this,a);this.renderSurfaces_[a]=b}return this.renderSurfaces_[a]};o3d.Texture2D.prototype.set=function(a,b){this.setValues_(a,b)};
o3d.Texture2D.prototype.setRect=function(a,b,c,d,e){var f=this.getGLTextureFormat_(),g=f==this.gl.RGB?3:4,h=e.length/g/d;if(!(b>this.width||c>this.height||b+d<0||c+h<0)){var j=d;if(b<0)j+=b;if(b+d>this.width)j-=b+d-this.width;var i=h;if(c<0)i+=c;if(c+h>this.height)i-=c+h-this.height;var k=b<0?Math.abs(b):0,l=c<0?Math.abs(c):0;h=new Uint8Array(j*i*g);for(var m=0,n=0;n<i;++n)for(var r=0;r<j;++r){var o=((l+n)*d+(k+r))*g;h[m++]=Math.min(255,Math.max(0,e[o]*256));h[m++]=Math.min(255,Math.max(0,e[o+1]*
256));h[m++]=Math.min(255,Math.max(0,e[o+2]*256));h[m++]=Math.min(255,Math.max(0,e[o+3]*256))}b=Math.max(b,0);c=this.height-(Math.max(c,0)+i);this.gl.bindTexture(this.texture_target_,this.texture_);this.gl.texSubImage2D(this.gl.TEXTURE_2D,a,b,c,j,i,f,this.gl.UNSIGNED_BYTE,h)}};o3d.Texture2D.prototype.getRect=function(){o3d.notImplemented()};o3d.Texture2D.prototype.setFromBitmap=function(a){this.setFromCanvas_(a.canvas_,a.defer_mipmaps_to_texture_,a.defer_flip_vertically_to_texture_,a.defer_mipmaps_to_texture_)};
o3d.Texture2D.prototype.drawImage=function(a,b,c,d,e,f,g,h,j,i,k){this.drawImageFromCanvas_(a.canvas_,c,d,e,f,g,h,j,i,k)};o3d.TextureCUBE=function(){o3d.Texture.call(this);this.edgeLength=0;this.faces_set_={0:false,1:false,2:false,3:false,4:false,5:false}};o3d.inherit("TextureCUBE","Texture");o3d.TextureCUBE.CubeFace=goog.typedef;o3d.TextureCUBE.FACE_POSITIVE_X=0;o3d.TextureCUBE.FACE_NEGATIVE_X=1;o3d.TextureCUBE.FACE_POSITIVE_Y=2;o3d.TextureCUBE.FACE_NEGATIVE_Y=3;o3d.TextureCUBE.FACE_POSITIVE_Z=4;
o3d.TextureCUBE.FACE_NEGATIVE_Z=5;o3d.ParamObject.setUpO3DParam_(o3d.TextureCUBE,"edgeLength","ParamInteger");o3d.TextureCUBE.prototype.init_=function(a,b,c,d,e){this.initWithTarget_(this.gl.TEXTURE_CUBE_MAP,a,a,b,c,d,e)};o3d.TextureCUBE.prototype.getRenderSurface=function(){o3d.notImplemented()};o3d.TextureCUBE.prototype.set=function(a,b,c){this.setValues_(b,c,a);this.faces_set_[a]=true};o3d.TextureCUBE.prototype.setRect=function(){o3d.notImplemented()};o3d.TextureCUBE.prototype.getRect=function(){o3d.notImplemented()};
o3d.TextureCUBE.prototype.setFromBitmap=function(a,b){var c=b.defer_mipmaps_to_texture_,d;for(d in this.faces_set_)c=c&&(this.faces_set_[d]||d==a);this.setFromCanvas_(b.canvas_,b.defer_mipmaps_to_texture_,false,c,a);this.faces_set_[a]=true};o3d.TextureCUBE.prototype.drawImage=function(a,b,c,d,e,f,g,h,j,i,k,l){this.drawImageFromCanvas_(a.canvas_,c,d,e,f,h,j,i,k,l,g)};
o3d.Texture.prototype.bindAndSetParameters_=function(a,b,c,d){var e=this.texture_target_;this.gl.bindTexture(e,this.texture_);if(!(o3d.Texture.isPowerOfTwo_(this.texture_width_)&&o3d.Texture.isPowerOfTwo_(this.texture_height_))||this.texture_target_==this.gl.TEXTURE_CUBE_MAP)a=b=this.gl.CLAMP_TO_EDGE;if(this.parameter_cache_.addressModeU!=a){this.gl.texParameteri(e,this.gl.TEXTURE_WRAP_S,a);this.parameter_cache_.addressModeU=a}if(this.parameter_cache_.addressModeV!=b){this.gl.texParameteri(e,this.gl.TEXTURE_WRAP_T,
b);this.parameter_cache_.addressModeV=b}if(this.parameter_cache_.minFilter!=c){this.gl.texParameteri(e,this.gl.TEXTURE_MIN_FILTER,c);this.parameter_cache_.minFilter=c}if(this.parameter_cache_.magFilter!=d){this.gl.texParameteri(e,this.gl.TEXTURE_MAG_FILTER,d);this.parameter_cache_.magFilter=d}};o3d.Bitmap=function(){o3d.ParamObject.call(this)};o3d.inherit("Bitmap","ParamObject");o3d.Bitmap.Semantic=goog.typedef;o3d.Bitmap.FACE_POSITIVE_X=0;o3d.Bitmap.FACE_NEGATIVE_X=1;o3d.Bitmap.FACE_POSITIVE_Y=2;
o3d.Bitmap.FACE_NEGATIVE_Y=3;o3d.Bitmap.FACE_POSITIVE_Z=4;o3d.Bitmap.FACE_NEGATIVE_Z=5;o3d.Bitmap.IMAGE=6;o3d.Bitmap.SLICE=7;o3d.Bitmap.scratch_canvas_=null;o3d.Bitmap.getScratchCanvas_=function(){if(!o3d.Bitmap.scratch_canvas_)o3d.Bitmap.scratch_canvas_=document.createElement("CANVAS");return o3d.Bitmap.scratch_canvas_};o3d.Bitmap.prototype.canvas_=null;
o3d.Bitmap.prototype.flipVertically=function(){var a=document.createElement("CANVAS");a.width=this.width;a.height=this.height;var b=a.getContext("2d");b.translate(0,this.height);b.scale(1,-1);b.drawImage(this.canvas_,0,0,this.width,this.height);this.canvas_=a};o3d.Bitmap.prototype.flipVerticallyLazily_=function(){this.defer_flip_vertically_to_texture_=true};o3d.Bitmap.prototype.generateMips=function(){this.defer_mipmaps_to_texture_=true};o3d.Bitmap.prototype.width=0;o3d.Bitmap.prototype.height=0;
o3d.Bitmap.prototype.defer_mipmaps_to_texture_=false;o3d.Bitmap.prototype.defer_flip_vertically_to_texture_=false;o3d.Bitmap.prototype.format=o3d.Texture.UNKNOWN_FORMAT;o3d.Bitmap.prototype.numMipmaps=1;o3d.Bitmap.prototype.semantic=o3d.Bitmap.UNKNOWN_SEMANTIC;
o3d.FileRequest=function(){this.method_="";this.async_=true;this.request_=new XMLHttpRequest;var a=this;this.request_.onreadystatechange=function(){a.readyState=this.readyState;a.done=a.done||this.done;if(this.readyState==4){if(this.responseText)a.success=true;a.done=true}a.data=this.responseText;a.onreadystatechange&&a.onreadystatechange.apply(a,arguments)}};o3d.inherit("FileRequest","NamedObject");o3d.FileRequest.prototype.onreadystatechange=null;o3d.FileRequest.prototype.uri="";
o3d.FileRequest.prototype.data=null;o3d.FileRequest.prototype.readyState=0;o3d.FileRequest.prototype.done=false;o3d.FileRequest.prototype.success=false;o3d.FileRequest.prototype.image_=null;o3d.FileRequest.prototype.error="";o3d.FileRequest.prototype.isImageUrl_=function(a){a=a.substring(a.length-4);return a==".png"||a==".jpg"};
o3d.FileRequest.prototype.imageLoaded_=function(){if(this.image_.complete){this.done=this.success=true;this.readyState=4;this.data=new o3d.RawData;this.data.image_=this.image_}this.onreadystatechange.apply(this,arguments)};o3d.FileRequest.prototype.open=function(a,b,c){this.uri=b;this.method_=a;this.async_=c};
o3d.FileRequest.prototype.send=function(){if(this.isImageUrl_(this.uri)){this.image_=new Image;var a=this;this.image_.onload=function(){a.imageLoaded_.call(a)};this.image_.src=this.uri}else this.request_.open(this.method_,this.uri,this.async_)};o3d.Renderer={};o3d.Renderer.InitStatus=goog.typedef;o3d.Renderer.UNINITIALIZED=0;o3d.Renderer.SUCCESS=1;o3d.Renderer.GPU_NOT_UP_TO_SPEC=2;o3d.Renderer.OUT_OF_RESOURCES=3;o3d.Renderer.INITIALIZATION_ERROR=4;o3d.Renderer.DisplayMode=goog.typedef;
o3d.Renderer.DISPLAY_MODE_DEFAULT=0;o3d.Renderer.render_callback_interval_=null;o3d.Renderer.clients_=[];o3d.Renderer.renderClients=function(){for(var a=0;a<o3d.Renderer.clients_.length;++a){var b=o3d.Renderer.clients_[a];b.counter_manager_.tick();b.renderMode==o3d.Client.RENDERMODE_CONTINUOUS&&b.render()}};o3d.Renderer.installRenderInterval=function(){o3d.Renderer.render_callback_interval_=setInterval("o3d.Renderer.renderClients()",1E3/60)};o3d.ClientInfo=function(){o3d.NamedObject.call(this)};
o3d.inherit("ClientInfo","NamedObject");o3d.ClientInfo.prototype.num_objects=0;o3d.ClientInfo.prototype.texture_memory_used=0;o3d.ClientInfo.prototype.buffer_memory_used=0;o3d.ClientInfo.prototype.software_renderer=false;o3d.ClientInfo.prototype.non_power_of_two_textures=true;o3d.ClientInfo.prototype.glsl=true;
o3d.Client=function(){o3d.NamedObject.call(this);var a=this.createPack();this.root=a.createObject("Transform");this.renderGraphRoot=a.createObject("RenderNode");this.clientId=o3d.Client.nextId++;this.packs_=[a];this.clientInfo=a.createObject("ClientInfo");this.counter_manager_=new o3d.CounterManager;o3d.Renderer.clients_.length==0&&o3d.Renderer.installRenderInterval();o3d.Renderer.clients_.push(this);this.stateMapStack_=[];this.stateVariableStacks_={}};o3d.inherit("Client","NamedObject");
o3d.Client.RenderCallback=goog.typedef;o3d.Client.TickCallback=goog.typedef;o3d.Client.ErrorCallback=goog.typedef;o3d.Client.prototype.renderGraphRoot=null;o3d.Client.nextId=0;o3d.Client.prototype.then_=0;o3d.Client.prototype.root=null;o3d.Client.prototype.packs_=[];o3d.Client.prototype.counter_manager_=null;o3d.Client.prototype.normalizeClearColorAlpha=true;o3d.Client.prototype.error_callback=function(a){alert(a)};o3d.Client.prototype.render_callback=function(){};
o3d.Client.prototype.tick_callback=function(){};o3d.Client.prototype.cleanup=function(){this.clearRenderCallback();this.clearTickCallback();this.clearErrorCallback()};o3d.Client.prototype.createPack=function(){var a=new o3d.Pack;a.client=this;a.gl=this.gl;this.packs_.push(a);return a};o3d.Client.prototype.destroyPack=function(a){o3d.removeFromArray(this.packs_,a)};o3d.Client.prototype.getObjectById=function(){o3d.notImplemented()};
o3d.Client.prototype.getObjects=function(a,b){for(var c=[],d=0;d<this.packs_.length;++d)c=c.concat(this.packs_[d].getObjects(a,b));return c};o3d.Client.prototype.getObjectsByClassName=function(a){for(var b=[],c=0;c<this.packs_.length;++c)b=b.concat(this.packs_[c].getObjectsByClassName(a));return b};o3d.Client.RenderMode=goog.typedef;o3d.Client.RENDERMODE_CONTINUOUS=0;o3d.Client.RENDERMODE_ON_DEMAND=1;o3d.Client.prototype.renderMode=o3d.Client.RENDERMODE_CONTINUOUS;
o3d.Client.prototype.render=function(){if(this.gl){var a=new o3d.RenderEvent;this.counter_manager_.advanceRenderFrameCounters();this.clearStateStack_();var b=(new Date).getTime()*0.001;a.elapsedTime=this.then_==0?0:b-this.then_;if(this.render_callback){for(var c in this.render_stats_)a[c]=this.render_stats_[c];this.render_callback(a)}this.then_=b;this.gl.colorMask(true,true,true,true);this.renderTree(this.renderGraphRoot);if(this.normalizeClearColorAlpha){this.gl.colorMask(false,false,false,true);
this.gl.clearColor(0,0,0,1);this.gl.clear(this.gl.COLOR_BUFFER_BIT)}}};o3d.Client.prototype.render_stats={};o3d.Client.prototype.renderTree=function(a){this.render_stats_={drawElementsCulled:0,drawElementsProcessed:0,drawElementsRendered:0,primitivesRendered:0,transformsCulled:0,transformsProcessed:0};a.render()};o3d.Client.prototype.getDisplayModes=[];o3d.Client.prototype.setFullscreenClickRegion=function(){o3d.notImplemented()};o3d.Client.prototype.clearFullscreenClickRegion=function(){o3d.notImplemented()};
o3d.Client.prototype.cancelFullscreenDisplay=function(){render_node.render()};o3d.Client.prototype.client_info=null;o3d.Client.prototype.fullscreen=false;o3d.Client.prototype.__defineGetter__("width",function(){return this.gl.hack_canvas.width});o3d.Client.prototype.__defineSetter__("width",function(a){this.gl.hack_canvas.width=a});o3d.Client.prototype.__defineGetter__("height",function(){return this.gl.hack_canvas.height});
o3d.Client.prototype.__defineSetter__("height",function(a){this.gl.hack_canvas.height=a});
o3d.Client.prototype.initWithCanvas=function(a){var b,c={alpha:true,depth:true,stencil:true,antialias:true,premultipliedAlpha:true};if(!a||!a.getContext)return false;for(var d=["webgl","experimental-webgl","moz-webgl"],e=0;e<d.length;++e){try{b=a.getContext(d[e],c)}catch(f){}if(b)break}if(!b)return false;b.hack_canvas=a;this.gl=b;this.root.gl=b;this.renderGraphRoot.gl=b;b.client=this;b.displayInfo={width:a.width,height:a.height};o3d.State.createDefaultState_(b).push_();this.initErrorTextures_();return true};
o3d.Client.prototype.initErrorTextures_=function(){var a=[1,0,0,1],b=[1,1,0,1],c=[a,a,a,a,a,a,a,a,a,a,b,b,b,b,a,a,a,b,a,a,a,b,b,a,a,b,a,a,b,a,b,a,a,b,a,b,a,a,b,a,a,b,b,a,a,a,b,a,a,a,b,b,b,b,a,a,a,a,a,a,a,a,a,a];a=[];for(b=0;b<c.length;b++)for(var d=0;d<4;d++)a[b*4+d]=c[b][d];c=new o3d.TextureCUBE;c.gl=this.gl;c.init_(8,o3d.Texture.ARGB8,1,false,true);for(b=0;b<6;++b)c.set(b,0,a);c.name="DefaultTextureCube";this.fallback_error_texture_cube_=this.error_texture_cube_=c;b=new o3d.Texture2D;b.gl=this.gl;
b.init_(8,8,o3d.Texture.ARGB8,1,false);b.set(0,a);b.name="DefaultTexture";this.fallback_error_texture_=this.error_texture_=b};o3d.Client.prototype.setRenderCallback=function(a){this.render_callback&&this.clearRenderCallback();this.render_callback=a};o3d.Client.prototype.clearRenderCallback=function(){clearInterval(this.render_callback_interval_);this.render_callback=null};o3d.Client.prototype.setPostRenderCallback=function(a){this.postRenderCallback=a};
o3d.Client.prototype.clearPostRenderCallback=function(){this.postRenderCallback=null};o3d.Client.prototype.setLostResourcesCallback=function(a){this.lostResourcesCallback=a};o3d.Client.prototype.clearLostResourcesCallback=function(){this.lostResourcesCallback=null};o3d.Client.getEvent_=function(a){return a?a:window.event};o3d.Client.getEventInfo_=function(a){var b=a.target?a.target:a.srcElement;return{event:a,element:b,name:b.id?b.id:"->"+b.toString(),wheel:a.detail?a.detail:-a.wheelDelta}};
o3d.Client.getAbsolutePosition_=function(a){for(var b={x:0,y:0};a;a=a.offsetParent){b.x+=a.offsetLeft;b.y+=a.offsetTop}return b};o3d.Client.getLocalXY_=function(a){var b=a.event;a=o3d.Client.getAbsolutePosition_(a.element);return{x:b.pageX-a.x,y:b.pageY-a.y}};o3d.Client.wrapEventCallback_=function(a,b){return function(c){var d=c=o3d.Client.getEvent_(c),e=o3d.Client.getEventInfo_(c),f=o3d.Client.getLocalXY_(e);c=o3d.clone(c);c.x=f.x;c.y=f.y;c.deltaY=-e.wheel;a(c);b&&o3djs.event.cancel(d)}};
o3d.Client.prototype.setEventCallback=function(a,b){var c=this.gl.hack_canvas,d=a=="wheel";if(a.substr(0,3)=="key")c=document;else b=o3d.Client.wrapEventCallback_(b,d);if(d){c.addEventListener("DOMMouseScroll",b,true);c.addEventListener("mousewheel",b,true)}else c.addEventListener(a,b,true)};o3d.Client.prototype.clearEventCallback=function(a){var b=this.gl.hack_canvas,c=a=="wheel";if(a.substr(0,3)=="key")b=document;if(c){b.removeEventListener("DOMMouseScroll");b.removeEventListener("mousewheel")}else b.removeEventListener(a)};
o3d.Client.prototype.setErrorTexture=function(a){this.error_texture_=a};o3d.Client.prototype.setErrorTextureCube=function(a){this.error_texture_cube_map_=a};o3d.Client.prototype.setTickCallback=function(a){this.tickCallback=a};o3d.Client.prototype.clearTickCallback=function(){this.tickCallback=null};o3d.Client.prototype.setErrorCallback=function(a){this.error_callback=a?this.wrapErrorCallback_(a):function(b){this.last_error_=b}};
o3d.Client.prototype.wrapErrorCallback_=function(a){return function(b){this.last_error_=b;a(b)}};o3d.Client.prototype.clearErrorCallback=function(){this.setErrorCallback(null)};o3d.Client.prototype.invalidateAllParameters=function(){o3d.notImplemented()};o3d.Client.prototype.toDataURL=function(){o3d.notImplemented()};
o3d.Client.prototype.clearStateStack_=function(){this.stateMapStack_=[];for(var a in this.stateVariableStacks_){var b=this.stateVariableStacks_[a];if(b.length!=1)this.stateVariableStacks_[a]=b.slice(0,1)}};o3d.Client.prototype.pushState_=function(a){this.stateMapStack_.push(a);for(var b in a){var c=a[b];if(this.stateVariableStacks_[b]==undefined)this.stateVariableStacks_[b]=[];this.stateVariableStacks_[b].push(c)}o3d.State.setVariables_(this.gl,a)};
o3d.Client.prototype.popState_=function(){var a=this.stateMapStack_.pop(),b;for(b in a){var c=this.stateVariableStacks_[b];c.pop();a[b]=c.length?c[c.length-1]:o3d.State.stateVariableInfos_[b].defaultValue}o3d.State.setVariables_(this.gl,a)};o3d.Client.prototype.getState_=function(a){var b=this.stateVariableStacks_[a];return b.length?b[b.length-1]:o3d.State.stateVariableInfos_[a].defaultValue};o3d.Client.prototype.renderer_init_status=0;o3d.Client.prototype.cursor=null;
o3d.Client.prototype.error_texture_=null;o3d.Client.prototype.error_texture_cube_=null;o3d.Client.prototype.fallback_error_texture_=null;o3d.Client.prototype.fallback_error_texture_cube_=null;o3d.Client.prototype.last_error_="";o3d.Client.prototype.__defineGetter__("lastError",function(){return this.last_error_});o3d.Client.prototype.reportErrors_=function(){return this.error_texture_==null};o3d.Client.prototype.objects=[];o3d.Client.prototype.clearLastError=function(){this.last_error_=""};
o3d.Client.prototype.profileReset=function(){o3d.notImplemented()};o3d.Client.prototype.profileToString=function(){o3d.notImplemented()};o3d.Client.prototype.clientId=0;o3d.Client.prototype.clientInfo=null;o3d.Client.prototype.canvas=null;o3d.RenderNode=function(a,b){o3d.ParamObject.call(this);this.priority=a||0;this.children=[];this.active=b||true;this.parent=null};o3d.inherit("RenderNode","ParamObject");o3d.ParamObject.setUpO3DParam_(o3d.RenderNode,"priority","ParamFloat");
o3d.ParamObject.setUpO3DParam_(o3d.RenderNode,"active","ParamBoolean");o3d.RenderNode.prototype.__defineSetter__("parent",function(a){this.parent_&&this.parent_.removeChild(this);if(this.parent_=a){if(!this.parent_.addChild)throw"Parent of render node must be render node or null.";this.parent_.addChild(this)}});o3d.RenderNode.prototype.__defineGetter__("parent",function(){return this.parent_});o3d.RenderNode.prototype.addChild=function(a){this.children.push(a)};
o3d.RenderNode.prototype.removeChild=function(a){o3d.removeFromArray(this.children,a)};o3d.RenderNode.prototype.getRenderNodesInTree=function(){o3d.notImplemented()};o3d.RenderNode.prototype.getRenderNodesByNameInTree=function(){o3d.notImplemented()};o3d.RenderNode.prototype.getRenderNodesByClassNameInTree=function(){o3d.notImplemented()};
o3d.RenderNode.prototype.render=function(){this.children.sort(function(c,d){return c.priority-d.priority});var a=this.children;this.before();for(var b=0;b<a.length;++b)a[b].render();this.after()};o3d.RenderNode.prototype.before=function(){};o3d.RenderNode.prototype.after=function(){};o3d.ClearBuffer=function(){o3d.RenderNode.call(this);this.clearColor=[0,0,0,1];this.clearColorFlag=true;this.clearDepth=1;this.clearDepthFlag=true;this.clearStencil=0;this.clearStencilFlag=true};
o3d.inherit("ClearBuffer","RenderNode");o3d.ParamObject.setUpO3DParam_(o3d.ClearBuffer,"clearColor","ParamFloat4");o3d.ParamObject.setUpO3DParam_(o3d.ClearBuffer,"clearColorFlag","ParamBoolean");o3d.ParamObject.setUpO3DParam_(o3d.ClearBuffer,"clearDepth","ParamFloat");o3d.ParamObject.setUpO3DParam_(o3d.ClearBuffer,"clearDepthFlag","ParamBoolean");o3d.ParamObject.setUpO3DParam_(o3d.ClearBuffer,"clearStencil","ParamInteger");o3d.ParamObject.setUpO3DParam_(o3d.ClearBuffer,"clearStencilFlag","ParamBoolean");
o3d.ClearBuffer.prototype.before=function(){var a=0;this.gl.clearColor(this.clearColor[0],this.clearColor[1],this.clearColor[2],this.clearColor[3]);this.gl.clearDepth(this.clearDepth);this.gl.clearStencil(this.clearStencil);if(this.clearColorFlag)a|=this.gl.COLOR_BUFFER_BIT;if(this.clearDepthFlag)a|=this.gl.DEPTH_BUFFER_BIT;if(this.clearStencilFlag)a|=this.gl.STENCIL_BUFFER_BIT;this.gl.clear(a)};o3d.StateSet=function(a){o3d.RenderNode.call(this);this.state=a||null};o3d.inherit("StateSet","RenderNode");
o3d.ParamObject.setUpO3DParam_(o3d.StateSet,"state","ParamState");o3d.StateSet.prototype.before=function(){this.state&&this.state.push_()};o3d.StateSet.prototype.after=function(){this.state&&this.state.pop_()};o3d.Viewport=function(a,b){o3d.RenderNode.call(this);this.viewport=a||[0,0,1,1];this.depthRange=b||[0,1]};o3d.inherit("Viewport","RenderNode");o3d.ParamObject.setUpO3DParam_(o3d.Viewport,"viewport","ParamFloat4");o3d.ParamObject.setUpO3DParam_(o3d.Viewport,"depthRange","ParamFloat2");
o3d.Viewport.prototype.before=function(){var a=this.viewport[0]*this.gl.displayInfo.width,b=(1-this.viewport[1]-this.viewport[3])*this.gl.displayInfo.height,c=this.viewport[2]*this.gl.displayInfo.width,d=this.viewport[3]*this.gl.displayInfo.height;this.gl.viewport(a,b,c,d);if(a!=0||b!=0||this.viewport[2]!=1||this.viewport[3]!=1){this.gl.enable(this.gl.SCISSOR_TEST);this.gl.scissor(a,b,c,d)}else this.gl.disable(this.gl.SCISSOR_TEST)};
o3d.TreeTraversal=function(a){o3d.RenderNode.call(this);this.transform=a||null;this.drawLists_=[];this.drawListsToReset_=[]};o3d.inherit("TreeTraversal","RenderNode");o3d.ParamObject.setUpO3DParam_(o3d.TreeTraversal,"transform","ParamTransform");o3d.TreeTraversal.prototype.registerDrawList=function(a,b,c){if(c==undefined||c)this.drawListsToReset_.push(a);this.drawLists_.push({list:a,context:b})};o3d.TreeTraversal.prototype.unregisterDrawList=function(){o3d.notImplemented()};
o3d.TreeTraversal.prototype.before=function(){for(var a=0;a<this.drawListsToReset_.length;++a)this.drawListsToReset_[a].list_=[];this.transform.traverse(this.drawLists_)};o3d.DrawList=function(){o3d.NamedObject.call(this);this.list_=[]};o3d.inherit("DrawList","NamedObject");this.list_=[];o3d.DrawList.SortMethod=goog.typedef;o3d.DrawList.BY_PERFORMANCE=0;o3d.DrawList.BY_Z_ORDER=1;o3d.DrawList.BY_PRIORITY=2;o3d.DrawList.comparePriority_=function(a,b){return a.drawElement.owner.priority-b.drawElement.owner.priority};
o3d.DrawList.compareZ_=function(a,b){return o3d.Transform.transformPointZOnly(b.worldViewProjection,b.drawElement.owner.zSortPoint)-o3d.Transform.transformPointZOnly(a.worldViewProjection,a.drawElement.owner.zSortPoint)};o3d.DrawList.prototype.sort_=function(a){switch(a){case o3d.DrawList.BY_PRIORITY:this.list_.sort(o3d.DrawList.comparePriority_);break;case o3d.DrawList.BY_Z_ORDER:this.list_.sort(o3d.DrawList.compareZ_)}};
o3d.DrawList.prototype.render=function(){for(var a=0;a<this.list_.length;++a){var b=this.list_[a],c=b.view,d=b.viewProjection,e=b.worldViewProjection,f=b.projection,g=b.transform,h=b.drawElement,j=h.owner,i=h.material||j.material,k=i.effect;o3d.Param.SAS.setWorld(b.world);o3d.Param.SAS.setView(c);o3d.Param.SAS.setProjection(f);o3d.Param.SAS.setViewProjection(d);o3d.Param.SAS.setWorldViewProjection(e);b=[g,h,j];j.streamBank&&b.push(j.streamBank);b.push(i,k,o3d.Param.SAS);k.searchForParams_(b);(k=i.state!=
undefined)&&i.state.push_();j.render();k&&i.state.pop_()}};o3d.DrawPass=function(a,b){o3d.RenderNode.call(this);this.drawList=a||null;this.sortMethod=b||o3d.DrawList.BY_PERFORMANCE};o3d.inherit("DrawPass","RenderNode");o3d.DrawPass.SortMethod=goog.typedef;o3d.ParamObject.setUpO3DParam_(o3d.DrawPass,"drawList","ParamDrawList");o3d.ParamObject.setUpO3DParam_(o3d.DrawPass,"sortMethod","ParamInteger");o3d.DrawPass.prototype.before=function(){if(this.drawList){this.drawList.sort_(this.sortMethod);this.drawList.render()}};
o3d.RenderSurfaceSet=function(a,b){o3d.RenderNode.call(this);this.renderSurface=a||null;this.renderDepthStencilSurface=b||null};o3d.inherit("RenderSurfaceSet","RenderNode");o3d.ParamObject.setUpO3DParam_(o3d.RenderSurfaceSet,"renderSurface","ParamRenderSurface");o3d.ParamObject.setUpO3DParam_(o3d.RenderSurfaceSet,"renderDepthStencilSurface","ParamRenderDepthStencilSurface");
o3d.RenderSurfaceSet.prototype.clearFramebufferObjects_=function(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.renderSurface.framebuffer_);this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.RENDERBUFFER,null);this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.DEPTH_ATTACHMENT,this.gl.RENDERBUFFER,null);this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)};
o3d.RenderSurfaceSet.prototype.installFramebufferObjects_=function(){this.clearFramebufferObjects_();this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.renderSurface.framebuffer_);if(this.renderSurface){var a=this.renderSurface.texture.texture_,b=this.renderSurface.level;this.gl.bindTexture(this.gl.TEXTURE_2D,a);this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,a,b)}if(this.renderDepthStencilSurface){a=this.renderDepthStencilSurface.depth_stencil_buffer_;
this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,a);this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.DEPTH_ATTACHMENT,this.gl.RENDERBUFFER,a)}};
o3d.RenderSurfaceSet.prototype.before=function(){this.installFramebufferObjects_();this.previousHeight=this.gl.displayInfo.height;this.previousWidth=this.gl.displayInfo.width;this.previousRenderSurfaceSet=this.gl.currentRenderSurfaceSet;this.gl.displayInfo.height=this.renderSurface.height;this.gl.displayInfo.width=this.renderSurface.width;this.gl.currentRenderSurfaceSet=this};
o3d.RenderSurfaceSet.prototype.after=function(){this.clearFramebufferObjects_();this.gl.displayInfo.height=this.previousHeight;this.gl.displayInfo.width=this.previousWidth;this.gl.currentRenderSurfaceSet=this.previousRenderSurfaceSet};o3d.RenderSurfaceBase=function(a,b,c){o3d.ParamObject.call(this);this.width=a||0;this.height=b||0;this.texture=c||null;this.level=0;this.framebuffer_=null};o3d.inherit("RenderSurfaceBase","ParamObject");o3d.ParamObject.setUpO3DParam_(o3d.RenderSurfaceBase,"width","ParamInteger");
o3d.ParamObject.setUpO3DParam_(o3d.RenderSurfaceBase,"height","ParamInteger");o3d.RenderSurface=function(){o3d.RenderSurfaceBase.call(this)};o3d.inherit("RenderSurface","RenderSurfaceBase");o3d.RenderSurface.prototype.initWithTexture=function(a,b){this.framebuffer_=this.gl.createFramebuffer();this.texture=a;this.level=b;this.width=a.width;this.height=a.height};o3d.RenderDepthStencilSurface=function(){o3d.RenderSurfaceBase.call(this);this.depth_stencil_buffer_=null};
o3d.inherit("RenderDepthStencilSurface","RenderSurfaceBase");o3d.RenderDepthStencilSurface.prototype.initWithSize_=function(a,b){this.depth_stencil_buffer_=this.gl.createRenderbuffer();this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.depth_stencil_buffer_);this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.DEPTH_COMPONENT16,a,b);this.width=a;this.height=b};
o3d.State=function(){o3d.ParamObject.call(this);this.state_params_={};o3d.State.stateVariableInfos_=o3d.State.stateVariableInfos_||{AlphaBlendEnable:{paramType:"ParamBoolean",defaultValue:false},AlphaComparisonFunction:{paramType:"ParamInteger",defaultValue:o3d.State.CMP_ALWAYS},AlphaReference:{paramType:"ParamFloat",defaultValue:0},AlphaTestEnable:{paramType:"ParamBoolean",defaultValue:false},BlendAlphaEquation:{paramType:"ParamInteger",defaultValue:o3d.State.BLEND_ADD},BlendEquation:{paramType:"ParamInteger",
defaultValue:o3d.State.BLEND_ADD},CCWStencilComparisonFunction:{paramType:"ParamInteger",defaultValue:o3d.State.CMP_ALWAYS},CCWStencilFailOperation:{paramType:"ParamInteger",defaultValue:o3d.State.STENCIL_KEEP},CCWStencilPassOperation:{paramType:"ParamInteger",defaultValue:o3d.State.STENCIL_KEEP},CCWStencilZFailOperation:{paramType:"ParamInteger",defaultValue:o3d.State.STENCIL_KEEP},ColorWriteEnable:{paramType:"ParamInteger",defaultValue:15},CullMode:{paramType:"ParamInteger",defaultValue:o3d.State.CULL_CW},
DestinationBlendAlphaFunction:{paramType:"ParamInteger",defaultValue:o3d.State.BLENDFUNC_ZERO},DestinationBlendFunction:{paramType:"ParamInteger",defaultValue:o3d.State.BLENDFUNC_ZERO},DitherEnable:{paramType:"ParamBoolean",defaultValue:false},FillMode:{paramType:"ParamInteger",defaultValue:o3d.State.SOLID},LineSmoothEnable:{paramType:"ParamBoolean",defaultValue:false},PointSize:{paramType:"ParamFloat",defaultValue:0},PointSpriteEnable:{paramType:"ParamBoolean",defaultValue:false},PolygonOffset1:{paramType:"ParamFloat",
defaultValue:0},PolygonOffset2:{paramType:"ParamFloat",defaultValue:0},SeparateAlphaBlendEnable:{paramType:"ParamBoolean",defaultValue:false},SourceBlendAlphaFunction:{paramType:"ParamInteger",defaultValue:o3d.State.BLENDFUNC_ONE},SourceBlendFunction:{paramType:"ParamInteger",defaultValue:o3d.State.BLENDFUNC_ONE},StencilComparisonFunction:{paramType:"ParamInteger",defaultValue:o3d.State.CMP_ALWAYS},StencilEnable:{paramType:"ParamBoolean",defaultValue:false},StencilFailOperation:{paramType:"ParamInteger",
defaultValue:o3d.State.STENCIL_KEEP},StencilMask:{paramType:"ParamInteger",defaultValue:255},StencilPassOperation:{paramType:"ParamInteger",defaultValue:o3d.State.STENCIL_KEEP},StencilReference:{paramType:"ParamInteger",defaultValue:0},StencilWriteMask:{paramType:"ParamInteger",defaultValue:255},StencilZFailOperation:{paramType:"ParamInteger",defaultValue:o3d.State.STENCIL_KEEP},TwoSidedStencilEnable:{paramType:"ParamBoolean",defaultValue:false},ZComparisonFunction:{paramType:"ParamInteger",defaultValue:o3d.State.CMP_LESS},
ZEnable:{paramType:"ParamBoolean",defaultValue:true},ZWriteEnable:{paramType:"ParamBoolean",defaultValue:true}}};o3d.inherit("State","ParamObject");o3d.State.prototype.state_params_={};o3d.State.CMP_NEVER=0;o3d.State.CMP_LESS=1;o3d.State.CMP_EQUAL=2;o3d.State.CMP_LEQUAL=3;o3d.State.CMP_GREATER=4;o3d.State.CMP_NOTEQUAL=5;o3d.State.CMP_GEQUAL=6;o3d.State.CMP_ALWAYS=7;o3d.Cull=goog.typedef;o3d.State.CULL_NONE=0;o3d.State.CULL_CW=1;o3d.State.CULL_CCW=2;o3d.State.POINT=0;o3d.State.WIREFRAME=1;
o3d.State.SOLID=2;o3d.State.BLENDFUNC_ZERO=0;o3d.State.BLENDFUNC_ONE=1;o3d.State.BLENDFUNC_SOURCE_COLOR=2;o3d.State.BLENDFUNC_INVERSE_SOURCE_COLOR=3;o3d.State.BLENDFUNC_SOURCE_ALPHA=4;o3d.State.BLENDFUNC_INVERSE_SOURCE_ALPHA=5;o3d.State.BLENDFUNC_DESTINATION_ALPHA=6;o3d.State.BLENDFUNC_INVERSE_DESTINATION_ALPHA=7;o3d.State.BLENDFUNC_DESTINATION_COLOR=8;o3d.State.BLENDFUNC_INVERSE_DESTINATION_COLOR=9;o3d.State.BLENDFUNC_SOURCE_ALPHA_SATUTRATE=10;o3d.State.BLEND_ADD=0;o3d.State.BLEND_SUBTRACT=1;
o3d.State.BLEND_REVERSE_SUBTRACT=2;o3d.State.BLEND_MIN=3;o3d.State.BLEND_MAX=4;o3d.State.STENCIL_KEEP=0;o3d.State.STENCIL_ZERO=1;o3d.State.STENCIL_REPLACE=2;o3d.State.STENCIL_INCREMENT_SATURATE=3;o3d.State.STENCIL_DECREMENT_SATURATE=4;o3d.State.STENCIL_INVERT=5;o3d.State.STENCIL_INCREMENT=6;o3d.State.STENCIL_DECREMENT=7;
o3d.State.prototype.getStateParam=function(a){if(!this.state_params_[a]){var b=o3d.State.stateVariableInfos_[a],c=new o3d.global.o3d[b.paramType];c.value=b.defaultValue;this.state_params_[a]=c}return this.state_params_[a]};o3d.State.createDefaultState_=function(a){var b=new o3d.State;b.gl=a;a=o3d.State.stateVariableInfos_;for(name in a){var c=a[name];b.getStateParam(name).value=c.defaultValue}return b};
o3d.State.convertCmpFunc_=function(a,b){switch(b){case o3d.State.CMP_NEVER:return a.NEVER;case o3d.State.CMP_LESS:return a.LESS;case o3d.State.CMP_GREATER:return a.GREATER;case o3d.State.CMP_LEQUAL:return a.LEQUAL;case o3d.State.CMP_GEQUAL:return a.GEQUAL;case o3d.State.CMP_EQUAL:return a.EQUAL;case o3d.State.CMP_NOTEQUAL:return a.NOTEQUAL}return a.ALWAYS};
o3d.State.convertBlendFunc_=function(a,b){switch(b){case o3d.State.BLENDFUNC_ZERO:return a.ZERO;case o3d.State.BLENDFUNC_SOURCE_COLOR:return a.SRC_COLOR;case o3d.State.BLENDFUNC_INVERSE_SOURCE_COLOR:return a.ONE_MINUS_SRC_COLOR;case o3d.State.BLENDFUNC_SOURCE_ALPHA:return a.SRC_ALPHA;case o3d.State.BLENDFUNC_INVERSE_SOURCE_ALPHA:return a.ONE_MINUS_SRC_ALPHA;case o3d.State.BLENDFUNC_DESTINATION_ALPHA:return a.DST_ALPHA;case o3d.State.BLENDFUNC_INVERSE_DESTINATION_ALPHA:return a.ONE_MINUS_DST_ALPHA;
case o3d.State.BLENDFUNC_DESTINATION_COLOR:return a.DST_COLOR;case o3d.State.BLENDFUNC_INVERSE_DESTINATION_COLOR:return a.ONE_MINUS_DST_COLOR;case o3d.State.BLENDFUNC_SOURCE_ALPHA_SATUTRATE:return a.SRC_ALPHA_SATURATE}return a.ONE};o3d.State.convertBlendEquation_=function(a,b){switch(b){case o3d.State.BLEND_SUBTRACT:return a.FUNC_SUBTRACT;case o3d.State.BLEND_REVERSE_SUBTRACT:return a.FUNC_REVERSE_SUBTRACT;case o3d.State.BLEND_MIN:return a.MIN;case o3d.State.BLEND_MAX:return a.MAX}return a.FUNC_ADD};
o3d.State.prototype.push_=function(){this.gl.client.pushState_(this.getVariableMap_())};o3d.State.prototype.pop_=function(){this.gl.client.popState_()};o3d.State.prototype.getVariableMap_=function(){var a={},b=this.state_params_,c;for(c in b)a[c]=b[c].value;return a};o3d.State.relevantValues_=function(a,b,c,d){for(var e=false,f=0;f<b.length;++f){var g=b[f];if(c[g]!==undefined){e=true;break}}if(e)for(f=0;f<b.length;++f){g=b[f];var h=c[g];if(h===undefined)h=a.client.getState_(g);d[g]=h}return e};
o3d.State.setVariables_=function(a,b){var c={};if(this.relevantValues_(a,["AlphaBlendEnable"],b,c))c.AlphaBlendEnable?a.enable(a.BLEND):a.disable(a.BLEND);if(this.relevantValues_(a,["SeparateAlphaBlendEnable","SourceBlendFunction","SourceBlendAlphaFunction","DestinationBlendAlphaFunction","BlendEquation","BlendAlphaEquation"],b,c))if(c.SeparateAlphaBlendEnable){a.blendFuncSeparate(o3d.State.convertBlendFunc_(a,c.SourceBlendFunction),o3d.State.convertBlendFunc_(a,c.DestinationBlendFunction),o3d.State.convertBlendFunc_(a,
c.SourceBlendAlphaFunction),o3d.State.convertBlendFunc_(a,c.DestinationBlendAlphaFunction));a.blendEquationSeparate(o3d.State.convertBlendEquation_(a,c.BlendEquation),o3d.State.convertBlendEquation_(a,c.BlendAlphaEquation))}this.relevantValues_(a,["SourceBlendFunction","DestinationBlendFunction"],b,c)&&a.blendFunc(o3d.State.convertBlendFunc_(a,c.SourceBlendFunction),o3d.State.convertBlendFunc_(a,c.DestinationBlendFunction));this.relevantValues_(a,["BlendEquation"],b,c)&&a.blendEquation(o3d.State.convertBlendEquation_(a,
c.BlendEquation));if(this.relevantValues_(a,["CullMode"],b,c))switch(c.CullMode){case o3d.State.CULL_CW:a.enable(a.CULL_FACE);a.cullFace(a.BACK);break;case o3d.State.CULL_CCW:a.enable(a.CULL_FACE);a.cullFace(a.FRONT);break;default:a.disable(a.CULL_FACE)}if(this.relevantValues_(a,["DitherEnable"],b,c))c.DitherEnable?a.enable(a.DITHER):a.disable(a.DITHER);if(this.relevantValues_(a,["ZEnable","ZComparisonFunction"],b,c))if(c.ZEnable){a.enable(a.DEPTH_TEST);a.depthFunc(this.convertCmpFunc_(a,c.ZComparisonFunction))}else a.disable(a.DEPTH_TEST);
this.relevantValues_(a,["ZWriteEnable"],b,c)&&a.depthMask(c.ZWriteEnable);if(this.relevantValues_(a,["StencilEnable","StencilComparisonFunction"],b,c))if(c.StencilEnable){a.enable(a.STENCIL_TEST);a.stencilFunc(this.convertCmpFunc_(a,c.StencilComparisonFunction))}else a.disable(a.STENCIL_TEST);if(this.relevantValues_(a,["PolygonOffset1","PolygonOffset2"],b,c)){var d=c.PolygonOffset1||0,e=c.PolygonOffset2||0;if(d||e){a.enable(a.POLYGON_OFFSET_FILL);a.polygonOffset(d,e)}else a.disable(a.POLYGON_OFFSET_FILL)}if(this.relevantValues_(a,
["FillMode"],b,c))a.fillMode_=c.FillMode};o3d.DrawContext=function(a,b){o3d.ParamObject.call(this);this.view=a||[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]];this.projection=b||[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]]};o3d.inherit("DrawContext","ParamObject");o3d.ParamObject.setUpO3DParam_(o3d.DrawContext,"view","ParamMatrix4");o3d.ParamObject.setUpO3DParam_(o3d.DrawContext,"projection","ParamMatrix4");
o3d.RayIntersectionInfo=function(){o3d.NamedObject.call(this);o3d.RayIntersectionInfo.prototype.position=[0,0,0]};o3d.inherit("RayIntersectionInfo","NamedObject");o3d.RayIntersectionInfo.prototype.valid=false;o3d.RayIntersectionInfo.prototype.inside=false;o3d.RayIntersectionInfo.prototype.intersected=false;o3d.RayIntersectionInfo.prototype.position=[0,0,0];o3d.RayIntersectionInfo.prototype.primitiveIndex=-1;
o3d.Sampler=function(){o3d.ParamObject.call(this);this.addressModeW=this.addressModeV=this.addressModeU=o3d.Sampler.WRAP;this.mipFilter=this.minFilter=this.magFilter=o3d.Sampler.LINEAR;this.borderColor=[0,0,0,0];this.maxAnisotropy=1;this.texture=null};o3d.inherit("Sampler","ParamObject");o3d.Sampler.AddressMode=goog.typedef;o3d.Sampler.WRAP=0;o3d.Sampler.MIRROR=1;o3d.Sampler.CLAMP=2;o3d.Sampler.BORDER=3;o3d.Sampler.FilterType=goog.typedef;o3d.Sampler.NONE=0;o3d.Sampler.POINT=1;
o3d.Sampler.LINEAR=2;o3d.Sampler.ANISOTROPIC=3;o3d.ParamObject.setUpO3DParam_(o3d.Sampler,"addressModeU","ParamInteger");o3d.ParamObject.setUpO3DParam_(o3d.Sampler,"addressModeV","ParamInteger");o3d.ParamObject.setUpO3DParam_(o3d.Sampler,"addressModeW","ParamInteger");o3d.ParamObject.setUpO3DParam_(o3d.Sampler,"magFilter","ParamInteger");o3d.ParamObject.setUpO3DParam_(o3d.Sampler,"minFilter","ParamInteger");o3d.ParamObject.setUpO3DParam_(o3d.Sampler,"mipFilter","ParamInteger");
o3d.ParamObject.setUpO3DParam_(o3d.Sampler,"borderColor","ParamFloat4");o3d.ParamObject.setUpO3DParam_(o3d.Sampler,"maxAnisotropy","ParamInteger");o3d.ParamObject.setUpO3DParam_(o3d.Sampler,"texture","ParamTexture");o3d.Sampler.prototype.convertAddressMode_=function(a){var b=this.gl.REPEAT;switch(a){case o3d.Sampler.WRAP:b=this.gl.REPEAT;break;case o3d.Sampler.MIRROR:b=this.gl.MIRRORED_REPEAT;break;case o3d.Sampler.CLAMP:b=this.gl.CLAMP_TO_EDGE;break;default:this.gl.client.error_callback("Unknown/Unavailable Address mode")}return b};
o3d.Sampler.prototype.convertMinFilter_=function(a,b){switch(a){case o3d.Sampler.NONE:return this.gl.NEAREST;case o3d.Sampler.POINT:if(b==o3d.Sampler.NONE)return this.gl.NEAREST;else if(b==o3d.Sampler.POINT)return this.gl.NEAREST_MIPMAP_NEAREST;else if(b==o3d.Sampler.LINEAR)return this.gl.NEAREST_MIPMAP_LINEAR;else if(b==o3d.Sampler.ANISOTROPIC)return this.gl.NEAREST_MIPMAP_LINEAR;case o3d.Sampler.ANISOTROPIC:case o3d.Sampler.LINEAR:if(b==o3d.Sampler.NONE)return this.gl.LINEAR;else if(b==o3d.Sampler.POINT)return this.gl.LINEAR_MIPMAP_NEAREST;
else if(b==o3d.Sampler.LINEAR)return this.gl.LINEAR_MIPMAP_LINEAR;else if(b==o3d.Sampler.ANISOTROPIC)return this.gl.LINEAR_MIPMAP_LINEAR}this.gl.client.error_callback("Unknown filter.");return this.gl.NONE};o3d.Sampler.prototype.convertMagFilter_=function(a){switch(a){case o3d.Sampler.NONE:case o3d.Sampler.POINT:return this.gl.NEAREST;case o3d.Sampler.LINEAR:case o3d.Sampler.ANISOTROPIC:return this.gl.LINEAR}this.gl.client.error_callback("Unknown filter.");return this.gl.LINEAR};
o3d.Sampler.defaultSampler_=new o3d.Sampler;o3d.Sampler.defaultSampler_.magFilter=o3d.Sampler.POINT;
o3d.Sampler.prototype.bindAndSetParameters_=function(a){var b=null;if(this.texture)b=this.texture;else if(this.gl.client.reportErrors_()){b=this.gl.client.fallback_error_texture_;this.gl.client.error_callback("Missing texture for sampler "+this.name)}else b=a?this.gl.client.error_texture_cube_:this.gl.client.error_texture_;a=this.mipFilter;if(b.levels==1)a=o3d.Sampler.NONE;b.bindAndSetParameters_(this.convertAddressMode_(this.addressModeU),this.convertAddressMode_(this.addressModeV),this.convertMinFilter_(this.minFilter,
a),this.convertMagFilter_(this.magFilter))};o3d.Transform=function(a,b,c,d,e){o3d.ParamObject.call(this);this.localMatrix=a||[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]];this.worldMatrix=b||[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]];this.parent=null;this.visible=c||true;this.boundingBox=d||new o3d.BoundingBox([-1,-1,-1],[1,1,1]);this.cull=e||false;this.children=[];this.shapes=[]};o3d.inherit("Transform","ParamObject");o3d.ParamObject.setUpO3DParam_(o3d.Transform,"visible","ParamBoolean");
o3d.ParamObject.setUpO3DParam_(o3d.Transform,"worldMatrix","ParamMatrix4");o3d.ParamObject.setUpO3DParam_(o3d.Transform,"localMatrix","ParamMatrix4");o3d.ParamObject.setUpO3DParam_(o3d.Transform,"cull","ParamBoolean");o3d.ParamObject.setUpO3DParam_(o3d.Transform,"boundingBox","ParamBoundingBox");o3d.Transform.prototype.__defineSetter__("parent",function(a){this.parent_!=null&&o3d.removeFromArray(this.parent_.children,this);(this.parent_=a)&&a.addChild(this)});
o3d.Transform.prototype.__defineGetter__("parent",function(){return this.parent_});o3d.Transform.prototype.addChild=function(a){this.children.push(a)};o3d.Transform.prototype.getTransformsInTree=function(){var a=[];o3d.Transform.getTransformInTreeRecursive_(this,a);return a};o3d.Transform.getTransformInTreeRecursive_=function(a,b){b.push(a);for(var c=a.children,d=0;d<c.length;++d)o3d.Transform.getTransformInTreeRecursive_(c[d],b)};o3d.Transform.prototype.getTransformsByNameInTree=function(){o3d.notImplemented()};
o3d.Transform.prototype.getUpdatedWorldMatrix=function(){var a;a=this.parent?this.parent.getUpdatedWorldMatrix():[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]];o3d.Transform.compose(a,this.localMatrix,this.worldMatrix);return this.worldMatrix};o3d.Transform.prototype.addShape=function(a){this.shapes.push(a)};o3d.Transform.prototype.removeShape=function(a){o3d.removeFromArray(this.shapes,a)};
o3d.Transform.prototype.createDrawElements=function(a,b){for(var c=this.children,d=this.shapes,e=0;e<d.length;++e)d[e].createDrawElements(a,b);for(e=0;e<c.length;++e)c[e].createDrawElements(a,b)};o3d.Transform.prototype.identity=function(){for(var a=this.localMatrix,b=0;b<4;++b)for(var c=0;c<4;++c)a[b][c]=b==c?1:0};
o3d.Transform.compose=function(a,b,c){c=c||a;var d=a[0],e=a[1],f=a[2],g=a[3],h=b[0],j=b[1],i=b[2],k=b[3];b=d[0];a=d[1];var l=d[2];d=d[3];var m=e[0],n=e[1],r=e[2];e=e[3];var o=f[0],q=f[1],p=f[2];f=f[3];var t=g[0],u=g[1],x=g[2];g=g[3];var w=h[0],y=h[1],s=h[2];h=h[3];var v=j[0],A=j[1],B=j[2];j=j[3];var D=i[0],C=i[1],z=i[2];i=i[3];var E=k[0],F=k[1],G=k[2];k=k[3];c[0].splice(0,4,b*w+m*y+o*s+t*h,a*w+n*y+q*s+u*h,l*w+r*y+p*s+x*h,d*w+e*y+f*s+g*h);c[1].splice(0,4,b*v+m*A+o*B+t*j,a*v+n*A+q*B+u*j,l*v+r*A+p*B+
x*j,d*v+e*A+f*B+g*j);c[2].splice(0,4,b*D+m*C+o*z+t*i,a*D+n*C+q*z+u*i,l*D+r*C+p*z+x*i,d*D+e*C+f*z+g*i);c[3].splice(0,4,b*E+m*F+o*G+t*k,a*E+n*F+q*G+u*k,l*E+r*F+p*G+x*k,d*E+e*F+f*G+g*k)};o3d.Transform.matricesEqual=function(a,b){if(a==b)return true;for(var c=0;c<4;++c)for(var d=0;d<4;++d)if(a[c][d]!=b[c][d])return false;return true};
o3d.Transform.transpose=function(a,b){var c=b||a,d=a[0],e=a[1],f=a[2],g=a[3],h=d[1],j=d[2],i=d[3],k=e[1],l=e[2],m=e[3],n=f[1],r=f[2],o=f[3],q=g[1],p=g[2],t=g[3];c[0].splice(0,4,d[0],e[0],f[0],g[0]);c[1].splice(0,4,h,k,n,q);c[2].splice(0,4,j,l,r,p);c[3].splice(0,4,i,m,o,t)};
o3d.Transform.inverse=function(a,b){var c=b||a,d=a[0],e=a[1],f=a[2],g=a[3],h=d[0],j=d[1],i=d[2];d=d[3];var k=e[0],l=e[1],m=e[2];e=e[3];var n=f[0],r=f[1],o=f[2];f=f[3];var q=g[0],p=g[1],t=g[2];g=g[3];var u=o*g,x=t*f,w=m*g,y=t*e,s=m*f,v=o*e,A=i*g,B=t*d,D=i*f,C=o*d,z=i*e,E=m*d,F=n*p,G=q*r,H=k*p,I=q*l,J=k*r,K=n*l,L=h*p,M=q*j,N=h*r,O=n*j,P=h*l,Q=k*j,R=u*l+y*r+s*p-(x*l+w*r+v*p),S=x*j+A*r+C*p-(u*j+B*r+D*p);p=w*j+B*l+z*p-(y*j+A*l+E*p);j=v*j+D*l+E*r-(s*j+C*l+z*r);l=1/(h*R+k*S+n*p+q*j);c[0].splice(0,4,l*R,
l*S,l*p,l*j);c[1].splice(0,4,l*(x*k+w*n+v*q-(u*k+y*n+s*q)),l*(u*h+B*n+D*q-(x*h+A*n+C*q)),l*(y*h+A*k+E*q-(w*h+B*k+z*q)),l*(s*h+C*k+z*n-(v*h+D*k+E*n)));c[2].splice(0,4,l*(F*e+I*f+J*g-(G*e+H*f+K*g)),l*(G*d+L*f+O*g-(F*d+M*f+N*g)),l*(H*d+M*e+P*g-(I*d+L*e+Q*g)),l*(K*d+N*e+Q*f-(J*d+O*e+P*f)));c[3].splice(0,4,l*(H*o+K*t+G*m-(J*t+F*m+I*o)),l*(N*t+F*i+M*o-(L*o+O*t+G*i)),l*(L*m+Q*t+I*i-(P*t+H*i+M*m)),l*(P*o+J*i+O*m-(N*m+Q*o+K*i)))};
o3d.Transform.prototype.translate=function(){var a;a=arguments.length==3?arguments:arguments[0];var b=this.localMatrix,c=a[0],d=a[1];a=a[2];var e=b[0],f=b[1],g=b[2];b=b[3];b.splice(0,4,e[0]*c+f[0]*d+g[0]*a+b[0],e[1]*c+f[1]*d+g[1]*a+b[1],e[2]*c+f[2]*d+g[2]*a+b[2],e[3]*c+f[3]*d+g[3]*a+b[3])};
o3d.Transform.prototype.rotateX=function(a){var b=this.localMatrix,c=b[1];b=b[2];var d=c[0],e=c[1],f=c[2],g=c[3],h=b[0],j=b[1],i=b[2],k=b[3],l=Math.cos(a);a=Math.sin(a);c.splice(0,4,l*d+a*h,l*e+a*j,l*f+a*i,l*g+a*k);b.splice(0,4,l*h-a*d,l*j-a*e,l*i-a*f,l*k-a*g)};o3d.Transform.transformPoint=function(a,b){var c=b[0],d=b[1],e=b[2],f=a[0],g=a[1],h=a[2],j=a[3],i=c*f[3]+d*g[3]+e*h[3]+j[3];return[(c*f[0]+d*g[0]+e*h[0]+j[0])/i,(c*f[1]+d*g[1]+e*h[1]+j[1])/i,(c*f[2]+d*g[2]+e*h[2]+j[2])/i]};
o3d.Transform.multiplyVector=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=a[0],h=a[1],j=a[2],i=a[3];return[c*g[0]+d*h[0]+e*j[0]+f*i[0],c*g[1]+d*h[1]+e*j[1]+f*i[1],c*g[2]+d*h[2]+e*j[2]+f*i[2],c*g[3]+d*h[3]+e*j[3]+f*i[3]]};o3d.Transform.transformPointZOnly=function(a,b){var c=b[0],d=b[1],e=b[2],f=a[0],g=a[1],h=a[2],j=a[3];return(c*f[2]+d*g[2]+e*h[2]+j[2])/(c*f[3]+d*g[3]+e*h[3]+j[3])};
o3d.Transform.prototype.rotateY=function(a){var b=this.localMatrix,c=b[0];b=b[2];var d=c[0],e=c[1],f=c[2],g=c[3],h=b[0],j=b[1],i=b[2],k=b[3],l=Math.cos(a);a=Math.sin(a);c.splice(0,4,l*d-a*h,l*e-a*j,l*f-a*i,l*g-a*k);b.splice(0,4,l*h+a*d,l*j+a*e,l*i+a*f,l*k+a*g)};
o3d.Transform.prototype.rotateZ=function(a){var b=this.localMatrix,c=b[0];b=b[1];var d=c[0],e=c[1],f=c[2],g=c[3],h=b[0],j=b[1],i=b[2],k=b[3],l=Math.cos(a);a=Math.sin(a);c.splice(0,4,l*d+a*h,l*e+a*j,l*f+a*i,l*g+a*k);b.splice(0,4,l*h-a*d,l*j-a*e,l*i-a*f,l*k-a*g)};
o3d.Transform.prototype.rotateZYX=function(a){var b=this.localMatrix,c=Math.sin(a[0]),d=Math.cos(a[0]),e=Math.sin(a[1]),f=Math.cos(a[1]),g=Math.sin(a[2]),h=Math.cos(a[2]),j=h*e,i=g*e;a=h*f;var k=g*f;e=-e;var l=j*c-g*d,m=i*c+h*d,n=f*c;g=j*d+g*c;c=i*d-h*c;d*=f;f=b[0];h=b[1];b=b[2];i=f[0];j=f[1];var r=f[2],o=f[3],q=h[0],p=h[1],t=h[2],u=h[3],x=b[0],w=b[1],y=b[2],s=b[3];f.splice(0,4,a*i+k*q+e*x,a*j+k*p+e*w,a*r+k*t+e*y,a*o+k*u+e*s);h.splice(0,4,l*i+m*q+n*x,l*j+m*p+n*w,l*r+m*t+n*y,l*o+m*u+n*s);b.splice(0,
4,g*i+c*q+d*x,g*j+c*p+d*w,g*r+c*t+d*y,g*o+c*u+d*s)};o3d.Transform.prototype.axisRotate=function(a,b){o3d.Transform.axisRotateMatrix(this.localMatrix,a,b)};
o3d.Transform.axisRotateMatrix=function(a,b,c,d){d=d||a;var e=b[0],f=b[1],g=b[2];b=Math.sqrt(e*e+f*f+g*g);e/=b;f/=b;g/=b;b=e*e;var h=f*f,j=g*g,i=Math.cos(c),k=Math.sin(c),l=1-i;c=b+(1-b)*i;b=e*f*l+g*k;var m=e*g*l-f*k,n=e*f*l-g*k;h+=(1-h)*i;var r=f*g*l+e*k,o=e*g*l+f*k;e=f*g*l-e*k;f=j+(1-j)*i;k=a[0];var q=a[1],p=a[2];i=a[3];a=k[0];g=k[1];j=k[2];k=k[3];l=q[0];var t=q[1],u=q[2];q=q[3];var x=p[0],w=p[1],y=p[2];p=p[3];var s=i[0],v=i[1],A=i[2];i=i[3];d[0].splice(0,4,c*a+b*l+m*x,c*g+b*t+m*w,c*j+b*u+m*y,c*
k+b*q+m*p);d[1].splice(0,4,n*a+h*l+r*x,n*g+h*t+r*w,n*j+h*u+r*y,n*k+h*q+r*p);d[2].splice(0,4,o*a+e*l+f*x,o*g+e*t+f*w,o*j+e*u+f*y,o*k+e*q+f*p);d[3].splice(0,4,s,v,A,i)};o3d.Transform.prototype.quaternionRotate=function(a){var b=a[0],c=a[1],d=a[2],e=a[3];a=e*e;var f=e*b,g=e*c;e*=d;var h=b*b,j=b*c;b*=d;var i=c*c;c*=d;d*=d;var k=a+h+i+d;o3d.Transform.compose(this.localMatrix,[[(a+h-i-d)/k,2*(e+j)/k,2*(b-g)/k,0],[2*(j-e)/k,(a-h+i-d)/k,2*(f+c)/k,0],[2*(g+b)/k,2*(c-f)/k,(a-h-i+d)/k,0],[0,0,0,1]])};
o3d.Transform.prototype.scale=function(){var a;a=arguments.length==3?arguments:arguments[0];var b=this.localMatrix,c=a[0],d=a[1];a=a[2];var e=b[0],f=b[1];b=b[2];e.splice(0,4,c*e[0],c*e[1],c*e[2],c*e[3]);f.splice(0,4,d*f[0],d*f[1],d*f[2],d*f[3]);b.splice(0,4,a*b[0],a*b[1],a*b[2],a*b[3])};o3d.Transform.flattenMatrix4=function(a){var b=a[0],c=a[1],d=a[2];a=a[3];return[b[0],b[1],b[2],b[3],c[0],c[1],c[2],c[3],d[0],d[1],d[2],d[3],a[0],a[1],a[2],a[3]]};
o3d.Transform.prototype.traverse=function(a,b){this.gl.client.render_stats_.transformsProcessed++;if(!(a.length==0||!this.visible)){b=b||[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]];o3d.Transform.compose(b,this.localMatrix,this.worldMatrix);var c=[];if(this.cull){if(this.boundingBox)for(var d=0;d<a.length;++d){var e=a[d],f=[[],[],[],[]];o3d.Transform.compose(e.context.view,this.worldMatrix,f);o3d.Transform.compose(e.context.projection,f,f);this.boundingBox.inFrustum(f)&&c.push(e)}}else c=a;if(c.length==
0)this.gl.client.render_stats_.transformsCulled++;else{e=this.children;f=this.shapes;for(d=0;d<f.length;++d)f[d].writeToDrawLists(c,this.worldMatrix,this);for(d=0;d<e.length;++d)e[d].traverse(c,this.worldMatrix)}}};o3d.Pack=function(){o3d.NamedObject.call(this);this.objects_=[]};o3d.inherit("Pack","NamedObject");o3d.Pack.prototype.destroy=function(){this.objects_=[];this.client.destroyPack(this)};o3d.Pack.prototype.removeObject=function(a){o3d.removeFromArray(this.objects_,a)};
o3d.Pack.prototype.createObject=function(a){var b=o3d.global.o3d[o3d.filterTypeName_(a)];if(typeof b!="function")throw"cannot find type in o3d namespace: "+a;a=new b;a.gl=this.gl;a.clientId=o3d.Client.nextId++;this.objects_.push(a);return a};o3d.Pack.prototype.createTexture2D=function(a,b,c,d,e){var f=this.createObject("Texture2D");f.init_(a,b,c,d,e);return f};o3d.Pack.prototype.createTextureCUBE=function(a,b,c,d){var e=this.createObject("TextureCUBE");e.init_(a,b,c,d);return e};
o3d.Pack.prototype.createDepthStencilSurface=function(a,b){var c=this.createObject("RenderDepthStencilSurface");c.initWithSize_(a,b);return c};o3d.Pack.prototype.getObjects=function(a,b){b=o3d.filterTypeName_(b);for(var c=[],d=0;d<this.objects_.length;++d){var e=this.objects_[d];e.isAClassName(b)&&e.name==a&&c.push(e)}return c};o3d.Pack.prototype.getObjectsByClassName=function(a){a=o3d.filterTypeName_(a);for(var b=[],c=0;c<this.objects_.length;++c){var d=this.objects_[c];d.isAClassName(a)&&b.push(d)}return b};
o3d.Pack.prototype.objects_=[];o3d.Pack.prototype.createFileRequest=function(){return this.createObject("FileRequest")};o3d.Pack.prototype.createArchiveRequest=function(){return this.createObject("ArchiveRequest")};
o3d.Pack.prototype.createBitmapsFromRawData=function(a){var b=this.createObject("Bitmap");if(!a.image_)throw"Cannot create bitmap from non-image data.";b.height=a.image_.height;b.width=a.image_.width;var c=document.createElement("CANVAS");c.width=b.width;c.height=b.height;c.getContext("2d").drawImage(a.image_,0,0,b.width,b.height);b.canvas_=c;b.flipVerticallyLazily_();b.format=o3d.Texture.ARGB8;b.numMipmaps=1;return[b]};o3d.Pack.prototype.createRawDataFromDataURL=function(){o3d.notImplemented()};
o3d.BoundingBox=function(a,b){o3d.ParamObject.call(this);var c=a||[0,0,0],d=b||[0,0,0];this.minExtent=[c[0],c[1],c[2]];this.maxExtent=[d[0],d[1],d[2]];if(a&&b)this.valid=true};o3d.inherit("BoundingBox","ParamObject");o3d.BoundingBox.prototype.corners_=function(){for(var a=[],b=[this.minExtent,this.maxExtent],c=0;c<2;++c)for(var d=0;d<2;++d)for(var e=0;e<2;++e)a.push([b[c][0],b[d][1],b[e][2]]);return a};
o3d.BoundingBox.fitBoxToPoints_=function(a,b){for(var c=b||new o3d.BoundingBox,d=0;d<3;++d){c.maxExtent[d]=c.minExtent[d]=a[0][d];for(var e=1;e<a.length;++e){var f=a[e];c.minExtent[d]=Math.min(c.minExtent[d],f[d]);c.maxExtent[d]=Math.max(c.maxExtent[d],f[d])}}c.valid=true;return c};o3d.BoundingBox.prototype.valid=false;o3d.BoundingBox.prototype.minExtent=[0,0,0];o3d.BoundingBox.prototype.maxExtent=[0,0,0];
o3d.BoundingBox.prototype.mul=function(a){for(var b=this.corners_(),c=[],d=0;d<b.length;++d)c.push(o3d.Transform.transformPoint(a,b[d]));return o3d.BoundingBox.fitBoxToPoints_(c)};o3d.BoundingBox.prototype.add=function(a){return new o3d.BoundingBox([Math.min(a.minExtent[0],this.minExtent[0]),Math.min(a.minExtent[1],this.minExtent[1]),Math.min(a.minExtent[2],this.minExtent[2])],[Math.max(a.maxExtent[0],this.maxExtent[0]),Math.max(a.maxExtent[1],this.maxExtent[1]),Math.max(a.maxExtent[2],this.maxExtent[2])])};
o3d.BoundingBox.prototype.intersectRay=function(a,b){if(arguments.length==6){a=[arguments[0],arguments[1],arguments[2]];b=[arguments[3],arguments[4],arguments[5]]}var c=new o3d.RayIntersectionInfo;if(this.valid){c.valid=true;c.intersected=true;for(var d=[b[0]-a[0],b[1]-a[1],b[2]-a[2]],e=[0,0,0],f=true,g=[],h=[],j=[],i=0;i<3;++i){g.push(0);h.push(0);j.push(0,0)}for(i=0;i<3;++i)if(a[i]<this.minExtent[i]){g[i]=1;j[i]=this.minExtent[i];f=false}else if(a[i]>this.maxExtent[i]){g[i]=0;j[i]=this.maxExtent[i];
f=false}else g[i]=2;if(f){c.position=a;c.inside=true}else{for(i=0;i<3;++i)h[i]=g[i]!=2&&d[i]!=0?(j[i]-a[i])/d[i]:-1;f=0;for(i=1;i<3;++i)if(h[f]<h[i])f=i;if(h[f]<0)c.intersected=false;else{for(i=0;i<3;++i)if(f!=i){e[i]=a[i]+h[f]*d[i];if(e[i]<this.minExtent[i]||e[i]>this.maxExtent[i]){c.intersected=false;break}}else e[i]=j[i];c.position=e}}}return c};
o3d.BoundingBox.prototype.inFrustum=function(a){for(var b=this.corners_(),c=63,d=0;d<b.length;++d){var e=o3d.Transform.transformPoint(a,b[d]);c&=(e[0]>1)<<0|(e[0]<-1)<<1|(e[1]>1)<<2|(e[1]<-1)<<3|(e[2]>1)<<4|(e[2]<0)<<5;if(c==0)return true}return c==0};o3d.DrawElement=function(a){o3d.ParamObject.call(this);this.material=a||null;this.owner_=null};o3d.inherit("DrawElement","ParamObject");o3d.ParamObject.setUpO3DParam_(o3d.DrawElement,"material","ParamMaterial");
o3d.Element=function(a,b,c,d){o3d.ParamObject.call(this);this.material=a;this.boundingBox=b||new o3d.BoundingBox([-1,-1,-1],[1,1,1]);this.zSortPoint=c||[0,0,0];this.priority=0;this.cull=d||false;this.owner_=null;this.drawElements=[]};o3d.inherit("Element","ParamObject");o3d.ParamObject.setUpO3DParam_(o3d.Element,"material","ParamMaterial");o3d.ParamObject.setUpO3DParam_(o3d.Element,"boundingBox","ParamBoundingBox");o3d.ParamObject.setUpO3DParam_(o3d.Element,"zSortPoint","ParamFloat3");
o3d.ParamObject.setUpO3DParam_(o3d.Element,"priority","ParamFloat");o3d.ParamObject.setUpO3DParam_(o3d.Element,"cull","ParamBoolean");o3d.Element.prototype.__defineSetter__("owner",function(a){this.owner_=a;a.addElement(this)});o3d.Element.prototype.__defineGetter__("owner",function(){return this.owner_});o3d.Element.prototype.createDrawElement=function(a,b){drawElement=a.createObject("DrawElement");drawElement.owner=this;drawElement.material=b;this.drawElements.push(drawElement);return drawElement};
o3d.Element.prototype.intersectRay=function(){o3d.notImplemented()};o3d.Element.prototype.getBoundingBox=function(){return this.boundingBox};o3d.Element.prototype.render=function(){};o3d.Field=function(){o3d.NamedObject.call(this)};o3d.inherit("Field","NamedObject");o3d.Field.prototype.numComponents=0;o3d.Field.prototype.buffer=null;o3d.Field.prototype.offset_=0;o3d.Field.prototype.size=0;
o3d.Field.prototype.setAt=function(a,b){this.buffer.lock();for(var c=b.length/this.numComponents,d=0;d<c;++d)for(var e=0;e<this.numComponents;++e)this.buffer.array_[(a+d)*this.buffer.totalComponents+this.offset_+e]=b[this.numComponents*d+e];this.buffer.unlock();return true};o3d.Field.prototype.getAt=function(a,b){return this.buffer.getAtHelper_(a,b,this.offset_,this.numComponents)};o3d.FloatField=function(){o3d.Field.call(this)};o3d.inherit("FloatField","Field");o3d.UInt32Field=function(){o3d.Field.call(this)};
o3d.inherit("UInt32Field","Field");o3d.UByteNField=function(){o3d.Field.call(this)};o3d.inherit("UByteNField","Field");o3d.Buffer=function(){this.fields=[];this.array_=null};o3d.inherit("Buffer","NamedObject");o3d.Buffer.prototype.fields=[];o3d.Buffer.prototype.totalComponents=0;o3d.Buffer.prototype.gl_buffer_=0;o3d.Buffer.prototype.createArray=function(a){return new Float32Array(a)};o3d.Buffer.prototype.__defineGetter__("numElements",function(){return!this.array_?0:this.array_.length/this.totalComponents});
o3d.Buffer.prototype.updateTotalComponents_=function(){for(var a=0,b=0;b<this.fields.length;++b){this.fields[b].offset_=a;a+=this.fields[b].numComponents}this.totalComponents=a};o3d.Buffer.prototype.allocateElements=function(a){this.updateTotalComponents_();this.resize(a*this.totalComponents)};o3d.Buffer.prototype.resize=function(a){this.gl_buffer_=this.gl.createBuffer();this.array_=this.createArray(Math.floor(a))};
o3d.Buffer.prototype.createField=function(a,b){var c=this.array_&&this.array_.length>0,d=[],e=this.numElements;if(c)for(var f=0;f<this.fields.length;f++)d[f]=this.fields[f].getAt(0,e);var g=new o3d.Field;g.buffer=this;g.numComponents=b;g.size=b*(a=="UByteNField"?1:4);this.fields.push(g);this.updateTotalComponents_();if(c){this.allocateElements(e);for(f=0;f<this.fields.length;f++)(c=d[f])&&this.fields[f].setAt(0,c)}return g};
o3d.Buffer.prototype.removeField=function(a){o3d.removeFromArray(this.fields,a);this.updateTotalComponents_()};o3d.Buffer.prototype.getAtHelper_=function(a,b,c,d){for(var e=[],f=0;f<b;++f)for(var g=0;g<d;++g)e.push(this.array_[(a+f)*this.totalComponents+c+g]);return e};o3d.Buffer.prototype.lock=function(){};o3d.Buffer.prototype.unlock=function(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.gl_buffer_);this.gl.bufferData(this.gl.ARRAY_BUFFER,this.array_,this.gl.STATIC_DRAW)};
o3d.Buffer.prototype.set=function(a){a.length||o3d.notImplemented();if(this.array_==null||this.array_.length!=a.length)this.resize(a.length);this.lock();for(var b=0;b<a.length;++b)this.array_[b]=a[b];this.unlock()};o3d.VertexBufferBase=function(){o3d.Buffer.call(this)};o3d.inherit("VertexBufferBase","Buffer");o3d.VertexBufferBase.prototype.get=function(){return this.getAtHelper_(0,this.numElements,0,this.totalComponents)};
o3d.VertexBufferBase.prototype.getAt=function(a,b){return this.getAtHelper_(a,b,0,this.totalComponents)};o3d.VertexBuffer=function(){o3d.Buffer.call(this)};o3d.inherit("VertexBuffer","Buffer");o3d.VertexBuffer.prototype.className="o3d.VertexBuffer";o3d.SourceBuffer=function(){o3d.Buffer.call(this)};o3d.inherit("SourceBuffer","Buffer");o3d.IndexBuffer=function(){o3d.Buffer.call(this)};o3d.inherit("IndexBuffer","Buffer");o3d.IndexBuffer.prototype.createArray=function(a){return new Uint16Array(a)};
o3d.IndexBuffer.prototype.unlock=function(){this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.gl_buffer_);this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,this.array_,this.gl.STATIC_DRAW)};o3d.Stream=function(a,b,c,d){o3d.NamedObject.call(this);this.semantic=a;this.semanticIndex=b;this.field=c;this.startIndex=d};o3d.inherit("Stream","NamedObject");o3d.Stream.Semantic=goog.typedef;o3d.Stream.UNKNOWN_SEMANTIC=0;o3d.Stream.POSITION=1;o3d.Stream.NORMAL=2;o3d.Stream.TANGENT=3;o3d.Stream.BINORMAL=4;
o3d.Stream.COLOR=5;o3d.Stream.TEXCOORD=6;o3d.Stream.INFLUENCE_WEIGHTS=7;o3d.Stream.INFLUENCE_INDICES=8;o3d.Stream.prototype.field=null;o3d.Stream.prototype.semantic=o3d.Stream.UNKNOWN_SEMANTIC;o3d.Stream.prototype.semanticIndex=0;o3d.Stream.prototype.startIndex=0;o3d.Stream.prototype.getMaxVertices_=function(){var a=this.field.buffer;if(!a)return 0;a=a.numElements;if(this.startIndex>a)return 0;return a-this.startIndex};o3d.VertexSource=function(){o3d.ParamObject.call(this)};
o3d.inherit("VertexSource","ParamObject");o3d.VertexSource.prototype.bindStream=function(a,b,c){if(a){var d=a.getVertexStreamParam(b,c),e=this.getVertexStreamParam(b,c);if(d&&e&&d.stream.field.className==e.stream.field.className&&d.stream.field.numComponents==e.stream.field.numComponents){e.bind(d);a.streamWasBound_(this,b,c);return true}}return false};o3d.VertexSource.prototype.unbindStream=function(a,b){var c=this.getVertexStreamParam(a,b);if(c&&c.inputConnection!=null){c.unbindInput();return true}return false};
o3d.VertexSource.prototype.getVertexStreamParam=function(){o3d.notImplemented()};o3d.VertexSource.prototype.streamWasBound_=function(){};o3d.StreamBank=function(){o3d.VertexSource.call(this);this.vertex_streams_=[]};o3d.inherit("StreamBank","VertexSource");o3d.StreamBank.prototype.vertex_streams_=[];
o3d.StreamBank.prototype.__defineGetter__("vertexStreams",function(){for(var a=[],b=0;b<this.vertex_streams_.length;++b){var c=this.vertex_streams_[b];if(c&&c.length)for(var d=0;d<c.length;++d){var e=c[d];e&&a.push(e.stream)}}return a});o3d.StreamBank.prototype.setVertexStream=function(a,b,c,d){if(this.vertex_streams_[a]==undefined)this.vertex_streams_[a]=[];c=new o3d.Stream(a,b,c,d);d=new o3d.ParamVertexBufferStream;d.stream=c;d.owner_=this;this.vertex_streams_[a][b]=d};
o3d.StreamBank.prototype.getVertexStream=function(a,b){if(this.vertex_streams_[a]==undefined)return null;if(!this.vertex_streams_[a][b])return null;return this.vertex_streams_[a][b].stream};o3d.StreamBank.prototype.getVertexStreamParam=function(a,b){if(this.vertex_streams_[a]==undefined)return null;return this.vertex_streams_[a][b]};o3d.StreamBank.prototype.removeVertexStream=function(a,b){if(this.vertex_streams_[a]==undefined)return false;delete this.vertex_streams_[a][b];return true};
o3d.Primitive=function(a){o3d.Element.call(this);this.indexBuffer=null;this.streamBank=a||null;this.primitiveType=o3d.Primitive.TRIANGLELIST;this.startIndex=this.numberPrimitives=this.numberVertices=0;this.wireframeIndexBuffer_=null};o3d.inherit("Primitive","Element");o3d.Primitive.Type=goog.typedef;o3d.Primitive.POINTLIST=1;o3d.Primitive.LINELIST=2;o3d.Primitive.LINESTRIP=3;o3d.Primitive.TRIANGLELIST=4;o3d.Primitive.TRIANGLESTRIP=5;o3d.Primitive.TRIANGLEFAN=6;
o3d.ParamObject.setUpO3DParam_(o3d.Primitive,"streamBank","ParamStreamBank");
o3d.Primitive.prototype.render=function(){for(var a=this.streamBank,b=this.indexBuffer,c=[],d=0;d<a.vertex_streams_.length;++d){var e=a.vertex_streams_[d];if(e&&e.length)for(var f=0;f<e.length;++f){var g=o3d.Effect.reverseSemanticMap_[d][f],h=e[f].stream.field,j=h.buffer;g==undefined&&this.gl.client.error_callback("uknown semantic");for(var i=e[f];!i.owner_.updateStreams&&i.inputConnection;)i=i.inputConnection;i.owner_.updateStreams&&i.owner_.updateStreams();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,
j.gl_buffer_);this.gl.enableVertexAttribArray(g);c.push(g);i=Float32Array.BYTES_PER_ELEMENT;this.gl.vertexAttribPointer(g,h.numComponents,this.gl.FLOAT,false,j.totalComponents*i,h.offset_*i)}}this.gl.client.render_stats_.primitivesRendered+=this.numberPrimitives;switch(this.primitiveType){case o3d.Primitive.POINTLIST:a=this.gl.POINTS;d=this.numberPrimitives;break;case o3d.Primitive.LINELIST:a=this.gl.LINES;d=this.numberPrimitives*2;break;case o3d.Primitive.LINESTRIP:a=this.gl.LINE_STRIP;d=this.numberPrimitives+
1;break;case o3d.Primitive.TRIANGLELIST:a=this.gl.TRIANGLES;d=this.numberPrimitives*3;break;case o3d.Primitive.TRIANGLESTRIP:a=this.gl.TRIANGLE_STRIP;d=this.numberPrimitives+2;break;case o3d.Primitive.TRIANGLEFAN:a=this.gl.TRIANGLE_FAN;d=this.numberPrimitives+2;break;default:a=this.gl.TRIANGLES;d=this.numberPrimitives*3}e=false;if(this.gl.fillMode_==o3d.State.POINT)a=this.gl.POINTS;else if(this.gl.fillMode_==o3d.State.WIREFRAME)if(this.primitiveType==o3d.Primitive.TRIANGLELIST||this.primitiveType==
o3d.Primitive.TRIANGLEFAN||this.primitiveType==o3d.Primitive.TRIANGLESTRIP){e=true;a=this.gl.LINES;this.computeWireframeIndices_()}if(e){b=this.wireframeIndexBuffer_;switch(this.primitiveType){default:case o3d.Primitive.TRIANGLELIST:d=this.numberPrimitives*6;break;case o3d.Primitive.TRIANGLESTRIP:case o3d.Primitive.TRIANGLEFAN:d=this.numberPrimitives==0?0:this.numberPrimitives*4+2}}if(b){this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,b.gl_buffer_);this.gl.drawElements(a,d,this.gl.UNSIGNED_SHORT,
0)}else this.gl.drawArrays(a,0,d);for(b=0;b<c.length;++b)this.gl.disableVertexAttribArray(c[b])};o3d.Primitive.prototype.getIndex_=function(a){if(this.indexBuffer)return this.indexBuffer.array_[a];return a};
o3d.Primitive.prototype.computeWireframeIndices_=function(){this.wireframeIndexBuffer_=new o3d.IndexBuffer;this.wireframeIndexBuffer_.gl=this.gl;var a=this.numberPrimitives;this.wireframeIndexBuffer_.resize(2*(this.primitiveType==o3d.Primitive.TRIANGLELIST?3*a:2*a+1));var b=0;switch(this.primitiveType){default:case o3d.Primitive.TRIANGLELIST:var c=this.wireframeIndexBuffer_.array_;this.wireframeIndexBuffer_.lock();for(var d=0;d<a;++d){var e=this.getIndex_(3*d),f=this.getIndex_(3*d+1),g=this.getIndex_(3*
d+2);c[b++]=e;c[b++]=f;c[b++]=f;c[b++]=g;c[b++]=g;c[b++]=e}this.wireframeIndexBuffer_.unlock();break;case o3d.Primitive.TRIANGLEFAN:c=this.wireframeIndexBuffer_.array_;this.wireframeIndexBuffer_.lock();if(a>0){g=this.getIndex_(0);c[b++]=g;c[b++]=this.getIndex_(1)}for(d=2;d<a+2;++d){e=this.getIndex_(d);c[b++]=g;c[b++]=e;c[b++]=e;c[b++]=this.getIndex_(d-1)}this.wireframeIndexBuffer_.unlock();break;case o3d.Primitive.TRIANGLESTRIP:c=this.wireframeIndexBuffer_.array_;this.wireframeIndexBuffer_.lock();
if(a>0){e=this.getIndex_(0);f=this.getIndex_(1);c[b++]=e;c[b++]=f}for(d=2;d<a+2;++d){g=this.getIndex_(d);c[b++]=f;c[b++]=g;c[b++]=g;c[b++]=e;e=f;f=g}this.wireframeIndexBuffer_.unlock()}};o3d.Primitive.prototype.computeTriangleIndices_=function(a){switch(this.primitiveType){case o3d.Primitive.TRIANGLESTRIP:a=a%2==0?[a,a+1,a+2]:[a+1,a,a+2];break;case o3d.Primitive.TRIANGLEFAN:a=[0,a+1,a+2];break;default:a=[3*a,3*a+1,3*a+2]}if(this.indexBuffer){var b=this.indexBuffer.array_;return[b[a[0]],b[a[1]],b[a[2]]]}else return a};
o3d.Primitive.prototype.intersectRay=function(a,b,c,d){var e=new o3d.RayIntersectionInfo;e.valid=true;var f=this.indexBuffer;a=this.streamBank.vertex_streams_[o3d.Stream.POSITION][a].stream.field;var g=a.buffer,h=g.array_.length/g.totalComponents;a=a.getAt(0,h);g=d[0]-c[0];var j=d[1]-c[1];d=d[2]-c[2];var i=-j,k=g,l=0;if(g*g+j*j<d*d){i=-d;k=0;l=g}var m=j*l-d*k,n=d*i-g*l,r=g*k-j*i,o=i*c[0]+k*c[1]+l*c[2],q=m*c[0]+n*c[1]+r*c[2],p=0;f=f?f.array_.length:h;switch(this.primitiveType){case o3d.Primitive.TRIANGLESTRIP:numTriangles=
f-2;break;case o3d.Primitive.TRIANGLEFAN:numTriangles=f-2;break;default:numTriangles=f/3}for(f=0;f<numTriangles;++f){var t=this.computeTriangleIndices_(f);h=[false,false,false];for(var u=[false,false,false],x=0;x<3;++x){var w=3*t[x],y=a.slice(w,w+3);h[x]=i*y[0]+k*y[1]+l*y[2]-o>0;u[x]=m*y[0]+n*y[1]+r*y[2]-q>0}if(!(h[0]==h[1]&&h[0]==h[2]||u[0]==u[1]&&u[0]==u[2])){w=3*t[0];var s=a[w]-c[0];x=a[w+1]-c[1];h=a[w+2]-c[2];w=3*t[1];var v=a[w]-c[0];y=a[w+1]-c[1];u=a[w+2]-c[2];w=3*t[2];var A=a[w]-c[0];t=a[w+
1]-c[1];w=a[w+2]-c[2];var B=y*w-u*t,D=x*w-h*t,C=x*u-h*y,z=s*B-v*D+A*C;if(!(b==o3d.State.CULL_CW&&z<0||b==o3d.State.CULL_CCW&&z>0)){B=(B*g-(v*w-u*A)*j+(v*t-y*A)*d)/z;D=(-D*g+(s*w-h*A)*j-(s*t-x*A)*d)/z;C=(C*g-(s*u-h*v)*j+(s*y-x*v)*d)/z;if(B>=0&&D>=0&&C>=0&&B+D+C>0){z=B+D+C;B/=z;D/=z;C/=z;s=s*B+v*D+A*C;x=x*B+y*D+t*C;h=h*B+u*D+w*C;u=s*s+x*x+h*h;if(!e.intersected||u<p){p=u;e.position[0]=s+c[0];e.position[1]=x+c[1];e.position[2]=h+c[2];e.primitiveIndex=f}e.intersected=true}}}}return e};
o3d.Primitive.prototype.getBoundingBox=function(a){var b=[];a=this.streamBank.getVertexStream(o3d.Stream.POSITION,a).field;var c=a.buffer;c=c.array_.length/c.totalComponents;for(var d=a.getAt(0,c),e=0;e<c;++e){for(var f=[0,0,0],g=0;g<a.numComponents;++g)f[g]=d[a.numComponents*e+g];b.push(f)}o3d.BoundingBox.fitBoxToPoints_(b,this.boundingBox);return this.boundingBox};o3d.Shape=function(){o3d.ParamObject.call(this);this.elements=[]};o3d.inherit("Shape","ParamObject");o3d.Shape.prototype.elements=[];
o3d.Shape.findDrawElementWithMaterial_=function(a,b){for(var c=0;c<a.length;++c)if(a[c].material==b)return a[c];return null};o3d.Shape.prototype.createDrawElements=function(a,b){for(var c=this.elements,d=0;d<c.length;++d){var e=c[d];o3d.Shape.findDrawElementWithMaterial_(e.drawElements,b)||e.createDrawElement(a,b)}};o3d.Shape.prototype.addElement=function(a){this.elements.push(a)};o3d.Shape.prototype.removeElement=function(a){o3d.removeFromArray(this.elements,a)};
o3d.Shape.prototype.writeToDrawLists=function(a,b,c){for(var d=this.elements,e=0;e<d.length;++e)for(var f=d[e],g=0;g<f.drawElements.length;++g){this.gl.client.render_stats_.drawElementsProcessed++;for(var h=f.drawElements[g],j=(h.material||h.owner.material).drawList,i=false,k=0;k<a.length;++k){var l=a[k],m=l.list;if(j==m){var n=l.context;l=n.view;n=n.projection;var r=[[],[],[],[]],o=[[],[],[],[]];o3d.Transform.compose(n,l,o);o3d.Transform.compose(o,b,r);if(f.cull&&f.boundingBox)if(!f.boundingBox.inFrustum(r))continue;
i=true;m.list_.push({view:l,projection:n,world:b,viewProjection:o,worldViewProjection:r,transform:c,drawElement:h})}}if(i)this.gl.client.render_stats_.drawElementsRendered++;else this.gl.client.render_stats_.drawElementsCulled++}};o3d.EffectParameterInfo=function(a,b,c,d,e){this.name=a||"";this.className=b||"";this.numElements=c||0;this.semantic=d||"";this.sasClassName=e||""};o3d.inherit("EffectParameterInfo","NamedObject");
o3d.EffectStreamInfo=function(a,b){o3d.NamedObject.call(this);if(!a)a=o3d.Stream.UNKNOWN_SEMANTIC;b||(b=0);this.semantic=a;this.opt_semantic_index=b};o3d.inherit("EffectStreamInfo","NamedObject");o3d.EffectStreamInfo.prototype.semantic=o3d.Stream.UNKNOWN_SEMANTIC;o3d.EffectStreamInfo.prototype.semanticIndex=0;o3d.Effect=function(){o3d.ParamObject.call(this);this.program_=null;this.uniforms_={};this.attributes_={}};o3d.inherit("Effect","ParamObject");o3d.Effect.HELPER_CONSTANT_NAME="dx_clipping";
o3d.Effect.prototype.uniforms_={};o3d.Effect.prototype.attributes_={};o3d.Effect.prototype.vertexShaderLoaded_=false;o3d.Effect.prototype.fragmentShaderLoaded_=false;
o3d.Effect.prototype.bindAttributesAndLinkIfReady=function(){if(this.vertexShaderLoaded_&&this.fragmentShaderLoaded_){var a=o3d.Effect.semanticMap_,b;for(b in a)this.gl.bindAttribLocation(this.program_,a[b].gl_index,b);this.gl.linkProgram(this.program_);this.gl.getProgramParameter(this.program_,this.gl.LINK_STATUS)||this.gl.client.error_callback("Program link failed with error log:\n"+this.gl.getShaderInfoLog(this.program_));this.getUniforms_();this.getAttributes_()}};
o3d.Effect.prototype.loadShaderFromString=function(a,b){if(!this.program_)this.program_=this.gl.createProgram();var c=true,d=this.gl.createShader(b);this.gl.shaderSource(d,"#ifdef GL_ES\nprecision highp float;\n#endif\n"+a);this.gl.compileShader(d);if(!this.gl.getShaderParameter(d,this.gl.COMPILE_STATUS)){c=false;this.gl.client.error_callback("Shader compile failed with error log:\n"+this.gl.getShaderInfoLog(d))}this.gl.attachShader(this.program_,d);return c};
o3d.Effect.prototype.loadVertexShaderFromString=function(a){this.vertexShaderLoaded_=a=this.loadShaderFromString(a,this.gl.VERTEX_SHADER);o3d.Effect.prototype.bindAttributesAndLinkIfReady();return a};o3d.Effect.prototype.loadPixelShaderFromString=function(a){this.fragmentShaderLoaded_=a=this.loadShaderFromString(a,this.gl.FRAGMENT_SHADER);this.bindAttributesAndLinkIfReady();return a};
o3d.Effect.prototype.loadFromFXString=function(a){var b=a.indexOf("// #o3d SplitMarker");return this.loadVertexShaderFromString(a.substr(0,b))&&this.loadPixelShaderFromString(a.substr(b))};o3d.Effect.prototype.getParamArrayNames_=function(a,b){for(var c=[],d=0;d<b;d++)c[d]=a+"["+d+"]";return c};
o3d.Effect.prototype.getUniforms_=function(){this.uniforms_={};for(var a=this.gl.getProgramParameter(this.program_,this.gl.ACTIVE_UNIFORMS),b=0;b<a;++b){var c=this.gl.getActiveUniform(this.program_,b),d=c.name;if(d.indexOf("[")!=-1){d=c.name.substring(0,c.name.indexOf("["));for(var e=this.getParamArrayNames_(d,c.size),f=[],g=0;g<e.length;g++)f[g]=this.gl.getUniformLocation(this.program_,e[g]);this.uniforms_[d]={info:{name:d,size:c.size,type:c.type},kind:o3d.Effect.ARRAY,locations:f}}else this.uniforms_[d]=
{info:c,kind:o3d.Effect.ELEMENT,location:this.gl.getUniformLocation(this.program_,d)}}};o3d.Effect.prototype.getAttributes_=function(){this.attributes_={};for(var a=this.gl.getProgramParameter(this.program_,this.gl.ACTIVE_ATTRIBUTES),b=0;b<a;++b){var c=this.gl.getActiveAttrib(this.program_,b);this.attributes_[c.name]={info:c,location:this.gl.getAttribLocation(this.program_,c.name)}}};o3d.Effect.paramTypes_=null;
o3d.Effect.getParamTypes_=function(a){if(!o3d.Effect.paramTypes_){o3d.Effect.paramTypes_={};o3d.Effect.paramTypes_[a.FLOAT]="ParamFloat";o3d.Effect.paramTypes_[a.FLOAT_VEC2]="ParamFloat2";o3d.Effect.paramTypes_[a.FLOAT_VEC3]="ParamFloat3";o3d.Effect.paramTypes_[a.FLOAT_VEC4]="ParamFloat4";o3d.Effect.paramTypes_[a.INT]="ParamInteger";o3d.Effect.paramTypes_[a.BOOL]="ParamBoolean";o3d.Effect.paramTypes_[a.FLOAT_MAT4]="ParamMatrix4";o3d.Effect.paramTypes_[a.SAMPLER_2D]="ParamSampler";o3d.Effect.paramTypes_[a.SAMPLER_CUBE]=
"ParamSampler"}return o3d.Effect.paramTypes_};
o3d.Effect.semanticMap_={position:{semantic:o3d.Stream.POSITION,index:0,gl_index:0},normal:{semantic:o3d.Stream.NORMAL,index:0,gl_index:1},tangent:{semantic:o3d.Stream.TANGENT,index:0,gl_index:2},binormal:{semantic:o3d.Stream.BINORMAL,index:0,gl_index:3},color:{semantic:o3d.Stream.COLOR,index:0,gl_index:4},texCoord0:{semantic:o3d.Stream.TEXCOORD,index:0,gl_index:5},texCoord1:{semantic:o3d.Stream.TEXCOORD,index:1,gl_index:6},texCoord2:{semantic:o3d.Stream.TEXCOORD,index:2,gl_index:7},texCoord3:{semantic:o3d.Stream.TEXCOORD,
index:3,gl_index:8},texCoord4:{semantic:o3d.Stream.TEXCOORD,index:4,gl_index:9},texCoord5:{semantic:o3d.Stream.TEXCOORD,index:5,gl_index:10},texCoord6:{semantic:o3d.Stream.TEXCOORD,index:6,gl_index:11},texCoord7:{semantic:o3d.Stream.TEXCOORD,index:7,gl_index:12},influenceWeights:{semantic:o3d.Stream.INFLUENCE_WEIGHTS,index:0,gl_index:13},influenceIndices:{semantic:o3d.Stream.INFLUENCE_INDICES,index:0,gl_index:14}};o3d.Effect.reverseSemanticMap_=[];
(function(){var a=o3d.Effect.reverseSemanticMap_,b;for(b in o3d.Effect.semanticMap_){var c=o3d.Effect.semanticMap_[b];a[c.semantic]=a[c.semantic]||[];a[c.semantic][c.index]=c.gl_index}})();
o3d.Effect.prototype.createUniformParameters=function(a){var b=o3d.Param.sasTypes_,c=o3d.Effect.getParamTypes_(this.gl),d;for(d in this.uniforms_){var e=this.uniforms_[d];if(!b[d])switch(e.kind){case o3d.Effect.ARRAY:var f=a.createParam(d,"ParamParamArray"),g=new o3d.ParamArray;g.gl=this.gl;g.resize(e.info.size,c[e.info.type]);f.value=g;break;case o3d.Effect.STRUCT:o3d.notImplemented();break;default:a.createParam(d,c[e.info.type])}}};
o3d.Effect.prototype.createSASParameters=function(a){var b=o3d.Param.sasTypes_,c;for(c in this.uniforms_){var d=this.uniforms_[c].info,e=b[c];e&&a.createParam(d.name,e)}};o3d.Effect.prototype.getParameterInfo=function(){var a=[],b=o3d.Param.sasTypes_,c=o3d.Effect.semanticMap_,d=o3d.Effect.getParamTypes_(this.gl),e;for(e in this.uniforms_){var f=this.uniforms_[e],g=b[e]||"";a.push(new o3d.EffectParameterInfo(e,d[f.info.type]||"",f.kind==o3d.Effect.ARRAY?f.info.size:0,(c[e]?e:"").toUpperCase(),g))}return a};
o3d.Effect.prototype.getStreamInfo=function(){var a=[],b;for(b in this.attributes_){var c=o3d.Effect.semanticMap_[b];a.push(new o3d.EffectStreamInfo(c.semantic,c.index))}return a};
o3d.Effect.prototype.searchForParams_=function(a){var b={},c;for(c in this.uniforms_)b[c]=true;this.gl.useProgram(this.program_);o3d.Param.texture_index_=0;c=a.length;for(var d=0;d<c;++d){var e=a[d],f;for(f in this.uniforms_)if(b[f]){var g=this.uniforms_[f],h=e.getParam(f);if(h){g.kind==o3d.Effect.ARRAY?h.applyToLocations(this.gl,g.locations):h.applyToLocation(this.gl,g.location);delete b[f]}}}this.updateHelperConstants_(this.gl.displayInfo.width,this.gl.displayInfo.height);delete b[o3d.Effect.HELPER_CONSTANT_NAME];
for(f in b)if(this.uniforms_[f].info.type==this.gl.SAMPLER_2D){this.gl.client.reportErrors_()&&this.gl.client.error_callback("Missing ParamSampler");a=o3d.ParamSampler.defaultParamSampler_;a.gl=this.gl;a.applyToLocation(this.gl,this.uniforms_[f].location)}else throw'Uniform param not filled: "'+f+'"';};
o3d.Effect.prototype.updateHelperConstants_=function(a,b){var c=this.uniforms_[o3d.Effect.HELPER_CONSTANT_NAME],d=[0,0,0,0];if(c){d[0]=1/a;d[1]=-1/b;d[2]=2;d[3]=this.gl.currentRenderSurfaceSet?-1:1;this.gl.uniform4f(c.location,d[0],d[1],d[2],d[3])}};o3d.Effect.MatrixLoadOrder=goog.typedef;o3d.Effect.ROW_MAJOR=0;o3d.Effect.COLUMN_MAJOR=1;o3d.Effect.ELEMENT=0;o3d.Effect.ARRAY=1;o3d.Effect.STRUCT=2;o3d.Effect.prototype.matrix_load_order_=o3d.Effect.ROW_MAJOR;o3d.Effect.prototype.source_="";
o3d.Material=function(a,b,c){o3d.ParamObject.call(this);this.state=a||null;this.effect=b||null;this.drawList=c||null};o3d.inherit("Material","ParamObject");o3d.ParamObject.setUpO3DParam_(o3d.Material,"effect","ParamEffect");o3d.ParamObject.setUpO3DParam_(o3d.Material,"state","ParamState");o3d.ParamObject.setUpO3DParam_(o3d.Material,"drawList","ParamDrawList");if(!this.JSON)this.JSON={};
(function(){function a(i){return i<10?"0"+i:i}function b(i){e.lastIndex=0;return e.test(i)?'"'+i.replace(e,function(k){var l=h[k];return typeof l==="string"?l:"\\u"+("0000"+k.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+i+'"'}function c(i,k){var l,m,n,r,o=f,q,p=k[i];if(p&&typeof p==="object"&&typeof p.toJSON==="function")p=p.toJSON(i);if(typeof j==="function")p=j.call(k,i,p);switch(typeof p){case "string":return b(p);case "number":return isFinite(p)?String(p):"null";case "boolean":case "null":return String(p);
case "object":if(!p)return"null";f+=g;q=[];if(Object.prototype.toString.apply(p)==="[object Array]"){r=p.length;for(l=0;l<r;l+=1)q[l]=c(l,p)||"null";n=q.length===0?"[]":f?"[\n"+f+q.join(",\n"+f)+"\n"+o+"]":"["+q.join(",")+"]";f=o;return n}if(j&&typeof j==="object"){r=j.length;for(l=0;l<r;l+=1){m=j[l];if(typeof m==="string")if(n=c(m,p))q.push(b(m)+(f?": ":":")+n)}}else for(m in p)if(Object.hasOwnProperty.call(p,m))if(n=c(m,p))q.push(b(m)+(f?": ":":")+n);n=q.length===0?"{}":f?"{\n"+f+q.join(",\n"+f)+
"\n"+o+"}":"{"+q.join(",")+"}";f=o;return n}}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+a(this.getUTCMonth()+1)+"-"+a(this.getUTCDate())+"T"+a(this.getUTCHours())+":"+a(this.getUTCMinutes())+":"+a(this.getUTCSeconds())+"Z":null};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()}}var d=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
e=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,f,g,h={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},j;if(typeof JSON.stringify!=="function")JSON.stringify=function(i,k,l){var m;g=f="";if(typeof l==="number")for(m=0;m<l;m+=1)g+=" ";else if(typeof l==="string")g=l;if((j=k)&&typeof k!=="function"&&(typeof k!=="object"||typeof k.length!=="number"))throw Error("JSON.stringify");return c("",
{"":i})};if(typeof JSON.parse!=="function")JSON.parse=function(i,k){function l(n,r){var o,q,p=n[r];if(p&&typeof p==="object")for(o in p)if(Object.hasOwnProperty.call(p,o)){q=l(p,o);if(q!==undefined)p[o]=q;else delete p[o]}return k.call(n,r,p)}var m;i=String(i);d.lastIndex=0;if(d.test(i))i=i.replace(d,function(n){return"\\u"+("0000"+n.charCodeAt(0).toString(16)).slice(-4)});if(/^[\],:{}\s]*$/.test(i.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,
"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){m=eval("("+i+")");return typeof k==="function"?l({"":m},""):m}throw new SyntaxError("JSON.parse");}})();o3d.ArchiveRequest=function(){o3d.ObjectBase.call(this);this.method_=null};o3d.inherit("ArchiveRequest","ObjectBase");o3d.ArchiveRequest.prototype.uri="";o3d.ArchiveRequest.prototype.open=function(a,b){var c=this.uri=b,d=b.lastIndexOf("/");if(d!=-1)c=c.substring(0,d+1);this.parentURI_=c};
o3d.ArchiveRequest.prototype.send=function(){var a=this;this.done=false;this.success=true;this.error=null;o3djs.io.loadTextFile(this.uri,function(b,c){var d=JSON.stringify(JSON.parse(b)),e=new o3d.RawData;e.uri="scene.json";e.stringValue=d;var f=/\"([^\"]*\.(fx|png|jpg))\"/g,g;for(d=[];(g=f.exec(b))!=null;)d.push(g[1]);a.pendingRequests_=d.length+1;for(f=0;f<d.length;++f)if(a.stringEndsWith_(d[f],".fx")){g=function(h){o3djs.io.loadTextFile(a.relativeToAbsoluteURI_(h),function(j,i){var k=null;if(i==
null){k=new o3d.RawData;k.uri=h;k.stringValue=j}a.resolvePendingRequest_(k,i)})};g(d[f])}else if(a.stringEndsWith_(d[f],".png")||a.stringEndsWith_(d[f],".jpg")){g=function(h){var j=new Image;j.onload=function(){var i=new o3d.RawData;i.uri=h;i.image_=j;a.resolvePendingRequest_(i,c)};j.onerror=function(){a.resolvePendingRequest_(null,c)};j.src=a.relativeToAbsoluteURI_(h)};g(d[f])}a.resolvePendingRequest_(e)})};o3d.ArchiveRequest.prototype.onreadystatechange=null;
o3d.ArchiveRequest.prototype.onfileavailable=null;o3d.ArchiveRequest.prototype.relativeToAbsoluteURI_=function(a){return this.parentURI_+a};o3d.ArchiveRequest.prototype.stringEndsWith_=function(a,b){return a.substring(a.length-b.length)==b};o3d.ArchiveRequest.prototype.resolvePendingRequest_=function(a,b){this.success=this.success&&a&&!b;if(b!=null)this.error=""+b;if(a&&this.onfileavailable)this.onfileavailable(a);if(--this.pendingRequests_==0){this.done=true;if(this.onreadystatechange)this.onreadystatechange()}};
o3d.ParamFloatOutput=function(){o3d.ParamFloat.call(this)};o3d.inherit("ParamFloatOutput","ParamFloat");o3d.ParamFloatOutput.prototype.__defineGetter__("value",function(){return this.owner_.updateOutputs()});o3d.ParamFloatOutput.prototype.__defineSetter__("value",function(){});o3d.ParamFloat2Output=function(){o3d.ParamFloat2.call(this)};o3d.inherit("ParamFloat2Output","ParamFloat2");o3d.ParamFloat2Output.prototype.__defineGetter__("value",function(){return this.owner_.updateOutputs()});
o3d.ParamFloat2Output.prototype.__defineSetter__("value",function(){});o3d.ParamFloat3Output=function(){o3d.ParamFloat3.call(this)};o3d.inherit("ParamFloat3Output","ParamFloat3");o3d.ParamFloat3Output.prototype.__defineGetter__("value",function(){return this.owner_.updateOutputs()});o3d.ParamFloat3Output.prototype.__defineSetter__("value",function(){});o3d.ParamFloat4Output=function(){o3d.ParamFloat4.call(this)};o3d.inherit("ParamFloat4Output","ParamFloat4");
o3d.ParamFloat4Output.prototype.__defineGetter__("value",function(){return this.owner_.updateOutputs()});o3d.ParamFloat4Output.prototype.__defineSetter__("value",function(){});o3d.ParamMatrix4Output=function(){o3d.ParamMatrix4.call(this)};o3d.inherit("ParamMatrix4Output","ParamMatrix4");o3d.ParamMatrix4Output.prototype.__defineGetter__("value",function(){return this.owner_.updateOutputs()});o3d.ParamMatrix4Output.prototype.__defineSetter__("value",function(){});
o3d.ParamOp2FloatsToFloat2=function(){o3d.ParamObject.call(this);this.last_output_value_=[0,0]};o3d.inherit("ParamOp2FloatsToFloat2","ParamObject");(function(){for(var a=0;a<2;a++)o3d.ParamObject.setUpO3DParam_(o3d.ParamOp2FloatsToFloat2,"input"+a,"ParamFloat");o3d.ParamObject.setUpO3DParam_(o3d.ParamOp2FloatsToFloat2,"output","ParamMatrix4Output")})();
o3d.ParamOp2FloatsToFloat2.prototype.updateOutputs=function(){this.last_output_value_[0]=this.getParam("input0").value;this.last_output_value_[1]=this.getParam("input1").value;return this.last_output_value_};o3d.ParamOp3FloatsToFloat3=function(){o3d.ParamObject.call(this);this.last_output_value_=[0,0,0]};o3d.inherit("ParamOp3FloatsToFloat3","ParamObject");
(function(){for(var a=0;a<3;a++)o3d.ParamObject.setUpO3DParam_(o3d.ParamOp3FloatsToFloat3,"input"+a,"ParamFloat");o3d.ParamObject.setUpO3DParam_(o3d.ParamOp3FloatsToFloat3,"output","ParamMatrix4Output")})();o3d.ParamOp3FloatsToFloat3.prototype.updateOutputs=function(){this.last_output_value_[0]=this.getParam("input0").value;this.last_output_value_[1]=this.getParam("input1").value;this.last_output_value_[2]=this.getParam("input2").value;return this.last_output_value_};
o3d.ParamOp4FloatsToFloat4=function(){o3d.ParamObject.call(this);this.last_output_value_=[0,0,0,0]};o3d.inherit("ParamOp4FloatsToFloat4","ParamObject");(function(){for(var a=0;a<4;a++)o3d.ParamObject.setUpO3DParam_(o3d.ParamOp4FloatsToFloat4,"input"+a,"ParamFloat");o3d.ParamObject.setUpO3DParam_(o3d.ParamOp4FloatsToFloat4,"output","ParamMatrix4Output")})();
o3d.ParamOp4FloatsToFloat4.prototype.updateOutputs=function(){this.last_output_value_[0]=this.getParam("input0").value;this.last_output_value_[1]=this.getParam("input1").value;this.last_output_value_[2]=this.getParam("input2").value;this.last_output_value_[3]=this.getParam("input3").value;return this.last_output_value_};o3d.ParamOp16FloatsToMatrix4=function(){o3d.ParamObject.call(this);this.last_output_value_=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]]};o3d.inherit("ParamOp16FloatsToMatrix4","ParamObject");
(function(){for(var a=0;a<16;a++)o3d.ParamObject.setUpO3DParam_(o3d.ParamOp16FloatsToMatrix4,"input"+a,"ParamFloat");o3d.ParamObject.setUpO3DParam_(o3d.ParamOp16FloatsToMatrix4,"output","ParamMatrix4Output")})();o3d.ParamOp16FloatsToMatrix4.prototype.updateOutputs=function(){for(var a=0;a<16;a++)this.last_output_value_[Math.floor(a/4)][a%4]=this.getParam("input"+a).value;return this.last_output_value_};
o3d.TRSToMatrix4=function(){o3d.ParamObject.call(this);this.translateZ=this.translateY=this.translateX=this.rotateZ=this.rotateY=this.rotateX=0;this.scaleZ=this.scaleY=this.scaleX=1;this.last_output_value_=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]]};o3d.inherit("TRSToMatrix4","ParamObject");
(function(){for(var a=["rotateX","rotateY","rotateZ","translateX","translateY","translateZ","scaleX","scaleY","scaleZ"],b=0;b<a.length;b++)o3d.ParamObject.setUpO3DParam_(o3d.TRSToMatrix4,a[b],"ParamFloat");o3d.ParamObject.setUpO3DParam_(o3d.TRSToMatrix4,"output","ParamMatrix4Output")})();
o3d.TRSToMatrix4.prototype.updateOutputs=function(){var a=this.last_output_value_,b=this.rotateX,c=this.rotateY,d=this.rotateZ,e=this.scaleX,f=this.scaleY,g=this.scaleZ,h=Math.sin(b);b=Math.cos(b);var j=Math.sin(c);c=Math.cos(c);var i=Math.sin(d);d=Math.cos(d);var k=d*j,l=i*j;a[0].splice(0,4,d*c*e,i*c*e,-j*e,0);a[1].splice(0,4,(k*h-i*b)*f,(l*h+d*b)*f,c*h*f,0);a[2].splice(0,4,(k*b+i*h)*g,(l*b-d*h)*g,c*b*g,0);a[3].splice(0,4,this.translateX,this.translateY,this.translateZ,1);return a};
o3d.Matrix4Composition=function(){o3d.ParamObject.call(this);this.last_output_value_=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]]};o3d.inherit("Matrix4Composition","ParamObject");o3d.ParamObject.setUpO3DParam_(o3d.Matrix4Composition,"inputMatrix","ParamMatrix4");o3d.ParamObject.setUpO3DParam_(o3d.Matrix4Composition,"localMatrix","ParamMatrix4");o3d.ParamObject.setUpO3DParam_(o3d.Matrix4Composition,"outputMatrix","ParamMatrix4Output");
o3d.Matrix4Composition.prototype.updateOutputs=function(){var a=this.getParam("inputMatrix").value,b=this.getParam("localMatrix").value;o3d.Transform.compose(a,b,this.last_output_value_);return this.last_output_value_};o3d.Matrix4AxisRotation=function(){o3d.ParamObject.call(this);this.last_output_value_=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]]};o3d.inherit("Matrix4AxisRotation","ParamObject");o3d.ParamObject.setUpO3DParam_(o3d.Matrix4AxisRotation,"inputMatrix","ParamMatrix4");
o3d.ParamObject.setUpO3DParam_(o3d.Matrix4AxisRotation,"axis","ParamFloat3");o3d.ParamObject.setUpO3DParam_(o3d.Matrix4AxisRotation,"angle","ParamFloat");o3d.ParamObject.setUpO3DParam_(o3d.Matrix4AxisRotation,"outputMatrix","ParamMatrix4Output");o3d.Matrix4AxisRotation.prototype.updateOutputs=function(){var a=this.getParam("inputMatrix").value,b=this.getParam("axis").value,c=this.getParam("angle").value;o3d.Transform.axisRotateMatrix(a,b,c,this.last_output_value_);return this.last_output_value_};
o3d.Matrix4Scale=function(){o3d.ParamObject.call(this);this.last_output_value_=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]]};o3d.inherit("Matrix4Scale","ParamObject");o3d.ParamObject.setUpO3DParam_(o3d.Matrix4Scale,"inputMatrix","ParamMatrix4");o3d.ParamObject.setUpO3DParam_(o3d.Matrix4Scale,"scale","ParamFloat3");o3d.ParamObject.setUpO3DParam_(o3d.Matrix4Scale,"outputMatrix","ParamMatrix4Output");
o3d.Matrix4Scale.prototype.updateOutputs=function(){var a=this.getParam("inputMatrix").value,b=this.last_output_value_,c=this.getParam("scale").value,d=c[0],e=c[1];c=c[2];var f=a[0],g=a[1],h=a[2];a=a[3];b[0].splice(0,4,d*f[0],d*f[1],d*f[2],d*f[3]);b[1].splice(0,4,e*g[0],e*g[1],e*g[2],e*g[3]);b[2].splice(0,4,c*h[0],c*h[1],c*h[2],c*h[3]);b[3]=a.slice(0);return b};o3d.Matrix4Translation=function(){o3d.ParamObject.call(this);this.last_output_value_=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]]};
o3d.inherit("Matrix4Translation","ParamObject");o3d.ParamObject.setUpO3DParam_(o3d.Matrix4Translation,"inputMatrix","ParamMatrix4");o3d.ParamObject.setUpO3DParam_(o3d.Matrix4Translation,"translation","ParamFloat3");o3d.ParamObject.setUpO3DParam_(o3d.Matrix4Translation,"outputMatrix","ParamMatrix4Output");
o3d.Matrix4Translation.prototype.updateOutputs=function(){var a=this.getParam("inputMatrix").value,b=this.last_output_value_,c=this.getParam("translation").value,d=c[0],e=c[1];c=c[2];var f=a[0],g=a[1],h=a[2];a=a[3];b[0]=f.slice(0);b[1]=g.slice(0);b[2]=h.slice(0);b[3].splice(0,4,f[0]*d+g[0]*e+h[0]*c+a[0],f[1]*d+g[1]*e+h[1]*c+a[1],f[2]*d+g[2]*e+h[2]*c+a[2],f[3]*d+g[3]*e+h[3]*c+a[3]);return b};o3d.Function=function(a){o3d.NamedObject.call(this);this.func_=a};o3d.inherit("Function","NamedObject");
o3d.Function.prototype.evaluate=function(a,b){this.func_.call(this,a,b)};o3d.FunctionEval=function(){o3d.ParamObject.call(this);this.input_param_=this.getParam("input");this.func_param_=this.getParam("functionObject");this.output_param_=this.getParam("output");this.func_context_={};this.last_output_value_=this.last_input_value_=null};o3d.inherit("FunctionEval","ParamObject");o3d.ParamObject.setUpO3DParam_(o3d.FunctionEval,"output","ParamFloatOutput");
o3d.ParamObject.setUpO3DParam_(o3d.FunctionEval,"input","ParamFloat");o3d.ParamObject.setUpO3DParam_(o3d.FunctionEval,"functionObject","ParamFunction");o3d.FunctionEval.prototype.updateOutputs=function(){var a=this.input_param_.value;if(this.last_input_value_!=a){this.last_output_value_=this.func_param_.value.evaluate(this.last_input_value_,this.func_context_);this.last_input_value_=a}return this.last_output_value_};o3d.CounterManager=function(){this.counterMap_={}};
o3d.CounterManager.prototype.lastUpdated=null;o3d.CounterManager.prototype.advanceCounters=function(a,b){var c=this.counterMap_[a];if(c){for(var d=c.length,e=[],f=0;f<d;f++)e[f]=c[f];for(f=0;f<d;++f)e[f].running&&e[f].advance(b)}};o3d.CounterManager.prototype.tick=function(){this.advanceCounters("TickCounter",1);var a=new Date,b=0;if(this.lastUpdated!=null)b=(a-this.lastUpdated)/1E3;this.lastUpdated=a;this.advanceCounters("SecondCounter",b)};
o3d.CounterManager.prototype.advanceRenderFrameCounters=function(){this.advanceCounters("RenderFrameCounter",1)};o3d.CounterManager.prototype.registerCounter=function(a){var b=a.counter_type_,c=this.counterMap_[b];c||(c=this.counterMap_[b]=[]);c.push(a)};o3d.CounterManager.prototype.unregisterCounter=function(a){var b=this.counterMap_[a.counter_type_];b&&o3d.removeFromArray(b,a)};
o3d.Counter=function(){o3d.ParamObject.call(this);this.prev_callback_=this.next_callback_=-1;this.last_call_callbacks_end_count_=this.old_count_=0;this.callbacks_=[];this.counter_manager_=null;this.running_param_=this.createParam("running","ParamBoolean");this.count_param_=this.createParam("count","ParamFloat");this.multiplier=1;this.forward=true;this.countMode=o3d.Counter.CONTINUOUS};o3d.inherit("Counter","ParamObject");o3d.ParamObject.setUpO3DParam_(o3d.Counter,"forward","ParamBoolean");
o3d.ParamObject.setUpO3DParam_(o3d.Counter,"start","ParamFloat");o3d.ParamObject.setUpO3DParam_(o3d.Counter,"end","ParamFloat");o3d.ParamObject.setUpO3DParam_(o3d.Counter,"countMode","ParamInteger");o3d.ParamObject.setUpO3DParam_(o3d.Counter,"multiplier","ParamFloat");
o3d.Counter.prototype.__defineSetter__("running",function(a){var b=this.running_param_.value;if(this.counter_manager_&&b!=a)a==false?this.counter_manager_.unregisterCounter(this):this.counter_manager_.registerCounter(this);this.running_param_.value=a});o3d.Counter.prototype.__defineGetter__("running",function(){return this.running_param_.value});o3d.Counter.prototype.__defineSetter__("count",function(a){this.setCount(a)});o3d.Counter.prototype.__defineGetter__("count",function(){return this.count_param_.value});
o3d.Counter.prototype.__defineSetter__("gl",function(a){var b=this.running;this.running=false;if((this.gl_=a)&&this.gl_.client)this.counter_manager_=this.gl_.client.counter_manager_;this.running=b});o3d.Counter.prototype.__defineGetter__("gl",function(){return this.gl_});o3d.Counter.CountMode=goog.typedef;o3d.Counter.CONTINUOUS=0;o3d.Counter.ONCE=1;o3d.Counter.CYCLE=2;o3d.Counter.OSCILLATE=3;o3d.Counter.prototype.counter_type_="Counter";
o3d.Counter.prototype.reset=function(){this.setCount(this.forward?this.start:this.end)};o3d.Counter.prototype.setCount=function(a){this.old_count_=this.count_param_.value=a;this.prev_callback_=this.next_callback_=-1};
o3d.Counter.prototype.advance=function(a){var b=[],c=this.count_param_.value;if(this.count_param_.inputConnection)this.callCallbacks_(this.old_count_,c,b);else{var d=this.forward,e=this.start,f=this.end;a=(d?a:-a)*this.multiplier;var g=f-e,h=this.countMode;if(g>=0){var j=c+a;if(a>=0){switch(h){case o3d.Counter.ONCE:if(j>=f){j=f;this.running=false}break;case o3d.Counter.CYCLE:for(;j>=f;){this.callCallbacks_(c,f,b);if(g==0)break;c=e;j-=g}break;case o3d.Counter.OSCILLATE:for(;a>0;){j=c+a;if(j<f)break;
this.callCallbacks_(c,f,b);d=!d;c=f-c;a-=c;j=c=f;if(a<=0||g==0)break;j-=a;if(j>e)break;this.callCallbacks_(c,e,b);d=!d;c-=e;a-=c;j=c=e}this.forward=d}this.callCallbacks_(c,j,b);this.count_param_.value=j}else if(a<0){switch(h){case o3d.Counter.ONCE:if(j<=e){j=e;this.running=false}break;case o3d.Counter.CYCLE:for(;j<=e;){this.callCallbacks_(c,e,b);if(g==0)break;c=f;j+=g}break;case o3d.Counter.OSCILLATE:for(;a<0;){j=c+a;if(j>e)break;this.callCallbacks_(c,e,b);d=!d;c-=e;a+=c;j=c=e;if(a>=0||g==0)break;
j-=a;if(j<f)break;this.callCallbacks_(c,f,b);d=!d;c=f-c;a+=c;j=c=f}this.forward=d}this.callCallbacks_(c,j,b);this.count_param_.value=j}}else if(g<0){g=-g;j=c-a;if(a>0){switch(h){case o3d.Counter.ONCE:if(j<=f){j=f;this.running=false}break;case o3d.Counter.CYCLE:for(;j<=f;){this.callCallbacks_(c,f,b);c=e;j+=g}break;case o3d.Counter.OSCILLATE:for(;a>0;){j=c-a;if(j>f)break;this.callCallbacks_(c,f,b);d=!d;c-=f;a-=c;j=c=f;if(a<=0)break;j+=a;if(j<e)break;this.callCallbacks_(c,e,b);d=!d;c=e-c;a-=c;j=c=e}this.forward=
d}this.callCallbacks_(c,j,b);this.count_param_.value=j}else if(a<0){switch(h){case o3d.Counter.ONCE:if(j>=e){j=e;this.running=false}break;case o3d.Counter.CYCLE:for(;j>=e;){this.callCallbacks_(c,e,b);c=f;j-=g}break;case o3d.Counter.OSCILLATE:for(;a<0;){j=c-a;if(j<e)break;this.callCallbacks_(c,e,b);d=!d;c=e-c;a+=c;j=c=e;if(a>=0)break;j+=a;if(j>f)break;this.callCallbacks_(c,f,b);d=!d;c-=f;a+=c;j=c=f}this.forward=d}this.callCallbacks_(c,j,b);this.count_param_.value=j}}}this.old_count_=c;for(d=0;d<b.length;d++)b[d]()};
o3d.Counter.prototype.callCallbacks_=function(a,b,c){if(b>a){if(this.next_callback_<0||a!=this.last_call_callbacks_end_count_)for(this.next_callback_=0;this.next_callback_!=this.callbacks_.length&&this.callbacks_[this.next_callback_].count<a;)++this.next_callback_;for(;this.next_callback_<this.callbacks_.length;){if(this.callbacks_[this.next_callback_].count>b)break;c.push(this.callbacks_[this.next_callback_].callback);++this.next_callback_}this.prev_callback_=-1;this.last_call_callbacks_end_count_=
b}else if(b<a){if(this.prev_callback_<0||a!=this.last_call_callbacks_end_count_)for(this.prev_callback_=this.callbacks_.length-1;this.prev_callback_>=0&&this.callbacks_[this.prev_callback_].count>a;)--this.prev_callback_;for(;this.prev_callback_>=0;){if(this.callbacks_[this.prev_callback_].count<b)break;c.push(this.callbacks_[this.prev_callback_].callback);--this.prev_callback_}this.next_callback_=-1;this.last_call_callbacks_end_count_=b}};
o3d.Counter.prototype.addCallback=function(a,b){this.prev_callback_=this.next_callback_=-1;for(var c=this.callbacks_.length,d=0;d!=c;){var e=this.callbacks_[d];if(e.count==a){e.callback=b;return}else if(e.count>a)break;++d}c=this.callbacks_.splice(d,this.callbacks_.length-d);this.callbacks_.push(new o3d.Counter.CallbackInfo(a,b));this.callbacks_.push.apply(this.callbacks_,c)};
o3d.Counter.prototype.removeCallback=function(a){for(var b=this.callbacks_.length,c=0;c!=b;++c)if(this.callbacks_[c].count==a){this.prev_callback_=this.next_callback_=-1;this.callbacks_.splice(c,1);return true}return false};o3d.Counter.prototype.removeAllCallbacks=function(){this.callbacks_=[];this.prev_callback_=this.next_callback_=-1};o3d.Counter.CallbackInfo=function(a,b){this.count=a;this.callback=b;this.called_=false};
o3d.Counter.CallbackInfo.prototype.run=function(){if(!this.called_){this.called_=true;this.callback();this.called_=false}};o3d.SecondCounter=function(){o3d.Counter.call(this);this.running=true};o3d.inherit("SecondCounter","Counter");o3d.SecondCounter.prototype.counter_type_="SecondCounter";o3d.RenderFrameCounter=function(){o3d.Counter.call(this);this.running=true};o3d.inherit("RenderFrameCounter","Counter");o3d.RenderFrameCounter.prototype.counter_type_="RenderFrameCounter";
o3d.TickCounter=function(){o3d.Counter.call(this);this.running=true};o3d.inherit("TickCounter","Counter");o3d.TickCounter.prototype.counter_type_="TickCounter";o3d.CurveKey=function(a){o3d.ObjectBase.call(this);this.owner_=a;this.output_=this.input_=0};o3d.inherit("CurveKey","ObjectBase");o3d.CurveKey.prototype.destroy=function(){o3d.removeFromArray(this.owner_.keys,this);this.owner_.invalidateCache_()};
o3d.CurveKey.prototype.getOutputAtOffset=function(a,b){return this.output+a/(b.input-this.input)*(b.output-this.output)};o3d.CurveKey.prototype.__defineGetter__("input",function(){return this.input_});o3d.CurveKey.prototype.__defineSetter__("input",function(a){if(a!=this.input_){this.input_=a;this.owner_.invalidateCache_()}});o3d.CurveKey.prototype.__defineGetter__("output",function(){return this.output_});
o3d.CurveKey.prototype.__defineSetter__("output",function(a){if(a!=this.output_){this.output_=a;this.owner_.invalidateCache_()}});o3d.StepCurveKey=function(a){o3d.CurveKey.call(this,a);a.num_step_keys_++};o3d.inherit("StepCurveKey","CurveKey");o3d.StepCurveKey.prototype.getOutputAtOffset=function(){return this.output};o3d.StepCurveKey.prototype.destroy=function(){o3d.CurveKey.prototype.destroy.call(this);this.owner_.num_step_keys_--};o3d.LinearCurveKey=function(a){o3d.CurveKey.call(this,a)};
o3d.inherit("LinearCurveKey","CurveKey");o3d.BezierCurveKey=function(a){o3d.CurveKey.call(this,a);this.in_tangent_=[0,0];this.out_tangent_=[0,0]};o3d.inherit("BezierCurveKey","CurveKey");o3d.BezierCurveKey.prototype.__defineGetter__("inTangent",function(){return this.in_tangent_});o3d.BezierCurveKey.prototype.__defineSetter__("inTangent",function(a){if(a!=this.in_tangent_){this.in_tangent_=a;this.owner_.invalidateCache_()}});o3d.BezierCurveKey.prototype.__defineGetter__("outTangent",function(){return this.out_tangent_});
o3d.BezierCurveKey.prototype.__defineSetter__("outTangent",function(a){if(a!=this.out_tangent_){this.out_tangent_=a;this.owner_.invalidateCache_()}});o3d.BezierCurveKey.findT_=function(a,b,c,d,e,f){var g=1,h=0,j=0.5;j=f<=0.1?0.1:f>=0.9?0.9:f;for(f=true;g-h>0.001;){if(f)f=false;else j=(g-h)/2+h;var i=1-j;i=a*i*i*i+3*b*j*i*i+3*c*j*j*i+d*j*j*j;if(Math.abs(i-e)<=0.001)break;if(i>e)g=j;else h=j}return j};
o3d.BezierCurveKey.prototype.getOutputAtOffset=function(a,b){var c=b.input-this.input,d=b.output-this.output;d=b.inTangent?b.inTangent:[b.input-c/3,b.output-d/3];c=o3d.BezierCurveKey.findT_(this.input,this.outTangent[0],d[0],b.input,this.input+a,a/c);var e=1-c;return this.output*e*e*e+3*this.outTangent[1]*e*e*c+3*d[1]*e*c*c+b.output*c*c*c};
o3d.Curve=function(){o3d.Function.call(this,this.evaluate);this.postInfinity=this.preInfinity=o3d.Curve.CONSTANT;this.useCache=true;this.sample_rate_=o3d.Curve.kDefaultSampleRate;this.keys=[];this.sorted_=true;this.discontinuous_=this.check_discontinuity_=false;this.num_step_keys_=0};o3d.inherit("Curve","Function");o3d.Curve.kMinimumSampleRate=1/240;o3d.Curve.kDefaultSampleRate=1/30;o3d.Curve.prototype.__defineGetter__("sampleRate",function(){return this.sample_rate_});
o3d.Curve.prototype.__defineSetter__("sampleRate",function(a){if(a<o3d.Curve.kMinimumSampleRate){a=o3d.Curve.kMinimumSampleRate;this.gl.client.error_callback("attempt to set sample rate to "+a+" which is lower than the minimum of "+o3d.Curve.kMinimumSampleRate)}else if(a!=this.sample_rate_){this.sample_rate_=a;this.invalidateCache_()}});o3d.Curve.Infinity=goog.typedef;o3d.Curve.CONSTANT=0;o3d.Curve.LINEAR=1;o3d.Curve.CYCLE=2;o3d.Curve.CYCLE_RELATIVE=3;o3d.Curve.OSCILLATE=4;
o3d.Curve.prototype.set=function(){o3d.notImplemented()};o3d.Curve.prototype.createKey=function(a){a=new o3d[a](this);this.keys.push(a);return a};o3d.Curve.prototype.addLinearKeys=function(a){if(a.length%2!=0)this.gl.client.error_callback("addLinearKeys: expected multiple of 2 values got "+a.size());else{for(var b=0;b<a.length;b+=2){var c=this.createKey("LinearCurveKey");c.input=a[b];c.output=a[b+1]}this.sorted_=false}};
o3d.Curve.prototype.addStepKeys=function(a){if(a.length%2!=0)this.gl.client.error_callback("addStepKeys: expected multiple of 2 values got "+a.size());else{for(var b=0;b<a.length;b+=2){var c=this.createKey("StepCurveKey");c.input=a[b];c.output=a[b+1]}this.sorted_=false}};
o3d.Curve.prototype.addBezierKeys=function(a){if(a.length%6!=0)this.gl.client.error_callback("addBezierKeys: expected multiple of 6 values got "+a.size());else{for(var b=0;b<a.length;b+=6){var c=this.createKey("BezierCurveKey");c.input=a[b];c.output=a[b+1];c.inTangent[0]=a[b+2];c.inTangent[1]=a[b+3];c.outTangent[0]=a[b+4];c.outTangent[1]=a[b+5]}this.sorted_=false}};o3d.Curve.prototype.invalidateCache_=function(){this.check_valid_=false;this.check_discontinuity_=true};
o3d.Curve.prototype.isDiscontinuous=function(){this.updateCurveInfo_();return this.discontinuous_};o3d.Curve.compareInputs_=function(a,b){return a.input-b.input};
o3d.Curve.prototype.updateCurveInfo_=function(){if(!this.sorted_){this.keys.sort(o3d.Curve.compareInputs_);this.sorted_=true;this.invalidateCache_()}if(this.check_discontinuity_){this.check_discontinuity_=false;var a=this.keys.length;this.discontinuous_=this.num_step_keys_>0&&this.num_step_keys_!=a;if(!this.discontinuous_&&a>1)for(var b=0;b<a-1;++b)if(this.keys[b].input==this.keys[b+1].input&&this.keys[b].output!=this.keys[b+1].output){this.discontinuous_=true;break}}};
o3d.Curve.prototype.getOutputInSpan_=function(a,b){var c=this.keys,d=c.length;if(a<c[0].input){this.gl.client.error_callback("Curve.getOutputInSpan_: input is lower than any key");return 0}if(a>=c[d-1].input)return c[d-1].output;var e=0,f=d,g,h=false;if(b){g=b.curve_last_key_index_;if(g<f-1)if(c[g].input<=a&&c[g+1].input>a)h=true;else if(a>c[g].input){var j=g+3;if(j>f)j=f;for(++g;g<j;++g)if(c[g].input<=a&&c[g+1].input>a){h=true;break}}else if(g>0){j=g-3;if(j<0)j=0;for(--g;g>=j;--g)if(c[g].input<=
a&&c[g+1].input>a){h=true;break}}}if(!h){for(;e<=f;){g=Math.floor((e+f)/2);if(a>c[g].input)e=g+1;else{if(g==0)break;f=g-1}}for(f=d;e<f;){if(c[e].input>a)break;++e}if(e<=0||e>=f)this.gl.client.error_callback("Curve.getOutputInSpan_: start is outside range.");g=e-1}e=c[g];if(b)b.curve_last_key_index_=g;if(g+1>=d||!c[g+1]){this.gl.client.error_callback("Curve.getOutputInSpan_: next key is null: index is "+g+"; size is "+d);return e.output}else return e.getOutputAtOffset(a-e.input,c[g+1])};
o3d.Curve.prototype.evaluate=function(a,b){var c=this.keys,d=c.length;if(d==0)return 0;if(d==1)return c[0].output;this.updateCurveInfo_();var e=c[0].input,f=c[d-1].input,g=f-e,h=c[0].output,j=c[d-1].output,i=j-h,k=0;if(a<e){if(g<=0)return h;d=e-a;switch(this.preInfinity){case o3d.Curve.CONSTANT:return h;case o3d.Curve.LINEAR:j=c[1];e=j.input-e;return e>1.0E-5?h-d*(j.output-h)/e:h;case o3d.Curve.CYCLE:h=Math.ceil(d/g);a+=h*g;a=e+(a-e)%g;break;case o3d.Curve.CYCLE_RELATIVE:h=Math.ceil(d/g);a+=h*g;a=
e+(a-e)%g;k-=h*i;break;case o3d.Curve.OSCILLATE:h=Math.ceil(d/(2*g));a+=h*2*g;a=f-Math.abs(a-f);break;default:this.gl.client.error_callback("Curve: invalid value "+this.preInfinity+"for pre-infinity");return h}}else if(a>=f){if(g<=0)return j;h=a-f;switch(this.postInfinity){case o3d.Curve.CONSTANT:return j;case o3d.Curve.LINEAR:g=c[d-2];e=f-g.input;return e>1.0E-5?j+h*(j-g.output)/e:j;case o3d.Curve.CYCLE:h=Math.ceil(h/g);a-=h*g;a=e+(a-e)%g;break;case o3d.Curve.CYCLE_RELATIVE:h=Math.floor((a-e)/g);
a-=h*g;a=e+(a-e)%g;k+=h*i;break;case o3d.Curve.OSCILLATE:h=Math.ceil(h/(2*g));a-=h*2*g;a=e+Math.abs(a-e);break;default:this.gl.client.error_callback("Curve.invalid value "+this.postInfinity+"for post-infinity");return j}}if(a>=f)return j+k;return this.getOutputInSpan_(a,b)+k};
o3d.Skin=function(){o3d.NamedObject.call(this);this.influences=[];this.inverseBindPoseMatrices=[];this.info_valid_=false;this.highest_influences_=this.highest_matrix_index_=0;this.buffers_valid_=this.supports_vertex_shader_=false;this.matrix_indices_field_=this.weights_field_=this.vertex_buffer_=null};o3d.inherit("Skin","NamedObject");
o3d.Skin.prototype.updateVertexShader=function(){if(!this.buffers_valid_){var a=this.influences.length;if(!this.weights_field_&&!this.matrix_indices_field_){var b=new o3d.VertexBuffer;b.gl=this.gl;this.weights_field_=b.createField("FloatField",4);this.matrix_indices_field_=b.createField("FloatField",4);b.allocateElements(a)}var c,d;b=this.weights_field_;var e=this.matrix_indices_field_;c=this.getHighestInfluences();this.buffers_valid_=true;b.buffer.lock();e.buffer.lock();d=o3d.SkinEval.getMaxNumBones(this);
if(this.supports_vertex_shader_=c<=4&&this.inverseBindPoseMatrices.length<=d){var f=new Float32Array(a*4),g=new Float32Array(a*4);for(c=0;c<a;++c){var h=this.influences[c];for(d=0;d<h.length&&d<8;d+=2){g[c*4+d/2]=h[d];f[c*4+d/2]=h[d+1]}}b.setAt(0,f);e.setAt(0,g)}b.buffer.unlock();e.buffer.unlock()}return this.supports_vertex_shader_};
o3d.Skin.prototype.setVertexInfluences=function(a,b){if(b.length%2!=0)this.gl.client.error_callback("odd number of values passed intoSetVertexInfluence. Even number required as they are pairs.");else{this.influences[a]=b;this.buffers_valid_=this.info_valid_=false}};o3d.Skin.prototype.getVertexInfluences=function(a){return this.influences[a]||[]};
o3d.Skin.prototype.updateInfo_=function(){if(!this.info_valid_){this.info_valid_=true;for(var a=this.highest_influences_=this.highest_matrix_index_=0;a<this.influences.length;++a){var b=this.influences[a],c=b.length;if(c>this.highest_influences_)this.highest_influences_=c;for(c=0;c<b.length;c+=2)if(b[c]>this.highest_matrix_index_)this.highest_matrix_index_=b[c]}this.highest_influences_%2&&this.gl.client.error_callback("Skin.updateInfo: Influences should not have odd length ");this.highest_influences_=
Math.floor(this.highest_influences_/2)}};o3d.Skin.prototype.getHighestMatrixIndex=function(){this.updateInfo_();return this.highest_matrix_index_};o3d.Skin.prototype.getHighestInfluences=function(){this.updateInfo_();return this.highest_influences_};o3d.Skin.prototype.setInverseBindPoseMatrix=function(a,b){this.inverseBindPoseMatrices[a]=b};o3d.Skin.prototype.set=function(){o3d.notImplemented()};
o3d.SkinEval=function(){o3d.StreamBank.call(this);this.base=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]];this.temp_matrix_=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]];this.bones_=[];this.bone_array_=null;this.input_stream_infos_=[];this.output_stream_infos_=[];this.createParam("boneToWorld3x4","ParamParamArrayOutput");this.usingSkinShader=0};o3d.inherit("SkinEval","StreamBank");o3d.ParamObject.setUpO3DParam_(o3d.SkinEval,"base","ParamMatrix4");
o3d.ParamObject.setUpO3DParam_(o3d.SkinEval,"usingSkinShader","ParamFloat");o3d.ParamObject.setUpO3DParam_(o3d.SkinEval,"disableShader","ParamBoolean");o3d.ParamObject.setUpO3DParam_(o3d.SkinEval,"skin","ParamSkin");o3d.ParamObject.setUpO3DParam_(o3d.SkinEval,"matrices","ParamArray");o3d.SkinEval.getMaxNumBones=function(a){a=a.gl;a=a.getParameter(a.MAX_VERTEX_UNIFORM_VECTORS);return Math.floor((a-32)/3)};
o3d.SkinEval.prototype.streamWasBound_=function(a){this.skin.updateVertexShader();if(this.skin.weights_field_&&this.skin.matrix_indices_field_){var b=a.getVertexStream(o3d.Stream.INFLUENCE_WEIGHTS,0),c=a.getVertexStream(o3d.Stream.INFLUENCE_INDICES,0);if(!b||!c||b.field!=this.skin.weights_field_||c.field!=this.skin.matrix_indices_field_){a.setVertexStream(o3d.Stream.INFLUENCE_WEIGHTS,0,this.skin.weights_field_,0);a.setVertexStream(o3d.Stream.INFLUENCE_INDICES,0,this.skin.matrix_indices_field_,0)}(b=
a.getParam("boneToWorld3x4"))||(b=a.createParam("boneToWorld3x4","ParamParamArray"));b.bind(this.getParam("boneToWorld3x4"));(b=a.getParam("usingSkinShader"))||(b=a.createParam("usingSkinShader","ParamFloat"));b.bind(this.getParam("usingSkinShader"))}};
o3d.SkinEval.prototype.multiplyAdd_=function(a,b,c){var d=a[0],e=a[1],f=a[2];a=a[3];var g=c[0],h=c[1],j=c[2];c=c[3];g[0]+=d[0]*b;g[1]+=d[1]*b;g[2]+=d[2]*b;g[3]+=d[3]*b;h[0]+=e[0]*b;h[1]+=e[1]*b;h[2]+=e[2]*b;h[3]+=e[3]*b;j[0]+=f[0]*b;j[1]+=f[1]*b;j[2]+=f[2]*b;j[3]+=f[3]*b;c[0]+=a[0]*b;c[1]+=a[1]*b;c[2]+=a[2]*b;c[3]+=a[3]*b};
o3d.SkinEval.prototype.initStreams_=function(a){var b,c,d,e,f=this.skin.influences.length;for(e=b=0;b<this.vertex_streams_.length;++b){var g=this.vertex_streams_[b];if(g)for(c=0;c<g.length;++c,++e){d=g[c];var h=d.inputConnection;h&&h.isAClassName("ParamVertexBufferStream")&&h.owner_.updateStreams();h=d.stream;if(h.getMaxVertices_()!=f){this.gl.client.error_callback("SkinEval.doSkinning_: stream "+h.semantic+" index "+h.semanticIndex+" in SkinEval '"+this.name+" does not have the same number of vertices as Skin '"+
a.name+"'");return}this.input_stream_infos_[e]||(this.input_stream_infos_[e]=new o3d.SkinEval.StreamInfo);if(!this.input_stream_infos_[e].init(h,false)){var j;if(h.field.buffer)j=h.field.buffer.name;this.gl.client.error_callback("SkinEval.doSkinning_: unable to lock buffer '"+j+" used by stream "+h.semantic+" index "+h.semanticIndex+" in SkinEval '"+this.name+"'");return}h=d.outputConnections;this.output_stream_infos_[e]||(this.output_stream_infos_[e]=[]);var i=this.output_stream_infos_[e];i.length=
h.length;for(d=0;d<h.length;++d){var k=h[d];k.isAClassName("ParamVertexBufferStream")||this.gl.client.error_callback("SkinEval.doSkinning: "+k.className+" not ParamVertexBufferStream");k=k.stream;if(k.getMaxVertices_()!=f){this.gl.client.error_callback("SkinEval.doSkinning_: stream "+k.semantic+" index "+k.semanticIndex+" targeted by SkinEval '"+this.name+" does not have the same number of vertices as Skin '"+a.name+"'");return}i[d]||(i[d]=new o3d.SkinEval.StreamInfo);if(!i[d].init(k,true)){if(k.field.buffer)j=
k.field.buffer.name;this.gl.client.error_callback("SkinEval.doSkinning_: unable to lock buffer '"+j+" used by stream "+k.semantic+" index "+k.semanticIndex+" targeted by SkinEval '"+this.name+"'");return}}}}this.input_stream_infos_.length=e;this.output_stream_infos_.length=e};
o3d.SkinEval.prototype.uninitStreams_=function(){for(ii=0;ii<this.input_stream_infos_.length;++ii)this.input_stream_infos_[ii].uninit();for(ii=0;ii<this.output_stream_infos_.length;++ii)for(var a=this.output_stream_infos_[ii],b=0;b<a.length;++b)a[b].uninit()};
o3d.SkinEval.prototype.doSkinning_=function(){this.initStreams_();var a,b,c,d=this.skin.influences,e=d.length;for(a=0;a<e;++a){c=d[a];if(c.length){var f=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]];this.multiplyAdd_(this.bones_[c[0]],c[1],f);var g=c.length;for(b=2;b<g;b+=2)this.multiplyAdd_(this.bones_[c[b]],c[b+1],f);for(b=0;b<this.input_stream_infos_.length;++b){g=this.input_stream_infos_[b];g.compute_function_(f);var h=this.output_stream_infos_[b],j=h.length;for(c=0;c<j;++c)h[c].copy_function_(g)}}}this.uninitStreams_()};
o3d.SkinEval.prototype.updateBones_=function(){var a=this.matrices;if(a){var b=this.skin;if(b)if(b.getHighestMatrixIndex()>=a.length)this.gl.client.error_callback("SkinEval.updateBones_: skin '"+b.name+" specified in SkinEval '"+this.name+"' references matrices outside the valid range in ParamArray '"+a.name+"'");else{var c=b.inverseBindPoseMatrices;if(c.length!=a.length)this.gl.client.error_callback("SkinEval.updateBones_: skin '"+b.name+" specified in SkinEval '"+this.name+"' and the ParamArray '"+
a.name+"' do not have the same number of matrices.");else{b=this.temp_matrix_;o3d.Transform.inverse(this.base,b);for(var d=0;d<a.length;++d){var e=a.getParam(d);if(!e){this.gl.client.error_callback("SkinEval.updateBones_: In SkinEval '"+this.name+"' param at index "+d+" in ParamArray '"+a.name+" is not a ParamMatrix4");break}this.bones_[d]=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]];o3d.Transform.compose(e.value,c[d],this.bones_[d]);o3d.Transform.compose(b,this.bones_[d],this.bones_[d])}}}else this.gl.client.error_callback("SkinEval.updateBones_: no skin specified in SkinEval '"+
this.name+"'")}else this.gl.client.error_callback("SkinEval.updateBones_: no matrices for SkinEval '"+this.name+"'")};o3d.SkinEval.prototype.updateStreams=function(){if(this.disableShader||!this.usingSkinShader||!this.skin.updateVertexShader()){this.updateBones_();this.doSkinning_(this.skin);this.usingSkinShader=0}};
o3d.SkinEval.prototype.updateOutputs=function(a){this.updateBones_();if(!this.bone_array_){this.bone_array_=new o3d.ParamArray;this.bone_array_.gl=this.gl;this.bone_array_.resize(o3d.SkinEval.getMaxNumBones(this)*3,"ParamFloat4");a.value=this.bone_array_}a=this.bone_array_;var b,c;if(!this.disableShader&&this.skin.updateVertexShader()){if(!this.usingSkinShader){this.usingSkinShader=1;this.initStreams_();var d=this.skin.influences.length;for(b=0;b<this.input_stream_infos_.length;++b){var e=this.input_stream_infos_[b],
f=this.output_stream_infos_[b];for(c=0;c<f.length;++c){var g=e.field_.getAt(0,d);f[c].field_.setAt(0,g)}}this.uninitStreams_()}for(b=0;b<this.bones_.length;++b){d=this.bones_[b];c=a.getParam(b*3);c.value[0]=d[0][0];c.value[1]=d[1][0];c.value[2]=d[2][0];c.value[3]=d[3][0];c=a.getParam(b*3+1);c.value[0]=d[0][1];c.value[1]=d[1][1];c.value[2]=d[2][1];c.value[3]=d[3][1];c=a.getParam(b*3+2);c.value[0]=d[0][2];c.value[1]=d[1][2];c.value[2]=d[2][2];c.value[3]=d[3][2]}}return a};
o3d.SkinEval.StreamInfo=function(){this.buffer_=this.values_=this.field_=this.result_=this.copy_function_=this.compute_function_=null;this.index_=0;this.writable_=false};
o3d.SkinEval.StreamInfo.prototype.init=function(a,b){if(this.values_||this.buffer_)return false;var c=a.field,d=c.buffer;if(!d)return false;switch(c.numComponents){case 3:this.copy_function_=this.copyFloat3;this.compute_function_=a.semantic==o3d.Stream.POSITION?this.computeFloat3AsPoint3:this.computeFloat3AsVector3;break;case 4:this.compute_function_=this.computeFloat4AsVector4;this.copy_function_=this.copyFloat4;break;default:return false}d.lock();this.field_=c;this.buffer_=d;this.values_=d.array_;
this.index_=this.field_.offset_;this.writable_=b;this.stride_=d.totalComponents;return true};o3d.SkinEval.StreamInfo.prototype.uninit=function(){if(this.buffer_){this.writable_&&this.buffer_.unlock();this.values_=this.field_=this.buffer_=null}};o3d.SkinEval.StreamInfo.prototype.computeFloat3AsVector3=function(a){var b=this.index_;this.result_=o3d.Transform.multiplyVector(a,[this.values_[b],this.values_[b+1],this.values_[b+2],0]);this.index_=b+this.stride_};
o3d.SkinEval.StreamInfo.prototype.computeFloat3AsPoint3=function(a){var b=this.index_;this.result_=o3d.Transform.multiplyVector(a,[this.values_[b],this.values_[b+1],this.values_[b+2],1]);this.index_=b+this.stride_};o3d.SkinEval.StreamInfo.prototype.computeFloat4AsVector4=function(a){var b=this.index_;this.result_=o3d.Transform.multiplyVector(a,[this.values_[b],this.values_[b+1],this.values_[b+2],this.values_[b+3]]);this.index_=b+this.stride_};
o3d.SkinEval.StreamInfo.prototype.copyFloat3=function(a){var b=this.index_;this.values_[b]=a.result_[0];this.values_[b+1]=a.result_[1];this.values_[b+2]=a.result_[2];this.index_=b+this.stride_};o3d.SkinEval.StreamInfo.prototype.copyFloat4=function(a){var b=this.index_;this.values_[b]=a.result_[0];this.values_[b+1]=a.result_[1];this.values_[b+2]=a.result_[2];this.values_[b+3]=a.result_[3];this.index_=b+this.stride_};
function trimAll(a){for(;a.substring(0,1)==" ";)a=a.substring(1,a.length);for(;a.substring(a.length-1,a.length)==" ";)a=a.substring(0,a.length-1);return a}
function createDefaultMaterial(a,b,c){var d=0;if(c[3]<0.99&&c[3]>0)d=1;a=o3djs.material.createBasicMaterial(a,b,c,d);a.getParam("lightWorldPos").value=[2E3,2E3,1E4];a.getParam("emissive").value=[0.1,0.1,0.1,0.08];a.getParam("ambient").value=[0.1,0.1,0.1,0.005];a.getParam("specular").value=[0.1,0.1,0.1,0.01];a.getParam("shininess").value=0.02;a.getParam("specularFactor").value=0.1;a.getParam("lightColor").value=[0.8,0.8,0.8,0.5];return a}
function readXMLFile(a,b,c){var d=a.getElementsByTagName("Piece")[0],e=parseInt(d.getAttribute("NumberOfPoints"));a=parseInt(d.getAttribute("NumberOfPolys"));for(var f=d.getElementsByTagName("Points")[0],g=0;g<f.childNodes.length;g++){var h=f.childNodes[g];if(h.tagName=="DataArray"&&h.getAttribute("Name")=="Points"){var j=parseInt(h.getAttribute("NumberOfComponents")),i=RegExp("[ ,;]+","g"),k=trimAll(window.ActiveXObject?h.text:h.textContent).split(i),l=i=h=0,m=[0,0,0];for(h=0;h<k.length;h++){var n=
parseFloat(k[h]);if(!isNaN(n)){m[l]=n;i++;l++;if(l==3){l=0;c.addElement(m[0],m[1],m[2])}}}h=j*e;i!=h&&alert("Error reading "+file+" : \n Number of read coordinates : "+i+"\n Number of wanted coordinates : "+h)}}c=d.getElementsByTagName("Polys")[0];for(g=0;g<c.childNodes.length;g++){h=c.childNodes[g];if(h.tagName=="DataArray"&&h.getAttribute("Name")=="connectivity"){d=window.ActiveXObject?h.text:h.textContent;i=RegExp("[ ,;]+","g");d=trimAll(d).split(i);l=i=0;e=[0,0,0];for(h=0;h<d.length;h++){n=parseInt(d[h]);
if(!isNaN(n)){e[l]=n;i++;l++;if(l==3){l=0;b.addTriangle(e[0],e[1],e[2])}}}h=3*a;i!=h&&alert("Error reading "+file+" : \n Number of read indices : "+i+"\n Number of wanted connectivities : "+h)}}}
function readVTKFile(a,b,c,d){a=a.split(RegExp("[ \n]+","gm"));for(var e=0;a[e]!="POINTS";)e++;e++;var f=a[e];e++;for(var g=[0,0,0],h=0;;){for(var j=parseFloat(a[e]);isNaN(j);){e++;j=parseFloat(a[e])}g[h]=j;h++;e++;if(h==3){h=0;c.addElement(g[0],g[1],g[2]);f--;if(f==0)break}}for(;a[e]!="POLYGONS";)e++;e++;c=[0,0,0,0];f=a[e];e++;e++;for(h=0;;){for(j=parseInt(a[e]);isNaN(j);){e++;j=parseInt(a[e])}c[h]=j;h++;e++;if(h==c[0]+1){h=0;if(d){b.addTriangle(c[1],c[3],c[2]);c[0]==4&&b.addTriangle(c[1],c[4],c[3])}else{b.addTriangle(c[1],
c[2],c[3]);c[0]==4&&b.addTriangle(c[1],c[3],c[4])}f--;if(f==0)break}}}
function createFromFile(a,b,c,d){var e=createDefaultMaterial(b,g_viewInfo,c);if(c[3]<0){c=b.createObject("State");e.state=c;c.getStateParam("FillMode").value=g_o3d.State.WIREFRAME}c=o3djs.primitives.createVertexInfo();var f=c.addStream(3,o3djs.base.o3d.Stream.POSITION),g=c.addStream(3,o3djs.base.o3d.Stream.NORMAL),h=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");h.open("GET",a,false);h.send();a=a.split(".");a=a[a.length-1].toLowerCase();switch(a){case "xml":a=h.responseXML;
readXMLFile(a,c,f);break;case "vtk":a=h.responseText;readVTKFile(a,c,f,d);break;default:alert(a+" file format not supported yet!")}d=f.numElements();a=c.numTriangles();for(h=0;h<d;h++)g.addElement(0,0,0);for(h=0;h<a;h++){for(var j=c.getTriangle(h),i=[],k=0;k<3;++k)i[k]=f.getElementVector(j[k]);k=o3djs.math.normalize(o3djs.math.subVector(i[1],i[0]));i=o3djs.math.normalize(o3djs.math.subVector(i[2],i[1]));i=o3djs.math.normalize(o3djs.math.cross(k,i));for(k=0;k<3;k++){var l=j[k],m=g.getElementVector(l);
g.setElementVector(l,o3djs.math.addVector(i,m))}}for(h=0;h<d;h++){i=g.getElementVector(h);g.setElementVector(h,o3djs.math.normalize(i))}return c.createShape(b,e)}o3djs.base.o3d=o3d;o3djs.require("o3djs.webgl");o3djs.require("o3djs.math");o3djs.require("o3djs.quaternions");o3djs.require("o3djs.rendergraph");o3djs.require("o3djs.pack");o3djs.require("o3djs.arcball");o3djs.require("o3djs.event");o3djs.require("o3djs.cameracontroller");o3djs.require("o3djs.primitives");window.onload=init;
window.onunload=uninit;var g_o3d,g_math,g_pack,g_client,g_o3dWidth=-1,g_o3dHeight=-1,g_viewInfo,g_cameracontroller;function updateClient(){g_client.renderMode==g_o3d.Client.RENDERMODE_ON_DEMAND&&g_client.render()}function renderCallback(){setClientSize();g_client.renderMode=g_o3d.Client.RENDERMODE_ON_DEMAND}
function AddMeshes(a,b){var c=new XMLHttpRequest;c.open("GET",a+"?nocache="+Math.random(),false);c.send();c=c.responseXML.getElementsByTagName("mesh");var d=a.lastIndexOf("/"),e="";if(d>0)e=a.substring(0,d);for(var f=d=0;f<c.length;f++){var g=c[f],h=g.getAttribute("Mesh"),j=g.getAttribute("Label"),i=[1,1,1,1];if(g.hasAttribute("flip"))d=1;if(g.hasAttribute("color")){g=g.getAttribute("color").split(" ");for(var k=0;k<4;k++)i[k]=parseFloat(g[k])}j!="0"&&b.addShape(createFromFile(e+"/"+h,g_pack,i,d))}}
function init(){o3djs.webgl.makeClients(initStep2)}function setClientSize(){var a=g_client.width,b=g_client.height;if(a!=g_o3dWidth||b!=g_o3dHeight){g_o3dWidth=a;g_o3dHeight=b;g_viewInfo.drawContext.projection=g_math.matrix4.perspective(g_math.degToRad(45),g_o3dWidth/g_o3dHeight,0.1,1E4);g_cameracontroller.setAreaSize(g_o3dWidth,g_o3dHeight)}}var g_dragging=false;
function startDragging(a){g_dragging=true;a.shiftKey||a.button==1?g_cameracontroller.setDragMode(o3djs.cameracontroller.DragMode.MOVE_CENTER_IN_VIEW_PLANE,a.x,a.y):g_cameracontroller.setDragMode(o3djs.cameracontroller.DragMode.SPIN_ABOUT_CENTER,a.x,a.y)}function drag(a){if(g_dragging){g_cameracontroller.mouseMoved(a.x,a.y);a=g_cameracontroller.calculateViewMatrix();g_client.root.localMatrix=a;updateClient()}}
function stopDragging(){g_dragging=false;g_cameracontroller.setDragMode(o3djs.cameracontroller.DragMode.NONE)}function scrollMe(a){if(a.deltaY){g_cameracontroller.backpedal*=(a.deltaY<0?14:10)/12;g_client.root.localMatrix=g_cameracontroller.calculateViewMatrix();updateClient()}}
function initStep2(a){a=a[0];g_client=a.client;g_o3d=a.o3d;g_math=o3djs.math;g_lastRot=g_math.matrix4.identity();g_thisRot=g_math.matrix4.identity();g_pack=g_client.createPack();g_viewInfo=o3djs.rendergraph.createBasicView(g_pack,g_client.root,g_client.renderGraphRoot,[1,1,1,1]);var b=g_pack.createObject("Transform");AddMeshes("http://www.creatis.insa-lyon.fr/~valette/meshView/coeurThorax/coeurthorax.xml",b);b.parent=g_client.root;g_cameracontroller=o3djs.cameracontroller.createCameraController([150,
150,150],500,100,100,0.8);setClientSize();g_client.render();g_client.root.localMatrix=g_cameracontroller.calculateViewMatrix();o3djs.event.addEventListener(a,"mousedown",startDragging);o3djs.event.addEventListener(a,"mousemove",drag);o3djs.event.addEventListener(a,"mouseup",stopDragging);o3djs.event.addEventListener(a,"wheel",scrollMe);g_client.render();g_client.setRenderCallback(renderCallback);window.onresize=updateClient}function uninit(){g_client&&g_client.cleanup()};
